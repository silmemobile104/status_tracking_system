<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SILMIN MOBILE</title>
    <link rel="icon" type="image/png" href="/image/icon_silme.png">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.default.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
    <style type="text/tailwindcss">
        /* ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô <style type="text/tailwindcss"> */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans Thai', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal { display: none; }
        .modal.active { display: flex; }
        
        .form-input-theme {
            @apply w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block p-3;
            @apply focus:ring-amber-500 focus:border-amber-500;
        }
        .form-select-theme {
            @apply w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block p-3;
            @apply focus:ring-amber-500 focus:border-amber-500;
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥ */
        .deposit-table th {
            background-color: #e0f2fe;
            border: 1px solid #94a3b8;
            text-align: center;
            padding: 8px;
            font-weight: 600;
            color: #334155;
        }
        .deposit-table td {
            border: 1px solid #cbd5e1;
            padding: 8px;
            vertical-align: middle;
        }
        .header-received {
            background-color: #fef3c7 !important;
        }
        
        /* --- RESPONSIVE FIXES (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) --- */
        #sidebar {
            /* üî¥ BASE (Mobile): Fixed position, ‡∏ã‡πà‡∏≠‡∏ô, ‡πÉ‡∏ä‡πâ transition */
            position: fixed;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            height: 100vh;
            padding-top: 4rem; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ Mobile Header */
            z-index: 50; 
        }
        /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Menu ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î */
        #sidebar.active {
            transform: translateX(0);
        }
        
        /* üü¢ DESKTOP FIX (md: ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤) */
        @media (min-width: 768px) {
            #sidebar {
                /* üî¥ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Relative/Static ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Layout ‡∏õ‡∏Å‡∏ï‡∏¥ (Flexbox) */
                position: static; 
                transform: translateX(0);
                padding-top: 0; /* ‡∏•‡∏ö padding ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏≠‡∏≠‡∏Å */
                box-shadow: none; 
            }
        }
        /* üî¥ MAIN CONTENT PADDING ADJUSTMENTS */
        #main-content {
            /* ‡πÉ‡∏ä‡πâ pt-20 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏á (‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏ó‡∏µ‡πà h-16 + p-3) */
            padding-top: 5rem; /* üî¥ 5rem = 80px (pt-20) */
            transition: margin-left 0.3s ease-in-out; 
        }
        @media (min-width: 768px) {
            #main-content {
                /* ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ Padding ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ö‡∏ô Desktop */
                padding-top: 1rem; 
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="mobile-header" class="md:hidden bg-white shadow p-3 flex justify-between items-center fixed top-0 left-0 w-full z-40">
        <button id="menu-toggle" class="text-gray-700 p-2">
            <ion-icon name="menu" class="text-2xl"></ion-icon>
        </button>
        <span class="text-lg font-bold text-amber-600">SILMIN MOBILE</span>
        <div id="notification-bell-mobile" class="relative">
             <button id="notification-bell-btn-mobile" class="relative text-gray-500 hover:text-amber-600 focus:outline-none">
                <ion-icon name="notifications-outline" class="w-6 h-6"></ion-icon>
                <span id="notification-dot-mobile" class="hidden absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
            </button>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    
    <div id="app-wrapper" class="flex min-h-screen"> 
        
        <aside id="sidebar" class="w-64 bg-white shadow-lg flex-shrink-0 flex flex-col md:shadow-lg">
            <div class="flex flex-col h-full">
                <div class="h-16 flex items-center justify-center border-b hidden md:flex">
                    <h1 class="text-xl font-bold text-gray-800">SILMIN MOBILE</h1>
                </div>
                
                <div class="p-4 border-b">
                    <label for="company-select" class="block text-sm font-medium text-gray-500 mb-2">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                    <select id="company-select" class="form-select-theme p-2.5">
                        <option selected value="company_1_id">‡∏ã‡∏¥‡∏•‡∏°‡∏µ‡∏ô ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</option>
                        <option value="company_2_id">‡πÄ‡∏≠‡∏™‡∏à‡∏µ ‡∏û‡∏•‡∏±‡∏™ 2023 ‡∏à‡∏≥‡∏Å‡∏±‡∏î</option>
                    </select>
                </div>
                
                <nav id="nav-menu" class="flex-1 py-4 px-2 space-y-2">
                    <a href="#" onclick="updateNavActiveState('dashboard')" id="nav-dashboard" class="flex items-center px-4 py-2 text-white bg-amber-500 rounded-lg font-medium">
                        <ion-icon name="grid-outline" class="w-5 h-5 mr-3"></ion-icon> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                    </a>
                    <a href="#" onclick="updateNavActiveState('mytasks')" id="nav-mytasks" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        <ion-icon name="document-text-outline" class="w-5 h-5 mr-3"></ion-icon> ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                    </a>
                    <a href="#" onclick="updateNavActiveState('deposit')" id="nav-Storefront_deposit" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        <ion-icon name="cash-outline" class="w-5 h-5 mr-3"></ion-icon> ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô
                    </a>
                    <a href="#" onclick="updateNavActiveState('admin')" id="nav-admin" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        <ion-icon name="person-add-outline" class="w-5 h-5 mr-3"></ion-icon> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                    </a>
                    <a href="#" id="nav-settings" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        <ion-icon name="settings-outline" class="w-5 h-5 mr-3"></ion-icon> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    </a>
                </nav>
                
                <div class="p-4 border-t mt-auto">
                    <div id="user-profile-widget" class="flex items-center justify-between">
                        <div class="flex items-center">
                            <img class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/100x100/e2e8f0/718096?text=U" alt="User Avatar">
                            <div class="ml-3">
                                <p id="user-name" class="text-sm font-medium text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                                <p id="user-role" class="text-xs text-gray-500">...</p>
                            </div>
                        </div>
                        <div class="relative hidden md:block">
                            <button id="notification-bell" class="relative text-gray-500 hover:text-amber-600 focus:outline-none">
                                <ion-icon name="notifications-outline" class="w-6 h-6"></ion-icon>
                                <span id="notification-dot" class="hidden absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                            </button>
                        </div>
                    </div>
                    <button id="logout-button" class="w-full mt-3 text-left flex items-center px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg">
                        <ion-icon name="log-out-outline" class="w-5 h-5 mr-3 text-red-500"></ion-icon> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </aside>

        <main id="main-content" class="flex-1 p-4 pt-20 md:pt-4 overflow-y-auto">
            
            <div class="container mx-auto px-6 py-8">
                
                <div class="flex justify-between items-center mb-6">
                    <h2 id="main-header" class="text-3xl font-bold text-gray-800">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
                    <div id="main-header-buttons">
                        <button id="newTaskButton" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <ion-icon name="add-outline" class="w-5 h-5 mr-2"></ion-icon>
                            ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </button>
                        <button id="newUserButton" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg flex items-center hidden">
                            <ion-icon name="person-add-outline" class="w-5 h-5 mr-2"></ion-icon>
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </div>

                <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    </div>
                
                <div id="mytasks-filters" class="hidden mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="filterMyTasks('todo')" id="btn-filter-todo" class="p-3 bg-white rounded-lg shadow hover:shadow-md transition-all border-l-4 border-gray-400 flex items-center justify-between group focus:ring-2 focus:ring-gray-300">
                            <div class="flex items-center">
                                <ion-icon name="clipboard-outline" class="text-gray-500 mr-2"></ion-icon>
                                <span class="text-sm font-semibold text-gray-700">‡∏£‡∏≠‡∏ó‡∏≥</span>
                            </div>
                            <span id="mytask-count-todo" class="bg-gray-100 text-gray-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                        </button>

                        <button onclick="filterMyTasks('in-progress')" id="btn-filter-inprogress" class="p-3 bg-white rounded-lg shadow hover:shadow-md transition-all border-l-4 border-yellow-400 flex items-center justify-between group focus:ring-2 focus:ring-yellow-300">
                            <div class="flex items-center">
                                <ion-icon name="construct-outline" class="text-yellow-600 mr-2"></ion-icon>
                                <span class="text-sm font-semibold text-yellow-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</span>
                            </div>
                            <span id="mytask-count-inprogress" class="bg-yellow-100 text-yellow-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                        </button>

                        <button onclick="filterMyTasks('for-review')" id="btn-filter-review" class="p-3 bg-white rounded-lg shadow hover:shadow-md transition-all border-l-4 border-amber-400 flex items-center justify-between group focus:ring-2 focus:ring-amber-300">
                            <div class="flex items-center">
                                <ion-icon name="search-outline" class="text-amber-600 mr-2"></ion-icon>
                                <span class="text-sm font-semibold text-amber-700">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                            </div>
                            <span id="mytask-count-review" class="bg-amber-100 text-amber-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                        </button>

                        <button onclick="filterMyTasks('completed')" id="btn-filter-completed" class="p-3 bg-white rounded-lg shadow hover:shadow-md transition-all border-l-4 border-green-400 flex items-center justify-between group focus:ring-2 focus:ring-green-300">
                            <div class="flex items-center">
                                <ion-icon name="checkmark-circle-outline" class="text-green-600 mr-2"></ion-icon>
                                <span class="text-sm font-semibold text-green-700">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>
                            </div>
                            <span id="mytask-count-completed" class="bg-green-100 text-green-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                        </button>
                    </div>
                    <div class="mt-2 flex justify-end">
                        <button onclick="filterMyTasks('all')" class="text-xs text-gray-500 hover:text-amber-600 underline flex items-center">
                            <ion-icon name="refresh-outline" class="mr-1"></ion-icon> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                </div>

                <div id="task-view-content" class="bg-white rounded-lg shadow overflow-hidden">
                    <div id="loading-tasks" class="text-center p-8 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-amber-500 mx-auto mb-4"></div>
                        <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...</p>
                    </div>
                    <div id="task-error-message" class="hidden p-4 m-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                        <span class="font-medium">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</span> <span id="task-error-text"></span>
                    </div>
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h3>
                        <span id="task-count" class="text-sm text-gray-500">0 ‡∏á‡∏≤‡∏ô</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th>
                                    <th id="header-assignee" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body" class="bg-white divide-y divide-gray-200">
                                <tr id="no-task-row" class="text-center">
                                    <td colspan="5" class="px-6 py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="deposit-view" class="hidden bg-white p-4 rounded-lg shadow overflow-x-auto mt-6">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            <ion-icon name="wallet" class="mr-2 text-amber-600"></ion-icon>
                            <span id="deposit-header-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</span>
                        </h3>
                    
                        <div class="flex items-center space-x-2">
                            <div id="filter-branch-container">
                                <select id="deposit-filter-branch" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2 focus:ring-amber-500 focus:border-amber-500">
                                    <option value="all" selected>‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>   
                                    <option value="‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™">‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</option>
                                    <option value="‡∏¢‡∏∞‡∏•‡∏≤">‡∏¢‡∏∞‡∏•‡∏≤</option>
                                    <option value="‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ">‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</option>
                                </select>
                            </div>
                        
                            <button onclick="openDepositModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center">
                                <ion-icon name="add-circle" class="mr-2"></ion-icon> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </button>
                        </div>
                    </div>
                
                    <table class="w-full deposit-table border-collapse text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th rowspan="2" class="border p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥</th>
                                <th rowspan="2" class="border p-2">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th rowspan="2" class="border p-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                <th rowspan="2" class="border p-2 bg-red-50 text-red-700">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥</th>
                                <th rowspan="2" class="border p-2">‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö</th>
                                <th colspan="7" class="border p-2 bg-gray-200 text-center">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                            </tr>
                            <tr>
                                <th class="border p-2 text-xs">‡∏ö‡∏¥‡∏•</th>
                                <th class="border p-2 text-xs">IMEI</th>
                                <th class="border p-2 text-xs">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th class="border p-2 text-xs">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°</th>
                                <th class="border p-2 text-xs bg-blue-50">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
                                <th class="border p-2 text-xs">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="border p-2 text-xs">‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="deposit-table-body" class="text-gray-700 bg-white">
                            </tbody>
                    </table>
                </div>

                <div id="admin-view-content" class="hidden bg-white rounded-lg shadow overflow-hidden">
                    <div id="loading-users" class="text-center p-8 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-600 mx-auto mb-4"></div>
                        <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</p>
                    </div>
                    <div class="p-4 border-b flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <span id="user-count" class="text-sm text-gray-500">0 ‡∏Ñ‡∏ô</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="bg-white divide-y divide-gray-200">
                                <tr id="no-user-row" class="text-center">
                                    <td colspan="6" class="px-6 py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> </main>
    </div>

    <div id="newTaskModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <h3 class="text-2xl font-semibold mb-6 text-gray-800">‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
            <form id="new-task-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="taskTitle" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
                        <input type="text" id="taskTitle" name="title" required class="form-input-theme" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå">
                    </div>
                    <div>
                        <label for="taskAssignTo" class="block text-sm font-medium text-gray-700 mb-2">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ</label>
                        <select id="taskAssignTo" name="assignedTo" required class="form-select-theme">
                            <option value="" disabled selected>--- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ---</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6">
                    <label for="taskDesc" class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label>
                    <textarea id="taskDesc" name="description" rows="4" class="form-input-theme" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="taskDueDate" class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
                        <input type="date" id="taskDueDate" name="dueDate" class="form-input-theme">
                    </div>
                    <div>
                        <label for="taskPriority" class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
                        <select id="taskPriority" name="priority" class="form-select-theme">
                            <option value="low">‡∏ï‡πà‡∏≥</option>
                            <option value="medium" selected>‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                            <option value="high">‡∏™‡∏π‡∏á</option>
                        </select>
                    </div>
                </div>
                <div id="new-task-error" class="hidden mt-4 p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg" onclick="closeModal('newTaskModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" id="submit-task-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg">
                        <span id="submit-task-text">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</span>
                        <div id="submit-task-spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="depositModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 overflow-hidden">
            <div class="bg-amber-600 p-4 flex justify-between items-center text-white">
                <h3 class="text-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥</h3>
                <button onclick="closeModal('depositModal')" class="hover:text-gray-200"><ion-icon name="close" class="text-2xl"></ion-icon></button>
            </div>
            <div class="p-6 max-h-[80vh] overflow-y-auto">
                <form id="deposit-form" class="space-y-4">
                    <input type="hidden" id="dep-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-4">
                        <div class="col-span-2 font-bold text-gray-700 flex items-center"><ion-icon name="document-text" class="mr-2"></ion-icon> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥</div>
                        <div><label class="block text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥</label><input type="date" id="dep-date" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö</label><input type="date" id="dep-pickup" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input type="text" id="dep-name" class="w-full border p-2 rounded" required></div>
                        <div><label class="block text-xs text-gray-500">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input type="text" id="dep-phone" class="w-full border p-2 rounded" required></div>
                        <div class="col-span-2"><label class="block text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥ (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="dep-amount" class="w-full border p-2 rounded bg-red-50 text-red-600 font-bold" required></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                        <div class="col-span-2 font-bold text-gray-700 flex items-center bg-yellow-50 p-2 rounded"><ion-icon name="gift" class="mr-2"></ion-icon> ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)</div>
                        <div><label class="block text-xs text-gray-500">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏∏‡πà‡∏ô/‡∏™‡∏µ/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏)</label><input type="text" id="dep-product" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-xs text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏° (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="dep-price" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-xs text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</label><input type="text" id="dep-bill" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-xs text-gray-500">IMEI</label><input type="text" id="dep-imei" class="w-full border p-2 rounded"></div>

                        <div class="col-span-2 flex items-center mt-2 p-3 bg-green-50 rounded border border-green-200 cursor-pointer" onclick="document.getElementById('dep-success').click()">
                            <input type="checkbox" id="dep-success" class="w-5 h-5 text-green-600 rounded mr-3">
                            <label for="dep-success" class="font-bold text-green-800 cursor-pointer">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)</label>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeModal('depositModal')" class="bg-gray-200 px-4 py-2 rounded text-gray-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-2 rounded font-bold shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="taskDetailModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <form id="update-task-form">
                <input type="hidden" id="detail-task-id" name="taskId">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-semibold text-gray-800" id="detail-task-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600" onclick="closeModal('taskDetailModal')"><ion-icon name="close-outline" class="w-7 h-7"></ion-icon></button>
                </div>
                <div class="space-y-4 mb-6">
                    <p class="text-sm text-gray-700"><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong><br><span id="detail-task-desc" class="text-gray-600 whitespace-pre-wrap">...</span></p>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô:</strong> <span id="detail-task-creator" class="text-gray-600">...</span></div>
                        <div><strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á:</strong> <span id="detail-task-dueDate" class="text-gray-600">...</span></div>
                    </div>
                </div>
                <div class="mt-6 border-t pt-6">
                    <h4 class="text-md font-semibold text-gray-700 mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</h4>
                    <div id="detail-task-comments-list" class="space-y-3 max-h-40 overflow-y-auto bg-gray-50 p-3 rounded-lg"><p class="text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</p></div>
                </div>
                <div class="mt-6 border-t pt-6">
                    <label for="detail-task-status" class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</label>
                    <select id="detail-task-status" name="status" class="form-select-theme">
                        <option value="todo">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (To Do)</option>
                        <option value="in-progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (In Progress)</option>
                        <option value="for-review">‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (For Review)</option>
                        <option value="completed">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (Completed)</option>
                    </select>
                    <div class="mt-4">
                        <label for="detail-task-comment" class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß')</label>
                        <textarea id="detail-task-comment" name="commentText" rows="3" class="form-input-theme" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö Link ‡∏ú‡∏•‡∏á‡∏≤‡∏ô..."></textarea>
                    </div>
                </div>
                <div id="update-task-error" class="hidden mt-4 p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                <div class="mt-8 flex justify-between items-center">
                    <button type="button" id="delete-task-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center" style="display: none;"><ion-icon name="trash-outline" class="w-5 h-5 mr-2"></ion-icon>‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>
                    <div class="space-x-3">
                        <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg" onclick="closeModal('taskDetailModal')">‡∏õ‡∏¥‡∏î</button>
                        <button type="submit" id="save-task-details-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-6 border w-full max-w-md shadow-lg rounded-lg bg-white">
            <div class="flex items-start">
                <div class="mr-4 flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><ion-icon name="warning-outline" class="h-6 w-6 text-red-600"></ion-icon></div>
                <div class="mt-0">
                    <h3 class="text-xl font-semibold text-gray-900">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-600" id="confirm-message">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
                        <p id="confirm-error-message" class="text-xs text-red-600 mt-2"></p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg" onclick="closeModal('confirmModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" id="confirm-delete-button" data-task-id="" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>


    <div id="userModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <h3 class="text-2xl font-semibold mb-6 text-gray-800" id="user-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
            <form id="user-form">
                <input type="hidden" id="user-id" name="userId">
                <input type="hidden" id="form-mode" name="mode" value="create">
                
                <div class="mb-6">
                    <label for="user-company-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (Company)</label>
                    <select id="user-company-input" name="companyId" required class="form-select-theme">
                        <option value="company_1_id">‡∏ã‡∏¥‡∏•‡∏°‡∏µ‡∏ô ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</option>
                        <option value="company_2_id">‡πÄ‡∏≠‡∏™‡∏à‡∏µ ‡∏û‡∏•‡∏±‡∏™ 2023 ‡∏à‡∏≥‡∏Å‡∏±‡∏î</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="user-name-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="user-name-input" name="name" required class="form-input-theme">
                    </div>
                    <div>
                        <label for="user-role-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Role)</label>
                        <select id="user-role-input" name="role" required class="form-select-theme">
                            <option value="staff">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff)</option>
                            <option value="manager">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Manager)</option>
                            <option value="hr">‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (HR)</option>
                            <option value="executive">‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive)</option>
                        </select>
                    </div>
                </div>
                <div id="auth-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="user-username-input" class="block text-sm font-medium text-gray-700 mb-2">Username (‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</label>
                        <input type="text" id="user-username-input" name="username" required class="form-input-theme">
                    </div>
                    <div>
                        <label for="user-password-input" class="block text-sm font-medium text-gray-700 mb-2">Password (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)</label>
                        <input type="password" id="user-password-input" name="password" class="form-input-theme" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="user-department-input" class="block text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                        <input type="text" id="user-department-input" name="department" required class="form-input-theme">
                    </div>
                    <div>
                        <label for="user-branch-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                        <input type="text" id="user-branch-input" name="branch" class="form-input-theme">
                    </div>
                </div>
                <div class="mt-6">
                    <label for="user-reportsTo-input" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Reports To)</label>
                    <select id="user-reportsTo-input" name="reportsTo" class="form-select-theme">
                        <option value="">--- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ---</option>
                    </select>
                </div>
                <div id="user-form-error" class="hidden mt-4 p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg" onclick="closeModal('userModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" id="submit-user-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="notificationModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold text-gray-800">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                <button type="button" class="text-gray-400 hover:text-gray-600" onclick="closeModal('notificationModal')">
                    <ion-icon name="close-outline" class="w-7 h-7"></ion-icon>
                </button>
            </div>
            
            <div id="notification-list" class="max-h-96 overflow-y-auto -mr-4 pr-4">
                <p class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
            </div>

            <div class="mt-8 flex justify-end space-x-3">
                <button type="button" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg" onclick="closeModal('notificationModal')">
                    ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>
    <script>
        const SERVER_URL = '/api';
        let currentUser = null; 
        let currentView = 'dashboard'; 
        let notificationPollInterval = null; 
        let allDashboardTasks = []; 
        let allMyTasks = []; 

        // --- Helper Functions ---
        const getRoleName = (role) => {
            switch (role) {
                case 'executive': return '‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£';
                case 'manager': return '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£';
                case 'hr': return '‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (HR)';
                case 'staff': return '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
                default: return role;
            }
        };
        const getStatusTag = (status) => {
            const map = {
                'todo': { text: '‡∏£‡∏≠‡∏ó‡∏≥', bg: 'bg-gray-100', color: 'text-gray-800' },
                'in-progress': { text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥', bg: 'bg-yellow-100', color: 'text-yellow-800' },
                'for-review': { text: '‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', bg: 'bg-amber-100', color: 'text-amber-800' },
                'completed': { text: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', bg: 'bg-green-100', color: 'text-green-800' },
                'overdue': { text: '‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î', bg: 'bg-red-100', color: 'text-red-800' },
            };
            const s = map[status] || map['todo'];
            return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${s.bg} ${s.color}">${s.text}</span>`;
        };
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const safeHide = (el) => { if (el) el.classList.add('hidden'); };
        const safeShow = (el) => { if (el) el.classList.remove('hidden'); };

        // (*** 2. (‡πÉ‡∏´‡∏°‡πà) ‡πÄ‡∏û‡∏¥‡πà‡∏° Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ***)
        const timeAgo = (date) => {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " ‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡πà‡∏≠‡∏ô";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô";
            return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
        };

        // --- Core Functions ---
        const initializeAuth = () => {
            const token = localStorage.getItem('token');
            const userString = localStorage.getItem('user');
            if (!token || !userString) { window.location.href = 'login.html'; return; }
            currentUser = JSON.parse(userString);
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = getRoleName(currentUser.role);
            if (currentUser.role === 'staff') {
                safeHide(document.getElementById('nav-dashboard'));
                safeHide(document.getElementById('nav-admin'));
                safeHide(document.getElementById('nav-settings')); 
                if (document.getElementById('company-select')) { document.getElementById('company-select').parentElement.style.display = 'none'; }
                updateNavActiveState('mytasks'); 
                fetchMyTasks(); 
            } else if (currentUser.role === 'executive') {
                safeHide(document.getElementById('nav-mytasks'));
                updateNavActiveState('dashboard'); 
                fetchDashboardTasks(); fetchTaskStats(); fetchAllUsers(); 
            } else if (currentUser.role === 'manager' || currentUser.role === 'hr') {
                updateNavActiveState('dashboard'); 
                fetchDashboardTasks(); fetchTaskStats(); fetchAllUsers();
            }
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('token'); localStorage.removeItem('user');
                clearInterval(notificationPollInterval); 
                window.location.href = 'login.html';
            });

            // (*** 3. (‡πÉ‡∏´‡∏°‡πà) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ***)
            fetchNotifications();
            // ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡πÜ 1 ‡∏ô‡∏≤‡∏ó‡∏µ
            notificationPollInterval = setInterval(fetchNotifications, 60000); 
        };
        
        // ------------------------------------------
        // --- (A) TASK FUNCTIONS ---
        // ------------------------------------------
        const fetchTaskStats = async () => {
            const token = localStorage.getItem('token');
            const selectedCompanyId = document.getElementById('company-select').value;
            const statsDiv = document.getElementById('stats-cards');
            statsDiv.innerHTML = `<div class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</div>`;
            try {
                const response = await fetch(`${SERVER_URL}/tasks/stats?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { statsDiv.innerHTML = `<div class="text-sm text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`; return; }
                const stats = await response.json();
                
                statsDiv.innerHTML = `
                    <div onclick="filterTasksByStatus('todo')" data-status="todo" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-gray-100 text-gray-600"><ion-icon name="clipboard-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</p><p class="text-2xl font-bold text-gray-900">${stats.todo || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('in-progress')" data-status="in-progress" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-yellow-100 text-yellow-600"><ion-icon name="ellipsis-horizontal-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p><p class="text-2xl font-bold text-gray-900">${stats.inProgress || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('for-review')" data-status="for-review" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-amber-100 text-amber-600"><ion-icon name="search-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p><p class="text-2xl font-bold text-gray-900">${stats.forReview || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('completed')" data-status="completed" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-green-100 text-green-600"><ion-icon name="checkmark-done-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p><p class="text-2xl font-bold text-gray-900">${stats.completed || 0}</p></div></div>
                    </div>
                `;
            } catch (error) {
                console.error('Fetch Stats Error:', error);
                statsDiv.innerHTML = `<div class="text-sm text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>`;
            }
        };

        const fetchAllUsers = async () => {
            const token = localStorage.getItem('token');
            const selectElement = document.getElementById('taskAssignTo');
            const selectedCompanyId = document.getElementById('company-select').value;
            selectElement.innerHTML = '<option value="" disabled selected>--- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... ---</option>';
            selectElement.disabled = true;
            try {
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                if (!response.ok) { selectElement.innerHTML = '<option value="" disabled selected>--- ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ---</option>'; return; }
                const users = await response.json(); 
                selectElement.innerHTML = '';
                selectElement.disabled = false;
                selectElement.prepend(new Option('--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ---', '', true, true));
                if (selectElement.tomselect) {
                    selectElement.tomselect.destroy();
                }
                users.forEach(user => {
                    if (user && user._id) { 
                        const option = document.createElement('option');
                        option.value = user._id; 
                        option.textContent = `${user.name} (${user.branch || user.department})`;
                        selectElement.appendChild(option);
                    }
                });
            } catch (error) {
                selectElement.innerHTML = '<option value="" disabled selected>--- ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Server Down?) ---</option>';
            }
        };

        const fetchDashboardTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = ''; 
            const selectedCompanyId = document.getElementById('company-select').value;
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=dashboard&companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();
                
                allDashboardTasks = tasks;      // ‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á Cache
                renderTaskTable(tasks);         // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏õ‡∏Å‡∏ï‡∏¥)
                filterTasksByStatus('todo');

            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };
        
        const fetchMyTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = ''; 
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=mytasks`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();
                allMyTasks = tasks;     // 1. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏•‡∏≤‡∏á
                updateMyTaskCounts();   // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°
                renderTaskTable(tasks); // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };

        const renderTaskTable = (tasks) => {
            const taskTableBody = document.getElementById('task-table-body');
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ element ‡∏ô‡∏µ‡πâ)
            const countElement = document.getElementById('task-count');
            if(countElement) countElement.textContent = `${tasks.length} ‡∏á‡∏≤‡∏ô`;
        
            // 1. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô
            if (tasks.length === 0) {
                taskTableBody.innerHTML = `<tr id="no-task-row" class="text-center"><td colspan="5" class="px-6 py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</td></tr>`;
                return;
            }
        
            taskTableBody.innerHTML = ''; 
        
            // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô
            tasks.forEach((task, index) => {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'completed';
                const statusDisplay = isOverdue ? getStatusTag('overdue') : getStatusTag(task.status);
                
                // --- LOGIC ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö VS ‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô) ---
                let personName = 'Unknown User';
                let personSubText = '-';
                let personImageChar = '?';
                let showBranchBadge = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå Badge ‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏´‡∏°
            
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentView ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)
                const isMyTasksView = (typeof currentView !== 'undefined' && currentView === 'mytasks');
            
                if (isMyTasksView) {
                    // >> ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô: ‡πÅ‡∏™‡∏î‡∏á "‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô" (Created By)
                    if (task.createdBy) {
                        personName = task.createdBy.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
                        personSubText = '‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô'; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        personImageChar = personName.charAt(0);
                    } else {
                        personName = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        personSubText = '‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô';
                    }
                    // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå Badge ‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πá‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ)
                    showBranchBadge = false; 
                
                } else {
                    // >> ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô (Dashboard): ‡πÅ‡∏™‡∏î‡∏á "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" (Assigned To)
                    if (task.assignedTo) {
                        personName = task.assignedTo.name || 'Unknown User';
                        // ‡∏î‡∏∂‡∏á‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏Å)
                        personSubText = task.assignedTo.branch || task.assignedTo.department || 'N/A';
                        personImageChar = personName.charAt(0);
                    }
                    // ‡πÅ‡∏™‡∏î‡∏á Badge ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤
                    showBranchBadge = true;
                }
            
                // --- LOGIC ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ Badge ---
                let nameDisplayHtml = personName;
                
                // ‡∏ñ‡πâ‡∏≤ Logic ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå Badge ‡πÅ‡∏•‡∏∞ Task ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Branch
                if (showBranchBadge && task.branch) {
                    nameDisplayHtml += ` <span class="ml-2 px-2 py-0.5 text-xs rounded bg-indigo-100 text-indigo-800 border border-indigo-200">‡∏™‡∏≤‡∏Ç‡∏≤${task.branch}</span>`;
                }
            
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ú‡∏•‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏µ event ‡πÅ‡∏¢‡∏Å)
                row.onclick = (e) => {
                    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏ã‡πâ‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (Optional)
                    if (!e.target.closest('button')) openDetailModal(task._id);
                };
            
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="ml-0">
                                <div class="text-sm font-medium text-gray-900">
                                    <span class="font-bold text-amber-600 mr-2">${index + 1}.</span>${task.title}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <img class="h-8 w-8 rounded-full object-cover shadow-sm" 
                                 src="https://placehold.co/100x100/e0e7ff/4f46e5?text=${encodeURIComponent(personImageChar)}" 
                                 alt="">
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900 flex items-center">
                                    ${nameDisplayHtml}
                                </div>
                                <div class="text-xs text-gray-500">${personSubText}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? 'text-red-500 font-bold' : 'text-gray-500'}">
                        ${formatDate(task.dueDate)}
                        <div class="text-xs font-normal text-gray-400">${timeAgo(task.dueDate)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-amber-600 hover:text-amber-800 bg-amber-50 hover:bg-amber-100 px-3 py-1 rounded-md transition-colors" onclick="openDetailModal('${task._id}')">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                        </button>
                    </td>
                `;
                taskTableBody.appendChild(row);
            });
        };

        const filterTasksByStatus = (status) => {
            // 1. ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const statCards = document.querySelectorAll('#stats-cards [data-status]');  
            statCards.forEach(card => {
                if (card.getAttribute('data-status') === status) {
                    card.classList.add('ring-2', 'ring-amber-500', 'shadow-lg');
                } else {
                    card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
                }
            });

            // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Cache
            const filteredTasks = allDashboardTasks.filter(task => task.status === status);
            
            // 3. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            renderTaskTable(filteredTasks);
        };

        const clearTaskFilterHighlights = () => {
            const statCards = document.querySelectorAll('#stats-cards [data-status]');
            statCards.forEach(card => {
                card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
            });
        };

        const handleNewTaskSubmit = async (event) => { 
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const submitButton = document.getElementById('submit-task-btn');
            const errorBox = document.getElementById('new-task-error');
            if (!data.assignedTo || data.assignedTo === "") {
                errorBox.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô'; safeShow(errorBox); return; 
            }
            const postData = { ...data, companyId: document.getElementById('company-select').value, dueDate: data.dueDate ? new Date(data.dueDate).toISOString() : null };
            submitButton.disabled = true; submitButton.querySelector('#submit-task-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...'; safeShow(submitButton.querySelector('#submit-task-spinner'));
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(postData)
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('newTaskModal'); form.reset(); fetchDashboardTasks(); fetchTaskStats(); 
                fetchNotifications(); 
            } catch (error) {
                errorBox.textContent = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.querySelector('#submit-task-text').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô'; safeHide(submitButton.querySelector('#submit-task-spinner'));
            }
        };
        
        const openDetailModal = async (taskId) => { 
            openModal('taskDetailModal');
            const token = localStorage.getItem('token');
            const errorBox = document.getElementById('update-task-error');
            const deleteTaskBtn = document.getElementById('delete-task-btn');
            safeHide(errorBox);
            document.getElementById('detail-task-title').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
            document.getElementById('detail-task-desc').textContent = "...";
            document.getElementById('detail-task-creator').textContent = "...";
            document.getElementById('detail-task-dueDate').textContent = "...";
            document.getElementById('detail-task-comment').value = '';
            document.getElementById('save-task-details-btn').disabled = true;

            const handleDeleteTask = async () => {
                const taskTitle = document.getElementById('detail-task-title').textContent;
                const confirmMsg = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-delete-button');
                confirmMsg.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô: "${taskTitle}"? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`;
                confirmBtn.setAttribute('data-task-id', taskId);
                document.getElementById('confirm-error-message').textContent = '';
                openModal('confirmModal');
            };

            deleteTaskBtn.replaceWith(deleteTaskBtn.cloneNode(true));
            document.getElementById('delete-task-btn').addEventListener('click', handleDeleteTask);

            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                const task = await response.json();
                document.getElementById('detail-task-id').value = task._id;
                document.getElementById('detail-task-title').textContent = task.title;
                document.getElementById('detail-task-desc').textContent = task.description || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)';
                document.getElementById('detail-task-status').value = task.status;
                document.getElementById('detail-task-creator').textContent = task.createdBy ? task.createdBy.name : 'N/A';
                document.getElementById('detail-task-dueDate').textContent = formatDate(task.dueDate);
                const commentsList = document.getElementById('detail-task-comments-list');
                commentsList.innerHTML = ''; 
                if (task.comments && task.comments.length > 0) {
                    task.comments.slice().reverse().forEach(comment => {
                        const commentEl = document.createElement('div');
                        commentEl.className = 'text-sm pb-2 mb-2 border-b border-gray-200';
                        commentEl.innerHTML = `<p class="text-gray-800">${comment.text}</p><p class="text-xs text-gray-500">‡πÇ‡∏î‡∏¢: ${comment.name} - ${new Date(comment.timestamp).toLocaleString('th-TH')}</p>`;
                        commentsList.appendChild(commentEl);
                    });
                } else {
                    commentsList.innerHTML = '<p class="text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</p>';
                }
                const userRole = currentUser.role;
                if (userRole === 'executive' || userRole === 'manager' || userRole === 'hr') {
                    document.getElementById('delete-task-btn').style.display = 'inline-flex';
                } else {
                    document.getElementById('delete-task-btn').style.display = 'none';
                }
            } catch (error) {
                console.error('Open Detail Modal Error:', error);
                errorBox.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ (Error: ' + error.message + ')';
                safeShow(errorBox);
            } finally {
                document.getElementById('save-task-details-btn').disabled = false;
            }
        }; 
        
        const handleUpdateTaskSubmit = async (event) => { 
            event.preventDefault();
            const token = localStorage.getItem('token');
            const status = document.getElementById('detail-task-status').value;
            const taskId = document.getElementById('detail-task-id').value;
            const commentText = document.getElementById('detail-task-comment').value; 
            const errorBox = document.getElementById('update-task-error');
            const submitButton = document.getElementById('save-task-details-btn');
            submitButton.disabled = true; submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status, commentText: commentText })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
                fetchNotifications(); 
            } catch (error) {
                errorBox.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
            }
        };

        const executeDelete = async () => {
            const token = localStorage.getItem('token');
            const deleteButton = document.getElementById('confirm-delete-button');
            const errorMsg = document.getElementById('confirm-error-message');
            const taskId = deleteButton.getAttribute('data-task-id');
            if (!taskId) { errorMsg.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏á‡∏≤‡∏ô'; return; }
            deleteButton.disabled = true; deleteButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...'; errorMsg.textContent = '';
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('confirmModal'); closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
            } catch (error) {
                errorMsg.textContent = `‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`;
            } finally {
                deleteButton.disabled = false; deleteButton.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
            }
        };
        
        // ------------------------------------------
        // --- (B) USER FUNCTIONS ---
        // ------------------------------------------
        const fetchAllUsersForTable = async () => {
            safeShow(document.getElementById('loading-users'));
            const token = localStorage.getItem('token');
            const userTableBody = document.getElementById('user-table-body');
            userTableBody.innerHTML = '';
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                safeHide(document.getElementById('loading-users'));
                if (!response.ok) { throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'); }
                const users = await response.json();
                document.getElementById('user-count').textContent = `${users.length} ‡∏Ñ‡∏ô`;
                if (users.length === 0) {
                    userTableBody.innerHTML = `<tr id="no-user-row" class="text-center"><td colspan="6" class="px-6 py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${user.name}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.username}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${getRoleName(user.role)}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.branch || user.department}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.reportsTo ? user.reportsTo.name : '-'}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-amber-600 hover:text-amber-800" onclick="openEditUserModal('${user._id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="text-red-600 hover:text-red-900 ml-4" onclick="executeDeleteUser('${user._id}', '${user.name}')">‡∏•‡∏ö</button>
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });
            } catch (error) {
                safeHide(document.getElementById('loading-users'));
                userTableBody.innerHTML = `<tr class="text-center"><td colspan="6" class="px-6 py-4 text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</td></tr>`;
            }
        };

        // ------------------------------------------
        // --- (C) NOTIFICATION FUNCTIONS ---
        // ------------------------------------------
        const fetchNotifications = async () => {
            const token = localStorage.getItem('token');
            if (!token) return;
        
            try {
                const response = await fetch(`${SERVER_URL}/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) return;
            
                const data = await response.json();
                const notificationsList = data.notifications; 
                const unreadCount = data.unreadCount;        
            
                updateNotificationUI(notificationsList, unreadCount);
            
            } catch (error) {
                console.warn('Could not fetch notifications:', error.message);
            }
        };
        
        const updateNotificationUI = (notifications, unreadCount) => {
            const dot = document.getElementById('notification-dot');
            const list = document.getElementById('notification-list');

            if (unreadCount > 0) {
                safeShow(dot);
            } else {
                safeHide(dot);
            }
        
            if (notifications && notifications.length > 0) {
                list.innerHTML = ''; 
                notifications.forEach(noti => {
                    const taskTitle = noti.task ? noti.task.title : '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
                    const taskAction = noti.task ? `onclick="openDetailModal('${noti.task._id}'); closeModal('notificationModal');"` : '';

                    const item = document.createElement('div'); 
                    item.className = `block p-3 border-b hover:bg-gray-50 cursor-pointer ${noti.isRead ? 'bg-white' : 'bg-blue-50'}`;

                    item.innerHTML = `
                        <div ${taskAction}>
                            <p class="text-sm text-gray-800 font-medium">${noti.message}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span class="font-semibold text-amber-600">${taskTitle}</span> ‚Ä¢ ${timeAgo(noti.createdAt)}
                            </p>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<p class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>';
            }
        };

        const markNotificationsAsRead = async () => {
            const token = localStorage.getItem('token');
            const dot = document.getElementById('notification-dot');
            safeHide(dot); 

            try {
                await fetch(`${SERVER_URL}/notifications/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.warn('Could not mark notifications as read:', error.message);
            }
        };
        
        // ------------------------------------------
        // --- (D) DEPOSIT FUNCTIONS ---
        // ------------------------------------------
        // ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html
        async function fetchDeposits() {
            try {
                const token = localStorage.getItem('token');
                const selectedCompanyId = document.getElementById('company-select').value;
            
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Header Title) ---
                // ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥ - ‡∏™‡∏≤‡∏Ç‡∏≤..."
                const titleElem = document.getElementById('deposit-header-title');
                const filterBranchElem = document.getElementById('deposit-filter-branch');
                
                if (titleElem) {
                    if (typeof currentUser !== 'undefined' && currentUser && currentUser.role === 'staff') {
                        // ‡∏Å‡∏£‡∏ì‡∏µ Staff: ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏á Staff ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏™‡∏°‡∏≠
                        const branchName = currentUser.branch || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á/null/undefined ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' ‡πÅ‡∏ó‡∏ô
                        titleElem.textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥ - ‡∏™‡∏≤‡∏Ç‡∏≤ ${branchName}`;
                    } else {
                        // ‡∏Å‡∏£‡∏ì‡∏µ Admin/Manager: ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Dropdown
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Text) ‡∏Ç‡∏≠‡∏á option ‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
                        let branchName = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                        if (filterBranchElem && filterBranchElem.value !== 'all' && filterBranchElem.selectedIndex > -1) {
                            branchName = filterBranchElem.options[filterBranchElem.selectedIndex].text;
                        }
                        titleElem.textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥ - ${branchName}`;
                    }
                }
            
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° URL ‡πÅ‡∏•‡∏∞ Parameter ---
                let url = `${SERVER_URL}/deposits?companyId=${selectedCompanyId}`;
            
                // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Dropdown ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà API
                if (filterBranchElem) {
                    const branchVal = filterBranchElem.value;
                    if (branchVal && branchVal !== 'all') {
                        url += `&branch=${encodeURIComponent(branchVal)}`;
                    }
                }
            
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server ---
                // console.log('Fetching URL:', url); 
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const deposits = await res.json();
            
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
                const tbody = document.getElementById('deposit-table-body');
                tbody.innerHTML = '';
            
                if (deposits.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ</td></tr>`;
                    return;
                }
            
                deposits.forEach(d => {
                    const price = d.price || 0;
                    const deposit = d.depositAmount || 0;
                    const balance = price > 0 ? (price - deposit) : 0;
                
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50 transition-colors cursor-pointer border-b";
                    tr.onclick = () => openDepositModal(d);
                
                    tr.innerHTML = `
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.depositDate)}</td>
                        <td class="font-medium border p-2 text-gray-800">${d.customerName}</td>
                        <td class="text-center border p-2 text-gray-600">${d.phoneNumber}</td>
                        <td class="text-right border p-2 font-bold text-red-600 bg-red-50">${deposit.toLocaleString()}</td>
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.pickupDueDate)}</td>
                
                        <td class="text-center border p-2 text-xs">${d.billNo || '-'}</td>
                        <td class="text-center border p-2 text-xs font-mono text-gray-500">${d.imei || '-'}</td>
                        <td class="text-xs border p-2">${d.product || '-'}</td>
                        <td class="text-right border p-2 bg-red-50 text-xs">${price ? price.toLocaleString() : '-'}</td>
                        <td class="text-right border p-2 font-bold bg-blue-50 text-blue-800">${price ? balance.toLocaleString() : '-'}</td>
                        <td class="text-center border p-2 bg-green-50">
                            ${d.isSuccess ? '<ion-icon name="checkmark-circle" class="text-green-600 text-xl"></ion-icon>' : '<span class="text-gray-300">-</span>'}
                        </td>
                        <td class="text-center border p-2 text-xs text-gray-500">${d.signName || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
            
            } catch (e) {
                console.error("Error fetching deposits:", e);
                // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Error ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                const tbody = document.getElementById('deposit-table-body');
                if(tbody) tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
            }
        }

        function openDepositModal(data = null) {
            openModal('depositModal');
            document.getElementById('deposit-form').reset();
            document.getElementById('dep-id').value = '';

            if (data) {
                document.getElementById('dep-id').value = data._id;
                document.getElementById('dep-date').value = data.depositDate ? data.depositDate.split('T')[0] : '';
                document.getElementById('dep-pickup').value = data.pickupDueDate ? data.pickupDueDate.split('T')[0] : '';
                document.getElementById('dep-name').value = data.customerName;
                document.getElementById('dep-phone').value = data.phoneNumber;
                document.getElementById('dep-amount').value = data.depositAmount;

                document.getElementById('dep-product').value = data.product || '';
                document.getElementById('dep-price').value = data.price || '';
                document.getElementById('dep-bill').value = data.billNo || '';
                document.getElementById('dep-imei').value = data.imei || '';
                document.getElementById('dep-success').checked = data.isSuccess;
            } else {
                document.getElementById('dep-date').value = new Date().toISOString().split('T')[0];
            }
        }

        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const payload = {
                id: document.getElementById('dep-id').value,
                depositDate: document.getElementById('dep-date').value,
                pickupDueDate: document.getElementById('dep-pickup').value,
                customerName: document.getElementById('dep-name').value,
                phoneNumber: document.getElementById('dep-phone').value,
                depositAmount: document.getElementById('dep-amount').value,

                product: document.getElementById('dep-product').value,
                price: document.getElementById('dep-price').value,
                billNo: document.getElementById('dep-bill').value,
                imei: document.getElementById('dep-imei').value,
                isSuccess: document.getElementById('dep-success').checked
            };
        
            try {
                const res = await fetch(`${SERVER_URL}/deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    closeModal('depositModal');
                    fetchDeposits(); 
                } else {
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                }
            } catch (err) { alert('Error: ' + err.message); }
        });

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric', year: '2-digit' });
        }


        // ------------------------------------------
        // --- (E) GENERAL HELPERS & INIT ---
        // ------------------------------------------

        const loadManagersForDropdown = async () => {
            const token = localStorage.getItem('token');
            const select = document.getElementById('user-reportsTo-input');
            select.innerHTML = '<option value="">--- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... ---</option>';
            try {
                const selectedCompanyId = document.getElementById('user-company-input').value; 
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                const users = await response.json();
                select.innerHTML = '<option value="">--- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ---</option>';
                const managers = users.filter(u => u.role === 'manager' || u.role === 'hr' || u.role === 'executive');
                managers.forEach(user => {
                    select.appendChild(new Option(`${user.name} (${getRoleName(user.role)})`, user._id));
                });
            } catch (error) {
                select.innerHTML = `<option value="">--- ${error.message} ---</option>`;
            }
        };

        const openNewUserModal = () => {
            document.getElementById('user-form').reset();
            document.getElementById('user-modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('form-mode').value = 'create';
            document.getElementById('user-id').value = '';
            safeHide(document.getElementById('user-form-error'));
            document.getElementById('user-username-input').disabled = false;
            document.getElementById('user-username-input').required = true;
            document.getElementById('user-password-input').placeholder = "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å";
            document.getElementById('user-password-input').required = true;
            safeShow(document.getElementById('auth-section'));
            
            const currentCompany = document.getElementById('company-select').value; 
            const userCompanySelect = document.getElementById('user-company-input');
            userCompanySelect.value = currentCompany; 
            userCompanySelect.disabled = false; 

            safeHide(document.getElementById('user-reportsTo-input').parentElement);
            
            openModal('userModal');
        };

        const openEditUserModal = async (id) => {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
                const users = await response.json();
                const user = users.find(u => u._id === id);
                
                if (user) {
                    document.getElementById('user-form').reset();
                    document.getElementById('user-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                    document.getElementById('form-mode').value = 'edit';
                    document.getElementById('user-id').value = user._id;
                    safeHide(document.getElementById('user-form-error'));

                    document.getElementById('user-username-input').disabled = true;
                    document.getElementById('user-username-input').required = false;
                    document.getElementById('user-password-input').placeholder = "‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô";
                    document.getElementById('user-password-input').required = false;
                    safeShow(document.getElementById('auth-section')); 
                    
                    document.getElementById('user-name-input').value = user.name;
                    document.getElementById('user-role-input').value = user.role;
                    document.getElementById('user-username-input').value = user.username;
                    document.getElementById('user-department-input').value = user.department;
                    document.getElementById('user-branch-input').value = user.branch || '';

                    const userCompanySelect = document.getElementById('user-company-input');
                    userCompanySelect.value = user.companyId; 
                    userCompanySelect.disabled = true; 
                    
                    const reportsToDiv = document.getElementById('user-reportsTo-input').parentElement;
                    safeShow(reportsToDiv);
                    
                    await loadManagersForDropdown(); 

                    document.getElementById('user-reportsTo-input').value = user.reportsTo ? user.reportsTo._id : '';
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                }
                openModal('userModal');
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            }
        };

        const handleUserFormSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries()); 
            const mode = data.mode;
            const userId = data.userId;
            const submitButton = document.getElementById('submit-user-btn');
            const errorBox = document.getElementById('user-form-error');
            submitButton.disabled = true;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            safeHide(errorBox);
            let url = '';
            let method = '';
            let body = {};

            if (mode === 'create') {
                url = `${SERVER_URL}/auth/register`;
                method = 'POST';
                body = {
                    name: data.name,
                    username: data.username,
                    password: data.password,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                    companyId: data.companyId 
                };
            } else { 
                url = `${SERVER_URL}/users/admin/${userId}`;
                method = 'PUT';
                body = {
                    name: data.name,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                };
                if (data.password && data.password.trim() !== '') {
                    body.password = data.password;
                }
            }
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                closeModal('userModal');
                fetchAllUsersForTable();
                fetchAllUsers(); 
            } catch (error) {
                errorBox.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`;
                safeShow(errorBox);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            }
        };

        const executeDeleteUser = async (id, name) => {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "${name}"?`)) {
                return;
            }
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                fetchAllUsersForTable();
                fetchAllUsers(); 
            } catch (error) {
                alert(`‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
            }
        };

        // --- NAVIGATION LOGIC (‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß) ---
        const updateNavActiveState = (activeView) => {
            const statsCards = document.getElementById('stats-cards');
            const myTasksFilters = document.getElementById('mytasks-filters');
            const taskView = document.getElementById('task-view-content');
            const adminView = document.getElementById('admin-view-content');
            const depositView = document.getElementById('deposit-view'); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Deposit View
            
            const mainHeader = document.getElementById('main-header');
            const newTaskBtn = document.getElementById('newTaskButton');
            const newUserBtn = document.getElementById('newUserButton');
            
            const navDashboard = document.getElementById('nav-dashboard');
            const navMyTasks = document.getElementById('nav-mytasks');
            const navAdmin = document.getElementById('nav-admin');
            const navDeposit = document.getElementById('nav-Storefront_deposit'); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Deposit Nav
            
            const companySelectDiv = document.getElementById('company-select').parentElement;
            
            // Reset Nav Styles
            [navDashboard, navMyTasks, navAdmin, navDeposit].forEach(el => {
                el.classList.remove('bg-amber-500', 'text-white');
                el.classList.add('text-gray-600', 'hover:bg-gray-100');
            });
            
            // Hide All Views
            safeHide(statsCards); 
            safeHide(taskView); 
            safeHide(adminView);
            safeHide(depositView); // Hide Deposit View
            
            // Hide Buttons & Filters
            safeHide(newTaskBtn); safeHide(newUserBtn);
            safeHide(myTasksFilters);
            
            currentView = activeView;

            if (activeView === 'dashboard') {
                safeShow(statsCards); safeShow(taskView);
                if (currentUser.role !== 'staff') safeShow(newTaskBtn);
                mainHeader.textContent = "‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î";
                navDashboard.classList.add('bg-amber-500', 'text-white');
                navDashboard.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'block';
            } 
            else if (activeView === 'mytasks') {
                safeShow(taskView);
                safeShow(myTasksFilters); 
                mainHeader.textContent = "‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô";
                navMyTasks.classList.add('bg-amber-500', 'text-white');
                navMyTasks.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            } 
            else if (activeView === 'admin') {
                safeShow(adminView); safeShow(newUserBtn);
                mainHeader.textContent = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
                navAdmin.classList.add('bg-amber-500', 'text-white');
                navAdmin.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'block';
            }
            else if (activeView === 'deposit') { // (*** ‡πÉ‡∏´‡∏°‡πà ***)
                safeShow(depositView);
                mainHeader.textContent = "‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô";
                navDeposit.classList.add('bg-amber-500', 'text-white');
                navDeposit.classList.remove('text-gray-600', 'hover:bg-gray-100');
                // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πá‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏î‡πâ
                if (companySelectDiv) companySelectDiv.style.display = 'block';
            }

            if (currentUser && currentUser.role === 'staff') {
                 if(document.getElementById('company-select')) document.getElementById('company-select').disabled = true;
            }
        };

        const updateMyTaskCounts = () => {
            if (!allMyTasks) return;
            document.getElementById('mytask-count-todo').textContent = allMyTasks.filter(t => t.status === 'todo').length;
            document.getElementById('mytask-count-inprogress').textContent = allMyTasks.filter(t => t.status === 'in-progress').length;
            document.getElementById('mytask-count-review').textContent = allMyTasks.filter(t => t.status === 'for-review').length;
            document.getElementById('mytask-count-completed').textContent = allMyTasks.filter(t => t.status === 'completed').length;
        };

        const filterMyTasks = (status) => {
            ['todo', 'inprogress', 'review', 'completed'].forEach(id => {
                document.getElementById(`btn-filter-${id}`).classList.remove('ring-2', 'ring-offset-1', 'ring-gray-400');
            });

            let filtered = [];
            if (status === 'all') {
                filtered = allMyTasks;
            } else {
                filtered = allMyTasks.filter(t => t.status === status);
                let btnId = '';
                if (status === 'todo') btnId = 'todo';
                else if (status === 'in-progress') btnId = 'inprogress';
                else if (status === 'for-review') btnId = 'review';
                else if (status === 'completed') btnId = 'completed';
                
                if (btnId) {
                    document.getElementById(`btn-filter-${btnId}`).classList.add('ring-2', 'ring-offset-1', 'ring-gray-400');
                }
            }
            renderTaskTable(filtered);
        };

        // --- INIT & LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth();
            
            // Forms
            document.getElementById('new-task-form').addEventListener('submit', handleNewTaskSubmit);
            document.getElementById('update-task-form').addEventListener('submit', handleUpdateTaskSubmit);
            document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);
            
            // Buttons
            document.getElementById('confirm-delete-button').addEventListener('click', executeDelete); 
            document.getElementById('newTaskButton').addEventListener('click', () => {
                fetchAllUsers(); 
                openModal('newTaskModal');
            });
            document.getElementById('newUserButton').addEventListener('click', openNewUserModal);
            document.getElementById('notification-bell').addEventListener('click', () => {
                openModal('notificationModal');
                markNotificationsAsRead();
            });

            // Navigation Listeners (‡πÉ‡∏ä‡πâ updateNavActiveState ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
            document.getElementById('nav-dashboard').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if(header) header.textContent = '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö';
                e.preventDefault(); updateNavActiveState('dashboard');
                fetchDashboardTasks(); fetchTaskStats(); 
            });
            document.getElementById('nav-mytasks').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if(header) header.textContent = '‡∏ú‡∏π‡πâ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
                e.preventDefault(); updateNavActiveState('mytasks');
                fetchMyTasks();
            });
            document.getElementById('nav-admin').addEventListener('click', (e) => {
                e.preventDefault(); updateNavActiveState('admin');
                fetchAllUsersForTable(); 
            });
            
            // (*** ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π Deposit ***)
            document.getElementById('nav-Storefront_deposit').addEventListener('click', (e) => {
                e.preventDefault(); 
                updateNavActiveState('deposit'); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á
                fetchDeposits(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            });

            // Company Change Listener
            document.getElementById('company-select').addEventListener('change', () => {
                if (currentView === 'dashboard') {
                    fetchNotifications(); fetchDashboardTasks(); fetchTaskStats(); fetchAllUsers();      
                } else if (currentView === 'admin') {
                    fetchAllUsersForTable();
                } else if (currentView === 'deposit') { // (*** ‡πÄ‡∏û‡∏¥‡πà‡∏° ***)
                    fetchDeposits(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                }
            });
            
            document.getElementById('user-company-input').addEventListener('change', () => {
                loadManagersForDropdown();
            });

            const branchFilterSelect = document.getElementById('deposit-filter-branch');
            if (branchFilterSelect) {
                branchFilterSelect.addEventListener('change', () => {
                    fetchDeposits(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                });

                // (‡πÄ‡∏™‡∏£‡∏¥‡∏°) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Staff ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                if (currentUser && currentUser.role === 'staff') {
                    const container = document.getElementById('filter-branch-container');
                    if(container) container.style.display = 'none';
                }
            }
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');

            if (menuToggle && sidebar && overlay) {
                const toggleMenu = () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('hidden');
                };
                menuToggle.addEventListener('click', toggleMenu);
                overlay.addEventListener('click', toggleMenu);
            
                // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå
                document.querySelectorAll('#nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 768px)
                        if (window.innerWidth < 768) { 
                            toggleMenu(); 
                        }
                    });
                });
            }
        });

        // Modal Control
        function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function closeModal(modalId) { 
            document.getElementById(modalId).classList.remove('active');
        } 

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>