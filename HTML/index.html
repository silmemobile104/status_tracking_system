<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SILMIN MOBILE</title>
    <link rel="icon" type="image/png" href="/image/icon_silme.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Tom Select -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.default.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans Thai"', 'sans-serif'],
                        display: ['"Outfit"', '"Noto Sans Thai"', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b', // Amber-500
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        body { 
            font-family: 'Inter', 'Noto Sans Thai', sans-serif; 
            background-color: #F8FAFC; /* Slate-50 */
            color: #1E293B; /* Slate-800 */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #fbbf24; }

        /* Modal Transitions */
        .modal { 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.2s ease-out;
            backdrop-filter: blur(4px);
            background-color: rgba(15, 23, 42, 0.4); /* Slate-900/40 */
            display: flex; /* Always flex but hidden by opacity/visibility */
        }
        .modal.active { 
            opacity: 1; 
            visibility: visible; 
        }
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Form Theme */
        .form-input-theme {
            @apply w-full bg-white border border-slate-200 text-slate-800 text-sm rounded-xl block p-3 transition-all duration-200;
            @apply focus:ring-2 focus:ring-yellow-400/50 focus:border-yellow-400 focus:outline-none placeholder-slate-400;
        }
        .form-select-theme {
            @apply w-full bg-white border border-slate-200 text-slate-800 text-sm rounded-xl block p-3 transition-all duration-200;
            @apply focus:ring-2 focus:ring-yellow-400/50 focus:border-yellow-400 focus:outline-none;
        }

        /* Deposit Table */
        .deposit-table th {
            @apply bg-slate-50 text-slate-500 font-semibold text-xs uppercase tracking-wider py-3 px-4 border-b border-slate-200 text-center;
        }
        .deposit-table td {
            @apply py-3 px-4 border-b border-slate-100 text-sm text-slate-600 align-middle;
        }
        .header-received {
            @apply bg-yellow-50 text-yellow-700 !important;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Sidebar & Layout */
        #sidebar {
            position: fixed;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100vh;
            padding-top: 4.5rem;
            z-index: 50; 
        }
        #sidebar.active { transform: translateX(0); }
        
        @media (min-width: 768px) {
            #sidebar {
                position: sticky;
                top: 0;
                transform: translateX(0);
                padding-top: 0;
                height: 100vh;
            }
        }

        #main-content {
            padding-top: 5rem;
            transition: all 0.3s ease-in-out; 
        }
        @media (min-width: 768px) {
            #main-content { padding-top: 0; }
        }
        /* Tom Select Customization */
        .ts-control {
            border-radius: 0.75rem !important; /* rounded-xl */
            border-color: #e2e8f0 !important; /* slate-200 */
            padding: 0.75rem !important; /* p-3 */
            box-shadow: none !important;
            min-height: 46px; /* Match standard input height */
        }
        .ts-control.focus {
            border-color: #facc15 !important; /* yellow-400 */
            box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.5) !important; /* ring-yellow-400/50 */
        }
        .ts-dropdown {
            border-radius: 0.75rem !important;
            border-color: #e2e8f0 !important;
            margin-top: 4px !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }
        .ts-dropdown .option {
            padding: 0.5rem 1rem !important;
        }
        .ts-dropdown .active {
            background-color: #fef9c3 !important; /* yellow-100 */
            color: #854d0e !important; /* yellow-800 */
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Toast Notifications */
        @keyframes toast-in {
            from { transform: translateX(100%) scale(0.9); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        @keyframes toast-out {
            from { transform: translateX(0) scale(1); opacity: 1; }
            to { transform: translateX(100%) scale(0.9); opacity: 0; }
        }
        .toast-animate-in { animation: toast-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .toast-animate-out { animation: toast-out 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .glass-toast {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans antialiased selection:bg-yellow-200 selection:text-yellow-900">

    <!-- Mobile Header -->
    <div id="mobile-header"
        class="md:hidden bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 flex justify-between items-center fixed top-0 left-0 w-full z-40">
        <button id="menu-toggle"
            class="text-slate-600 hover:text-slate-900 p-1 rounded-lg hover:bg-slate-100 transition-colors">
            <ion-icon name="menu-outline" class="text-2xl"></ion-icon>
        </button>
        <span class="text-lg font-bold text-slate-800 tracking-tight flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
            SILMIN MOBILE
        </span>
        <div id="notification-bell-mobile" class="relative">
            <button id="notification-bell-btn-mobile"
                class="relative p-2 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors">
                <ion-icon name="notifications-outline" class="text-2xl"></ion-icon>
                <span id="notification-dot-mobile"
                    class="hidden absolute top-2 right-2 block h-2 w-2 rounded-full ring-2 ring-white bg-red-500"></span>
            </button>
        </div>
    </div>

    <div id="sidebar-overlay"
        class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <div id="app-wrapper" class="flex min-h-screen">

        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-72 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col shadow-xl md:shadow-none">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="h-20 flex items-center px-8 border-b border-slate-100 hidden md:flex">
                    <img src="/image/icon_silme.png" alt="SILME Icon" class="w-8 h-8 mr-3 rounded-lg shadow-lg" />
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight font-display">SILMIN MOBILE</h1>
                </div>

                <!-- Company Select -->
                <div class="p-6 pb-2">
                    <label for="company-select"
                        class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Workspace</label>
                    <select id="company-select" class="form-select-theme shadow-sm">
                        <option selected value="company_1_id">ซิลมีน โมบาย จำกัด</option>
                        <option value="company_2_id">เอสจี พลัส 2023 จำกัด</option>
                    </select>
                </div>

                <!-- Navigation -->
                <nav id="nav-menu" class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
                    <a href="#" onclick="updateNavActiveState('dashboard')" id="nav-dashboard"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="grid-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">แดชบอร์ด</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('mytasks')" id="nav-mytasks"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="document-text-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">งานของฉัน</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('deposit')" id="nav-Storefront_deposit"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="wallet-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">เงินค่ามัดจำหน้าร้าน</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('purchasing')" id="nav-purchasing"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="cart-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">รายการจองเครื่อง</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('import')" id="nav-import"
                        class="hidden flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="cloud-upload-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">แจ้งนำเข้า</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('stock-import')" id="nav-stock-import"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="cube-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">จัดการรายการนำเข้า</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('stock-request')" id="nav-stock-request"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="clipboard-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">แจ้งเบิกสินค้า</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('stock-request-manage')" id="nav-stock-request-manage"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="settings-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">จัดการคำขอเบิก</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('branch-order')" id="nav-branch-order"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="basket-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">สั่งของลงสาขา</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('branch-order-inventory')" id="nav-branch-order-inventory"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="basket-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">รายการของลงสาขา</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('claim')" id="nav-claim"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="hammer-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-orange-500 transition-colors"></ion-icon>
                        <span class="font-medium">แจ้งเคลมอุปกรณ์เสริม</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('stock-claim')" id="nav-stock-claim"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="hammer-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-purple-500 transition-colors"></ion-icon>
                        <span class="font-medium">รายการแจ้งเคลมอุปกรณ์เสริม</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('admin')" id="nav-admin"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="people-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">จัดการผู้ใช้</span>
                    </a>
                </nav>

                <!-- User Profile -->
                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <div id="user-profile-widget" class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm">
                                <ion-icon name="person" class="text-xl"></ion-icon>
                            </div>
                            <div class="ml-3">
                                <p id="user-name" class="text-sm font-semibold text-slate-800">กำลังโหลด...</p>
                                <p id="user-role" class="text-xs text-slate-500 font-medium">...</p>
                            </div>
                        </div>
                        <div class="relative hidden md:block">
                            <button id="notification-bell"
                                class="relative p-2 text-slate-400 hover:text-yellow-600 hover:bg-yellow-50 rounded-full transition-all">
                                <ion-icon name="notifications-outline" class="w-5 h-5"></ion-icon>
                                <span id="notification-dot"
                                    class="hidden absolute top-2 right-2 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                            </button>
                        </div>
                    </div>
                    <button id="logout-button"
                        class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-xl transition-colors">
                        <ion-icon name="log-out-outline" class="w-5 h-5 mr-2"></ion-icon> ออกจากระบบ
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto h-screen">
            <div class="max-w-7xl mx-auto">

                <!-- Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div>
                        <h2 id="main-header" class="text-3xl font-bold text-slate-800 font-display">แดชบอร์ด</h2>
                        <p class="text-slate-500 mt-1">Silmin Mobile</p>
                    </div>
                    <div id="main-header-buttons" class="flex gap-3">
                        <button id="showAllTasksBtn"
                            class="bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 font-semibold py-2.5 px-5 rounded-xl shadow-sm flex items-center transition-all transform hover:-translate-y-0.5">
                            <ion-icon name="list-outline" class="w-5 h-5 mr-2"></ion-icon> แสดงงานทั้งหมด
                        </button>
                        <button id="newTaskButton"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-yellow-500/30 flex items-center transition-all transform hover:-translate-y-0.5">
                            <ion-icon name="add-circle-outline" class="w-5 h-5 mr-2"></ion-icon> สั่งงานใหม่
                        </button>
                        <button id="newUserButton"
                            class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-slate-800/30 flex items-center transition-all transform hover:-translate-y-0.5 hidden">
                            <ion-icon name="person-add-outline" class="w-5 h-5 mr-2"></ion-icon> เพิ่มผู้ใช้ใหม่
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Content injected by JS -->
                </div>

                <!-- My Tasks Filters -->
                <div id="mytasks-filters" class="hidden mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-700">สถานะงาน</h3>
                        <button onclick="filterMyTasks('all')"
                            class="text-sm text-slate-500 hover:text-yellow-600 font-medium flex items-center transition-colors">
                            <ion-icon name="refresh-outline" class="mr-1"></ion-icon> แสดงทั้งหมด
                        </button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="filterMyTasks('todo')" id="btn-filter-todo"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-slate-100 rounded-lg text-slate-600 group-hover:bg-slate-200 transition-colors">
                                    <ion-icon name="clipboard-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-todo"
                                    class="bg-slate-100 text-slate-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">รอทำ</span>
                        </button>

                        <button onclick="filterMyTasks('in-progress')" id="btn-filter-inprogress"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-yellow-100 rounded-lg text-yellow-600 group-hover:bg-yellow-200 transition-colors">
                                    <ion-icon name="construct-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-inprogress"
                                    class="bg-yellow-100 text-yellow-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">กำลังทำ</span>
                        </button>

                        <button onclick="filterMyTasks('for-review')" id="btn-filter-review"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-orange-100 rounded-lg text-orange-600 group-hover:bg-orange-200 transition-colors">
                                    <ion-icon name="search-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-review"
                                    class="bg-orange-100 text-orange-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">รอตรวจสอบ</span>
                        </button>

                        <button onclick="filterMyTasks('completed')" id="btn-filter-completed"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-green-100 rounded-lg text-green-600 group-hover:bg-green-200 transition-colors">
                                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-completed"
                                    class="bg-green-100 text-green-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">เสร็จสิ้น</span>
                        </button>
                    </div>
                </div>

                <!-- Task View -->
                <div id="task-view-content"
                    class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div id="loading-tasks" class="text-center p-12 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-4">
                        </div>
                        <p class="text-slate-500 font-medium">กำลังดึงข้อมูลงาน...</p>
                    </div>
                    <div id="task-error-message"
                        class="hidden p-4 m-6 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100 flex items-center"
                        role="alert">
                        <ion-icon name="alert-circle" class="text-xl mr-2"></ion-icon>
                        <div><span class="font-bold">เกิดข้อผิดพลาด:</span> <span id="task-error-text"></span></div>
                    </div>

                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="text-lg font-bold text-slate-800">รายการงาน</h3>
                        <span id="task-count"
                            class="text-xs font-semibold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">0
                            งาน</span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ชื่องาน</th>
                                    <th id="header-assignee"
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ผู้รับผิดชอบ</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        สถานะ</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        วันครบกำหนด</th>
                                    <th
                                        class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body" class="divide-y divide-slate-100">
                                <tr id="no-task-row" class="text-center">
                                    <td colspan="5"
                                        class="px-6 py-12 text-slate-400 flex flex-col items-center justify-center">
                                        <ion-icon name="folder-open-outline"
                                            class="text-4xl mb-2 text-slate-300"></ion-icon>
                                        ไม่มีงานที่ต้องแสดงในขณะนี้
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Deposit View -->
                <div id="deposit-view"
                    class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mt-6 p-6">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h3 class="text-xl font-bold text-slate-800 flex items-center">
                            <div class="p-2 bg-yellow-100 text-yellow-600 rounded-lg mr-3"><ion-icon
                                    name="wallet"></ion-icon></div>
                            <span id="deposit-header-title">เงินค่ามัดจำหน้าร้าน</span>
                        </h3>

                        <div class="flex items-center gap-3">
                            <div id="filter-branch-container">
                                <select id="deposit-filter-branch" class="form-select-theme py-2 pl-3 pr-8 text-sm">
                                    <option value="all" selected>ดูทุกสาขา</option>
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="หาดใหญ่">หาดใหญ่</option>
                                    <option value="บิ๊กซี">บิ๊กซี</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                    <option value="โคลีเซียม">โคลีเซียม</option>
                                    <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                    <option value="ปากแมว">ปากแมว</option>
                                    <option value="ภูเก็ต">ภูเก็ต</option>
                                    <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                    <option value="กระบี่">กระบี่</option>
                                    <option value="กะทู้">กะทู้</option>
                                    <option value="ตรัง">ตรัง</option>
                                    <option value="คุรุ">คุรุ</option>
                                    <option value="ชุมพร">ชุมพร</option>
                                    <option value="สตูล">สตูล</option>
                                    <option value="พัทลุง">พัทลุง</option>
                                    <option value="สงขลา">สงขลา</option>
                                </select>
                            </div>
                            <div id="filter-status-container">
                                <select id="deposit-filter-status" class="form-select-theme py-2 pl-3 pr-8 text-sm">
                                    <option value="all-status">สถานะทั้งหมด</option>
                                    <option value="รอดำเนินการ" selected>รอดำเนินการ</option>
                                    <option value="สำเร็จ">สำเร็จ</option>
                                </select>
                            </div>
                            <div id="filter-date-container">
                                <input type="date" id="deposit-filter-date" class="form-input-theme py-2 text-sm">
                            </div>
                            <div id="search-container">
                                <input type="text" id="deposit-search-input" placeholder="ค้นหาลูกค้า/เบอร์โทร..."
                                    class="form-input-theme py-2 pl-3 text-sm w-48">
                            </div>
                            <button id="btn-filter-due-today"
                                class="relative bg-white hover:bg-red-50 text-slate-400 hover:text-red-500 p-2 rounded-xl transition-all border border-slate-200 hover:border-red-200 group"
                                title="สินค้าที่ต้องรับวันนี้ หรือ เกินกำหนด">
                                <ion-icon name="notifications-outline" class="text-xl"></ion-icon>
                                <!-- Badge -->
                                <span id="deposit-due-badge"
                                    class="hidden absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white shadow-sm animate-pulse">
                                    0
                                </span>
                            </button>
                            <button onclick="openDepositModal()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl shadow-lg shadow-green-600/20 flex items-center font-medium transition-all">
                                <ion-icon name="add-circle" class="mr-2"></ion-icon> เพิ่มรายการ
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-xl border border-slate-200">
                        <table class="w-full deposit-table border-collapse text-sm">
                            <thead>
                                <tr>
                                    <th rowspan="2">วันที่มัดจำ</th>
                                    <th rowspan="2">ลูกค้า</th>
                                    <th rowspan="2">เบอร์โทร</th>
                                    <th rowspan="2" class="bg-red-50 text-red-700 border-red-100">ยอดมัดจำ</th>
                                    <th rowspan="2">นัดรับ</th>
                                    <th colspan="8" class="bg-slate-100 text-slate-600 border-b border-slate-200">
                                        ข้อมูลรับเครื่อง</th>
                                </tr>
                                <tr>
                                    <th>เลขที่บิล</th>
                                    <th>IMEI</th>
                                    <th>สินค้า</th>
                                    <th>ราคาเต็ม</th>
                                    <th class="bg-blue-50 text-blue-700">ค้างชำระ</th>
                                    <th>สถานะ</th>
                                    <th>ผู้ทำรายการ</th>
                                    <th>เพิ่มเติม</th>
                                </tr>
                            </thead>
                            <tbody id="deposit-table-body" class="text-slate-600 bg-white">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="purchasing-view" class="hidden space-y-6 mt-6">
                    <!-- Header Section -->
                    <div
                        class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div
                                class="p-3 bg-gradient-to-br from-yellow-400 to-orange-600 text-white rounded-xl shadow-lg shadow-blue-500/30">
                                <ion-icon name="cart" class="text-2xl"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">รายการจองเครื่อง</h3>
                                <p class="text-sm text-slate-500">จัดการและติดตามสถานะสินค้าสำหรับหน้าร้าน</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 w-full md:w-auto">
                            <!-- Search Input (New) -->
                            <div class="relative w-full md:w-64">
                                <input type="text" id="purchasing-search-input" onkeyup="handlePurchasingSearch()"
                                    class="form-input-theme pl-10 text-sm shadow-sm border-slate-200 focus:border-blue-400 focus:ring-blue-400/50 placeholder-slate-400"
                                    placeholder="ค้นหาลูกค้า, เบอร์โทร, สินค้า...">
                            </div>

                            <!-- (*** เพิ่ม) Bell Notification Button *** -->
                            <button id="btn-purchasing-overdue" onclick="filterPurchasingByStatus('overdue')"
                                class="relative p-2.5 bg-white border border-slate-200 rounded-xl text-slate-400 hover:text-red-500 hover:border-red-300 hover:bg-red-50 transition-all shadow-sm active:scale-95 group">
                                <ion-icon name="notifications-outline" class="text-xl"></ion-icon>
                                <!-- Badge (Hidden by default) -->
                                <span id="purchasing-overdue-badge"
                                    class="hidden absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white shadow-sm animate-pulse">
                                    0
                                </span>
                            </button>

                            <div class="relative group w-full md:w-48">
                                <select id="purchasing-filter-branch" onchange="fetchPurchasingOrders()"
                                    class="form-select-theme pl-10 text-sm shadow-sm border-slate-200 hover:border-blue-400 transition-colors cursor-pointer appearance-none">
                                    <option value="all" selected>ทุกสาขา</option>
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="หาดใหญ่">หาดใหญ่</option>
                                    <option value="บิ๊กซี">บิ๊กซี</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                    <option value="โคลีเซียม">โคลีเซียม</option>
                                    <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                    <option value="ปากแมว">ปากแมว</option>
                                    <option value="ภูเก็ต">ภูเก็ต</option>
                                    <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                    <option value="กระบี่">กระบี่</option>
                                    <option value="กะทู้">กะทู้</option>
                                    <option value="ตรัง">ตรัง</option>
                                    <option value="คุรุ">คุรุ</option>
                                    <option value="ชุมพร">ชุมพร</option>
                                    <option value="สตูล">สตูล</option>
                                    <option value="พัทลุง">พัทลุง</option>
                                    <option value="สงขลา">สงขลา</option>
                                </select>
                            </div>
                            <button onclick="fetchPurchasingOrders()"
                                class="p-2.5 bg-white border border-slate-200 rounded-xl text-slate-500 hover:text-blue-600 hover:border-blue-300 hover:bg-blue-50 transition-all shadow-sm active:scale-95">
                                <ion-icon name="refresh" class="text-xl"></ion-icon>
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Summary (Optional Enhancement) -->
                    <!-- Statistics Summary (Clickable Filters) -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div onclick="filterPurchasingByStatus('pending')" id="card-filter-pending"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-yellow-600 transition-colors">
                                    รอดำเนินการ</p>
                                <p id="count-pending" class="text-xl font-bold text-yellow-600">0</p>
                            </div>
                            <div
                                class="p-2 bg-yellow-50 text-yellow-600 rounded-lg group-hover:bg-yellow-100 transition-colors">
                                <ion-icon name="time"></ion-icon>
                            </div>
                        </div>
                        <div onclick="filterPurchasingByStatus('ordered')" id="card-filter-ordered"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-blue-600 transition-colors">
                                    สั่งของแล้ว</p>
                                <p id="count-ordered" class="text-xl font-bold text-blue-600">0</p>
                            </div>
                            <div
                                class="p-2 bg-blue-50 text-blue-600 rounded-lg group-hover:bg-blue-100 transition-colors">
                                <ion-icon name="cart"></ion-icon>
                            </div>
                        </div>
                        <div onclick="filterPurchasingByStatus('arrived')" id="card-filter-arrived"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-green-600 transition-colors">
                                    ของถึงปลายทางแล้ว</p>
                                <p id="count-arrived" class="text-xl font-bold text-green-600">0</p>
                            </div>
                            <div
                                class="p-2 bg-green-50 text-green-600 rounded-lg group-hover:bg-green-100 transition-colors">
                                <ion-icon name="cube"></ion-icon>
                            </div>
                        </div>
                        <div onclick="filterPurchasingByStatus('canceled')" id="card-filter-canceled"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-red-600 transition-colors">
                                    ยกเลิก/คืนเงิน</p>
                                <p id="count-canceled" class="text-xl font-bold text-red-600">0</p>
                            </div>
                            <div class="p-2 bg-red-50 text-red-600 rounded-lg group-hover:bg-red-100 transition-colors">
                                <ion-icon name="alert-circle"></ion-icon>
                            </div>
                        </div>
                    </div>

                    <!-- Clear Filter Button (Hidden by default) -->
                    <div id="active-filter-indicator"
                        class="hidden flex items-center justify-between bg-blue-50 text-blue-700 px-4 py-2 rounded-xl border border-blue-100">
                        <span class="text-sm font-semibold flex items-center"><ion-icon name="funnel"
                                class="mr-2"></ion-icon> กำลังแสดง: <span id="filter-name-display"
                                class="ml-1">...</span></span>
                        <button onclick="clearPurchasingFilter()"
                            class="text-xs bg-white border border-blue-200 px-2 py-1 rounded-lg hover:bg-blue-100 transition-colors">ล้างตัวกรอง</button>
                    </div>

                    <!-- Cards Container -->
                    <div id="purchasing-list-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Cards will be injected here via JS -->
                    </div>

                    <!-- Empty State (Hidden by default) -->
                    <div id="purchasing-empty-state"
                        class="hidden flex-col items-center justify-center py-16 bg-white rounded-3xl border-2 border-dashed border-slate-200">
                        <div class="p-4 bg-slate-50 rounded-full mb-4">
                            <ion-icon name="basket-outline" class="text-4xl text-slate-300"></ion-icon>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-600">ไม่มีรายการสั่งซื้อ</h4>
                        <p class="text-slate-400 text-sm mt-1">รายการมัดจำจากหน้าร้านจะปรากฏที่นี่</p>
                    </div>
                </div>

                <!-- Stock Request View (For Sales) -->
                <div id="stock-request-view" class="hidden space-y-6 mt-6">
                    <div
                        class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-indigo-600 text-white rounded-xl shadow-lg">
                                <ion-icon name="cart-outline" class="text-2xl"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">แจ้งเบิกสินค้า</h3>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                            <div class="relative group hidden md:block">
                                <input type="date" id="stock-request-date-filter" onchange="fetchStockRequests()"
                                    class="pl-4 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all shadow-sm">
                            </div>
                            <div class="relative group flex-1 md:flex-none">
                                <ion-icon name="search-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                                <input type="text" id="stock-request-search" onkeyup="fetchStockRequests()"
                                    placeholder="ค้นหาชื่อรายการ, สินค้า..."
                                    class="pl-11 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all shadow-sm w-full md:w-64">
                            </div>
                            <!-- Status Filter -->
                            <div class="relative group flex-1 md:flex-none min-w-[160px]">
                                <ion-icon name="funnel-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                                <select id="stock-request-status-filter" onchange="fetchStockRequests()"
                                    class="pl-11 pr-10 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-all shadow-sm appearance-none w-full">
                                    <option value="">ทุกสถานะ</option>
                                    <option value="pending" selected>⏳ รอสั่ง</option>
                                    <option value="processing">📦 กำลังสั่ง</option>
                                    <option value="received">✅ ได้รับแล้ว</option>
                                    <option value="canceled">❌ ยกเลิก</option>
                                </select>
                                <ion-icon name="chevron-down-outline"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>

                            <button onclick="openStockRequestModal()"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg transition-all flex items-center shrink-0">
                                <ion-icon name="add-circle" class="mr-2 text-xl"></ion-icon> แจ้งเบิกสินค้าใหม่
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">
                                            วันที่สั่ง</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">
                                            รายการ</th>
                                        <th
                                            class="px-6 py-4 text-center text-xs font-semibold text-slate-500 uppercase">
                                            สถานะ</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">
                                            วันคาดการถึง</th>
                                        <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase">
                                            จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-request-table-body" class="divide-y divide-slate-100 text-sm">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- Branch Order View -->
                <div id="branch-order-view" class="hidden space-y-6 mt-6">
                    <!-- Modern Header & Filters -->
                    <div
                        class="bg-white/70 backdrop-blur-md rounded-3xl p-6 shadow-xl shadow-slate-200/50 border border-white flex flex-col lg:flex-row justify-between items-center gap-6">
                        <div class="flex items-center gap-5">
                            <div
                                class="w-14 h-14 bg-gradient-to-br from-yellow-400 to-amber-600 text-white rounded-2xl shadow-lg shadow-yellow-500/30 flex items-center justify-center transform transition-transform hover:scale-110 active:scale-95">
                                <ion-icon name="basket" class="text-3xl"></ion-icon>
                            </div>
                            <div>
                                <h3 id="branch-order-title" class="text-2xl font-black text-slate-800 tracking-tight">
                                    สั่งของลงสาขา</h3>
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-4 w-full lg:w-auto">


                            <!-- Modern Branch Filter -->
                            <div id="branch-order-filter-branch-container" class="min-w-[180px]">
                                <div class="relative group">
                                    <div
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-yellow-500 transition-colors">
                                        <ion-icon name="business-outline" class="text-lg"></ion-icon>
                                    </div>
                                    <select id="branch-order-filter-branch" onchange="fetchBranchOrders()"
                                        class="w-full bg-slate-100/80 border border-slate-200/60 text-slate-700 text-sm font-bold rounded-2xl pl-10 pr-4 py-3.5 outline-none focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all appearance-none cursor-pointer">
                                        <option value="all" selected>ทุกสาขา (All Branches)</option>
                                        <option value="ยะลา">ยะลา</option>
                                        <option value="นราธิวาส">นราธิวาส</option>
                                        <option value="หาดใหญ่">หาดใหญ่</option>
                                        <option value="บิ๊กซี">บิ๊กซี</option>
                                        <option value="ปัตตานี">ปัตตานี</option>
                                        <option value="โคลีเซียม">โคลีเซียม</option>
                                        <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                        <option value="ปากแมว">ปากแมว</option>
                                        <option value="ภูเก็ต">ภูเก็ต</option>
                                        <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                        <option value="กระบี่">กระบี่</option>
                                        <option value="กะทู้">กะทู้</option>
                                        <option value="ตรัง">ตรัง</option>
                                        <option value="คุรุ">คุรุ</option>
                                        <option value="ชุมพร">ชุมพร</option>
                                        <option value="สตูล">สตูล</option>
                                        <option value="พัทลุง">พัทลุง</option>
                                        <option value="สงขลา">สงขลา</option>
                                    </select>
                                    <div
                                        class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                        <ion-icon name="chevron-down-outline"></ion-icon>
                                    </div>
                                </div>
                            </div>

                            <!-- Status Filter (Icons) -->
                            <div class="bg-slate-100 p-1.5 rounded-2xl flex flex-wrap items-center gap-1">
                                <input type="hidden" id="branch-order-status-filter" value="">

                                <button onclick="setBranchOrderStatusFilter('')" id="btn-bo-all"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-indigo-600 hover:shadow-sm transition-all bg-white shadow-sm ring-1 ring-black/5"
                                    title="ทุกสถานะ">
                                    <ion-icon name="grid-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">ทั้งหมด</span>
                                    <span id="count-bo-all"
                                        class="absolute -top-1 -right-1 bg-indigo-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="setBranchOrderStatusFilter('pending')" id="btn-bo-pending"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-amber-600 hover:shadow-sm transition-all"
                                    title="รอดำเนินการ">
                                    <ion-icon name="time-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">รออนุมัติ</span>
                                    <span id="count-bo-pending"
                                        class="absolute -top-1 -right-1 bg-amber-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="setBranchOrderStatusFilter('shipped')" id="btn-bo-shipped"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-blue-600 hover:shadow-sm transition-all"
                                    title="รอของ">
                                    <ion-icon name="bus-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">รอของ</span>
                                    <span id="count-bo-shipped"
                                        class="absolute -top-1 -right-1 bg-blue-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="setBranchOrderStatusFilter('arrived')" id="btn-bo-arrived"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-emerald-600 hover:shadow-sm transition-all"
                                    title="ได้รับแล้ว">
                                    <ion-icon name="checkmark-circle-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">ได้รับแล้ว</span>
                                    <span id="count-bo-arrived"
                                        class="absolute -top-1 -right-1 bg-emerald-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="setBranchOrderStatusFilter('canceled')" id="btn-bo-canceled"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-rose-600 hover:shadow-sm transition-all"
                                    title="ยกเลิก">
                                    <ion-icon name="close-circle-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">ยกเลิก</span>
                                    <span id="count-bo-canceled"
                                        class="absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>
                            </div>
                            <button id="btn-add-branch-order" onclick="openBranchOrderModal()"
                                class="bg-slate-900 hover:bg-black text-white font-black py-3.5 px-8 rounded-2xl shadow-xl shadow-slate-900/20 transition-all hover:-translate-y-1 active:translate-y-0.5 flex items-center gap-2">
                                <ion-icon name="add-circle" class="text-xl text-yellow-400"></ion-icon>
                                <span>เพิ่มรายการ</span>
                            </button>
                        </div>
                    </div>

                    <div
                        class="bg-white rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead class="bg-slate-50/50 backdrop-blur-sm border-b border-slate-100">
                                    <tr>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            วันที่สั่ง</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            วันที่คาดว่าจะส่ง</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            รายละเอียดสั่ง</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            รายละเอียดสินค้า</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            สาขา</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody id="branch-order-table-body"
                                    class="divide-y divide-slate-50 text-sm italic-last-row">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Branch Inventory View (Sales) -->
                <div id="branch-inventory-view" class="hidden space-y-6 mt-6">
                    <!-- Modern Header & Filters -->
                    <div
                        class="bg-white/70 backdrop-blur-md rounded-3xl p-6 shadow-xl shadow-slate-200/50 border border-white flex flex-col lg:flex-row justify-between items-center gap-6">
                        <div class="flex items-center gap-5">
                            <div
                                class="w-14 h-14 bg-gradient-to-br from-emerald-400 to-teal-600 text-white rounded-2xl shadow-lg shadow-emerald-500/30 flex items-center justify-center transform transition-transform hover:scale-110 active:scale-95">
                                <ion-icon name="list-box" class="text-3xl"></ion-icon>
                            </div>
                            <div>
                                <h3 id="branch-inventory-title"
                                    class="text-2xl font-black text-slate-800 tracking-tight">
                                    รายการของลงสาขา</h3>
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-4 w-full lg:w-auto">
                            <!-- Date Filter -->
                            <div class="relative group hidden md:block">
                                <input type="date" id="branch-inventory-date-filter" onchange="fetchBranchInventory()"
                                    class="pl-4 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 outline-none transition-all shadow-sm">
                            </div>

                            <!-- Search Filter -->
                            <div class="relative group flex-1 md:flex-none">
                                <ion-icon name="search-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-emerald-500 transition-colors z-10"></ion-icon>
                                <input type="text" id="branch-inventory-search" onkeyup="fetchBranchInventory()"
                                    placeholder="ค้นหาชื่อรายการ, สินค้า..."
                                    class="pl-11 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 outline-none transition-all shadow-sm w-full md:w-64">
                            </div>

                            <!-- Status Filter -->
                            <div class="relative group">
                                <ion-icon name="filter"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-emerald-500 transition-colors"></ion-icon>
                                <select id="branch-inventory-status-filter" onchange="fetchBranchInventory()"
                                    class="pl-9 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none cursor-pointer hover:border-emerald-300 transition-colors shadow-sm appearance-none min-w-[160px]">
                                    <option value="all">ทุกสถานะ</option>
                                    <option value="pending" selected>⏳ รอดำเนินการ</option>
                                    <option value="shipped">🚚 รอของ</option>
                                    <option value="arrived">✅ ของถึงสาขาแล้ว</option>
                                    <option value="canceled">❌ ยกเลิก</option>
                                </select>
                                <ion-icon name="chevron-down"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead class="bg-slate-50/50 backdrop-blur-sm border-b border-slate-100">
                                    <tr>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            วันที่สั่ง</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            วันที่คาดว่าจะส่ง</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            รายละเอียดสั่ง</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            รายละเอียดสินค้า</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            สาขา</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody id="branch-inventory-table-body"
                                    class="divide-y divide-slate-50 text-sm italic-last-row">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Claim View -->
                <div id="claim-view-content" class="hidden space-y-8 mt-6">
                    <!-- Premium Header -->
                    <div
                        class="relative overflow-hidden bg-white rounded-3xl p-8 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
                        <!-- Decorative bg -->
                        <div
                            class="absolute top-0 right-0 w-64 h-64 bg-orange-400 opacity-10 rounded-full blur-3xl -mr-20 -mt-20">
                        </div>
                        <div
                            class="absolute bottom-0 left-0 w-32 h-32 bg-red-400 opacity-5 rounded-full blur-2xl -ml-10 -mb-10">
                        </div>

                        <div class="flex items-center gap-6 relative z-10">
                            <div
                                class="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-orange-500/20 transform -rotate-3 hover:rotate-0 transition-transform duration-300">
                                <ion-icon name="hammer" class="text-3xl"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-2xl font-black text-slate-800 tracking-tight">รายการแจ้งเคลม</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span>
                                    <p class="text-sm font-bold text-slate-500 uppercase tracking-widest">Accessory
                                        Claims Management</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="openClaimModal()"
                            class="relative group bg-slate-900 hover:bg-black text-white px-8 py-4 rounded-2xl font-bold shadow-xl shadow-slate-900/10 hover:shadow-2xl hover:shadow-orange-500/20 transition-all duration-300 flex items-center gap-3 overflow-hidden">
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-orange-500 to-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            </div>
                            <ion-icon name="add-circle" class="text-2xl relative z-10"></ion-icon>
                            <span class="relative z-10">แจ้งเคลมใหม่</span>
                        </button>
                    </div>

                    <!-- Standardized Filters (For Sales View) -->
                    <div id="claim-filter-standard"
                        class="hidden bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                            <!-- Date Filter -->
                            <div class="relative group hidden md:block">
                                <ion-icon name="calendar-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-orange-500 transition-colors z-10"></ion-icon>
                                <input type="date" id="claim-date-standard" onchange="fetchClaims()"
                                    class="pl-11 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none transition-all shadow-sm">
                            </div>

                            <!-- Search Filter -->
                            <div class="relative group flex-1 md:flex-none">
                                <ion-icon name="search-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-orange-500 transition-colors z-10"></ion-icon>
                                <input type="text" id="claim-search-standard" onkeyup="fetchClaims()"
                                    placeholder="ค้นหา เลขที่โอน, สินค้า..."
                                    class="pl-11 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none transition-all shadow-sm w-full md:w-64">
                            </div>

                            <!-- Branch Filter -->
                            <div id="claim-branch-standard-container"
                                class="relative group flex-1 md:flex-none min-w-[180px]">
                                <ion-icon name="storefront-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-orange-500 transition-colors z-10"></ion-icon>
                                <select id="claim-branch-standard" onchange="fetchClaims()"
                                    class="pl-11 pr-10 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none cursor-pointer hover:border-orange-300 transition-all shadow-sm appearance-none w-full">
                                    <option value="all">ทุกสาขา</option>
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="หาดใหญ่">หาดใหญ่</option>
                                    <option value="บิ๊กซี">บิ๊กซี</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                    <option value="โคลีเซียม">โคลีเซียม</option>
                                    <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                    <option value="ปากแมว">ปากแมว</option>
                                    <option value="ภูเก็ต">ภูเก็ต</option>
                                    <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                    <option value="กระบี่">กระบี่</option>
                                    <option value="กะทู้">กะทู้</option>
                                    <option value="ตรัง">ตรัง</option>
                                    <option value="คุรุ">คุรุ</option>
                                    <option value="ชุมพร">ชุมพร</option>
                                    <option value="สตูล">สตูล</option>
                                    <option value="พัทลุง">พัทลุง</option>
                                    <option value="สงขลา">สงขลา</option>
                                </select>
                                <ion-icon name="chevron-down-outline"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>

                            <!-- Status Filter -->
                            <div class="relative group flex-1 md:flex-none min-w-[160px]">
                                <ion-icon name="funnel-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-orange-500 transition-colors z-10"></ion-icon>
                                <select id="claim-status-standard" onchange="fetchClaims()"
                                    class="pl-11 pr-10 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none cursor-pointer hover:border-orange-300 transition-all shadow-sm appearance-none w-full">
                                    <option value="all">ทุกสถานะ</option>
                                    <option value="pending">⏳ รอดำเนินการ</option>
                                    <option value="approved">✅ รับสินค้าแล้ว</option>
                                    <option value="completed">🔵 เสร็จสิ้น</option>
                                </select>
                                <ion-icon name="chevron-down-outline"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>
                        </div>
                    </div>

                    <!-- Modern Glassmorphism Filters (For Stock View) -->
                    <div id="claim-filter-modern"
                        class="bg-white/70 backdrop-blur-2xl p-4 rounded-3xl shadow-xl border border-white/50 flex flex-col xl:flex-row gap-6 items-center">

                        <!-- Left Group: Search & Date -->
                        <div class="flex flex-col md:flex-row gap-4 flex-1 w-full">
                            <!-- Search Box -->
                            <div class="relative group flex-1">
                                <ion-icon name="search"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-orange-500 transition-colors text-lg"></ion-icon>
                                <input type="text" id="claim-search-filter" oninput="fetchClaims()"
                                    placeholder="ค้นหา เลขที่โอน, สินค้า..."
                                    class="w-full pl-12 pr-4 py-3.5 rounded-2xl border border-slate-200/60 bg-white/50 focus:bg-white focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none transition-all duration-300 font-bold text-slate-700 placeholder:text-slate-400">
                            </div>

                            <!-- Date Filter -->
                            <div class="relative group min-w-[200px]">
                                <ion-icon name="calendar"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-orange-500 transition-colors text-lg"></ion-icon>
                                <input type="date" id="claim-date-filter" onchange="fetchClaims()"
                                    class="w-full pl-12 pr-4 py-3.5 rounded-2xl border border-slate-200/60 bg-white/50 focus:bg-white focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none cursor-pointer transition-all duration-300 font-bold text-slate-700">
                            </div>
                        </div>

                        <!-- Right Group: Branch & Status -->
                        <div class="flex flex-col md:flex-row gap-4 items-center w-full xl:w-auto">
                            <!-- Branch Select -->
                            <div id="claim-branch-filter-container" class="relative group w-full md:w-56">
                                <ion-icon name="storefront"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-orange-500 transition-colors text-lg"></ion-icon>
                                <select id="claim-branch-filter" onchange="fetchClaims()"
                                    class="w-full pl-12 pr-10 py-3.5 rounded-2xl border border-slate-200/60 bg-white/50 focus:bg-white focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none cursor-pointer transition-all duration-300 font-bold text-slate-700 appearance-none">
                                    <option value="all">ทุกสาขา</option>
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="หาดใหญ่">หาดใหญ่</option>
                                    <option value="บิ๊กซี">บิ๊กซี</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                    <option value="โคลีเซียม">โคลีเซียม</option>
                                    <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                    <option value="ปากแมว">ปากแมว</option>
                                    <option value="ภูเก็ต">ภูเก็ต</option>
                                    <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                    <option value="กระบี่">กระบี่</option>
                                    <option value="กะทู้">กะทู้</option>
                                    <option value="ตรัง">ตรัง</option>
                                    <option value="คุรุ">คุรุ</option>
                                    <option value="ชุมพร">ชุมพร</option>
                                    <option value="สตูล">สตูล</option>
                                    <option value="พัทลุง">พัทลุง</option>
                                    <option value="สงขลา">สงขลา</option>
                                </select>
                                <ion-icon name="chevron-down"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>

                            <!-- Status Filter Bar -->
                            <div
                                class="bg-slate-100/80 p-1.5 rounded-[22px] flex items-center gap-1 w-full md:w-auto overflow-x-auto no-scrollbar">
                                <input type="hidden" id="claim-status-filter" value="all">

                                <button onclick="setClaimStatusFilter('all')" id="btn-claim-all"
                                    class="relative px-5 h-11 rounded-[18px] flex items-center justify-center gap-2.5 text-slate-500 hover:text-orange-600 transition-all duration-300 bg-white shadow-sm ring-1 ring-black/5 whitespace-nowrap"
                                    title="ทุกสถานะ">
                                    <ion-icon name="grid-outline"
                                        class="text-xl transition-transform group-hover:scale-110"></ion-icon>
                                    <span class="text-xs font-black uppercase tracking-wider">ทั้งหมด</span>
                                    <span id="count-claim-all"
                                        class="min-w-[20px] h-5 bg-orange-500 text-white text-[10px] font-black rounded-full flex items-center justify-center px-1 hidden shadow-lg shadow-orange-500/20">0</span>
                                </button>

                                <button onclick="setClaimStatusFilter('pending')" id="btn-claim-pending"
                                    class="relative px-5 h-11 rounded-[18px] flex items-center justify-center gap-2.5 text-slate-500 hover:bg-white hover:text-amber-600 hover:shadow-md transition-all duration-300 group whitespace-nowrap"
                                    title="รอดำเนินการ">
                                    <ion-icon name="time-outline" class="text-xl"></ion-icon>
                                    <span class="text-xs font-black uppercase tracking-wider">รอดำเนินการ</span>
                                    <span id="count-claim-pending"
                                        class="min-w-[20px] h-5 bg-amber-500 text-white text-[10px] font-black rounded-full flex items-center justify-center px-1 hidden shadow-lg shadow-amber-500/20">0</span>
                                </button>

                                <button onclick="setClaimStatusFilter('approved')" id="btn-claim-approved"
                                    class="relative px-5 h-11 rounded-[18px] flex items-center justify-center gap-2.5 text-slate-500 hover:bg-white hover:text-emerald-600 hover:shadow-md transition-all duration-300 group whitespace-nowrap"
                                    title="รับสินค้าแล้ว">
                                    <ion-icon name="checkmark-circle-outline" class="text-xl"></ion-icon>
                                    <span class="text-xs font-black uppercase tracking-wider">รับสินค้าแล้ว</span>
                                    <span id="count-claim-approved"
                                        class="min-w-[20px] h-5 bg-blue-500 text-white text-[10px] font-black rounded-full flex items-center justify-center px-1 hidden shadow-lg shadow-emerald-500/20">0</span>
                                </button>

                                <button onclick="setClaimStatusFilter('completed')" id="btn-claim-completed"
                                    class="relative px-5 h-11 rounded-[18px] flex items-center justify-center gap-2.5 text-slate-500 hover:bg-white hover:text-blue-600 hover:shadow-md transition-all duration-300 group whitespace-nowrap"
                                    title="เสร็จสิ้น">
                                    <ion-icon name="checkbox-outline" class="text-xl"></ion-icon>
                                    <span class="text-xs font-black uppercase tracking-wider">เสร็จสิ้น</span>
                                    <span id="count-claim-completed"
                                        class="min-w-[20px] h-5 bg-emerald-500 text-white text-[10px] font-black rounded-full flex items-center justify-center px-1 hidden shadow-lg shadow-emerald-500/20">0</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50/80 border-b border-slate-100">
                                    <tr>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            วันที่/เวลา</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            เลขที่โอน</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            สาขา</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            ผู้แจ้ง</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            สินค้า (รหัส)</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            จำนวน</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            ปัญหา</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            สถานะ</th>
                                        <th
                                            class="px-6 py-5 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="claim-table-body" class="divide-y divide-slate-50">
                                    <!-- Dynamic Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="admin-view-content"
                    class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div id="loading-users" class="text-center p-12 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-4">
                        </div>
                        <p class="text-slate-500">กำลังดึงข้อมูลผู้ใช้...</p>
                    </div>
                    <div
                        class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center bg-slate-50/50 gap-4">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-bold text-slate-800">รายชื่อผู้ใช้ในระบบ</h3>
                            <span id="user-count"
                                class="text-xs font-semibold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">0
                                คน</span>
                        </div>
                        <div class="relative w-full sm:w-64">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <ion-icon name="search-outline" class="text-slate-400"></ion-icon>
                            </div>
                            <input type="text" id="user-search-input"
                                class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-xl leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 sm:text-sm transition-shadow"
                                placeholder="ค้นหาชื่อ หรือ Username...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ชื่อ-สกุล</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        Username</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ตำแหน่ง</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        แผนก / สาขา</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        หัวหน้า</th>
                                    <th
                                        class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="divide-y divide-slate-100">
                                <tr id="no-user-row" class="text-center">
                                    <td colspan="6" class="px-6 py-12 text-slate-400">ไม่มีผู้ใช้ในระบบ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="stock-request-manage-view" class="hidden animate-fade-in space-y-6">
                    <div
                        class="bg-white/80 backdrop-blur-xl p-6 rounded-[2.5rem] shadow-sm border border-slate-200/60 flex flex-col lg:flex-row justify-between items-center gap-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-200 shrink-0">
                                <ion-icon name="clipboard-outline" class="text-2xl text-white"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-black text-slate-800 tracking-tight">จัดการรายการแจ้งเบิก
                                </h3>
                                <p class="text-sm font-medium text-slate-500">
                                    คัดกรองและบริหารจัดการคำขอเบิกสินค้าจากทุกสาขา
                                </p>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                            <!-- Status Filter -->
                            <!-- Status Filter (Icons) -->
                            <div class="bg-slate-100 p-1.5 rounded-2xl flex flex-wrap items-center gap-1">
                                <input type="hidden" id="manage-request-status-filter" value="">

                                <button onclick="setManageStatusFilter('')" id="btn-status-all"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-indigo-600 hover:shadow-sm transition-all bg-white shadow-sm ring-1 ring-black/5"
                                    title="ทุกสถานะ">
                                    <ion-icon name="grid-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">ทั้งหมด</span>
                                    <span id="count-status-all"
                                        class="absolute -top-1 -right-1 bg-indigo-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="setManageStatusFilter('pending')" id="btn-status-pending"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-amber-600 hover:shadow-sm transition-all"
                                    title="รอดำเนินการ">
                                    <ion-icon name="time-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">รอดำเนินการ</span>
                                    <span id="count-status-pending"
                                        class="absolute -top-1 -right-1 bg-amber-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="setManageStatusFilter('processing')" id="btn-status-processing"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-blue-600 hover:shadow-sm transition-all"
                                    title="กำลังเตรียมของ">
                                    <ion-icon name="cube-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">กำลังเตรียม</span>
                                    <span id="count-status-processing"
                                        class="absolute -top-1 -right-1 bg-blue-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="setManageStatusFilter('received')" id="btn-status-received"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-emerald-600 hover:shadow-sm transition-all"
                                    title="สำเร็จ">
                                    <ion-icon name="checkmark-circle-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">สำเร็จ</span>
                                    <span id="count-status-received"
                                        class="absolute -top-1 -right-1 bg-emerald-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="setManageStatusFilter('canceled')" id="btn-status-canceled"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-rose-600 hover:shadow-sm transition-all"
                                    title="ยกเลิก">
                                    <ion-icon name="close-circle-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">ยกเลิก</span>
                                    <span id="count-status-canceled"
                                        class="absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>
                            </div>

                            <!-- Branch Filter -->
                            <div class="relative group flex-1 md:flex-none min-w-[200px]">
                                <ion-icon name="business-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                                <select id="manage-request-branch-filter" onchange="fetchManageStockRequests()"
                                    class="pl-11 pr-10 py-3 rounded-2xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-all shadow-sm appearance-none w-full">
                                    <option value="">ทุกสาขา</option>
                                    <!-- Branches will be populated by JS -->
                                </select>
                                <ion-icon name="chevron-down-outline"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50/50 border-b border-slate-100">
                                    <tr>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            วันที่แจ้ง</th>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            สาขา / ผู้แจ้ง</th>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            รายการสินค้า</th>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            สถานะ</th>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            สินค้าถึงเมื่อ</th>
                                        <th
                                            class="px-8 py-5 text-right text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-request-manage-table-body" class="divide-y divide-slate-100">
                                    <!-- JS Injected Rows -->
                                    <tr>
                                        <td colspan="6" class="px-6 py-10 text-center text-slate-400">
                                            กำลังโหลดข้อมูล...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="stock-import-view" class="hidden space-y-8 mt-8 animate-fade-in pb-20">
                    <div
                        class="sticky top-4 z-30 bg-white/80 backdrop-blur-xl p-2 rounded-2xl shadow-lg border border-slate-200/60 flex flex-col md:flex-row gap-4 items-center justify-between transition-all">
                        <!-- Type Toggle Switch (Pill Shape) -->
                        <div class="bg-slate-100 p-1.5 rounded-xl flex gap-1 w-full md:w-auto">
                            <button onclick="filterStockType('phone')" id="tab-stock-phone"
                                class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-white text-indigo-600 ring-1 ring-black/5">
                                <ion-icon name="phone-portrait" class="text-lg"></ion-icon> Phone (Excel)
                            </button>
                            <button onclick="filterStockType('accessory')" id="tab-stock-accessory"
                                class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50">
                                <ion-icon name="headset" class="text-lg"></ion-icon> Accessories
                            </button>
                            <button onclick="filterStockType('all')" id="tab-stock-all"
                                class="flex-1 md:flex-none px-4 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50 hidden">
                                รวม
                            </button>
                        </div>

                        <!-- Filters Group -->
                        <div class="flex items-center gap-3 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 px-1">
                            <!-- Branch Select -->
                            <div class="relative group">
                                <ion-icon name="storefront"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors"></ion-icon>
                                <select id="stock-import-branch-filter"
                                    class="pl-9 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-colors shadow-sm appearance-none min-w-[160px]">
                                    <option value="all">ทุกสาขา</option>
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="หาดใหญ่">หาดใหญ่</option>
                                    <option value="บิ๊กซี">บิ๊กซี</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                    <option value="โคลีเซียม">โคลีเซียม</option>
                                    <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                    <option value="ปากแมว">ปากแมว</option>
                                    <option value="ภูเก็ต">ภูเก็ต</option>
                                    <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                    <option value="กระบี่">กระบี่</option>
                                    <option value="กะทู้">กะทู้</option>
                                    <option value="ตรัง">ตรัง</option>
                                    <option value="คุรุ">คุรุ</option>
                                    <option value="ชุมพร">ชุมพร</option>
                                    <option value="สตูล">สตูล</option>
                                    <option value="พัทลุง">พัทลุง</option>
                                    <option value="สงขลา">สงขลา</option>
                                </select>
                                <ion-icon name="chevron-down"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>

                            <!-- Status Filter (Icons) -->
                            <div class="bg-slate-100 p-1.5 rounded-2xl flex flex-wrap items-center gap-1">
                                <input type="hidden" id="stock-import-status-filter" value="all">

                                <button onclick="filterStockImports('all')" id="btn-stock-all"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-indigo-600 hover:shadow-sm transition-all bg-white shadow-sm ring-1 ring-black/5"
                                    title="ทุกสถานะ">
                                    <ion-icon name="grid-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">ทั้งหมด</span>
                                    <span id="count-stock-all"
                                        class="absolute -top-1 -right-1 bg-indigo-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="filterStockImports('pending')" id="btn-stock-pending"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-amber-600 hover:shadow-sm transition-all"
                                    title="รอนำเข้า">
                                    <ion-icon name="time-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">รอนำเข้า</span>
                                    <span id="count-stock-pending"
                                        class="absolute -top-1 -right-1 bg-amber-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="filterStockImports('importing')" id="btn-stock-importing"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-blue-600 hover:shadow-sm transition-all"
                                    title="กำลังนำเข้า">
                                    <ion-icon name="bus-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">กำลังนำเข้า</span>
                                    <span id="count-stock-importing"
                                        class="absolute -top-1 -right-1 bg-blue-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="filterStockImports('received')" id="btn-stock-received"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-emerald-600 hover:shadow-sm transition-all"
                                    title="สำเร็จ">
                                    <ion-icon name="checkmark-circle-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">สำเร็จ</span>
                                    <span id="count-stock-received"
                                        class="absolute -top-1 -right-1 bg-emerald-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>

                                <button onclick="filterStockImports('rejected')" id="btn-stock-rejected"
                                    class="relative px-3 h-10 rounded-xl flex items-center justify-center gap-2 text-slate-500 hover:bg-white hover:text-rose-600 hover:shadow-sm transition-all"
                                    title="ยกเลิก">
                                    <ion-icon name="close-circle-outline" class="text-lg"></ion-icon>
                                    <span class="text-xs font-bold">ยกเลิก</span>
                                    <span id="count-stock-rejected"
                                        class="absolute -top-1 -right-1 bg-rose-500 text-white text-[9px] font-bold px-1 rounded-full min-w-[14px] h-[14px] flex items-center justify-center hidden">0</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Content Views Container -->
                    <div
                        class="bg-white rounded-[2rem] shadow-sm border border-slate-200 min-h-[500px] overflow-hidden relative">
                        <!-- Loading Overlay -->
                        <div id="stock-loading"
                            class="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex flex-col items-center justify-center hidden">
                            <div
                                class="w-12 h-12 border-4 border-indigo-100 border-t-indigo-500 rounded-full animate-spin mb-4">
                            </div>
                            <p class="text-indigo-900 font-bold animate-pulse">กำลังโหลดข้อมูล...</p>
                        </div>

                        <!-- PHONE VIEW (Table) -->
                        <div id="stock-view-phone" class="hidden animate-fade-in relative z-10">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-100">
                                    <thead class="bg-slate-50/80 backdrop-blur-sm sticky top-0 z-10">
                                        <tr>
                                            <th
                                                class="px-6 py-5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                🗓️ วันที่แจ้ง</th>
                                            <th
                                                class="px-6 py-5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                🏪 สาขา / ผู้แจ้ง</th>
                                            <th
                                                class="px-6 py-5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                📦 Supplier</th>
                                            <th
                                                class="px-6 py-5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                📎 ไฟล์แนบ</th>
                                            <th
                                                class="px-6 py-5 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                สถานะ</th>
                                            <th
                                                class="px-6 py-5 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                จัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stock-phone-tbody" class="divide-y divide-slate-100 bg-white">
                                        <!-- JS Injected -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ACCESSORY VIEW (Grid) -->
                        <div id="stock-view-accessory" class="p-6 hidden animate-fade-in relative z-10">
                            <div id="stock-acc-grid"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                <!-- JS Injected Cards -->
                            </div>
                        </div>

                        <!-- Empty State (Common) -->
                        <div id="stock-empty-state"
                            class="hidden absolute inset-0 flex flex-col items-center justify-center text-center p-8 z-0">
                            <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6">
                                <ion-icon name="file-tray-outline" class="text-5xl text-slate-300"></ion-icon>
                            </div>
                            <h4 class="text-xl font-bold text-slate-700">ไม่พบรายการนำเข้า</h4>
                            <p class="text-slate-400 mt-2">ยังไม่มีการแจ้งนำเข้าในหมวดหมู่นี้ หรือสถานะที่เลือก</p>
                        </div>
                    </div>
                    <div id="stock-pagination"
                        class="hidden border-t border-slate-100 bg-slate-50 p-4 flex flex-col md:flex-row justify-between items-center gap-4 relative z-20">
                        <div class="text-xs font-bold text-slate-500">
                            แสดง <span id="pagination-info-start">0</span> - <span id="pagination-info-end">0</span>
                            จาก
                            <span id="pagination-info-total">0</span> รายการ
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btn-prev-page" onclick="changeStockPage(-1)" disabled
                                class="p-2 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                                <ion-icon name="chevron-back"></ion-icon>
                            </button>
                            <span id="pagination-page-display"
                                class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-700 shadow-sm">
                                หน้า 1 / 1
                            </span>
                            <button id="btn-next-page" onclick="changeStockPage(1)" disabled
                                class="p-2 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                                <ion-icon name="chevron-forward"></ion-icon>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="import-view" class="hidden space-y-6 mt-6">
                    <!-- Header -->
                    <div
                        class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 relative overflow-hidden">
                        <!-- Decorative bg -->
                        <div
                            class="absolute top-0 right-0 w-32 h-32 bg-yellow-400 opacity-10 rounded-full blur-3xl -mr-10 -mt-10">
                        </div>

                        <div class="flex items-center gap-4 relative z-10">
                            <div class="p-3 bg-slate-900 text-yellow-400 rounded-2xl shadow-lg shadow-slate-900/20">
                                <ion-icon name="cloud-upload" class="text-2xl"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">แจ้งนำเข้าสินค้า</h3>
                                <p class="text-sm text-slate-500">แจ้งรายการสินค้าเข้าใหม่ไปยังฝ่ายสต็อก</p>
                            </div>
                        </div>
                        <div class="flex space-x-2 md:space-x-4 min-w-max">
                            <button onclick="switchImportTab('phone')" id="tab-btn-phone"
                                class="flex items-center px-6 py-3 rounded-xl text-sm font-bold transition-all bg-yellow-400 text-slate-900 shadow-md shadow-yellow-400/30">
                                <ion-icon name="phone-portrait-outline" class="mr-2 text-lg"></ion-icon>
                                นำเข้าโทรศัพท์ (Excel)
                            </button>
                            <button onclick="switchImportTab('accessory')" id="tab-btn-accessory"
                                class="flex items-center px-6 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 transition-all">
                                <ion-icon name="headset-outline" class="mr-2 text-lg"></ion-icon>
                                นำเข้า Accessories (รูปภาพ)
                            </button>
                        </div>
                    </div>


                    <!-- Phone Import Section -->
                    <div id="tab-import-phone" class="space-y-6 animate-fade-in">
                        <!-- Phone Filter Toolbar (Modernized) -->
                        <div
                            class="flex flex-col md:flex-row gap-4 mb-2 justify-between items-center bg-white/80 backdrop-blur-md p-5 rounded-3xl border border-white/50 shadow-xl shadow-slate-200/50 relative overflow-hidden group">
                            <!-- Decorative Background Glow -->
                            <div
                                class="absolute top-0 right-0 w-64 h-64 bg-yellow-400/5 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none transition-opacity duration-700 opacity-50 group-hover:opacity-100">
                            </div>

                            <div class="relative w-full md:w-72 z-10">
                                <ion-icon name="search"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></ion-icon>
                                <input type="text" id="phone-import-search" oninput="renderPhoneImportList()"
                                    class="w-full pl-11 pr-4 py-3 rounded-2xl border border-slate-200 bg-slate-50/50 focus:bg-white focus:border-yellow-400 focus:ring-4 focus:ring-yellow-400/10 outline-none text-sm font-bold text-slate-700 transition-all placeholder:text-slate-400"
                                    placeholder="ค้นหา Supplier, สาขา...">
                            </div>

                            <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto z-10">
                                <div class="relative w-full md:w-auto group/select">
                                    <ion-icon name="filter"
                                        class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover/select:text-yellow-500 transition-colors"></ion-icon>
                                    <ion-icon name="chevron-down"
                                        class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 text-xs pointer-events-none"></ion-icon>
                                    <select id="phone-import-status" onchange="renderPhoneImportList()"
                                        class="appearance-none w-full md:w-48 pl-11 pr-10 py-3 rounded-2xl border border-slate-200 bg-slate-50/50 focus:bg-white focus:border-yellow-400 focus:ring-4 focus:ring-yellow-400/10 outline-none text-sm font-bold text-slate-700 cursor-pointer transition-all hover:border-yellow-300">
                                        <option value="all">ทุกสถานะ</option>
                                        <option value="pending" selected>รอนำเข้า</option>
                                        <option value="importing">กำลังนำเข้า</option>
                                        <option value="received">สำเร็จ</option>
                                    </select>
                                </div>

                                <button onclick="openPhoneImportModal()"
                                    class="w-full md:w-auto bg-slate-900 hover:bg-slate-800 text-yellow-400 hover:text-yellow-300 px-6 py-3 rounded-2xl font-bold shadow-lg shadow-slate-900/20 hover:shadow-xl hover:shadow-slate-900/30 hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-3 group/btn relative overflow-hidden">
                                    <div
                                        class="absolute inset-0 bg-white/10 translate-y-full group-hover/btn:translate-y-0 transition-transform duration-300">
                                    </div>
                                    <div
                                        class="p-1.5 bg-yellow-400 text-slate-900 rounded-lg group-hover/btn:rotate-90 transition-transform duration-500">
                                        <ion-icon name="add" class="text-sm font-bold"></ion-icon>
                                    </div>
                                    <span class="relative">เพิ่มรายการนำเข้า</span>
                                </button>
                            </div>
                        </div>

                        <!-- (*** New: Phone Import Modal ***) -->
                        <div id="phoneImportModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
                            <div
                                class="modal-content relative w-full max-w-lg bg-white rounded-3xl shadow-2xl overflow-hidden ring-4 ring-yellow-400/20 transform transition-all scale-100">
                                <!-- Header -->
                                <div
                                    class="bg-slate-900 p-6 flex justify-between items-center text-white relative overflow-hidden">
                                    <div
                                        class="absolute top-0 right-0 w-24 h-24 bg-yellow-400 rounded-full opacity-10 blur-xl -mr-10 -mt-10">
                                    </div>
                                    <h3 class="text-xl font-bold flex items-center gap-3 relative z-10">
                                        <div
                                            class="p-2 bg-yellow-400 text-slate-900 rounded-lg shadow-lg shadow-yellow-400/50">
                                            <ion-icon name="cloud-upload"></ion-icon>
                                        </div>
                                        <span class="text-white tracking-wide">นำเข้าไฟล์ Excel</span>
                                    </h3>
                                    <button onclick="closeModal('phoneImportModal')"
                                        class="hover:bg-white/10 p-2 rounded-full transition-colors relative z-10 text-slate-400 hover:text-white">
                                        <ion-icon name="close" class="text-2xl"></ion-icon>
                                    </button>
                                </div>

                                <!-- Form Body -->
                                <div class="p-8">
                                    <form id="phone-import-form" class="space-y-6">
                                        <input type="hidden" id="phone-import-id" value="">
                                        <!-- Files Container -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <!-- Excel File Input -->
                                            <div>
                                                <label class="block text-sm font-bold text-slate-700 mb-2">1. ไฟล์
                                                    Excel
                                                    (.xlsx, .xls)</label>
                                                <div
                                                    class="border-2 border-dashed border-slate-200 rounded-2xl p-4 text-center hover:bg-slate-50 hover:border-yellow-400 transition-all cursor-pointer relative group bg-slate-50/30 h-32 flex flex-col items-center justify-center">
                                                    <input type="file" id="phone-import-file" accept=".xlsx, .xls"
                                                        multiple
                                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer text-sm">
                                                    <ion-icon name="document-text-outline"
                                                        class="text-2xl text-slate-300 mb-1 group-hover:text-yellow-500 transition-colors"></ion-icon>
                                                    <p class="font-bold text-slate-600 text-xs">เลือกไฟล์ Excel</p>
                                                    <p id="file-name-display"
                                                        class="mt-1 text-[10px] font-bold text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-lg hidden truncate max-w-[90%]">
                                                    </p>
                                                </div>
                                            </div>

                                            <!-- Image File Input -->
                                            <div>
                                                <label class="block text-sm font-bold text-slate-700 mb-2">2.
                                                    รูปภาพประกอบ (ถ้ามี)</label>
                                                <div
                                                    class="border-2 border-dashed border-slate-200 rounded-2xl p-4 text-center hover:bg-slate-50 hover:border-blue-400 transition-all cursor-pointer relative group bg-slate-50/30 h-32 flex flex-col items-center justify-center overflow-hidden">
                                                    <input type="file" id="phone-import-image" accept="image/*" multiple
                                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer text-sm">

                                                    <div id="phone-image-placeholder"
                                                        class="flex flex-col items-center">
                                                        <ion-icon name="image-outline"
                                                            class="text-2xl text-slate-300 mb-1 group-hover:text-blue-500 transition-colors"></ion-icon>
                                                        <p class="font-bold text-slate-600 text-xs">แนบรูปภาพ</p>
                                                    </div>

                                                    <img id="phone-image-preview"
                                                        class="absolute inset-0 w-full h-full object-cover hidden"
                                                        src="">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Supplier Input -->
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">Supplier
                                                (แหล่งที่มา)</label>
                                            <input type="text" id="phone-import-supplier" class="form-input-theme"
                                                required placeholder="เช่น Samsung Thailand, Com7...">
                                        </div>

                                        <!-- Description Input -->
                                        <div>
                                            <label
                                                class="block text-sm font-bold text-slate-700 mb-2">รายละเอียดเพิ่มเติม</label>
                                            <textarea id="phone-import-description" rows="2"
                                                class="form-input-theme resize-none"
                                                placeholder="ระบุรายละเอียด (ถ้ามี)..."></textarea>
                                        </div>

                                        <!-- Submit Button -->
                                        <div class="pt-2">
                                            <button type="button" onclick="submitPhoneImport()"
                                                class="w-full bg-slate-900 hover:bg-black text-yellow-400 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                                                <ion-icon name="checkmark-circle"></ion-icon>
                                                ยืนยันการนำเข้า
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- History List -->
                        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                                <h4 class="text-lg font-bold text-slate-800">รายการแจ้งนำเข้า(โทรศัพท์)</h4>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-white border-b border-slate-100">
                                        <tr>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                วันที่แจ้ง</th>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                ไฟล์แนบ</th>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                Supplier</th> <!-- (New Header) -->
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                สาขา</th>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                สถานะ</th>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                ผู้แจ้ง</th>
                                            <th
                                                class="px-6 py-4 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                จัดการ</th> <!-- (New) -->
                                        </tr>
                                    </thead>
                                    <tbody id="phone-import-list" class="divide-y divide-slate-100">
                                        <!-- Items will be injected here -->
                                        <tr>
                                            <td colspan="5" class="px-6 py-10 text-center text-slate-400">
                                                กำลังโหลดข้อมูล...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Accessory Import Section -->
                    <div id="tab-import-accessory" class="hidden space-y-6 animate-fade-in">
                        <!-- Accessory Filter Toolbar (Modernized) -->
                        <div
                            class="flex flex-col md:flex-row gap-4 mb-2 justify-between items-center bg-white/80 backdrop-blur-md p-5 rounded-3xl border border-white/50 shadow-xl shadow-slate-200/50 relative overflow-hidden group">
                            <!-- Decorative Background Glow -->
                            <div
                                class="absolute top-0 right-0 w-64 h-64 bg-slate-900/5 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none transition-opacity duration-700 opacity-50 group-hover:opacity-100">
                            </div>

                            <div class="relative w-full md:w-72 z-10">
                                <ion-icon name="search"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-lg"></ion-icon>
                                <input type="text" id="acc-import-search" oninput="renderAccessoryImportList()"
                                    class="w-full pl-11 pr-4 py-3 rounded-2xl border border-slate-200 bg-slate-50/50 focus:bg-white focus:border-slate-800 focus:ring-4 focus:ring-slate-900/10 outline-none text-sm font-bold text-slate-700 transition-all placeholder:text-slate-400"
                                    placeholder="ค้นหา (บิล, สินค้า)...">
                            </div>

                            <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto z-10">
                                <div class="relative w-full md:w-auto group/select">
                                    <ion-icon name="filter"
                                        class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover/select:text-slate-800 transition-colors"></ion-icon>
                                    <ion-icon name="chevron-down"
                                        class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 text-xs pointer-events-none"></ion-icon>
                                    <select id="acc-import-status" onchange="renderAccessoryImportList()"
                                        class="appearance-none w-full md:w-48 pl-11 pr-10 py-3 rounded-2xl border border-slate-200 bg-slate-50/50 focus:bg-white focus:border-slate-800 focus:ring-4 focus:ring-slate-900/10 outline-none text-sm font-bold text-slate-700 cursor-pointer transition-all hover:border-slate-300">
                                        <option value="all">ทุกสถานะ</option>
                                        <option value="pending" selected>รอนำเข้า</option>
                                        <option value="importing">กำลังนำเข้า</option>
                                        <option value="received">สำเร็จ</option>
                                    </select>
                                </div>

                                <button onclick="openAccessoryImportModal()"
                                    class="w-full md:w-auto bg-slate-900 hover:bg-slate-800 text-white hover:text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-slate-900/20 hover:shadow-xl hover:shadow-slate-900/30 hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-3 group/btn relative overflow-hidden">
                                    <div
                                        class="absolute inset-0 bg-white/10 translate-y-full group-hover/btn:translate-y-0 transition-transform duration-300">
                                    </div>
                                    <div
                                        class="p-1.5 bg-white/20 rounded-lg group-hover/btn:rotate-90 transition-transform duration-500 backdrop-blur-sm">
                                        <ion-icon name="add" class="text-sm font-bold"></ion-icon>
                                    </div>
                                    <span class="relative">เพิ่มรายการ (บิล)</span>
                                </button>
                            </div>
                        </div>



                        <!-- Full Width List -->
                        <div class="col-span-full">
                            <div
                                class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden h-full flex flex-col">
                                <div
                                    class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                    <h4 class="text-lg font-bold text-slate-800">รายการแจ้งนำเข้า(Accessories)</h4>
                                </div>
                                <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 flex-grow overflow-y-auto max-h-[600px] custom-scrollbar"
                                    id="accessory-import-list">
                                    <!-- Accessor Cards Injected Here -->
                                    <div class="col-span-full py-12 text-center text-slate-400">กำลังโหลดข้อมูล...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- (*** New: Accessory Import Modal (Multi-Item) ***) -->
                    <div id="accImportModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
                        <div
                            class="modal-content relative w-full h-full max-w-4xl max-h-[90vh] bg-white rounded-3xl shadow-2xl overflow-hidden ring-4 ring-slate-900/10 flex flex-col transform transition-all scale-100">
                            <!-- Header -->
                            <div
                                class="bg-slate-900 p-6 flex justify-between items-center text-white flex-shrink-0 relative overflow-hidden">
                                <div
                                    class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full blur-2xl -mr-10 -mt-10">
                                </div>
                                <h3 class="text-xl font-bold flex items-center gap-3 relative z-10">
                                    <div class="p-2 bg-white/10 rounded-lg backdrop-blur-sm">
                                        <ion-icon name="receipt-outline"></ion-icon>
                                    </div>
                                    <span class="tracking-wide">บันทึกบิลนำเข้า (Accessories)</span>
                                </h3>
                                <button onclick="closeModal('accImportModal')"
                                    class="hover:bg-white/10 p-2 rounded-full transition-colors text-slate-400 hover:text-white relative z-10">
                                    <ion-icon name="close" class="text-2xl"></ion-icon>
                                </button>
                            </div>

                            <!-- Body (Scrollable) -->
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-8 bg-slate-50">
                                <form id="accessory-import-form-multi" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                                    <input type="hidden" id="acc-import-id" value="">
                                    <!-- Left Column: Bill Image & Info -->
                                    <div class="lg:col-span-4 space-y-6">
                                        <div
                                            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 sticky top-0">
                                            <h5 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                                <ion-icon name="image" class="text-yellow-500"></ion-icon>
                                                ข้อมูลบิล
                                            </h5>

                                            <div class="space-y-4">
                                                <!-- Image Upload -->
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 mb-2 uppercase">รูปถ่ายบิลสินค้า</label>
                                                    <div
                                                        class="border-2 border-dashed border-slate-200 rounded-xl p-2 text-center hover:bg-slate-50 hover:border-yellow-400 transition-all cursor-pointer relative bg-slate-50/50 group h-48 flex items-center justify-center">
                                                        <input type="file" id="acc-bill-image" accept="image/*" multiple
                                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                                            onchange="previewImage(this)">
                                                        <div id="image-preview-placeholder"
                                                            class="flex flex-col items-center pointer-events-none transition-opacity">
                                                            <div
                                                                class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mb-2 group-hover:bg-yellow-100 group-hover:text-yellow-600 transition-colors">
                                                                <ion-icon name="camera"
                                                                    class="text-2xl text-slate-400 group-hover:text-yellow-600"></ion-icon>
                                                            </div>
                                                            <span
                                                                class="text-xs font-bold text-slate-400">คลิกอัปโหลด</span>
                                                        </div>
                                                        <img id="image-preview" src=""
                                                            class="hidden w-full h-full object-contain rounded-lg relative z-0">
                                                    </div>
                                                </div>

                                                <!-- Bill Name (New) -->
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 mb-1 uppercase">เลขที่เอกสาร
                                                        / ชื่อบิล</label>
                                                    <input type="text" id="acc-bill-name"
                                                        class="form-input-theme w-full"
                                                        placeholder="ระบุเลขที่บิล หรือชื่อ..." required>
                                                </div>

                                                <!-- Date & Supplier -->
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 mb-1 uppercase">วันที่ในบิล</label>
                                                    <input type="date" id="acc-bill-date"
                                                        class="form-input-theme w-full" required>
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 mb-1 uppercase">Supplier
                                                        (ร้านที่ซื้อ)</label>
                                                    <input type="text" id="acc-bill-supplier"
                                                        class="form-input-theme w-full" placeholder="ระบุร้านค้า...">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column: Items List -->
                                    <div class="lg:col-span-8 space-y-6">
                                        <div class="flex justify-between items-center">
                                            <h5 class="font-bold text-slate-800 flex items-center gap-2">
                                                <ion-icon name="list" class="text-blue-500"></ion-icon>
                                                รายการสินค้าในบิล
                                            </h5>
                                            <button type="button" onclick="addAccessoryItemRow()"
                                                class="text-sm font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-2 rounded-lg transition-colors flex items-center gap-1">
                                                <ion-icon name="add-circle"></ion-icon> เพิ่มสินค้า
                                            </button>
                                        </div>

                                        <!-- Items Container -->
                                        <div id="acc-items-container" class="space-y-3">
                                            <!-- Dynamic Rows will be added here -->
                                        </div>

                                        <!-- Empty State Helper -->
                                        <div id="acc-items-empty"
                                            class="text-center py-10 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50">
                                            <ion-icon name="basket-outline"
                                                class="text-4xl text-slate-300 mb-2"></ion-icon>
                                            <p class="text-slate-400 text-sm">ยังไม่มีรายการสินค้า</p>
                                            <button type="button" onclick="addAccessoryItemRow()"
                                                class="mt-2 text-xs font-bold text-blue-500 hover:underline">คลิกเพื่อเพิ่มสินค้าแรก</button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Footer -->
                            <div
                                class="bg-white p-6 border-t border-slate-100 flex justify-between items-center flex-shrink-0 z-20">
                                <div class="text-sm text-slate-500">
                                    จำนวนรายการ: <span id="acc-total-items-count"
                                        class="font-bold text-slate-900">0</span>
                                </div>
                                <div class="flex gap-3">
                                    <button type="button" onclick="closeModal('accImportModal')"
                                        class="px-6 py-2.5 rounded-xl text-slate-500 font-bold hover:bg-slate-50 transition-colors">ยกเลิก</button>
                                    <button type="button" onclick="submitAccessoryImport()"
                                        class="bg-slate-900 hover:bg-black text-yellow-400 px-8 py-2.5 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2">
                                        <ion-icon name="checkmark-circle"></ion-icon>
                                        บันทึกทั้งหมด
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- View: Stock Request (Sales) -->
    <div id="stock-request-view" class="hidden animate-fade-in space-y-6">
        <div
            class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-100 gap-4">
            <div>
                <h3 class="text-xl font-bold text-slate-800">รายการแจ้งเบิกสินค้า</h3>
                <p class="text-sm text-slate-500 mt-1">รายการสินค้าที่สาขาแจ้งเบิกจากสต๊อกกลาง</p>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                <select id="stock-request-branch-filter" class="form-select-theme py-2.5 min-w-[160px] shadow-sm">
                    <option value="">สาขาของฉัน</option>
                    <!-- Branches populated by JS -->
                </select>
                <select id="stock-request-status-filter" onchange="fetchStockRequests()"
                    class="form-select-theme py-2.5 min-w-[160px] shadow-sm">
                    <option value="">ทุกสถานะ</option>
                    <option value="pending">รอสั่ง</option>
                    <option value="processing">กำลังสั่ง</option>
                    <option value="received">ได้รับแล้ว</option>
                    <option value="canceled">ยกเลิก</option>
                </select>
                <button onclick="openStockRequestModal()"
                    class="w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg shadow-yellow-500/30 transition-all flex items-center justify-center gap-2">
                    <ion-icon name="add-circle" class="text-xl"></ion-icon>
                    <span>แจ้งเบิกสินค้าใหม่</span>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">
                                วันที่แจ้ง</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">
                                รายการสินค้า</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">สถานะ
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">
                                วันที่คาดว่าจะถึง</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">หมายเหตุ
                            </th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase">จัดการ
                            </th>
                        </tr>
                    </thead>
                    <tbody id="stock-request-table-body" class="divide-y divide-slate-100">
                        <!-- JS Injected Rows -->
                        <tr>
                            <td colspan="6" class="px-6 py-10 text-center text-slate-400">กำลังโหลดข้อมูล...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- New Task Modal -->
    <div id="newTaskModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">สั่งงานใหม่</h3>
                <button onclick="closeModal('newTaskModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8">
                <form id="new-task-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="taskTitle"
                                class="block text-sm font-semibold text-slate-700 mb-2">ชื่องาน</label>
                            <input type="text" id="taskTitle" name="title" required class="form-input-theme"
                                placeholder="เช่น สรุปยอดขายประจำสัปดาห์">
                        </div>
                        <div>
                            <label for="taskAssignTo"
                                class="block text-sm font-semibold text-slate-700 mb-2">มอบหมายให้</label>
                            <select id="taskAssignTo" name="assignedTo" required class="form-select-theme">
                                <option value="" disabled selected>--- กำลังโหลดรายชื่อพนักงาน ---</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="taskDesc"
                            class="block text-sm font-semibold text-slate-700 mb-2">รายละเอียดงาน</label>
                        <textarea id="taskDesc" name="description" rows="4" class="form-input-theme"
                            placeholder="รายละเอียด..."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="taskDueDate"
                                class="block text-sm font-semibold text-slate-700 mb-2">กำหนดส่ง</label>
                            <input type="date" id="taskDueDate" name="dueDate" class="form-input-theme">
                        </div>
                        <div>
                            <label for="taskPriority"
                                class="block text-sm font-semibold text-slate-700 mb-2">ความสำคัญ</label>
                            <select id="taskPriority" name="priority" class="form-select-theme">
                                <option value="low">ต่ำ</option>
                                <option value="medium" selected>ปานกลาง</option>
                                <option value="high">สูง</option>
                            </select>
                        </div>
                    </div>
                    <div id="new-task-error"
                        class="hidden p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('newTaskModal')">ยกเลิก</button>
                        <button type="submit" id="submit-task-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all flex items-center">
                            <span id="submit-task-text">สร้างงาน</span>
                            <div id="submit-task-spinner"
                                class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent">
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="depositModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div
                class="bg-gradient-to-r from-yellow-500 to-orange-600 p-6 flex justify-between items-center text-white">
                <h3 class="text-xl font-bold flex items-center"><ion-icon name="wallet" class="mr-2"></ion-icon>
                    บันทึกรายการมัดจำ</h3>
                <button onclick="closeModal('depositModal')" class="hover:text-yellow-100 transition-colors"><ion-icon
                        name="close" class="text-2xl"></ion-icon></button>
            </div>
            <div class="p-8 max-h-[80vh] overflow-y-auto">
                <form id="deposit-form" class="space-y-6">
                    <input type="hidden" id="dep-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 border-b border-slate-100">
                        <div class="col-span-2 font-bold text-slate-800 flex items-center text-lg">
                            <div
                                class="w-8 h-8 rounded-lg bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3">
                                <ion-icon name="document-text"></ion-icon>
                            </div>
                            ข้อมูลการมัดจำ
                        </div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">วันที่มัดจำ</label><input
                                type="date" id="dep-date" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">วันที่นัดรับ</label><input
                                type="date" id="dep-pickup" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ชื่อลูกค้า</label><input
                                type="text" id="dep-name" class="form-input-theme" required></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">เบอร์โทร</label><input
                                type="text" id="dep-phone" class="form-input-theme" required></div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ยอดมัดจำ
                                (บาท)</label>
                            <input type="number" id="dep-amount"
                                class="form-input-theme bg-red-50 text-red-600 font-bold border-red-100 focus:ring-red-500 focus:border-red-500 text-lg"
                                required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                        <div
                            class="col-span-2 font-bold text-slate-800 flex items-center text-lg bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <ion-icon name="gift" class="mr-3 text-yellow-500 text-xl"></ion-icon> ส่วนรับเครื่อง
                            (กรอกเมื่อมารับของ)
                        </div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">สินค้า
                                (รุ่น/สี/ความจุ)</label><select id="dep-product" class="form-select-theme"
                                placeholder="เลือกหรือพิมพ์เพิ่ม..."></select>
                        </div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ราคาเครื่องเต็ม
                                (บาท)</label><input type="number" id="dep-price" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">เลขที่บิล</label><input
                                type="text" id="dep-bill" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">IMEI</label><input
                                type="text" id="dep-imei" class="form-input-theme"></div>

                        <label for="dep-success"
                            class="col-span-2 flex items-center mt-2 p-4 bg-green-50 rounded-xl border border-green-200 cursor-pointer hover:bg-green-100 transition-colors">

                            <input type="checkbox" id="dep-success"
                                class="w-5 h-5 text-green-600 rounded focus:ring-green-500 mr-3">

                            <span class="font-bold text-green-800 cursor-pointer select-none">
                                ทำรายการสำเร็จ (รับเครื่องแล้ว)
                            </span>
                        </label>
                    </div>

                    <div class="flex justify-end gap-3 pt-6 border-t border-slate-100">
                        <button type="button" onclick="closeModal('depositModal')"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors">ยกเลิก</button>
                        <button type="submit"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">บันทึกข้อมูล</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <form id="update-task-form">
                <input type="hidden" id="detail-task-id" name="taskId">
                <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800" id="detail-task-title">กำลังโหลด...</h3>
                    <button type="button" class="text-slate-400 hover:text-slate-600 transition-colors"
                        onclick="closeModal('taskDetailModal')">
                        <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                    </button>
                </div>

                <div class="p-8 space-y-6">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-sm font-semibold text-slate-500 mb-1">รายละเอียด</p>
                        <p id="detail-task-desc" class="text-slate-700 whitespace-pre-wrap leading-relaxed">...</p>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">ผู้สั่งงาน</p>
                                <p id="detail-task-creator" class="text-sm font-semibold text-slate-800">...</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3">
                                <ion-icon name="calendar"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">กำหนดส่ง</p>
                                <p id="detail-task-dueDate" class="text-sm font-semibold text-slate-800">...</p>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6">
                        <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center"><ion-icon
                                name="time-outline" class="mr-2"></ion-icon> ประวัติการอัปเดต</h4>
                        <div id="detail-task-comments-list"
                            class="space-y-3 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                            <p class="text-sm text-slate-400 italic">ไม่มีประวัติการอัปเดต</p>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6 bg-yellow-50/50 -mx-8 px-8 -mb-8 pb-8">
                        <div class="mb-4">
                            <label for="detail-task-status"
                                class="block text-sm font-bold text-slate-700 mb-2">อัปเดตสถานะงาน</label>
                            <select id="detail-task-status" name="status" class="form-select-theme">
                                <option value="todo">มอบหมายแล้ว (To Do)</option>
                                <option value="in-progress">กำลังดำเนินการ (In Progress)</option>
                                <option value="for-review">ส่งตรวจสอบ (For Review)</option>
                                <option value="completed">สำเร็จแล้ว (Completed)</option>
                            </select>
                        </div>
                        <div>
                            <label for="detail-task-comment"
                                class="block text-sm font-bold text-slate-700 mb-2">เพิ่มคำอธิบาย</label>
                            <textarea id="detail-task-comment" name="commentText" rows="3" class="form-input-theme"
                                placeholder="เช่น อัปเดตความคืบหน้า หรือแนบ Link ผลงาน..."></textarea>
                        </div>
                    </div>
                </div>

                <div id="update-task-error"
                    class="hidden mx-8 mb-6 p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>

                <div class="px-8 py-4 border-t border-slate-100 bg-white flex justify-between items-center">
                    <button type="button" id="delete-task-btn"
                        class="text-red-600 hover:text-red-700 font-medium text-sm flex items-center px-3 py-2 rounded-lg hover:bg-red-50 transition-colors"
                        style="display: none;">
                        <ion-icon name="trash-outline" class="text-lg mr-2"></ion-icon> ลบงานนี้
                    </button>
                    <div class="flex gap-3">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('taskDetailModal')">ปิด</button>
                        <button type="submit" id="save-task-details-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">บันทึกการเปลี่ยนแปลง</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-sm bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="p-6 text-center">
                <div
                    class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <ion-icon name="warning" class="text-3xl"></ion-icon>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">ยืนยันการลบ</h3>
                <p class="text-slate-500 text-sm mb-6" id="confirm-message">
                    คุณแน่ใจหรือไม่ว่าต้องการลบงานนี้? การกระทำนี้ไม่สามารถย้อนกลับได้
                </p>
                <p id="confirm-error-message" class="text-xs text-red-600 mb-4 font-semibold"></p>
                <div class="flex justify-center gap-3">
                    <button type="button"
                        class="flex-1 px-4 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors border border-slate-200"
                        onclick="closeModal('confirmModal')">
                        ยกเลิก
                    </button>
                    <button type="button" id="confirm-delete-button" data-task-id="" onclick="executeDelete()"
                        class="flex-1 px-4 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg shadow-red-600/30 transition-all">
                        ยืนยันลบ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="branchOrderModal" class="modal fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/40 transition-opacity" aria-hidden="true"
            onclick="closeModal('branchOrderModal')"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="modal-content inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-pink-100 sm:mx-0 sm:h-10 sm:w-10">
                        <ion-icon name="basket" class="text-pink-600 text-xl"></ion-icon>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-slate-900" id="modal-title">
                            เพิ่มรายการสั่งของลงสาขา</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">ชื่อรายการ (เช่น
                                    สั่งของรอบเดือน มี.ค.)</label>
                                <input type="text" id="bo-order-name" class="form-input-theme" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">วันที่สั่ง</label>
                                    <input type="date" id="bo-order-date" class="form-input-theme" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">วันที่ของจะถึง</label>
                                    <input type="date" id="bo-expected-date" class="form-input-theme">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">สาขาปลายทาง</label>
                                <select id="bo-branch" class="form-select-theme">
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="หาดใหญ่">หาดใหญ่</option>
                                    <option value="บิ๊กซี">บิ๊กซี</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                    <option value="โคลีเซียม">โคลีเซียม</option>
                                    <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                    <option value="ปากแมว">ปากแมว</option>
                                    <option value="ภูเก็ต">ภูเก็ต</option>
                                    <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                    <option value="กระบี่">กระบี่</option>
                                    <option value="กะทู้">กะทู้</option>
                                    <option value="ตรัง">ตรัง</option>
                                    <option value="คุรุ">คุรุ</option>
                                    <option value="ชุมพร">ชุมพร</option>
                                    <option value="สตูล">สตูล</option>
                                    <option value="พัทลุง">พัทลุง</option>
                                    <option value="สงขลา">สงขลา</option>
                                </select>
                            </div>

                            <!-- Dynamic Items Section -->
                            <div class="border-t border-slate-100 pt-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-slate-700">รายการสินค้า</label>
                                    <button type="button" onclick="addBranchOrderItemRow()"
                                        class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold px-2 py-1 rounded-lg transition-colors">
                                        + เพิ่มสินค้า
                                    </button>
                                </div>
                                <div id="bo-items-container" class="space-y-3 max-h-60 overflow-y-auto pr-1">
                                    <!-- Items will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitBranchOrder()"
                    class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    บันทึกรายการ
                </button>
                <button type="button" onclick="closeModal('branchOrderModal')"
                    class="mt-3 w-full inline-flex justify-center rounded-xl border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>
    </div>


    <!-- Confirm Modal for Status Change -->
    <div id="statusUpdateModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 transform transition-all border border-slate-100">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <ion-icon name="sync-circle" class="text-indigo-500 text-2xl"></ion-icon>
                    อัปเดตสถานะนำเข้า
                </h3>
                <button onclick="closeModal('statusUpdateModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <button onclick="updateStockStatusFromModal('pending')"
                    class="group flex items-center justify-between p-4 rounded-2xl bg-amber-50 border border-amber-100 hover:bg-amber-100 hover:border-amber-200 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-amber-500 text-white flex items-center justify-center shadow-lg shadow-amber-500/20 group-hover:scale-110 transition-transform">
                            <ion-icon name="time-outline" class="text-xl"></ion-icon>
                        </div>
                        <div>
                            <div class="font-bold text-amber-900">รอนำเข้า</div>
                            <div class="text-xs text-amber-700/60 font-medium tracking-wide uppercase">Pending Review
                            </div>
                        </div>
                    </div>
                    <ion-icon name="chevron-forward-outline"
                        class="text-amber-400 group-hover:translate-x-1 transition-transform"></ion-icon>
                </button>

                <button onclick="updateStockStatusFromModal('importing')"
                    class="group flex items-center justify-between p-4 rounded-2xl bg-blue-50 border border-blue-100 hover:bg-blue-100 hover:border-blue-200 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-blue-500 text-white flex items-center justify-center shadow-lg shadow-blue-500/20 group-hover:scale-110 transition-transform">
                            <ion-icon name="bus-outline" class="text-xl"></ion-icon>
                        </div>
                        <div>
                            <div class="font-bold text-blue-900">กำลังนำเข้า</div>
                            <div class="text-xs text-blue-700/60 font-medium tracking-wide uppercase">Processing</div>
                        </div>
                    </div>
                    <ion-icon name="chevron-forward-outline"
                        class="text-blue-400 group-hover:translate-x-1 transition-transform"></ion-icon>
                </button>

                <button onclick="updateStockStatusFromModal('received')"
                    class="group flex items-center justify-between p-4 rounded-2xl bg-emerald-50 border border-emerald-100 hover:bg-emerald-100 hover:border-emerald-200 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-500/20 group-hover:scale-110 transition-transform">
                            <ion-icon name="checkmark-circle-outline" class="text-xl"></ion-icon>
                        </div>
                        <div>
                            <div class="font-bold text-emerald-900">สำเร็จ (ได้รับแล้ว)</div>
                            <div class="text-xs text-emerald-700/60 font-medium tracking-wide uppercase">Received</div>
                        </div>
                    </div>
                    <ion-icon name="chevron-forward-outline"
                        class="text-emerald-400 group-hover:translate-x-1 transition-transform"></ion-icon>
                </button>

                <button onclick="updateStockStatusFromModal('rejected')"
                    class="group flex items-center justify-between p-4 rounded-2xl bg-rose-50 border border-rose-100 hover:bg-rose-100 hover:border-rose-200 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-rose-500 text-white flex items-center justify-center shadow-lg shadow-rose-500/20 group-hover:scale-110 transition-transform">
                            <ion-icon name="close-circle-outline" class="text-xl"></ion-icon>
                        </div>
                        <div>
                            <div class="font-bold text-rose-900">ยกเลิก</div>
                            <div class="text-xs text-rose-700/60 font-medium tracking-wide uppercase">Rejected</div>
                        </div>
                    </div>
                    <ion-icon name="chevron-forward-outline"
                        class="text-rose-400 group-hover:translate-x-1 transition-transform"></ion-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- (*** NEW: Stock Detail Modal for Accessories ***) -->
    <div id="stockDetailModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-5xl h-[90vh] bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row">
            <!-- Left Column: Image Area -->
            <div class="w-full md:w-1/2 bg-slate-900 relative flex items-center justify-center group overflow-hidden">
                <img id="detail-bill-image" src=""
                    class="max-w-full max-h-full object-contain shadow-2xl transition-transform duration-500 group-hover:scale-105"
                    alt="Bill Image">

                <div class="absolute top-4 left-4 z-10">
                    <span
                        class="px-3 py-1 bg-black/50 text-white text-xs font-bold rounded-full backdrop-blur-md">รูปใบเสร็จ/บิล</span>
                </div>

                <!-- Expand Button -->
                <a id="detail-bill-link" href="#" target="_blank"
                    class="absolute bottom-6 right-6 p-3 bg-white text-slate-900 rounded-full shadow-lg hover:bg-yellow-400 transition-colors"
                    title="ดูรูปเต็ม">
                    <ion-icon name="expand-outline" class="text-xl"></ion-icon>
                </a>
            </div>

            <!-- Right Column: Info & Actions -->
            <div class="w-full md:w-1/2 flex flex-col h-full">
                <!-- Header -->
                <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50/50">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span id="detail-branch-badge"
                                class="px-2 py-0.5 rounded-md bg-white border border-slate-200 text-xs font-bold text-slate-600 shadow-sm">สาขา...</span>
                            <span id="detail-date-display" class="text-xs text-slate-400">...</span>
                        </div>
                        <h3 id="detail-supplier-title" class="text-xl font-bold text-slate-800 line-clamp-1">Supplier
                            Name</h3>
                        <p id="detail-by-user" class="text-xs text-slate-500 mt-0.5">แจ้งโดย: ...</p>
                    </div>
                    <button onclick="closeModal('stockDetailModal')" class="text-slate-400 hover:text-slate-600 p-1">
                        <ion-icon name="close" class="text-2xl"></ion-icon>
                    </button>
                </div>

                <!-- Items List (Scrollable) -->
                <div class="flex-1 overflow-y-auto p-6 bg-white custom-scrollbar">
                    <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <ion-icon name="list-circle" class="text-indigo-500 text-lg"></ion-icon> รายการสินค้าที่แจ้งเข้า
                    </h4>
                    <div id="detail-items-list" class="space-y-3">
                        <!-- Items injected here -->
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="p-6 border-t border-slate-100 bg-slate-50/30">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-bold text-slate-600">สถานะปัจจุบัน:</span>
                        <span id="detail-current-status" class="px-3 py-1 rounded-full text-xs font-bold">...</span>
                    </div>

                    <div id="detail-actions-container" class="grid grid-cols-2 gap-3">
                        <button id="btn-action-importing" onclick="updateStockStatusFromModal('importing')"
                            class="col-span-1 py-3 rounded-xl bg-blue-100 text-blue-700 font-bold hover:bg-blue-200 transition-colors flex items-center justify-center gap-2">
                            <ion-icon name="timer-outline"></ion-icon> กำลังนำเข้า
                        </button>
                        <button id="btn-action-received" onclick="updateStockStatusFromModal('received')"
                            class="col-span-1 py-3 rounded-xl bg-green-100 text-green-700 font-bold hover:bg-green-200 transition-colors flex items-center justify-center gap-2">
                            <ion-icon name="checkmark-circle-outline"></ion-icon> นำเข้าแล้ว
                        </button>
                        <button id="btn-action-reject" onclick="updateStockStatusFromModal('rejected')"
                            class="col-span-2 py-3 rounded-xl bg-white border border-red-200 text-red-500 font-bold hover:bg-red-50 transition-colors flex items-center justify-center gap-2">
                            <ion-icon name="close-circle-outline"></ion-icon> ยกเลิกรายการ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- =============================================== -->
    <div id="admin-view-content" class="hidden animate-fade-in">
        <div class="modal-content relative w-full max-w-md bg-white rounded-2xl shadow-2xl p-6 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <ion-icon name="warning" class="text-3xl"></ion-icon>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">ยืนยันการลบ</h3>
            <p class="text-slate-500 mb-6" id="confirm-message">คุณแน่ใจหรือไม่ว่าต้องการลบงานนี้?
                การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <p id="confirm-error-message" class="text-xs text-red-600 mb-4"></p>

            <div class="flex justify-center gap-3">
                <button type="button"
                    class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                    onclick="closeModal('confirmModal')">ยกเลิก</button>
                <button type="button" id="confirm-delete-button" data-task-id=""
                    class="px-6 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg shadow-red-600/30 transition-all">ยืนยันลบ</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800" id="user-modal-title">เพิ่มผู้ใช้ใหม่</h3>
                <button onclick="closeModal('userModal')" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8">
                <form id="user-form" class="space-y-6">
                    <input type="hidden" id="user-id" name="userId">
                    <input type="hidden" id="form-mode" name="mode" value="create">

                    <div>
                        <label for="user-company-input" class="block text-sm font-semibold text-slate-700 mb-2">บริษัท
                            (Company)</label>
                        <select id="user-company-input" name="companyId" required class="form-select-theme">
                            <option value="company_1_id">ซิลมีน โมบาย จำกัด</option>
                            <option value="company_2_id">เอสจี พลัส 2023 จำกัด</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="user-name-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">ชื่อ-สกุล</label>
                            <input type="text" id="user-name-input" name="name" required class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-role-input" class="block text-sm font-semibold text-slate-700 mb-2">ตำแหน่ง
                                (Role)</label>
                            <select id="user-role-input" name="role" required class="form-select-theme">
                                <option value="staff">พนักงาน (Staff)</option>
                                <option value="manager">ผู้จัดการ (Manager)</option>
                                <option value="hr">ฝ่ายบุคคล (HR)</option>
                                <option value="executive">ผู้บริหาร (Executive)</option>
                            </select>
                        </div>
                    </div>

                    <div id="auth-section"
                        class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                        <div>
                            <label for="user-username-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">Username (รหัสพนักงาน)</label>
                            <input type="text" id="user-username-input" name="username" required
                                class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-password-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">Password</label>
                            <input type="password" id="user-password-input" name="password" class="form-input-theme"
                                placeholder="เว้นว่างไว้หากไม่ต้องการเปลี่ยน">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="user-department-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">แผนก</label>
                            <input type="text" id="user-department-input" name="department" required
                                class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-branch-input" class="block text-sm font-semibold text-slate-700 mb-2">สาขา
                                (ถ้ามี)</label>
                            <input type="text" id="user-branch-input" name="branch" class="form-input-theme">
                        </div>
                    </div>

                    <div>
                        <label for="user-reportsTo-input"
                            class="block text-sm font-semibold text-slate-700 mb-2">หัวหน้างาน (Reports To)</label>
                        <select id="user-reportsTo-input" name="reportsTo" class="form-select-theme">
                            <option value="">--- ไม่มีหัวหน้า ---</option>
                        </select>
                    </div>

                    <div id="user-form-error"
                        class="hidden p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>

                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('userModal')">ยกเลิก</button>
                        <button type="submit" id="submit-user-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-slate-800">การแจ้งเตือน</h3>
                    <button onclick="deleteAllNotifications()"
                        class="text-xs text-red-500 hover:text-red-700 font-medium bg-red-50 px-2 py-1 rounded-lg transition-colors">
                        ลบทั้งหมด
                    </button>
                </div>
                <button onclick="closeModal('notificationModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>

            <div id="notification-list" class="max-h-[60vh] overflow-y-auto custom-scrollbar">
                <p class="text-center text-slate-400 p-8">ไม่มีการแจ้งเตือนใหม่</p>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50/50 flex justify-end">
                <button type="button"
                    class="px-6 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium transition-colors"
                    onclick="closeModal('notificationModal')">ปิด</button>
            </div>
        </div>
    </div>
    <div id="purchasingModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div
                class="bg-gradient-to-r from-blue-600 to-indigo-600 p-5 flex justify-between items-center text-white shadow-md">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                        <ion-icon name="cart" class="text-xl"></ion-icon>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold">อัปเดตสถานะ</h3>
                        <p class="text-blue-100 text-xs font-light">สำหรับฝ่ายจัดซื้อ</p>
                    </div>
                </div>
                <button onclick="closeModal('purchasingModal')"
                    class="hover:bg-white/10 p-2 rounded-full transition-colors"><ion-icon name="close"
                        class="text-2xl"></ion-icon></button>
            </div>
            <div class="p-6">
                <form id="purchasing-form" class="space-y-4">
                    <input type="hidden" id="pur-id">

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6 shadow-inner">
                        <div class="flex items-start gap-3">
                            <div class="mt-1 p-1.5 bg-yellow-100 text-yellow-600 rounded-md">
                                <ion-icon name="cube"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-semibold uppercase tracking-wider">สินค้า</p>
                                <p id="pur-product-display"
                                    class="font-bold text-slate-800 text-lg leading-tight mt-0.5">...</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-200 flex items-start gap-3">
                            <div class="mt-1 p-1.5 bg-green-100 text-green-600 rounded-md">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-semibold uppercase tracking-wider">ลูกค้า</p>
                                <p id="pur-customer-display" class="font-medium text-slate-700 mt-0.5">...</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">สถานะสินค้า</label>
                        <select id="pur-status" class="form-select-theme">
                            <option value="pending">⏳ รอดำเนินการ (Pending)</option>
                            <option value="ordered">🚚 สั่งของแล้ว (Ordered)</option>
                            <option value="arrived">✅ ของถึงปลายทางแล้ว (Arrived)</option>
                            <option value="canceled">❌ ยกเลิก (Canceled)</option>
                        </select>
                    </div>

                    <!-- (*** เพิ่ม: วันที่คาดว่าของจะมาถึง ***) -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">วันที่คาดว่าของจะมาถึง (Expected
                            Arrival)</label>
                        <input type="date" id="pur-arrival-date" class="form-input-theme">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">หมายเหตุ (เช่น เลขพัสดุ)</label>
                        <textarea id="pur-note" rows="3" class="form-input-theme"
                            placeholder="ระบุรายละเอียดเพิ่มเติม..."></textarea>
                    </div>

                    <div class="pt-4 flex justify-end gap-3">
                        <button type="button" onclick="closeModal('purchasingModal')"
                            class="px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100">ยกเลิก</button>
                        <button type="submit"
                            class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-600/30">บันทึกสถานะ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- (*** New: Deposit Detail Modal ***) -->
    <div id="depositDetailModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-sm bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div
                class="bg-gradient-to-r from-teal-500 to-emerald-600 p-4 flex justify-between items-center text-white shadow-md">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <ion-icon name="information-circle"></ion-icon> รายละเอียดเพิ่มเติม
                </h3>
                <button onclick="closeModal('depositDetailModal')"
                    class="hover:bg-white/10 p-1 rounded-full transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-6 space-y-4">

                <!-- Customer Context -->
                <div class="text-center border-b border-slate-100 pb-4 mb-2">
                    <p class="text-xs text-slate-400 font-semibold mb-1">ลูกค้า</p>
                    <p id="detail-customer-name" class="font-bold text-slate-800 text-lg">...</p>
                </div>

                <!-- Purchasing Status -->
                <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div class="flex items-center gap-2 text-slate-600 font-medium">
                        <ion-icon name="cart" class="text-blue-500 text-lg"></ion-icon>
                        <span>สถานะจัดซื้อ</span>
                    </div>
                    <div id="detail-status-badge">...</div>
                </div>

                <!-- Expected Arrival -->
                <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div class="flex items-center gap-2 text-slate-600 font-medium">
                        <ion-icon name="calendar" class="text-orange-500 text-lg"></ion-icon>
                        <span>ของจะมาถึง</span>
                    </div>
                    <span id="detail-arrival-date" class="font-bold text-slate-800">...</span>
                </div>

                <!-- Close Button -->
                <div class="pt-2">
                    <button onclick="closeModal('depositDetailModal')"
                        class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-medium transition-colors">
                        ปิดหน้าต่าง
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Stock Request (Create) -->
    <div id="stockRequestModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">แจ้งเบิกสินค้าใหม่</h3>
                <button onclick="closeModal('stockRequestModal')" class="text-slate-400 hover:text-slate-600">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label for="stock-request-title" class="block text-sm font-bold text-slate-700 mb-2">ชื่อรายการ
                        (เช่น เบิกเคส iPhone 15, เบิกสายชาร์จ)</label>
                    <input type="text" id="stock-request-title" class="form-input-theme w-full"
                        placeholder="ระบุชื่อรายการแจ้งเบิก..." required>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-semibold text-slate-700">รายการสินค้าที่ต้องการเบิก</label>
                    <button type="button" onclick="addStockRequestItemRow()"
                        class="text-sm font-bold text-yellow-600 bg-yellow-50 hover:bg-yellow-100 px-3 py-1.5 rounded-lg transition-all flex items-center gap-1">
                        <ion-icon name="add-circle"></ion-icon> เพิ่มแถว
                    </button>
                </div>

                <div id="stock-request-items-container"
                    class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Dynamic rows added by JS -->
                </div>

                <div>
                    <label for="stock-request-note"
                        class="block text-sm font-semibold text-slate-700 mb-2">หมายเหตุเพิ่มเติม</label>
                    <textarea id="stock-request-note" rows="3" class="form-input-theme"
                        placeholder="ระบุรายละเอียด เช่น สี, ขนาด, หรือเหตุผลการเบิก..."></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-slate-50">
                    <button type="button" onclick="closeModal('stockRequestModal')"
                        class="px-6 py-2.5 rounded-xl text-slate-500 font-medium hover:bg-slate-50 transition-colors">ยกเลิก</button>
                    <button type="button" onclick="submitStockRequest()"
                        class="px-8 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">ส่งรายการแจ้งเบิก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Manage Stock Request (Purchasing) -->
    <div id="manageRequestModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-lg bg-white rounded-[2.5rem] shadow-2xl overflow-hidden ring-1 ring-slate-200">
            <!-- Header -->
            <div
                class="bg-gradient-to-r from-slate-900 to-indigo-950 px-8 py-8 flex justify-between items-center text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 w-48 h-48 bg-indigo-500/10 rounded-full blur-3xl -mr-20 -mt-20">
                </div>
                <div class="relative z-10">
                    <h3 class="text-2xl font-black tracking-tight flex items-center gap-3">
                        <div class="p-2.5 bg-white/10 rounded-xl backdrop-blur-md">
                            <ion-icon name="build-outline" class="text-xl"></ion-icon>
                        </div>
                        จัดการคำขอเบิก
                    </h3>
                    <p class="text-indigo-200/70 text-sm font-medium mt-1">อัปเดตสถานะและข้อมูลการส่งมวลสาร</p>
                </div>
                <button onclick="closeModal('manageRequestModal')"
                    class="hover:bg-white/10 p-2.5 rounded-2xl transition-all text-indigo-300 hover:text-white relative z-10 active:scale-90">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>

            <!-- Body -->
            <div class="p-8 space-y-8 bg-slate-50/30">
                <!-- Items Summary Section -->
                <div id="manage-request-items-list">
                    <!-- Items will be injected here -->
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Status Selection -->
                    <div class="space-y-2">
                        <label for="manage-request-status"
                            class="block text-xs font-black text-slate-500 uppercase tracking-widest ml-1">สถานะใหม่</label>
                        <div class="relative group">
                            <ion-icon name="swap-horizontal-outline"
                                class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                            <select id="manage-request-status"
                                class="w-full pl-11 pr-10 py-3.5 rounded-2xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-all shadow-sm appearance-none">
                                <option value="pending">⏳ รอสั่ง</option>
                                <option value="processing">📦 กำลังสั่ง</option>
                                <option value="received">✅ สินค้าถึงสาขาแล้ว</option>
                                <option value="canceled">❌ ยกเลิก</option>
                            </select>
                            <ion-icon name="chevron-down"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                        </div>
                    </div>

                    <!-- Arrival Date -->
                    <div class="space-y-2">
                        <label for="manage-request-arrival"
                            class="block text-xs font-black text-slate-500 uppercase tracking-widest ml-1">วันที่ของถึง</label>
                        <div class="relative group">
                            <ion-icon name="calendar-clear-outline"
                                class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                            <input type="date" id="manage-request-arrival"
                                class="w-full pl-11 pr-4 py-3.5 rounded-2xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all shadow-sm">
                        </div>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('manageRequestModal')"
                        class="flex-1 py-4 rounded-2xl text-slate-500 font-bold hover:bg-slate-100 transition-all border border-transparent hover:border-slate-200">ยกเลิก</button>
                    <button type="button" onclick="updateRequestStatus()"
                        class="flex-[2] py-4 rounded-2xl bg-slate-900 hover:bg-indigo-950 text-white font-black shadow-xl shadow-slate-900/20 transition-all flex items-center justify-center gap-2 active:scale-[0.98]">
                        <ion-icon name="save-outline" class="text-xl"></ion-icon>
                        <span>ยืนยันการบันทึก</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = '/api';
        let currentUser = null;
        let currentView = 'dashboard';
        let notificationPollInterval = null;
        let allDashboardTasks = [];
        let allMyTasks = [];

        // --- Helper Functions ---
        const getRoleName = (role) => {
            switch (role) {
                case 'executive': return 'ผู้บริหาร';
                case 'manager': return 'ผู้จัดการ';
                case 'hr': return 'ฝ่ายบุคคล (HR)';
                case 'staff': return 'พนักงาน';
                default: return role;
            }
        };
        const getStatusTag = (status) => {
            const map = {
                'todo': { text: 'รอทำ', bg: 'bg-slate-100', color: 'text-slate-600' },
                'in-progress': { text: 'กำลังทำ', bg: 'bg-yellow-100', color: 'text-yellow-700' },
                'for-review': { text: 'ส่งตรวจสอบ', bg: 'bg-orange-100', color: 'text-orange-700' },
                'completed': { text: 'เสร็จสิ้น', bg: 'bg-green-100', color: 'text-green-700' },
                'overdue': { text: 'เลยกำหนด', bg: 'bg-red-100', color: 'text-red-700' },
                // Import Statuses
                'pending': { text: 'รอนำเข้า', bg: 'bg-yellow-50', color: 'text-yellow-700' },
                'importing': { text: 'กำลังนำเข้า', bg: 'bg-blue-50', color: 'text-blue-700' },
                'received': { text: 'นำเข้าแล้ว', bg: 'bg-green-50', color: 'text-green-700' },
                'rejected': { text: 'ยกเลิก', bg: 'bg-red-50', color: 'text-red-700' }
            };
            const s = map[status] || map['todo'];
            return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${s.bg} ${s.color}">${s.text}</span>`;
        };
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const safeHide = (el) => { if (el) el.classList.add('hidden'); };
        const safeShow = (el) => { if (el) el.classList.remove('hidden'); };

        const initializeAuth = () => {
            const token = localStorage.getItem('token');
            const userString = localStorage.getItem('user');

            if (!token || !userString) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userString);

            // แสดงชื่อและตำแหน่ง
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = getRoleName(currentUser.role);

            // เตรียมข้อมูลแผนก (ตัดช่องว่างซ้ายขวาออกเพื่อความชัวร์)
            const userDept = (currentUser.department || '').trim();

            // Populate Branches
            populateBranchSelects();

            // =======================================================
            // 1. ควบคุมเมนู "เงินค่ามัดจำหน้าร้าน" (Sales / Storefront)
            // =======================================================
            const depositNav = document.getElementById('nav-Storefront_deposit');
            if (depositNav) {
                const isSalesTeam = userDept.includes('ขาย') || userDept.includes('Sales');

                // แสดงเมนูนี้ถ้าเป็น: ทีมขาย, Admin, Executive, Manager, หรือ HR
                if (isSalesTeam || ['admin', 'executive', 'manager', 'hr'].includes(currentUser.role)) {
                    depositNav.style.display = 'flex';
                } else {
                    depositNav.style.display = 'none';
                }
            }

            const purchasingNav = document.getElementById('nav-purchasing');
            if (purchasingNav) {
                const isPurchasing = userDept.includes('จัดซื้อ') || userDept.includes('Purchase');

                // แสดงเมนูนี้ถ้าเป็น: ทีมจัดซื้อ, Admin, Executive, หรือ Manager
                // (HR อาจจะไม่จำเป็นต้องดู แต่ถ้าอยากให้ดูได้ก็เติม 'hr' เข้าไปใน array ได้ครับ)
                if (isPurchasing || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    purchasingNav.style.display = 'flex';
                } else {
                    purchasingNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2.1 [ใหม่] ควบคุมเมนู "แจ้งนำเข้า" (Import Notification)
            // =======================================================
            const importNav = document.getElementById('nav-import');
            if (importNav) {
                const isSales = userDept.includes('ขาย') || userDept.includes('Sales');
                // แสดงเมนูนี้ถ้าเป็น: ทีมขาย (Sales), Admin, Executive, Manager
                if (isSales || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    importNav.classList.remove('hidden');
                    importNav.style.display = 'flex';
                } else {
                    importNav.classList.add('hidden');
                    importNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2.2 [ใหม่] ควบคุมเมนู "จัดการรายการนำเข้า" (Stock Import)
            // =======================================================
            const stockImportNav = document.getElementById('nav-stock-import');
            if (stockImportNav) {
                const isStockTeam = userDept.includes('Store') || userDept.includes('Stock') || userDept.includes('สต๊อก');
                if (isStockTeam || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    stockImportNav.classList.remove('hidden');
                    stockImportNav.style.display = 'flex';
                } else {
                    stockImportNav.classList.add('hidden');
                    stockImportNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2.3 [ใหม่] ควบคุมเมนู "แจ้งเบิกสินค้า" และ "จัดการคำขอเบิก"
            // =======================================================
            const stockRequestNav = document.getElementById('nav-stock-request');
            const stockRequestManageNav = document.getElementById('nav-stock-request-manage');

            if (stockRequestNav) {
                const isSales = userDept.includes('ขาย') || userDept.includes('Sales');
                if (isSales || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    stockRequestNav.style.display = 'flex';
                } else {
                    stockRequestNav.style.display = 'none';
                }
            }

            if (stockRequestManageNav) {
                const isPurchasing = userDept.includes('จัดซื้อ') || userDept.includes('Purchase');
                if (isPurchasing || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    stockRequestManageNav.style.display = 'flex';
                    stockRequestManageNav.classList.remove('hidden');
                } else {
                    stockRequestManageNav.style.display = 'none';
                    stockRequestManageNav.classList.add('hidden');
                }
            }

            // =======================================================
            // 2.4 [ใหม่] ควบคุมเมนู "สั่งของลงสาขา" และ "รายการของลงสาขา"
            // =======================================================
            const branchOrderNav = document.getElementById('nav-branch-order');
            const branchOrderInvNav = document.getElementById('nav-branch-order-inventory');

            if (branchOrderNav && branchOrderInvNav) {
                const isPurchasing = userDept.includes('จัดซื้อ') || userDept.includes('Purchase');
                const isSales = userDept.includes('ขาย') || userDept.includes('Sales');

                // Logic for "สั่งของลงสาขา" (Management/Purchasing/HR)
                const canManageOrders = isPurchasing || ['admin', 'executive', 'manager', 'hr'].includes(currentUser.role);
                // Logic for "รายการของลงสาขา" (Sales/Management/HR)
                const canViewInventory = isSales || ['executive', 'manager', 'hr', 'admin'].includes(currentUser.role);

                if (canManageOrders) {
                    branchOrderNav.style.display = 'flex';
                    branchOrderNav.classList.remove('hidden');
                } else {
                    branchOrderNav.style.display = 'none';
                    branchOrderNav.classList.add('hidden');
                }

                if (canViewInventory) {
                    branchOrderInvNav.style.display = 'flex';
                    branchOrderInvNav.classList.remove('hidden');
                } else {
                    branchOrderInvNav.style.display = 'none';
                    branchOrderInvNav.classList.add('hidden');
                }
            }

            // =======================================================
            // 2.5 [ใหม่] ควบคุมเมนู "แจ้งเคลมอุปกรณ์เสริม"
            // =======================================================
            const claimNav = document.getElementById('nav-claim');
            if (claimNav) {
                const isSales = userDept.includes('ขาย') || userDept.includes('sales');
                // Allow: Sales Dept (any role including staff) OR Admin/Exec/Manager
                if (isSales || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    claimNav.style.display = 'flex';
                    claimNav.classList.remove('hidden');
                } else {
                    claimNav.style.display = 'none';
                    claimNav.classList.add('hidden');
                }
            }

            const stockClaimNav = document.getElementById('nav-stock-claim');
            if (stockClaimNav) {
                const stockKeywords = ['stock', 'store', 'สต๊อก', 'คลัง', 'warehouse', 'supply'];
                const isStockTeam = stockKeywords.some(keyword => userDept.includes(keyword));

                if (isStockTeam || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    stockClaimNav.style.display = 'flex';
                    stockClaimNav.classList.remove('hidden');
                } else {
                    stockClaimNav.classList.add('hidden');
                }
            }

            // =======================================================
            // 3. กำหนดหน้าจอเริ่มต้นตามตำแหน่ง (Role Logic)
            // =======================================================
            if (currentUser.role === 'staff') {
                // --- พนักงานทั่วไป (Staff) ---
                safeHide(document.getElementById('nav-dashboard'));
                safeHide(document.getElementById('nav-admin'));

                if (document.getElementById('company-select')) {
                    document.getElementById('company-select').parentElement.style.display = 'none';
                }

                // เปลี่ยนข้อความ Header
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = 'ผู้มอบหมายงาน';

                // เข้าสู่หน้า "งานของฉัน" เป็นหน้าแรก
                updateNavActiveState('mytasks');
                fetchMyTasks();

            } else if (currentUser.role === 'executive') {
                // --- ผู้บริหาร (Executive) ---
                safeHide(document.getElementById('nav-mytasks'));

                // เข้าสู่หน้า Dashboard เป็นหน้าแรก
                updateNavActiveState('dashboard');
                fetchDashboardTasks();
                fetchTaskStats();
                fetchAllUsers();

            } else if (currentUser.role === 'manager' || currentUser.role === 'hr') {
                // --- ผู้จัดการ (Manager) และ HR ---
                // (แสดง Dashboard แต่ยังเข้าเมนู My Tasks ได้ถ้าไม่ได้ซ่อน)

                updateNavActiveState('dashboard');
                fetchDashboardTasks();
                fetchTaskStats();
                fetchAllUsers();
            }

            // =======================================================
            // 4. ตั้งค่าระบบอื่นๆ (Logout / Notifications)
            // =======================================================
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                clearInterval(notificationPollInterval);
                window.location.href = 'login.html';
            });

            fetchNotifications();
            notificationPollInterval = setInterval(fetchNotifications, 60000);
        };

        // ------------------------------------------
        // --- (A) TASK FUNCTIONS ---
        // ------------------------------------------
        const fetchTaskStats = async () => {
            const token = localStorage.getItem('token');
            const selectedCompanyId = document.getElementById('company-select').value;
            const statsDiv = document.getElementById('stats-cards');
            statsDiv.innerHTML = `<div class="text-sm text-gray-500">กำลังโหลดสถิติ...</div>`;
            try {
                const response = await fetch(`${SERVER_URL}/tasks/stats?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { statsDiv.innerHTML = `<div class="text-sm text-red-500">โหลดสถิติไม่สำเร็จ</div>`; return; }
                const stats = await response.json();

                statsDiv.innerHTML = `
                    <div onclick="filterTasksByStatus('todo')" data-status="todo" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-gray-100 text-gray-600"><ion-icon name="clipboard-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">สั่งแล้ว</p><p class="text-2xl font-bold text-gray-900">${stats.todo || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('in-progress')" data-status="in-progress" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-yellow-100 text-yellow-600"><ion-icon name="ellipsis-horizontal-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">กำลังดำเนินการ</p><p class="text-2xl font-bold text-gray-900">${stats.inProgress || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('for-review')" data-status="for-review" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-amber-100 text-amber-600"><ion-icon name="search-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">ส่งตรวจสอบ</p><p class="text-2xl font-bold text-gray-900">${stats.forReview || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('completed')" data-status="completed" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-green-100 text-green-600"><ion-icon name="checkmark-done-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">งานที่เสร็จสิ้น</p><p class="text-2xl font-bold text-gray-900">${stats.completed || 0}</p></div></div>
                    </div>
                `;
            } catch (error) {
                console.error('Fetch Stats Error:', error);
                statsDiv.innerHTML = `<div class="text-sm text-red-500">เกิดข้อผิดพลาดในการโหลดสถิติ</div>`;
            }
        };

        const fetchAllUsers = async () => {
            const token = localStorage.getItem('token');
            const selectElement = document.getElementById('taskAssignTo');
            const selectedCompanyId = document.getElementById('company-select').value;
            selectElement.innerHTML = '<option value="" disabled selected>--- กำลังโหลด... ---</option>';
            selectElement.disabled = true;
            try {
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                if (!response.ok) { selectElement.innerHTML = '<option value="" disabled selected>--- โหลดรายชื่อไม่สำเร็จ ---</option>'; return; }
                const users = await response.json();
                selectElement.innerHTML = '';
                selectElement.disabled = false;
                selectElement.prepend(new Option('--- เลือกผู้รับผิดชอบ ---', '', true, true));
                if (selectElement.tomselect) {
                    selectElement.tomselect.destroy();
                }
                users.forEach(user => {
                    if (user && user._id) {
                        const option = document.createElement('option');
                        option.value = user._id;
                        option.textContent = `${user.name} (${user.branch || user.department})`;
                        selectElement.appendChild(option);
                    }
                });
            } catch (error) {
                selectElement.innerHTML = '<option value="" disabled selected>--- โหลดรายชื่อไม่สำเร็จ (Server Down?) ---</option>';
            }
        };

        const fetchDashboardTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = '';
            const selectedCompanyId = document.getElementById('company-select').value;
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=dashboard&companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || 'ไม่สามารถดึงข้อมูลงานได้';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();

                allDashboardTasks = tasks;      // เก็บงานทั้งหมดลง Cache
                renderTaskTable(tasks);         // แสดงผลทั้งหมด (ปกติ)
                filterTasksByStatus('todo');

            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };

        const fetchMyTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = '';
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=mytasks`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || 'ไม่สามารถดึงข้อมูลงานได้';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();
                allMyTasks = tasks;     // 1. เก็บข้อมูลทั้งหมดไว้ในตัวแปรกลาง
                updateMyTaskCounts();   // 2. อัปเดตตัวเลขบนปุ่ม
                filterMyTasks('todo'); // 3. Default แสดง Todo
            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };

        const renderTaskTable = (tasks) => {
            const taskTableBody = document.getElementById('task-table-body');

            // อัปเดตจำนวนงาน (ถ้ามี element นี้)
            const countElement = document.getElementById('task-count');
            if (countElement) countElement.textContent = `${tasks.length} งาน`;

            // 1. กรณีไม่มีงาน
            if (tasks.length === 0) {
                taskTableBody.innerHTML = `<tr id="no-task-row" class="text-center"><td colspan="5" class="px-6 py-4 text-gray-500">ไม่มีงานที่ต้องแสดงในขณะนี้</td></tr>`;
                return;
            }

            taskTableBody.innerHTML = '';

            // 2. วนลูปแสดงงาน
            tasks.forEach((task, index) => {
                // ตรวจสอบงานเกินกำหนด
                const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'completed';
                const statusDisplay = isOverdue ? getStatusTag('overdue') : getStatusTag(task.status);

                // --- LOGIC การเลือกแสดงชื่อ (ผู้รับผิดชอบ VS ผู้สั่งงาน) ---
                let personName = 'Unknown User';
                let personSubText = '-';
                let personImageChar = '?';
                let showBranchBadge = false; // ตัวแปรเช็คว่าจะโชว์ Badge สาขาไหม

                // ตรวจสอบว่าเป็นหน้า "งานของฉัน" หรือไม่ (ต้องมีตัวแปร currentView ในระบบ)
                const isMyTasksView = (typeof currentView !== 'undefined' && currentView === 'mytasks');

                if (isMyTasksView) {
                    // >> กรณีหน้างานของฉัน: แสดง "ผู้สั่งงาน" (Created By)
                    if (task.createdBy) {
                        personName = task.createdBy.name || 'ไม่ระบุชื่อ';
                        personSubText = 'ผู้สั่งงาน'; // ข้อความระบุสถานะ
                        personImageChar = personName.charAt(0);
                    } else {
                        personName = 'ไม่ระบุ';
                        personSubText = 'ผู้สั่งงาน';
                    }
                    // ปกติผู้สั่งงานไม่ต้องโชว์ Badge สาขาก็ได้ (หรือถ้าต้องการก็เปิดได้)
                    showBranchBadge = false;

                } else {
                    // >> กรณีหน้าอื่น (Dashboard): แสดง "ผู้รับผิดชอบ" (Assigned To)
                    if (task.assignedTo) {
                        personName = task.assignedTo.name || 'Unknown User';
                        // ดึงสังกัด (ถ้ามีสาขาให้แสดงสาขา ถ้าไม่มีให้แสดงแผนก)
                        personSubText = task.assignedTo.branch || task.assignedTo.department || 'N/A';
                        personImageChar = personName.charAt(0);
                    }
                    // แสดง Badge สาขาเฉพาะเมื่อดูในมุมมองผู้รับผิดชอบ และงานนั้นมีระบุสาขา
                    showBranchBadge = true;
                }

                // --- LOGIC การแสดงชื่อและ Badge ---
                let nameDisplayHtml = personName;

                // ถ้า Logic อนุญาตให้โชว์ Badge และ Task มีข้อมูล Branch
                if (showBranchBadge && task.branch) {
                    nameDisplayHtml += ` <span class="ml-2 px-2 py-0.5 text-xs rounded bg-indigo-100 text-indigo-800 border border-indigo-200">สาขา${task.branch}</span>`;
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition-colors duration-150';
                // คลิกที่แถวเพื่อดูรายละเอียด (ถ้าเผลอคลิกปุ่มจะไม่ซ้อนทับกัน เพราะปุ่มมี event แยก)
                row.onclick = (e) => {
                    // ป้องกันการเปิด Modal ซ้อนถ้าคลิกโดนปุ่ม "เพิ่มเติม" โดยตรง (Optional)
                    if (!e.target.closest('button')) openDetailModal(task._id);
                };

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="ml-0">
                                <div class="text-sm font-medium text-gray-900">
                                    <span class="font-bold text-yellow-600 mr-2">${index + 1}.</span>${task.title}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <img class="h-8 w-8 rounded-full object-cover shadow-sm" 
                                 src="https://placehold.co/100x100/e0e7ff/4f46e5?text=${encodeURIComponent(personImageChar)}" 
                                 alt="">
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900 flex items-center">
                                    ${nameDisplayHtml}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? 'text-red-500 font-bold' : 'text-gray-500'}">
                        ${formatDate(task.dueDate)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-amber-600 hover:text-amber-800 bg-amber-50 hover:bg-amber-100 px-3 py-1 rounded-md transition-colors" onclick="openDetailModal('${task._id}')">
                            เพิ่มเติม
                        </button>
                    </td>
                `;
                taskTableBody.appendChild(row);
            });
        };

        const filterTasksByStatus = (status) => {
            // 1. ไฮไลท์การ์ดที่เลือก
            const statCards = document.querySelectorAll('#stats-cards [data-status]');
            statCards.forEach(card => {
                if (card.getAttribute('data-status') === status) {
                    card.classList.add('ring-2', 'ring-amber-500', 'shadow-lg');
                } else {
                    card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
                }
            });

            // 2. กรองงานจาก Cache
            const filteredTasks = allDashboardTasks.filter(task => task.status === status);

            // 3. วาดตารางใหม่
            renderTaskTable(filteredTasks);
        };

        const clearTaskFilterHighlights = () => {
            const statCards = document.querySelectorAll('#stats-cards [data-status]');
            statCards.forEach(card => {
                card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
            });
        };

        const handleNewTaskSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const submitButton = document.getElementById('submit-task-btn');
            const errorBox = document.getElementById('new-task-error');
            if (!data.assignedTo || data.assignedTo === "") {
                errorBox.textContent = 'กรุณาเลือกผู้รับผิดชอบงาน'; safeShow(errorBox); return;
            }
            const postData = { ...data, companyId: document.getElementById('company-select').value, dueDate: data.dueDate ? new Date(data.dueDate).toISOString() : null };
            submitButton.disabled = true; submitButton.querySelector('#submit-task-text').textContent = 'กำลังสร้าง...'; safeShow(submitButton.querySelector('#submit-task-spinner'));
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(postData)
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('newTaskModal'); form.reset(); fetchDashboardTasks(); fetchTaskStats();
                fetchNotifications();
            } catch (error) {
                errorBox.textContent = `สร้างงานไม่สำเร็จ: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.querySelector('#submit-task-text').textContent = 'สร้างงาน'; safeHide(submitButton.querySelector('#submit-task-spinner'));
            }
        };

        const openDetailModal = async (taskId) => {
            openModal('taskDetailModal');
            const token = localStorage.getItem('token');
            const errorBox = document.getElementById('update-task-error');
            const deleteTaskBtn = document.getElementById('delete-task-btn');
            safeHide(errorBox);
            document.getElementById('detail-task-title').textContent = "กำลังโหลด...";
            document.getElementById('detail-task-desc').textContent = "...";
            document.getElementById('detail-task-creator').textContent = "...";
            document.getElementById('detail-task-dueDate').textContent = "...";
            document.getElementById('detail-task-comment').value = '';
            document.getElementById('save-task-details-btn').disabled = true;

            const handleDeleteTask = async () => {
                const taskTitle = document.getElementById('detail-task-title').textContent;
                const confirmMsg = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-delete-button');
                confirmMsg.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบงาน: "${taskTitle}"? การกระทำนี้ไม่สามารถย้อนกลับได้`;
                confirmBtn.setAttribute('data-task-id', taskId);
                document.getElementById('confirm-error-message').textContent = '';
                openModal('confirmModal');
            };

            // deleteTaskBtn.replaceWith(deleteTaskBtn.cloneNode(true)); // Removed to avoid detachment issues

            // [DEBUG] Log deletion setup

            // Ensure we get the fresh element from DOM
            const freshDeleteBtn = document.getElementById('delete-task-btn');

            // Remove old listeners by cloning OR just overwriting onclick (safer here)
            // Using onclick ensures previous listeners are replaced without DOM node replacement issues
            freshDeleteBtn.onclick = () => {
                handleDeleteTask();
            };

            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                const task = await response.json();
                document.getElementById('detail-task-id').value = task._id;
                document.getElementById('detail-task-title').textContent = task.title;
                document.getElementById('detail-task-desc').textContent = task.description || '(ไม่มีรายละเอียด)';
                document.getElementById('detail-task-status').value = task.status;
                document.getElementById('detail-task-creator').textContent = task.createdBy ? task.createdBy.name : 'N/A';
                document.getElementById('detail-task-dueDate').textContent = formatDate(task.dueDate);
                const commentsList = document.getElementById('detail-task-comments-list');
                commentsList.innerHTML = '';
                if (task.comments && task.comments.length > 0) {
                    task.comments.slice().reverse().forEach(comment => {
                        const commentEl = document.createElement('div');
                        commentEl.className = 'text-sm pb-2 mb-2 border-b border-gray-200';
                        commentEl.innerHTML = `<p class="text-gray-800">${comment.text}</p><p class="text-xs text-gray-500">โดย: ${comment.name} - ${new Date(comment.timestamp).toLocaleString('th-TH')}</p>`;
                        commentsList.appendChild(commentEl);
                    });
                } else {
                    commentsList.innerHTML = '<p class="text-sm text-gray-500">ไม่มีประวัติการอัปเดต</p>';
                }
                const userRole = (currentUser.role || '').toLowerCase();
                const canDelete = ['executive', 'manager', 'hr'].includes(userRole);

                if (canDelete) {
                    document.getElementById('delete-task-btn').style.display = 'inline-flex';
                } else {
                    document.getElementById('delete-task-btn').style.display = 'none';
                }
            } catch (error) {
                console.error('Open Detail Modal Error:', error);
                errorBox.textContent = 'ไม่สามารถดึงข้อมูลงานได้ (Error: ' + error.message + ')';
                safeShow(errorBox);
            } finally {
                document.getElementById('save-task-details-btn').disabled = false;
            }
        };

        const handleUpdateTaskSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const status = document.getElementById('detail-task-status').value;
            const taskId = document.getElementById('detail-task-id').value;
            const commentText = document.getElementById('detail-task-comment').value;
            const errorBox = document.getElementById('update-task-error');
            const submitButton = document.getElementById('save-task-details-btn');
            submitButton.disabled = true; submitButton.textContent = 'กำลังบันทึก...';
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status, commentText: commentText })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
                fetchNotifications();
            } catch (error) {
                errorBox.textContent = `อัปเดตไม่สำเร็จ: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.textContent = 'บันทึกการเปลี่ยนแปลง';
            }
        };

        const executeDelete = async () => {
            const token = localStorage.getItem('token');
            const deleteButton = document.getElementById('confirm-delete-button');
            const errorMsg = document.getElementById('confirm-error-message');
            const taskId = deleteButton.getAttribute('data-task-id');
            if (!taskId) { errorMsg.textContent = 'เกิดข้อผิดพลาด: ไม่พบ ID งาน'; return; }
            deleteButton.disabled = true; deleteButton.textContent = 'กำลังลบ...'; errorMsg.textContent = '';
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('confirmModal'); closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
            } catch (error) {
                errorMsg.textContent = `ลบไม่สำเร็จ: ${error.message}`;
            } finally {
                deleteButton.disabled = false; deleteButton.textContent = 'ตกลง';
            }
        };

        // ------------------------------------------
        // --- (B) USER FUNCTIONS ---
        // ------------------------------------------
        const fetchAllUsersForTable = async () => {
            safeShow(document.getElementById('loading-users'));
            const token = localStorage.getItem('token');
            const userTableBody = document.getElementById('user-table-body');
            userTableBody.innerHTML = '';
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                safeHide(document.getElementById('loading-users'));
                if (!response.ok) { throw new Error('ไม่สามารถดึงข้อมูลผู้ใช้'); }
                const users = await response.json();
                document.getElementById('user-count').textContent = `${users.length} คน`;
                if (users.length === 0) {
                    userTableBody.innerHTML = `<tr id="no-user-row" class="text-center"><td colspan="6" class="px-6 py-4 text-slate-500">ไม่มีผู้ใช้ในระบบ</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50';
                    row.setAttribute('data-name', (user.name || '').toLowerCase());
                    row.setAttribute('data-username', (user.username || '').toLowerCase());
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${user.name}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.username}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${getRoleName(user.role)}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.branch || user.department}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.reportsTo ? user.reportsTo.name : '-'}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-amber-600 hover:text-amber-800" onclick="openEditUserModal('${user._id}')">แก้ไข</button>
                            <button class="text-red-600 hover:text-red-900 ml-4" onclick="executeDeleteUser('${user._id}', '${user.name}')">ลบ</button>
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });
            } catch (error) {
                safeHide(document.getElementById('loading-users'));
                userTableBody.innerHTML = `<tr class="text-center"><td colspan="6" class="px-6 py-4 text-red-500">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
            }
        };

        // ------------------------------------------
        // --- (C) NOTIFICATION FUNCTIONS ---
        // ------------------------------------------
        const filterUsersByName = (query) => {
            const rows = document.querySelectorAll('#user-table-body tr:not(#no-user-row)');
            const lowerQuery = query.toLowerCase();

            rows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const username = row.getAttribute('data-username') || '';

                if (name.includes(lowerQuery) || username.includes(lowerQuery)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        // Add listener for search input
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('user-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterUsersByName(e.target.value);
                });
            }
        });

        const fetchNotifications = async () => {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                // 1. ดึงข้อมูลจาก Server
                const response = await fetch(`${SERVER_URL}/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();

                // จัดการโครงสร้างข้อมูล (รองรับทั้งแบบส่งมาเป็น Array โดยตรง หรือส่งมาเป็น Object)
                const notifications = Array.isArray(data) ? data : (data.notifications || []);

                // คำนวณจำนวนที่ยังไม่อ่าน
                const unreadCount = typeof data.unreadCount === 'number'
                    ? data.unreadCount
                    : notifications.filter(n => !n.isRead).length;

                // --- ส่วนที่ 1: จัดการจุดแดง (Red Dot) ---

                // ฟังก์ชันช่วยเปิด/ปิดจุด (ใช้ได้ทั้ง Desktop และ Mobile)
                const toggleDot = (elementId, show) => {
                    const el = document.getElementById(elementId);
                    if (el) {
                        if (show) el.classList.remove('hidden');
                        else el.classList.add('hidden');
                    }
                };

                // อัปเดตจุดแดงทั้ง 2 จุดพร้อมกัน
                const hasUnread = unreadCount > 0;
                toggleDot('notification-dot', hasUnread);          // สำหรับ Desktop
                toggleDot('notification-dot-mobile', hasUnread);   // สำหรับ Mobile (ที่คุณเพิ่งเพิ่ม)

                // --- ส่วนที่ 2: แสดงรายการแจ้งเตือนใน Dropdown ---
                const listContainer = document.getElementById('notification-list');
                if (listContainer) {
                    listContainer.innerHTML = ''; // ล้างรายการเก่า

                    if (notifications.length === 0) {
                        // กรณีไม่มีการแจ้งเตือน
                        listContainer.innerHTML = `
                            <div class="px-4 py-6 text-sm text-gray-500 text-center flex flex-col items-center">
                                <ion-icon name="notifications-off-outline" class="text-2xl mb-2 text-gray-300"></ion-icon>
                                ไม่มีการแจ้งเตือนใหม่
                            </div>`;
                    } else {
                        // วนลูปสร้างรายการ
                        notifications.forEach(notif => {
                            const item = document.createElement('div');
                            // ถ้ายังไม่อ่าน ให้พื้นหลังเป็นสีฟ้าอ่อน (bg-blue-50)
                            item.className = `px-4 py-3 border-b hover:bg-gray-50 transition-colors cursor-pointer ${!notif.isRead ? 'bg-blue-50' : ''}`;

                            // ใส่เนื้อหา HTML
                            item.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">${notif.title || 'การแจ้งเตือน'}</p>
                                        <p class="text-xs text-gray-500 mt-1">${notif.message || '-'}</p>
                                        <p class="text-[10px] text-gray-400 mt-2">
                                            ${new Date(notif.createdAt).toLocaleString('th-TH')}
                                        </p>
                                    </div>
                                    ${!notif.isRead ? '<span class="h-2 w-2 bg-blue-600 rounded-full mt-1 flex-shrink-0"></span>' : ''}
                                </div>
                            `;

                            // เพิ่ม Event คลิก (เช่น กดแล้วไปหน้างาน หรือทำเครื่องหมายว่าอ่านแล้ว)
                            item.onclick = () => {
                                // ตรงนี้ใส่ Logic เพิ่มเติมได้ เช่น markAsRead(notif._id)
                                console.log('Clicked notification:', notif._id);
                            };

                            listContainer.appendChild(item);
                        });
                    }
                }

            } catch (error) {
                console.warn('Could not fetch notifications:', error.message);
            }
        };

        const updateNotificationUI = (notifications, unreadCount) => {
            const dot = document.getElementById('notification-dot');
            const list = document.getElementById('notification-list');

            if (unreadCount > 0) {
                safeShow(dot);
            } else {
                safeHide(dot);
            }

            if (notifications && notifications.length > 0) {
                list.innerHTML = '';
                notifications.forEach(noti => {
                    const taskTitle = noti.task ? noti.task.title : 'งานนี้ถูกลบแล้ว';
                    const taskAction = noti.task ? `onclick="openDetailModal('${noti.task._id}'); closeModal('notificationModal');"` : '';

                    const item = document.createElement('div');
                    item.className = `flex justify-between items-start p-3 border-b hover:bg-gray-50 cursor-pointer ${noti.isRead ? 'bg-white' : 'bg-blue-50'}`;

                    item.innerHTML = `
                        <div ${taskAction} class="flex-1">
                            <p class="text-sm text-gray-800 font-medium">${noti.message}</p>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<p class="text-center text-gray-500 p-4">ไม่มีการแจ้งเตือนใหม่</p>';
            }
        };

        const markNotificationsAsRead = async () => {
            const token = localStorage.getItem('token');
            const dot = document.getElementById('notification-dot');
            safeHide(dot);

            try {
                await fetch(`${SERVER_URL}/notifications/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.warn('Could not mark notifications as read:', error.message);
            }
        };

        // ------------------------------------------
        const deleteNotification = async (id) => {
            const token = localStorage.getItem('token');
            if (!confirm('คุณต้องการลบการแจ้งเตือนนี้หรือไม่?')) return;

            try {
                const response = await fetch(`${SERVER_URL}/notifications/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    fetchNotifications();
                } else {
                    showToast('ลบการแจ้งเตือนไม่สำเร็จ', 'error');
                }
            } catch (error) {
                console.error('Delete Notification Error:', error);
                showToast('เกิดข้อผิดพลาดในการลบการแจ้งเตือน', 'error');
            }
        };

        const deleteAllNotifications = async () => {
            const token = localStorage.getItem('token');
            if (!confirm('คุณต้องการลบการแจ้งเตือนทั้งหมดหรือไม่?')) return;

            try {
                const response = await fetch(`${SERVER_URL}/notifications`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    fetchNotifications();
                } else {
                    showToast('ลบการแจ้งเตือนทั้งหมดไม่สำเร็จ', 'error');
                }
            } catch (error) {
                console.error('Delete All Notifications Error:', error);
                showToast('เกิดข้อผิดพลาดในการลบการแจ้งเตือนทั้งหมด', 'error');
            }
        };

        // --- (D) DEPOSIT FUNCTIONS ---
        // ------------------------------------------
        // ในไฟล์ index.html
        function getOrderStatusBadge(status) {
            status = status || 'pending';
            switch (status) {
                case 'ordered':
                    return `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold border border-blue-200 whitespace-nowrap">สั่งของแล้ว</span>`;
                case 'arrived':
                    return `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold border border-green-200 whitespace-nowrap">ของถึงปลายทางแล้ว</span>`;
                case 'canceled':
                    return `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold border border-red-200 whitespace-nowrap">ยกเลิก</span>`;
                default:
                    return `<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-[10px] font-bold border border-yellow-200 whitespace-nowrap">รอดำเนินการ</span>`;
            }
        }

        async function fetchDeposits() {
            try {
                const token = localStorage.getItem('token');
                const selectedCompanyId = document.getElementById('company-select').value;

                // --- ส่วนที่ 1: อัปเดตหัวข้อตาราง (Header Title) ---
                // ส่วนนี้จะเปลี่ยนข้อความ "รายการเงินค่ามัดจำหน้าร้าน" เป็น "รายการเงินค่ามัดจำ - สาขา..."
                const titleElem = document.getElementById('deposit-header-title');
                const filterBranchElem = document.getElementById('deposit-filter-branch');

                if (titleElem) {
                    if (typeof currentUser !== 'undefined' && currentUser && currentUser.role === 'staff') {
                        // กรณี Staff: ให้แสดงสาขาของ Staff คนนั้นเสมอ
                        const branchName = currentUser.branch || 'ทั้งหมด'; // ถ้าเป็นค่าว่าง/null/undefined ให้ใช้คำว่า 'ทั้งหมด' แทน
                        titleElem.textContent = `สาขา ${branchName}`;
                    } else {
                        // กรณี Admin/Manager: ให้แสดงตามที่เลือกใน Dropdown
                        // ถ้าเลือก "ทั้งหมด" หรือยังไม่เลือก ให้แสดงคำว่า "ทั้งหมด"
                        // ถ้าเลือกสาขาเจาะจง ให้ดึงข้อความ (Text) ของ option นั้นมาแสดง
                        let branchName = 'ทั้งหมด';
                        if (filterBranchElem && filterBranchElem.value !== 'all' && filterBranchElem.selectedIndex > -1) {
                            branchName = filterBranchElem.options[filterBranchElem.selectedIndex].text;
                        }
                        titleElem.textContent = `สาขา ${branchName}`;
                    }
                }

                // --- ส่วนที่ 2: เตรียม URL และ Parameter ---
                let url = `${SERVER_URL}/deposits?companyId=${selectedCompanyId}`;

                // ดึงค่าจาก Dropdown ตัวกรองสาขา เพื่อส่งไปที่ API
                if (filterBranchElem) {
                    const branchVal = filterBranchElem.value;
                    if (branchVal && branchVal !== 'all') {
                        url += `&branch=${encodeURIComponent(branchVal)}`;
                    }
                }

                // --- ส่วนที่ 3: ส่งคำสั่งไปที่ Server ---
                // console.log('Fetching URL:', url); 
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                let deposits = await res.json();

                // --- ส่วนที่ 3.5: Client-Side Filters (Status, Date, Search) ---
                const statusFilterElem = document.getElementById('deposit-filter-status');
                const dateFilterElem = document.getElementById('deposit-filter-date');
                const searchInputElem = document.getElementById('deposit-search-input');
                const bellBtn = document.getElementById('btn-filter-due-today');
                const badgeElem = document.getElementById('deposit-due-badge');

                // (*** New: Calculate Due Count for Badge ***)
                const todayStr = new Date().toISOString().split('T')[0];
                const dueItems = deposits.filter(d => {
                    if (d.isSuccess) return false; // ไม่นับงานที่เสร็จแล้ว
                    if (!d.pickupDueDate) return false;

                    // แปลงวันที่นัดรับเป็น YYYY-MM-DD
                    const dueStr = new Date(d.pickupDueDate).toISOString().split('T')[0];
                    // นับถ้า "วันนัดรับ <= วันนี้" (คือต้องรับวันนี้ หรือ เลยมาแล้ว)
                    return dueStr <= todayStr;
                });

                if (badgeElem && bellBtn) {
                    const count = dueItems.length;
                    badgeElem.textContent = count;
                    if (count > 0) {
                        badgeElem.classList.remove('hidden');
                        bellBtn.classList.add('text-red-500', 'bg-red-50', 'border-red-200');
                        bellBtn.classList.remove('text-slate-400', 'bg-white', 'border-slate-200');
                    } else {
                        badgeElem.classList.add('hidden');
                        bellBtn.classList.remove('text-red-500', 'bg-red-50', 'border-red-200');
                        bellBtn.classList.add('text-slate-400', 'bg-white', 'border-slate-200');
                    }
                }

                // 0. Filter by "Due Today + Overdue" (Bell Button)
                if (bellBtn && bellBtn.classList.contains('active-bell')) {
                    // กรองเอาเฉพาะ Due Items ที่คำนวณไว้ข้างบน
                    deposits = dueItems;
                }
                // If Bell is NOT active, use normal Date Picker Logic
                else if (dateFilterElem && dateFilterElem.value) {
                    const filterDate = dateFilterElem.value; // YYYY-MM-DD
                    deposits = deposits.filter(d => {
                        return d.depositDate && d.depositDate.startsWith(filterDate);
                    });
                }

                // --- NEW: Calculate Counts for Status Filter Options ---
                if (statusFilterElem) {
                    const countPending = deposits.filter(d => !d.isSuccess).length;
                    const countSuccess = deposits.filter(d => d.isSuccess).length;

                    Array.from(statusFilterElem.options).forEach(opt => {
                        if (opt.value === 'รอดำเนินการ') {
                            opt.textContent = `รอดำเนินการ (${countPending})`;
                        } else if (opt.value === 'สำเร็จ') {
                            opt.textContent = `สำเร็จ (${countSuccess})`;
                        }
                    });
                }

                // 1. Filter by Status
                if (statusFilterElem) {
                    const statusVal = statusFilterElem.value;
                    if (statusVal === 'รอดำเนินการ') {
                        deposits = deposits.filter(d => !d.isSuccess);
                    } else if (statusVal === 'สำเร็จ') {
                        deposits = deposits.filter(d => d.isSuccess);
                    }
                }

                // 2. (Depreacted Logic: Date logic moved above to handle priority)

                // 3. Filter by Search (Name/Phone)
                if (searchInputElem && searchInputElem.value) {
                    const searchText = searchInputElem.value.toLowerCase().trim();
                    deposits = deposits.filter(d => {
                        const name = (d.customerName || '').toLowerCase();
                        const phone = (d.phoneNumber || '').toLowerCase();
                        return name.includes(searchText) || phone.includes(searchText);
                    });
                }

                // --- ส่วนที่ 4: วาดตาราง ---
                const tbody = document.getElementById('deposit-table-body');
                tbody.innerHTML = '';

                if (deposits.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-slate-500">ไม่พบข้อมูลในสาขานี้</td></tr>`;
                    return;
                }

                deposits.forEach(d => {
                    const price = d.price || 0;
                    const deposit = d.depositAmount || 0;
                    const balance = price > 0 ? (price - deposit) : 0;

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-yellow-50 transition-colors cursor-pointer border-b";
                    tr.onclick = () => openDepositModal(d);

                    tr.innerHTML = `
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.depositDate)}</td>
                        <td class="font-medium border p-2 text-gray-800">${d.customerName}</td>
                        <td class="text-center border p-2 text-gray-600">${d.phoneNumber}</td>
                        <td class="text-right border p-2 font-bold text-red-600 bg-red-50">${deposit.toLocaleString()}</td>
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.pickupDueDate)}</td>
                                
                        <td class="text-center border p-2 text-xs">${d.billNo || '-'}</td>
                        <td class="text-center border p-2 text-xs font-mono text-gray-500">${d.imei || '-'}</td>
                        <td class="text-xs border p-2">${d.product || '-'}</td>
                        <td class="text-right border p-2 bg-red-50 text-xs">${price ? price.toLocaleString() : '-'}</td>
                        <td class="text-right border p-2 font-bold bg-blue-50 text-blue-800">${price ? balance.toLocaleString() : '-'}</td>
                        
                        <td class="text-center border p-2">
                            ${d.isSuccess
                            ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-md text-xs font-bold border border-green-200 inline-block w-24">สำเร็จ</span>'
                            : '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-md text-xs font-bold border border-yellow-200 inline-block w-24">รอดำเนินการ</span>'}
                        </td>
                        <td class="text-center border p-2 text-xs text-gray-500">${d.signName || ''}</td>
                        <td class="text-center border p-2 text-xs">
                           <button onclick="event.stopPropagation(); openDepositDetailModal({ 
                               customerName: '${d.customerName}', 
                               orderStatus: '${d.orderStatus}', 
                               expectedArrivalDate: '${d.expectedArrivalDate || ''}' 
                           })" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded-md transition-colors text-xs font-bold">
                               เพิ่มเติม
                           </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error("Error fetching deposits:", e);
                // อาจจะแสดง Error บนหน้าจอด้วยก็ได้ถ้าต้องการ
                const tbody = document.getElementById('deposit-table-body');
                if (tbody) tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
            }
        }

        let productTomSelect = null;

        async function fetchProducts() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${SERVER_URL}/deposits/products`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) return [];
                return await res.json();
            } catch (e) {
                console.error("Error fetching products:", e);
                return [];
            }
        }

        // Global variables for purchasing view
        let allPurchasingOrders = [];
        let currentStatusFilter = 'all';
        let currentSearchText = '';

        // 1. ฟังก์ชันดึงข้อมูล (Fetch & Store)
        // 1. ฟังก์ชันดึงข้อมูล (Fetch & Store)
        async function fetchPurchasingOrders(initialStatus = null) {
            const token = localStorage.getItem('token');
            const container = document.getElementById('purchasing-list-container');
            const emptyState = document.getElementById('purchasing-empty-state');
            const branchFilter = document.getElementById('purchasing-filter-branch').value;
            const companyId = document.getElementById('company-select').value;

            // Loading State
            container.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-16">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mb-4"></div>
                    <p class="text-slate-400 animate-pulse">กำลังโหลดข้อมูลการสั่งซื้อ...</p>
                </div>
            `;
            emptyState.classList.add('hidden');

            try {
                let url = `${SERVER_URL}/deposits?companyId=${companyId}&viewMode=purchasing`;
                if (branchFilter && branchFilter !== 'all') {
                    url += `&branch=${encodeURIComponent(branchFilter)}`;
                }

                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to fetch');

                const deposits = await res.json();
                allPurchasingOrders = deposits; // Store data

                // Set Filter Logic
                if (initialStatus) {
                    currentStatusFilter = initialStatus;
                    // Trigger UI update for the filter buttons
                    // Note: filterPurchasingByStatus sets currentStatusFilter and calls renderPurchasingOrders
                    filterPurchasingByStatus(initialStatus);
                } else {
                    // Reset filters if no initialStatus provided
                    currentStatusFilter = 'all';
                    currentSearchText = '';
                    document.getElementById('purchasing-search-input').value = '';
                    clearPurchasingFilterUI();
                    renderPurchasingOrders();
                }

                updatePurchasingStats(deposits);

            } catch (e) {
                console.error(e);
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 bg-red-50 rounded-2xl border border-red-100">
                        <ion-icon name="alert-circle" class="text-4xl text-red-400 mb-2"></ion-icon>
                        <p class="text-red-700 font-semibold">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                        <button onclick="fetchPurchasingOrders()" class="mt-4 text-sm bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg hover:bg-red-50">ลองใหม่</button>
                    </div>
                `;
            }
        }

        function renderPurchasingOrders() {
            const container = document.getElementById('purchasing-list-container');
            const emptyState = document.getElementById('purchasing-empty-state');
            const searchText = currentSearchText.toLowerCase();

            container.innerHTML = '';

            // Filter Data
            const filtered = allPurchasingOrders.filter(d => {
                // Status Filter
                if (currentStatusFilter !== 'all') {
                    if (currentStatusFilter === 'overdue') {
                        // (*** เพิ่ม: Logic กรอง Overdue ***)
                        if ((d.orderStatus || 'pending') !== 'ordered') return false;
                        if (!d.expectedArrivalDate) return false;

                        const arrivalDate = new Date(d.expectedArrivalDate);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (arrivalDate >= today) return false;

                    } else {
                        if ((d.orderStatus || 'pending') !== currentStatusFilter) return false;
                    }
                }

                // Search Filter
                if (searchText) {
                    const searchMatch = (d.customerName || '').toLowerCase().includes(searchText) ||
                        (d.phoneNumber || '').toLowerCase().includes(searchText) ||
                        (d.product || '').toLowerCase().includes(searchText) ||
                        (d.branch || '').toLowerCase().includes(searchText);
                    if (!searchMatch) return false;
                }
                return true;
            });

            filtered.forEach(d => {
                // Status Logic
                let statusConfig = { text: 'รอดำเนินการ', color: 'bg-yellow-100 text-yellow-700 border-yellow-200', icon: 'time' };
                const status = d.orderStatus || 'pending';

                if (status === 'ordered') statusConfig = { text: 'สั่งของแล้ว', color: 'bg-blue-100 text-blue-700 border-blue-200', icon: 'cart' };
                else if (status === 'arrived') statusConfig = { text: 'ของถึงปลายทางแล้ว', color: 'bg-green-100 text-green-700 border-green-200', icon: 'checkmark-circle' };
                else if (status === 'canceled') statusConfig = { text: 'ยกเลิก', color: 'bg-red-100 text-red-700 border-red-200', icon: 'close-circle' };

                const dataString = JSON.stringify(d).replace(/'/g, "&#39;");

                // (*** เพิ่ม: Logic แจ้งเตือน Overdue ***)
                let arrivalDateDisplay = '';
                let overdueClass = '';
                let overdueBadge = '';

                if (d.expectedArrivalDate && d.orderStatus === 'ordered') {
                    const arrivalDate = new Date(d.expectedArrivalDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // เคลียร์เวลาเพื่อเทียบแค่วันที่

                    // แปลงเป็น String สั้นๆ
                    const dateStr = arrivalDate.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    arrivalDateDisplay = `<p class="text-xs text-slate-500 mt-1">คาดว่าจะถึง: <span class="font-medium text-slate-700">${dateStr}</span></p>`;

                    if (arrivalDate < today) {
                        overdueClass = 'ring-2 ring-red-500 bg-red-50'; // ไฮไลท์การ์ด
                        overdueBadge = `<span class="absolute top-2 right-2 px-2 py-0.5 bg-red-600 text-white text-[10px] font-bold rounded-full shadow-md animate-pulse">! เกินกำหนด</span>`;
                    }
                } else if (d.expectedArrivalDate) {
                    // แสดงวันที่เฉยๆ ถ้าสถานะอื่น
                    const dateStr = new Date(d.expectedArrivalDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    arrivalDateDisplay = `<p class="text-xs text-slate-400 mt-1">คาดว่าจะถึง: ${dateStr}</p>`;
                }

                const card = document.createElement('div');
                card.className = `bg-white rounded-2xl p-5 shadow-sm border border-slate-100 hover:shadow-md transition-shadow group relative overflow-hidden ${overdueClass}`;

                const statusColorMap = {
                    'pending': 'bg-yellow-400',
                    'ordered': 'bg-blue-500',
                    'arrived': 'bg-green-500',
                    'canceled': 'bg-red-500'
                };
                const sidebarColor = statusColorMap[status] || 'bg-slate-300';

                card.innerHTML = `
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 ${sidebarColor}"></div>
                    <div class="flex justify-between items-start mb-4 pl-3">
                        <div>
                            <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-md font-medium mb-2 inline-block">
                                <ion-icon name="storefront-outline" class="align-middle mr-1"></ion-icon>${d.branch || '-'}
                            </span>
                            <h4 class="font-bold text-slate-800 text-lg leading-tight line-clamp-2" title="${d.product || 'ไม่ระบุสินค้า'}">${d.product || 'ไม่ระบุสินค้า'}</h4>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="${statusConfig.color} px-2.5 py-1 rounded-full text-xs font-bold border flex items-center gap-1 shadow-sm">
                                <ion-icon name="${statusConfig.icon}"></ion-icon> ${statusConfig.text}
                            </span>
                        </div>
                    </div>
                    
                    <div class="space-y-3 pl-3">
                        <div class="flex items-center gap-3 text-sm text-slate-600">
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-slate-700">${d.customerName}</p>
                                <p class="text-xs text-slate-400">${d.phoneNumber}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 text-xs bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <div>
                                <p class="text-slate-400 font-medium">วันกำหนดรับ</p>
                                <p class="font-semibold text-slate-700 mt-0.5 flex items-center gap-1">
                                    <ion-icon name="calendar-outline"></ion-icon> ${formatDateShort(d.pickupDueDate)}
                                </p>
                            </div>
                            <div>
                                <p class="text-slate-400 font-medium">ยอดมัดจำ</p>
                                <p class="font-mono font-semibold text-red-500 mt-0.5">฿${(d.depositAmount || 0).toLocaleString()}</p>
                            </div>
                        </div>

                            ${d.orderNote ? `
                            <div class="text-xs text-slate-500 bg-yellow-50/50 p-2 rounded-lg border border-yellow-100/50 flex gap-2">
                                <ion-icon name="document-text-outline" class="text-yellow-500 mt-0.5"></ion-icon>
                                <span class="line-clamp-2 italic">"${d.orderNote}"</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-100 flex justify-end pl-3">
                        <button onclick='openPurchasingModal(${dataString})' 
                            class="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-xl font-medium transition-all shadow-lg shadow-slate-800/20 active:scale-95">
                            <ion-icon name="create-outline"></ion-icon> อัปเดตสถานะ
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Helpers
        function updatePurchasingStats(deposits) {
            const pending = deposits.filter(d => !d.orderStatus || d.orderStatus === 'pending').length;
            const ordered = deposits.filter(d => d.orderStatus === 'ordered').length;
            const arrived = deposits.filter(d => d.orderStatus === 'arrived').length;
            const canceled = deposits.filter(d => d.orderStatus === 'canceled').length;

            document.getElementById('count-pending').textContent = pending;
            document.getElementById('count-ordered').textContent = ordered;
            document.getElementById('count-arrived').textContent = arrived;
            document.getElementById('count-canceled').textContent = canceled;

            // (*** เพิ่ม: อัปเดตกระดิ่งแจ้งเตือน Overdue ***)
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const overdueCount = deposits.filter(d => {
                if (d.orderStatus === 'ordered' && d.expectedArrivalDate) {
                    const arr = new Date(d.expectedArrivalDate);
                    return arr < today;
                }
                return false;
            }).length;

            const badge = document.getElementById('purchasing-overdue-badge');
            const btn = document.getElementById('btn-purchasing-overdue');

            if (badge && btn) {
                badge.textContent = overdueCount;
                if (overdueCount > 0) {
                    badge.classList.remove('hidden');
                    btn.classList.add('text-red-500', 'bg-red-50', 'border-red-200');
                    btn.classList.remove('text-slate-400', 'bg-white', 'border-slate-200');
                } else {
                    badge.classList.add('hidden');
                    btn.classList.remove('text-red-500', 'bg-red-50', 'border-red-200');
                    btn.classList.add('text-slate-400', 'bg-white', 'border-slate-200');
                }
            }

        }

        function handlePurchasingSearch() {
            currentSearchText = document.getElementById('purchasing-search-input').value.trim();
            renderPurchasingOrders();
        }

        function filterPurchasingByStatus(status) {
            currentStatusFilter = status;

            // Highlight Logic
            ['pending', 'ordered', 'arrived', 'canceled'].forEach(s => {
                const card = document.getElementById(`card-filter-${s}`);
                if (card) {
                    if (s === status) {
                        card.classList.add('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-slate-50');
                    } else {
                        card.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-slate-50');
                    }
                }
            });

            // Show indicator
            const indicator = document.getElementById('active-filter-indicator');
            const nameDisplay = document.getElementById('filter-name-display');

            if (indicator && nameDisplay) {
                indicator.classList.remove('hidden');

                let statusName = '';
                if (status === 'pending') statusName = 'รอดำเนินการ';
                else if (status === 'ordered') statusName = 'สั่งของแล้ว';
                else if (status === 'arrived') statusName = 'ของถึงปลายทางแล้ว';
                else if (status === 'canceled') statusName = 'ยกเลิก';
                else if (status === 'overdue') statusName = '🔔 เกินกำหนด (Overdue)';

                nameDisplay.textContent = statusName;
            }

            renderPurchasingOrders();
        }



        function clearPurchasingFilter() {
            currentStatusFilter = 'all';
            clearPurchasingFilterUI();
            renderPurchasingOrders();
        }

        function clearPurchasingFilterUI() {
            ['pending', 'ordered', 'arrived', 'canceled'].forEach(s => {
                document.getElementById(`card-filter-${s}`).classList.remove('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-slate-50');
            });
            document.getElementById('active-filter-indicator').classList.add('hidden');
        }


        // 2. ฟังก์ชันเปิด Modal อัปเดตสถานะ
        function openPurchasingModal(data) {
            document.getElementById('pur-id').value = data._id;
            document.getElementById('pur-product-display').textContent = data.product || 'ไม่ระบุสินค้า';
            document.getElementById('pur-customer-display').textContent = `${data.customerName} (โทร: ${data.phoneNumber})`;
            document.getElementById('pur-status').value = data.orderStatus || 'pending';
            document.getElementById('pur-note').value = data.orderNote || '';

            // Set Date
            const dateInput = document.getElementById('pur-arrival-date');
            if (data.expectedArrivalDate) {
                const d = new Date(data.expectedArrivalDate);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            } else {
                dateInput.value = '';
            }

            openModal('purchasingModal');
        }

        async function openDepositModal(data = null) {
            openModal('depositModal');

            // Initialize Tom Select if not already done
            if (!productTomSelect) {
                productTomSelect = new TomSelect('#dep-product', {
                    create: true,
                    sortField: { field: "text", direction: "asc" },
                    placeholder: "เลือกหรือพิมพ์เพิ่ม...",
                    valueField: 'text',
                    labelField: 'text',
                    searchField: 'text',
                    options: [],
                    maxOptions: null
                });
            }

            // Load products
            productTomSelect.clear();
            productTomSelect.clearOptions();

            const defaultProducts = [
                // iPhone 13
                "13 128 ดำ New",
                "13 128 ขาว New",

                // iPhone 15
                "15 128 ดำ New",
                "15 128 บลู New",
                "15 128 ชมพู New",
                "15 256 บลู New",

                // iPhone 16
                "16 128 ดำ New",
                "16 128 บลู New",
                "16 128 ชมพู New",
                "16 128 เขียว New",
                "16 128 ขาว New",
                "16 256 บลู New",

                // iPhone 16 Plus
                "16 Plus 128 ดำ New",
                "16 Plus 128 ชมพู New",
                "16 Plus 128 ขาว New",

                // iPhone 16 Pro
                "16 Pro 128 ดำ New",
                "16 Pro 128 Black Titanium",
                "16 Pro 128 Graphite",

                // iPhone 16 Pro Max
                "16 Pro Max 256 Black Titanium",
                "16 Pro Max 256 Desert",
                "16 Pro Max 256 Desert Titanium",
                "16 Pro Max 256 Graphite",
                "16 Pro Max 256 Silver",
                "16 Pro Max 256 White Titanium",

                // iPhone 17
                "17 256 ดำ New",
                "17 256 บลู New",
                "17 256 Lavender",
                "17 256 Purple",
                "17 256 ขาว New",

                // iPhone 17 Pro
                "17 Pro 256 Orange",
                "17 Pro 256 บลู New",

                // iPhone 17 Pro Max
                "17 Pro Max 256 Blue",
                "17 Pro Max 256 Orange",
                "17 Pro Max 256 White",

                // iPad Gen 11
                "iPad Gen11 128 ขาว New",
                "iPad Gen11 128 บลู New",
                "iPad Gen11 128 ชมพู New",

                // iPad Air 7
                "iPad Air7 128 ขาว New",
                "iPad Air7 128 ม่วง New",
                "iPad Air7 128 เทา New",
                "iPad Air7 128 บลู New"
            ];

            const serverProducts = await fetchProducts();
            // Merge and dedup
            const allProducts = Array.from(new Set([...defaultProducts, ...serverProducts])).sort();

            allProducts.forEach(p => productTomSelect.addOption({ text: p }));
            document.getElementById('deposit-form').reset();
            document.getElementById('dep-id').value = '';

            if (data) {
                document.getElementById('dep-id').value = data._id;
                document.getElementById('dep-date').value = data.depositDate ? data.depositDate.split('T')[0] : '';
                document.getElementById('dep-pickup').value = data.pickupDueDate ? data.pickupDueDate.split('T')[0] : '';
                document.getElementById('dep-name').value = data.customerName;
                document.getElementById('dep-phone').value = data.phoneNumber;
                document.getElementById('dep-amount').value = data.depositAmount;

                // Set product value
                if (data.product) {
                    productTomSelect.addOption({ text: data.product }); // Ensure option exists
                    productTomSelect.setValue(data.product);
                }
                document.getElementById('dep-price').value = data.price || '';
                document.getElementById('dep-bill').value = data.billNo || '';
                document.getElementById('dep-imei').value = data.imei || '';
                document.getElementById('dep-success').checked = data.isSuccess;
            } else {
                document.getElementById('dep-date').value = new Date().toISOString().split('T')[0];
            }
        }

        // (*** New: Open Detail Modal ***)
        function openDepositDetailModal(data) {
            // 1. Populate Data
            document.getElementById('detail-customer-name').textContent = data.customerName || '-';

            // Status Badge
            const statusBadge = getOrderStatusBadge(data.orderStatus);
            document.getElementById('detail-status-badge').innerHTML = statusBadge;

            // Arrival Date
            if (data.expectedArrivalDate) {
                const d = new Date(data.expectedArrivalDate);
                const dateStr = d.toLocaleDateString('th-TH', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                document.getElementById('detail-arrival-date').textContent = dateStr;
                document.getElementById('detail-arrival-date').className = "font-bold text-blue-600";
            } else {
                document.getElementById('detail-arrival-date').textContent = "ยังไม่ระบุ";
                document.getElementById('detail-arrival-date').className = "font-bold text-slate-400";
            }

            // 2. Open Modal
            openModal('depositDetailModal');
        }

        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const payload = {
                id: document.getElementById('dep-id').value,
                depositDate: document.getElementById('dep-date').value,
                pickupDueDate: document.getElementById('dep-pickup').value,
                customerName: document.getElementById('dep-name').value,
                phoneNumber: document.getElementById('dep-phone').value,
                depositAmount: document.getElementById('dep-amount').value,

                product: document.getElementById('dep-product').value,
                price: document.getElementById('dep-price').value,
                billNo: document.getElementById('dep-bill').value,
                imei: document.getElementById('dep-imei').value,
                isSuccess: document.getElementById('dep-success').checked
            };

            try {
                const res = await fetch(`${SERVER_URL}/deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    closeModal('depositModal');
                    fetchDeposits();
                } else {
                    alert('บันทึกไม่สำเร็จ โปรดลองใหม่');
                }
            } catch (err) { alert('Error: ' + err.message); }
        });

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric', year: '2-digit' });
        }


        // ------------------------------------------
        // --- (F) IMPORT NOTIFICATION FUNCTIONS ---
        // ------------------------------------------
        let startImportTab = 'phone';

        function switchImportTab(tab) {
            startImportTab = tab;
            const btnPhone = document.getElementById('tab-btn-phone');
            const btnAcc = document.getElementById('tab-btn-accessory');
            const viewPhone = document.getElementById('tab-import-phone');
            const viewAcc = document.getElementById('tab-import-accessory');

            if (tab === 'phone') {
                // Active Phone
                btnPhone.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold transition-all bg-indigo-50 text-indigo-600 ring-2 ring-indigo-100";
                btnAcc.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold text-slate-500 hover:bg-slate-50 transition-all";
                safeShow(viewPhone);
                safeHide(viewAcc);
            } else {
                // Active Accessory
                btnAcc.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold transition-all bg-pink-50 text-pink-600 ring-2 ring-pink-100";
                btnPhone.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold text-slate-500 hover:bg-slate-50 transition-all";
                safeShow(viewAcc);
                safeHide(viewPhone);
            }
            fetchImportRequests();
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const placeholder = document.getElementById('image-preview-placeholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function fetchImportRequests() {
            const token = localStorage.getItem('token');
            const companyId = document.getElementById('company-select').value;
            try {
                const res = await fetch(`${SERVER_URL}/imports?companyId=${companyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) return;
                const responseData = await res.json();
                const data = Array.isArray(responseData) ? responseData : (responseData.data || []);

                // Render Phone List
                const phoneList = document.getElementById('phone-import-list');
                const phoneData = data.filter(d => d.type === 'phone');
                if (phoneList) {
                    phoneList.innerHTML = '';
                    if (phoneData.length === 0) {
                        phoneList.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-slate-400">ไม่มีประวัติการแจ้งนำเข้า</td></tr>`;
                    } else {
                        phoneData.forEach(item => {
                            const fileLink = (item.files && item.files.length > 0) ? item.files[0] : '#';
                            const linkClass = (fileLink !== '#') ? 'text-indigo-600 hover:underline' : 'text-gray-400 cursor-not-allowed';
                            const targetAttr = (fileLink !== '#') ? 'target="_blank"' : '';

                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-slate-50";
                            tr.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatDateShort(item.createdAt)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <a href="${fileLink}" ${targetAttr} class="${linkClass} flex items-center">
                                        <ion-icon name="document-text" class="mr-1"></ion-icon> Download
                                    </a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.branch}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${getStatusTag(item.status)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.createdBy ? item.createdBy.name : '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                                    <button onclick="openEditPhoneModal('${item._id}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 p-2 rounded-lg transition-colors" title="แก้ไข">
                                        <ion-icon name="create-outline" class="text-lg"></ion-icon>
                                    </button>
                                </td>
                            `;
                            phoneList.appendChild(tr);
                        });
                    }
                }

                // Render Accessory List
                const accList = document.getElementById('accessory-import-list');
                const accData = data.filter(d => d.type === 'accessory');
                if (accList) {
                    accList.innerHTML = '';
                    if (accData.length === 0) {
                        accList.innerHTML = `<div class="col-span-full text-center py-8 text-slate-400">ไม่มีรายการแจ้งนำเข้า</div>`;
                    } else {
                        accData.forEach(item => {
                            const card = document.createElement('div');
                            card.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex gap-4";

                            let imgUrl = 'https://placehold.co/100';
                            if (item.files && item.files.length > 0) {
                                imgUrl = `${SERVER_URL.replace('/api', '')}/${item.files[0]}`;
                            }

                            // Handle Multi-Item vs Single Item
                            let accName = item.details?.productName || item.details?.name || 'Unknown';
                            let accQty = item.details?.quantity || '-';

                            if (item.details?.items && item.details.items.length > 0) {
                                const totalQty = item.details.items.reduce((sum, i) => sum + (i.qty || 0), 0);
                                const firstItem = item.details.items[0].name;
                                const moreCount = item.details.items.length - 1;

                                accName = moreCount > 0 ? `${firstItem} (+${moreCount})` : firstItem;
                                accQty = totalQty;
                            }

                            const accDate = item.details ? formatDateShort(item.details.importDate || item.createdAt) : '-';

                            // Safe Status Tag
                            const statusTagHtml = (typeof getStatusTag === 'function') ? getStatusTag(item.status) : `<span class="text-xs">${item.status}</span>`;

                            card.innerHTML = `
                                 <img src="${imgUrl}" class="w-20 h-20 object-cover rounded-lg bg-slate-100 border border-slate-200" loading="lazy" onerror="this.src='https://placehold.co/100?text=No+Image'">
                                 <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <h5 class="font-bold text-slate-800 text-sm line-clamp-1" title="${accName}">${accName}</h5>
                                        ${statusTagHtml}
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">จำนวน: <span class="font-semibold text-slate-700">${accQty}</span> ชิ้น</p>
                                    <p class="text-xs text-slate-500">วันที่: ${accDate}</p>
                                    <div class="mt-2 flex items-center justify-between text-xs text-slate-400">
                                        <div class="flex items-center">
                                            <ion-icon name="person" class="mr-1"></ion-icon> ${item.createdBy ? item.createdBy.name : '-'} (${item.branch})
                                        </div>
                                        <button onclick="openEditAccModal('${item._id}')" class="text-pink-600 hover:text-pink-900 bg-pink-50 hover:bg-pink-100 p-1.5 rounded-lg transition-colors" title="แก้ไข">
                                            <ion-icon name="create-outline" class="text-sm"></ion-icon>
                                        </button>
                                    </div>
                                 </div>
                            `;
                            accList.appendChild(card);
                        });
                    }
                }
            } catch (err) {
                console.error(err);
                const accList = document.getElementById('accessory-import-list');
                if (accList) accList.innerHTML = `<div class="col-span-full text-center py-8 text-red-400">Error loading data: ${err.message}</div>`;
            }
        }

        // ------------------------------------------
        // --- (E) GENERAL HELPERS & INIT ---
        // ------------------------------------------

        const loadManagersForDropdown = async () => {
            const token = localStorage.getItem('token');
            const select = document.getElementById('user-reportsTo-input');
            select.innerHTML = '<option value="">--- กำลังโหลด... ---</option>';
            try {
                const selectedCompanyId = document.getElementById('user-company-input').value;
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('โหลดรายชื่อหัวหน้าไม่สำเร็จ');
                const users = await response.json();
                select.innerHTML = '<option value="">--- ไม่มีหัวหน้า ---</option>';
                const managers = users.filter(u => u.role === 'manager' || u.role === 'hr' || u.role === 'executive');
                managers.forEach(user => {
                    select.appendChild(new Option(`${user.name} (${getRoleName(user.role)})`, user._id));
                });
            } catch (error) {
                select.innerHTML = `<option value="">--- ${error.message} ---</option>`;
            }
        };

        const populateBranchSelects = () => {
            const branches = ['ยะลา', 'นราธิวาส', 'ปัตตานี', 'หาดใหญ่', 'บิ๊กซี', 'โคลีเซียม', 'สุราษฎร์ธานี', 'ปากแมว', 'ภูเก็ต', 'นครศรีธรรมราช', 'กระบี่', 'กะทู้', 'ตรัง', 'คุรุ', 'ชุมพร', 'สตูล', 'พัทลุง', 'สงขลา'];
            const selects = ['deposit-filter-branch', 'purchasing-filter-branch', 'manage-request-branch-filter', 'stock-request-branch-filter'];

            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    // Keep the first option (all)
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption);

                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        select.appendChild(option);
                    });
                }
            });
        };

        const openNewUserModal = () => {
            document.getElementById('user-form').reset();
            document.getElementById('user-modal-title').textContent = 'เพิ่มผู้ใช้ใหม่';
            document.getElementById('form-mode').value = 'create';
            document.getElementById('user-id').value = '';
            safeHide(document.getElementById('user-form-error'));
            document.getElementById('user-username-input').disabled = false;
            document.getElementById('user-username-input').required = true;
            document.getElementById('user-password-input').placeholder = "ต้องกรอก";
            document.getElementById('user-password-input').required = true;
            safeShow(document.getElementById('auth-section'));

            const currentCompany = document.getElementById('company-select').value;
            const userCompanySelect = document.getElementById('user-company-input');
            userCompanySelect.value = currentCompany;
            userCompanySelect.disabled = false;

            safeHide(document.getElementById('user-reportsTo-input').parentElement);

            openModal('userModal');
        };

        const openEditUserModal = async (id) => {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('ไม่สามารถดึงข้อมูลผู้ใช้ได้');
                const users = await response.json();
                const user = users.find(u => u._id === id);

                if (user) {
                    document.getElementById('user-form').reset();
                    document.getElementById('user-modal-title').textContent = 'แก้ไขผู้ใช้';
                    document.getElementById('form-mode').value = 'edit';
                    document.getElementById('user-id').value = user._id;
                    safeHide(document.getElementById('user-form-error'));

                    document.getElementById('user-username-input').disabled = true;
                    document.getElementById('user-username-input').required = false;
                    document.getElementById('user-password-input').placeholder = "เว้นว่างไว้หากไม่ต้องการเปลี่ยน";
                    document.getElementById('user-password-input').required = false;
                    safeShow(document.getElementById('auth-section'));

                    document.getElementById('user-name-input').value = user.name;
                    document.getElementById('user-role-input').value = user.role;
                    document.getElementById('user-username-input').value = user.username;
                    document.getElementById('user-department-input').value = user.department;
                    document.getElementById('user-branch-input').value = user.branch || '';

                    const userCompanySelect = document.getElementById('user-company-input');
                    userCompanySelect.value = user.companyId;
                    userCompanySelect.disabled = true;

                    const reportsToDiv = document.getElementById('user-reportsTo-input').parentElement;
                    safeShow(reportsToDiv);

                    await loadManagersForDropdown();

                    document.getElementById('user-reportsTo-input').value = user.reportsTo ? user.reportsTo._id : '';
                } else {
                    throw new Error('ไม่พบข้อมูลผู้ใช้');
                }
                openModal('userModal');
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการดึงข้อมูล: ' + error.message);
            }
        };

        const handleUserFormSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const mode = data.mode;
            const userId = data.userId;
            const submitButton = document.getElementById('submit-user-btn');
            const errorBox = document.getElementById('user-form-error');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';
            safeHide(errorBox);
            let url = '';
            let method = '';
            let body = {};

            if (mode === 'create') {
                url = `${SERVER_URL}/auth/register`;
                method = 'POST';
                body = {
                    name: data.name,
                    username: data.username,
                    password: data.password,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                    companyId: data.companyId
                };
            } else {
                url = `${SERVER_URL}/users/admin/${userId}`;
                method = 'PUT';
                body = {
                    name: data.name,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                };
                if (data.password && data.password.trim() !== '') {
                    body.password = data.password;
                }
            }
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                closeModal('userModal');
                fetchAllUsersForTable();
                fetchAllUsers();
            } catch (error) {
                errorBox.textContent = `บันทึกไม่สำเร็จ: ${error.message}`;
                safeShow(errorBox);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึก';
            }
        };

        const executeDeleteUser = async (id, name) => {
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้: "${name}"?`)) {
                return;
            }
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                fetchAllUsersForTable();
                fetchAllUsers();
            } catch (error) {
                alert(`ลบไม่สำเร็จ: ${error.message}`);
            }
        };

        // --- NAVIGATION LOGIC (รวมระบบแล้ว) ---
        const updateNavActiveState = (activeView) => {
            const statsCards = document.getElementById('stats-cards');
            const myTasksFilters = document.getElementById('mytasks-filters');
            const taskView = document.getElementById('task-view-content');
            const adminView = document.getElementById('admin-view-content');
            const depositView = document.getElementById('deposit-view'); // เพิ่ม Deposit View

            const mainHeader = document.getElementById('main-header');
            const newTaskBtn = document.getElementById('newTaskButton');
            const newUserBtn = document.getElementById('newUserButton');
            const showAllTasksBtn = document.getElementById('showAllTasksBtn');

            const navDashboard = document.getElementById('nav-dashboard');
            const navMyTasks = document.getElementById('nav-mytasks');
            const navAdmin = document.getElementById('nav-admin');
            const navDeposit = document.getElementById('nav-Storefront_deposit'); // เพิ่ม Deposit Nav

            const companySelectDiv = document.getElementById('company-select').parentElement;
            const navPurchasing = document.getElementById('nav-purchasing');
            const purchasingView = document.getElementById('purchasing-view');
            const navImport = document.getElementById('nav-import');      // [New]
            const importView = document.getElementById('import-view');    // [New]
            const navStockImport = document.getElementById('nav-stock-import'); // [Stock Import]
            const stockImportView = document.getElementById('stock-import-view'); // [Stock Import]

            const navStockRequest = document.getElementById('nav-stock-request');
            const stockRequestView = document.getElementById('stock-request-view');
            const navStockRequestManage = document.getElementById('nav-stock-request-manage');
            const stockRequestManageView = document.getElementById('stock-request-manage-view');

            const navBranchOrder = document.getElementById('nav-branch-order'); // [Branch Order - Purchasing]
            const navBranchOrderInventory = document.getElementById('nav-branch-order-inventory'); // [Branch Order - Sales]
            const branchOrderView = document.getElementById('branch-order-view'); // [Order Management View]
            const branchInventoryView = document.getElementById('branch-inventory-view'); // [Inventory View]

            const navClaim = document.getElementById('nav-claim'); // [Claim]
            const navStockClaim = document.getElementById('nav-stock-claim'); // [Stock Claim]
            const claimView = document.getElementById('claim-view-content'); // [Claim View]

            // Only toggle visibility if changing views (prevents flicker on refresh)
            if (activeView !== currentView) {
                // Reset Nav Styles
                [navDashboard, navMyTasks, navAdmin, navDeposit, navPurchasing, navImport, navStockImport, navStockRequest, navStockRequestManage, navBranchOrder, navBranchOrderInventory, navClaim, navStockClaim].forEach(el => {
                    if (el) {
                        el.classList.remove('bg-amber-500', 'text-white');
                        el.classList.add('text-slate-600', 'hover:bg-slate-50');
                    }
                });

                // Hide All Views
                safeHide(statsCards);
                safeHide(taskView);
                safeHide(adminView);
                safeHide(depositView); // Hide Deposit View
                safeHide(purchasingView);
                safeHide(importView);     // [New]
                safeHide(stockImportView); // [Stock Import]
                safeHide(stockRequestView);
                safeHide(stockRequestManageView);
                safeHide(branchOrderView);
                safeHide(branchInventoryView);
                safeHide(claimView);
            }

            // Update state
            currentView = activeView;

            // Hide Buttons & Filters
            safeHide(newTaskBtn); safeHide(newUserBtn);
            safeHide(showAllTasksBtn);
            safeHide(myTasksFilters);

            currentView = activeView;

            if (activeView === 'dashboard') {
                safeShow(statsCards); safeShow(taskView);
                if (currentUser.role !== 'staff') safeShow(newTaskBtn);
                safeShow(showAllTasksBtn);
                mainHeader.textContent = "แดชบอร์ด";
                navDashboard.classList.add('bg-amber-500', 'text-white');
                navDashboard.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'block';
            }
            else if (activeView === 'mytasks') {
                safeShow(taskView);
                safeShow(myTasksFilters);
                mainHeader.textContent = "งานของฉัน";
                navMyTasks.classList.add('bg-amber-500', 'text-white');
                navMyTasks.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'admin') {
                safeShow(adminView); safeShow(newUserBtn);
                mainHeader.textContent = "จัดการผู้ใช้";
                navAdmin.classList.add('bg-amber-500', 'text-white');
                navAdmin.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'deposit') { // (*** ใหม่ ***)
                safeShow(depositView);
                mainHeader.textContent = "เงินค่ามัดจำหน้าร้าน";
                navDeposit.classList.add('bg-amber-500', 'text-white');
                navDeposit.classList.remove('text-gray-600', 'hover:bg-gray-100');
                // ปกติหน้าร้านก็ควรเลือกบริษัทได้
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'purchasing') { // [เพิ่ม]
                safeShow(purchasingView);
                mainHeader.textContent = "รายการจองเครื่อง";
                navPurchasing.classList.add('bg-amber-500', 'text-white');
                navPurchasing.classList.remove('text-slate-600', 'hover:bg-slate-50');
                if (companySelectDiv) companySelectDiv.style.display = 'none';

                // Default to Pending
                if (typeof fetchPurchasingOrders === 'function') {
                    fetchPurchasingOrders('pending');
                }
            }
            else if (activeView === 'import') { // [New]
                safeShow(importView);
                mainHeader.textContent = "แจ้งนำเข้าสินค้า";
                navImport.classList.add('bg-amber-500', 'text-white');
                navImport.classList.remove('text-slate-600', 'hover:bg-slate-50');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                fetchImportRequests();
            }
            else if (activeView === 'stock-import') { // [New Stock]
                const stockImportView = document.getElementById('stock-import-view');
                const navStockImport = document.getElementById('nav-stock-import');
                safeShow(stockImportView);
                mainHeader.textContent = "จัดการรายการนำเข้า";
                if (navStockImport) {
                    navStockImport.classList.add('bg-amber-500', 'text-white');
                    navStockImport.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                // Reset to Phone and Pending on entry
                if (typeof filterStockType === 'function' && typeof filterStockImports === 'function') {
                    filterStockType('phone', false);
                    filterStockImports('pending', false);
                    fetchStockImports();
                } else if (typeof fetchStockImports === 'function') {
                    fetchStockImports();
                }
            }
            else if (activeView === 'stock-request') {
                safeShow(stockRequestView);
                mainHeader.textContent = "แจ้งเบิกสินค้า";
                if (navStockRequest) {
                    navStockRequest.classList.add('bg-amber-500', 'text-white');
                    navStockRequest.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                fetchStockRequests();
            }
            else if (activeView === 'stock-request-manage') {
                safeShow(stockRequestManageView);
                mainHeader.textContent = "จัดการรายการแจ้งเบิกสินค้า";
                if (navStockRequestManage) {
                    navStockRequestManage.classList.add('bg-amber-500', 'text-white');
                    navStockRequestManage.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                fetchManageStockRequests();
            }
            else if (activeView === 'branch-order') {
                if (typeof fetchBranchOrders === 'function') fetchBranchOrders();
                safeShow(branchOrderView);
                mainHeader.textContent = "สั่งของลงสาขา";
                if (navBranchOrder) {
                    navBranchOrder.classList.add('bg-amber-500', 'text-white');
                    navBranchOrder.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'branch-order-inventory') {
                if (typeof fetchBranchInventory === 'function') fetchBranchInventory();
                safeShow(branchInventoryView);
                mainHeader.textContent = "รายการของลงสาขา";
                if (navBranchOrderInventory) {
                    navBranchOrderInventory.classList.add('bg-amber-500', 'text-white');
                    navBranchOrderInventory.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'claim' || activeView === 'stock-claim') {
                safeShow(claimView);
                mainHeader.textContent = activeView === 'claim' ? "แจ้งเคลมอุปกรณ์เสริม" : "รายการแจ้งเคลมอุปกรณ์เสริม";

                const navEl = activeView === 'claim' ? navClaim : navStockClaim;
                if (navEl) {
                    navEl.classList.add('bg-amber-500', 'text-white');
                    navEl.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';

                // Handle Branch Filter Visibility for Sales Staff (Both Standard and Modern)
                const branchContainers = [
                    document.getElementById('claim-branch-filter-container'),
                    document.getElementById('claim-branch-standard-container')
                ];

                const userDept = (currentUser.department || '').toLowerCase();
                const isSalesTeam = userDept.includes('ขาย') || userDept.includes('sales');
                const isStaff = currentUser.role === 'staff';

                branchContainers.forEach(container => {
                    if (container) {
                        if (isSalesTeam && isStaff) safeHide(container);
                        else safeShow(container);
                    }
                });

                // Toggle Filter UI Style (Sales vs Stock)
                const filterModern = document.getElementById('claim-filter-modern');
                const filterStandard = document.getElementById('claim-filter-standard');
                if (filterModern && filterStandard) {
                    if (activeView === 'claim') {
                        safeHide(filterModern);
                        safeShow(filterStandard);
                    } else {
                        safeShow(filterModern);
                        safeHide(filterStandard);
                    }
                }

                if (typeof setClaimStatusFilter === 'function') setClaimStatusFilter('pending');
                else if (typeof fetchClaims === 'function') fetchClaims();
            }

            if (currentUser && currentUser.role === 'staff') {
                if (document.getElementById('company-select')) document.getElementById('company-select').disabled = true;
            }
        };

        const updateMyTaskCounts = () => {
            if (!allMyTasks) return;
            document.getElementById('mytask-count-todo').textContent = allMyTasks.filter(t => t.status === 'todo').length;
            document.getElementById('mytask-count-inprogress').textContent = allMyTasks.filter(t => t.status === 'in-progress').length;
            document.getElementById('mytask-count-review').textContent = allMyTasks.filter(t => t.status === 'for-review').length;
            document.getElementById('mytask-count-completed').textContent = allMyTasks.filter(t => t.status === 'completed').length;
        };

        const filterMyTasks = (status) => {
            ['todo', 'inprogress', 'review', 'completed'].forEach(id => {
                document.getElementById(`btn-filter-${id}`).classList.remove('ring-2', 'ring-offset-1', 'ring-gray-400');
            });

            let filtered = [];
            if (status === 'all') {
                filtered = allMyTasks;
            } else {
                filtered = allMyTasks.filter(t => t.status === status);
                let btnId = '';
                if (status === 'todo') btnId = 'todo';
                else if (status === 'in-progress') btnId = 'inprogress';
                else if (status === 'for-review') btnId = 'review';
                else if (status === 'completed') btnId = 'completed';

                if (btnId) {
                    document.getElementById(`btn-filter-${btnId}`).classList.add('ring-2', 'ring-offset-1', 'ring-gray-400');
                }
            }
            renderTaskTable(filtered);
        };

        // --- INIT & LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth();


            // ============================================
            // STOCK IMPORT LOGIC
            // ============================================
            let currentStockFilter = 'pending';
            let currentStockImportType = 'phone'; // Default to Phone
            let currentStockBranch = 'all'; // [New] Branch Filter
            let targetImportId = null;
            let targetImportStatus = null;

            // Pagination Vars
            let currentStockPage = 1;
            let currentStockLimit = 20;
            let currentStockTotalPages = 1;

            // (*** Updated Stock Functions ***)
            function renderStockImportTable(data) {
                const phoneTbody = document.getElementById('stock-phone-tbody');
                const accGrid = document.getElementById('stock-acc-grid');
                const emptyState = document.getElementById('stock-empty-state');
                const loading = document.getElementById('stock-loading');

                // Permissions logic
                const isStaff = currentUser?.role === 'staff';
                const userDept = (currentUser?.department || '').toLowerCase();
                const isSalesTeam = userDept.includes('ขาย') || userDept.includes('sales');
                const isStockUser = userDept.includes('stock') ||
                    userDept.includes('store') ||
                    userDept.includes('สต๊อก');
                const canUpdate = !isSalesTeam && (!isStaff || isStockUser);

                if (loading) loading.classList.add('hidden');

                // Clear both
                if (phoneTbody) phoneTbody.innerHTML = '';
                if (accGrid) accGrid.innerHTML = '';

                if (!data || data.length === 0) {
                    if (emptyState) emptyState.classList.remove('hidden');
                    return;
                } else {
                    if (emptyState) emptyState.classList.add('hidden');
                }

                // Render based on current mode
                if (currentStockImportType === 'phone') {
                    // --- RENDER TABLE ---
                    data.forEach(item => {
                        const date = new Date(item.createdAt).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const branch = item.branch || '-';
                        const createdBy = item.createdBy ? item.createdBy.name : '-';
                        const supplier = item.details?.supplier || '-';
                        const desc = item.details?.description || '-';

                        // Check Delete Permission (Own branch OR not staff)
                        const canDelete = !isStaff || (currentUser?.branch === item.branch);

                        // File
                        const fileCount = item.files ? item.files.length : 0;
                        let fileLink = '';

                        if (fileCount > 0) {
                            fileLink = `<div class="flex flex-col gap-1">`;
                            item.files.forEach((rawPath, idx) => {
                                const finalUrl = rawPath.startsWith('http') ? rawPath : `${SERVER_URL.replace('/api', '')}/${rawPath}`;
                                const isExcel = rawPath.toLowerCase().endsWith('.xlsx') || rawPath.toLowerCase().endsWith('.xls');

                                const icon = isExcel ? 'document-text' : 'image';
                                const label = isExcel ? 'โหลด Excel' : 'ดูรูปภาพ';
                                const colorClass = isExcel ? 'bg-indigo-50 text-indigo-600 border-indigo-200 hover:bg-indigo-100' : 'bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100';

                                fileLink += `
                                    <a href="${finalUrl}" target="_blank" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg ${colorClass} transition-colors text-xs font-bold">
                                        <ion-icon name="${icon}"></ion-icon> ${label}
                                    </a>`;
                            });
                            fileLink += `</div>`;
                        } else {
                            fileLink = `<span class="text-slate-400 text-xs">-</span>`;
                        }

                        // Status Badge Logic
                        const statusBadge = getStockStatusBadge(item.status);
                        let statusHtml = '';
                        if (canUpdate) {
                            statusHtml = `<button onclick="openStatusModal('${item._id}', '${item.status}')" class="hover:scale-105 active:scale-95 transition-transform">${statusBadge}</button>`;
                        } else {
                            statusHtml = `<div class="cursor-default opacity-90">${statusBadge}</div>`;
                        }

                        // Delete Button Logic
                        let deleteHtml = '';
                        if (canDelete) {
                            deleteHtml = `<button onclick="deleteImportRequest('${item._id}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all" title="ลบรายการ">
                                    <ion-icon name="trash-outline" class="text-lg"></ion-icon>
                                </button>`;
                        } else {
                            deleteHtml = `<span class="w-8 h-8 block"></span>`;
                        }

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50/80 transition-colors border-b border-slate-50 last:border-0 group";
                        tr.innerHTML = `
                            <td class="px-6 py-4">
                                <span class="text-sm font-bold text-slate-600">${date}</span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs uppercase tracking-tighter border border-slate-200">
                                        ${branch.substring(0, 2)}
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-slate-700">${branch}</div>
                                        <div class="text-xs text-slate-400">${createdBy}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-bold text-slate-800">${supplier}</div>
                            </td>
                            <td class="px-6 py-4 text-sm">${fileLink}</td>
                            <td class="px-6 py-4 text-center">
                                ${statusHtml}
                            </td>
                             <td class="px-6 py-4 text-right">
                                ${deleteHtml}
                            </td>
                        `;
                        phoneTbody.appendChild(tr);
                    });

                } else {
                    // --- RENDER GRID (ACCESSORIES) ---
                    data.forEach(item => {
                        const date = new Date(item.createdAt).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
                        const branch = item.branch || 'Unknown';
                        const itemsCount = item.details?.items?.length || 1;
                        let title = item.details?.billName || item.details?.productName || `${itemsCount} รายการ`;
                        if (itemsCount > 1 && !item.details?.billName) title = `บิลรวม (${itemsCount} รายการ)`;

                        // Image
                        let imgUrl = 'image/placeholder.jpg'; // Path placeholder
                        if (item.files && item.files.length > 0) {
                            const rawPath = item.files[0];
                            imgUrl = rawPath.startsWith('http') ? rawPath : `${SERVER_URL.replace('/api', '')}/${rawPath}`;
                        } else {
                            // Fallback icon
                        }

                        // Status
                        const statusBadge = getStockStatusBadge(item.status);

                        const card = document.createElement('div');
                        card.className = "bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden cursor-pointer group flex flex-col h-full";
                        card.onclick = (e) => {
                            // prevent opening if clicked on specific action buttons if any (but here whole card is clickable)
                            openImportDetailModal(item);
                        };

                        card.innerHTML = `
                            <div class="relative h-48 bg-slate-100 overflow-hidden">
                                <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" loading="lazy" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
                                <div class="absolute top-3 left-3">
                                    <span class="px-2 py-1 bg-white/90 backdrop-blur-sm rounded-lg text-xs font-bold text-slate-700 shadow-sm flex items-center gap-1">
                                        <ion-icon name="storefront"></ion-icon> ${branch}
                                    </span>
                                </div>
                                <div class="absolute top-3 right-3">
                                     <span class="px-2 py-1 bg-black/50 backdrop-blur-md rounded-lg text-xs font-bold text-white border border-white/20">
                                        ${date}
                                    </span>
                                </div>
                            </div>
                            <div class="p-5 flex-1 flex flex-col">
                                <h4 class="font-bold text-slate-800 text-lg mb-1 line-clamp-1">เลขที่บิล : ${title}</h4>
                                <p class="text-sm text-slate-500 mb-4 flex items-center gap-1">
                                    <ion-icon name="person-circle-outline"></ion-icon> ${item.createdBy?.name || '-'}
                                </p>
                                <div class="mt-auto flex items-center justify-between pt-4 border-t border-slate-50">
                                   ${statusBadge}
                                   <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-indigo-500 group-hover:text-white transition-colors">
                                        <ion-icon name="arrow-forward"></ion-icon>
                                   </div>
                                </div>
                            </div>
                        `;
                        accGrid.appendChild(card);
                    });
                }

                // Update Dashboard Stats (Simple Client-side count based on loaded data - ideal for 'All')
                // Note: If filters strictly limit data, these stats will only reflect filtered data.
                // Ideal solution: Separate stats API. For now, we update specific stats if we are in 'all' mode.
                updateStockStatsUI(data);
            }

            function getStockStatusBadge(status) {
                if (status === 'pending') return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 ring-1 ring-yellow-500/20"><div class="w-1.5 h-1.5 rounded-full bg-yellow-500 mr-1.5 animate-pulse"></div>รอนำเข้า</span>`;
                if (status === 'importing') return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 ring-1 ring-blue-500/20"><div class="w-1.5 h-1.5 rounded-full bg-blue-500 mr-1.5"></div>กำลังนำเข้า</span>`;
                if (status === 'received') return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 ring-1 ring-green-200/20"><div class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></div>นำเข้าแล้ว</span>`;
                if (status === 'rejected' || status === 'canceled') return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-rose-100 text-rose-700 ring-1 ring-rose-500/20"><div class="w-1.5 h-1.5 rounded-full bg-rose-500 mr-1.5"></div>ยกเลิกแล้ว</span>`;
                return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 ring-1 ring-slate-500/20">${status}</span>`;
            }

            function updateStockStatsUI(data) {
                if (currentStockFilter !== 'all') return; // Don't update global stats if filtered

                const all = data.length;
                const pending = data.filter(i => i.status === 'pending').length;
                const importing = data.filter(i => i.status === 'importing').length;
                const received = data.filter(i => i.status === 'received').length;

                const anim = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = val;
                };

                anim('stat-stock-all', all);
                anim('stat-stock-pending', pending);
                anim('stat-stock-importing', importing);
                anim('stat-stock-received', received); // (*** New ***)
            }

            window.changeStockPage = function (delta) {
                const newPage = currentStockPage + delta;
                if (newPage >= 1 && newPage <= currentStockTotalPages) {
                    currentStockPage = newPage;
                    fetchStockImports();
                }
            };

            function updatePaginationUI(meta) {
                const paginationEl = document.getElementById('stock-pagination');
                if (!paginationEl) return;

                if (meta.total > 0) {
                    paginationEl.classList.remove('hidden');

                    const start = (meta.page - 1) * currentStockLimit + 1;
                    const end = Math.min(meta.page * currentStockLimit, meta.total);

                    document.getElementById('pagination-info-start').textContent = start;
                    document.getElementById('pagination-info-end').textContent = end;
                    document.getElementById('pagination-info-total').textContent = meta.total;
                    document.getElementById('pagination-page-display').textContent = `หน้า ${meta.page} / ${meta.totalPages}`;

                    const btnPrev = document.getElementById('btn-prev-page');
                    const btnNext = document.getElementById('btn-next-page');

                    if (btnPrev) btnPrev.disabled = (meta.page <= 1);
                    if (btnNext) btnNext.disabled = (meta.page >= meta.totalPages);
                } else {
                    paginationEl.classList.add('hidden');
                }
            }

            async function fetchStockImports() {
                try {
                    // Fetch ALL items for the current type/branch to calculate counts
                    // Remove page/limit restrictions (effectively) and status filter from URL
                    let url = `${SERVER_URL}/imports?t=${Date.now()}`;
                    url += `&page=1&limit=9999`;

                    if (currentStockImportType && currentStockImportType !== 'all') {
                        url += `&type=${currentStockImportType}`;
                    }

                    // Branch filter still applies Server-Side? 
                    // Yes, we only want counts for the selected branch.
                    if (currentStockBranch !== 'all') {
                        url += `&branch=${encodeURIComponent(currentStockBranch)}`;
                    }

                    // Verify Date Filters are REMOVED from logic
                    // (Old logic removed)

                    if (document.getElementById('stock-loading')) document.getElementById('stock-loading').classList.remove('hidden');

                    const res = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!res.ok) throw new Error('Failed to fetch');

                    const responseData = await res.json();
                    // Since we requested limit=9999, 'data' should be all items (or fallback to array)
                    const allItems = Array.isArray(responseData) ? responseData : (responseData.data || []);

                    // 1. Calculate Counts
                    const counts = {
                        all: allItems.length,
                        pending: 0,
                        importing: 0,
                        received: 0,
                        rejected: 0
                    };

                    allItems.forEach(item => {
                        const s = item.status || 'pending';
                        if (counts[s] !== undefined) {
                            counts[s]++;
                        } else {
                            // Map unknown or 'canceled' to rejected if needed?
                            // Assuming 'rejected' is the key in DB if dropdown had it.
                            if (s === 'canceled') counts.rejected++; // Fallback
                        }
                    });

                    // 2. Update Badges
                    Object.keys(counts).forEach(key => {
                        const badge = document.getElementById(`count-stock-${key}`);
                        if (badge) {
                            badge.textContent = counts[key];
                            badge.classList.remove('hidden');
                            if (counts[key] === 0) badge.classList.add('hidden');
                        }
                    });

                    // 3. Client-Side Filtering
                    const effectiveFilter = currentStockFilter || 'all';
                    const filteredData = effectiveFilter === 'all'
                        ? allItems
                        : allItems.filter(item => item.status === effectiveFilter);

                    // 4. Update UI
                    // Hide pagination as we are showing all
                    const paginationEl = document.getElementById('stock-pagination');
                    if (paginationEl) paginationEl.classList.add('hidden');

                    renderStockImportTable(filteredData);

                } catch (err) {
                    console.error('Fetch Stock Import Error:', err);
                } finally {
                    if (document.getElementById('stock-loading')) document.getElementById('stock-loading').classList.add('hidden');
                }
            }

            function filterStockImports(status, doFetch = true) {
                currentStockFilter = status;

                // Update Hidden Input
                const hiddenInput = document.getElementById('stock-import-status-filter');
                if (hiddenInput) hiddenInput.value = status;

                // Update Visuals
                const buttons = [
                    { id: 'btn-stock-all', val: 'all' },
                    { id: 'btn-stock-pending', val: 'pending', color: 'text-amber-600' },
                    { id: 'btn-stock-importing', val: 'importing', color: 'text-blue-600' },
                    { id: 'btn-stock-received', val: 'received', color: 'text-emerald-600' },
                    { id: 'btn-stock-rejected', val: 'rejected', color: 'text-rose-600' }
                ];

                buttons.forEach(btn => {
                    const el = document.getElementById(btn.id);
                    if (el) {
                        if (btn.val === status) {
                            // Active Style
                            el.classList.add('bg-white', 'shadow-sm', 'ring-1', 'ring-black/5');
                            el.classList.remove('text-slate-500');
                            if (btn.color) el.classList.add(btn.color);
                            else el.classList.add('text-indigo-600');
                        } else {
                            // Inactive Style
                            el.classList.remove('bg-white', 'shadow-sm', 'ring-1', 'ring-black/5', 'text-indigo-600', 'text-amber-600', 'text-blue-600', 'text-emerald-600', 'text-rose-600');
                            el.classList.add('text-slate-500');
                        }
                    }
                });

                if (doFetch) fetchStockImports();
            }

            function filterStockType(type, doFetch = true) {
                currentStockImportType = type;
                currentStockPage = 1; // Reset page

                const phoneTab = document.getElementById('tab-stock-phone');
                const accTab = document.getElementById('tab-stock-accessory');
                const allTab = document.getElementById('tab-stock-all'); // Not really used for view switch, but for button style

                // View Contrainers
                const phoneView = document.getElementById('stock-view-phone');
                const accView = document.getElementById('stock-view-accessory');

                // Toggle Views
                if (type === 'phone') {
                    if (phoneView) phoneView.classList.remove('hidden');
                    if (accView) accView.classList.add('hidden');
                } else if (type === 'accessory') {
                    if (phoneView) phoneView.classList.add('hidden');
                    if (accView) accView.classList.remove('hidden');
                } else {
                    // Should technically show both or redirect to one, defaulting to phone for now if 'all'
                    if (phoneView) phoneView.classList.remove('hidden');
                    if (accView) accView.classList.add('hidden');
                }

                // Update Button Styles
                const baseClass = "flex-1 md:flex-none px-6 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all";
                const activeClass = baseClass + " shadow-sm bg-white text-indigo-600 ring-1 ring-black/5";
                const inactiveClass = baseClass + " text-slate-500 hover:text-slate-700 hover:bg-slate-200/50";

                if (phoneTab) phoneTab.className = (type === 'phone') ? activeClass : inactiveClass;
                if (accTab) accTab.className = (type === 'accessory') ? activeClass : inactiveClass;
                // if (allTab) allTab.className = (type === 'all') ? activeClass : inactiveClass;

                if (doFetch) fetchStockImports();
            }

            // Expose Stock Functions to Window
            window.filterStockImports = filterStockImports;
            window.fetchStockImports = fetchStockImports;
            window.openStatusModal = openStatusModal;
            window.filterStockType = filterStockType;
            window.updateStockStatusFromModal = updateStockStatusFromModal;
            window.openImportDetailModal = openImportDetailModal;

            // [New] Branch Filter Listener
            const stockBranchSelect = document.getElementById('stock-import-branch-filter');
            if (stockBranchSelect) {
                stockBranchSelect.addEventListener('change', (e) => {
                    currentStockBranch = e.target.value;
                    fetchStockImports();
                });
            }

            // Status Modal Selection
            function openStatusModal(id, currentStatus) {
                const isStaff = currentUser?.role === 'staff';
                const userDept = (currentUser?.department || '').toLowerCase();
                const isSalesTeam = userDept.includes('ขาย') || userDept.includes('sales');
                const isStockUser = userDept.includes('stock') ||
                    userDept.includes('store') ||
                    userDept.includes('สต๊อก');

                if (isSalesTeam || (isStaff && !isStockUser)) return;
                targetImportId = id;
                openModal('statusUpdateModal');
            }

            // *** NEW: Open Detail Modal for Accessory ***
            let currentDetailItem = null;
            function openImportDetailModal(item) {
                currentDetailItem = item;
                targetImportId = item._id;

                // ACTIONS VISIBILITY
                const actionsContainer = document.getElementById('detail-actions-container');
                if (actionsContainer) {
                    const isStaff = currentUser?.role === 'staff';
                    const userDept = (currentUser?.department || '').toLowerCase();
                    const isSalesTeam = userDept.includes('ขาย') || userDept.includes('sales');
                    const isStockUser = userDept.includes('stock') ||
                        userDept.includes('store') ||
                        userDept.includes('สต๊อก');

                    if (isSalesTeam || (isStaff && !isStockUser)) {
                        actionsContainer.classList.add('hidden');
                    } else {
                        actionsContainer.classList.remove('hidden');
                    }
                }

                const d = item.details || {};
                const supplier = d.supplier || '-';
                const billName = d.billName || '-'; // (*** New: Bill Name ***)
                const branch = item.branch || '-';
                const createdBy = item.createdBy ? item.createdBy.name : '-';
                const date = new Date(item.createdAt).toLocaleDateString('th-TH');

                // Populate Info
                document.getElementById('detail-supplier-title').innerHTML = `${supplier} <span class="text-xs font-normal text-slate-400">เลขที่บิล : ${billName}</span>`;
                document.getElementById('detail-branch-badge').textContent = branch;
                document.getElementById('detail-date-display').textContent = date;
                document.getElementById('detail-by-user').textContent = `แจ้งโดย: ${createdBy}`;
                document.getElementById('detail-current-status').innerHTML = getStockStatusBadge(item.status);

                // Image
                const imgEl = document.getElementById('detail-bill-image');
                const linkEl = document.getElementById('detail-bill-link');
                if (item.files && item.files.length > 0) {
                    const rawPath = item.files[0];
                    const path = rawPath.startsWith('http') ? rawPath : `${SERVER_URL.replace('/api', '')}/${rawPath}`;
                    imgEl.src = path;
                    linkEl.href = path;
                } else {
                    imgEl.src = 'image/placeholder.jpg';
                    linkEl.href = '#';
                }

                // Items List
                const listContainer = document.getElementById('detail-items-list');
                listContainer.innerHTML = '';

                if (d.items && d.items.length > 0) {
                    d.items.forEach((subItem, index) => {
                        // Fix: Support both productName/quantity and legacy name/qty
                        const pName = subItem.productName || subItem.name || 'สินค้า';
                        const pQty = subItem.quantity || subItem.qty || 0;
                        const pNote = subItem.note || '';

                        const div = document.createElement('div');
                        div.className = "flex justify-between items-center p-3 rounded-xl bg-slate-50 border border-slate-100";
                        div.innerHTML = `
                             <div class="flex items-center gap-3">
                                 <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">${index + 1}</span>
                                 <div>
                                     <span class="font-bold text-slate-700 block">${pName}</span>
                                     ${pNote ? `<span class="text-xs text-slate-400 font-normal">${pNote}</span>` : ''}
                                 </div>
                             </div>
                             <span class="font-bold text-slate-900 bg-white px-2 py-1 rounded border border-slate-100 shadow-sm">x${pQty}</span>
                         `;
                        listContainer.appendChild(div);
                    });
                } else {
                    // Single Item Fallback
                    const pName = d.productName || 'สินค้า';
                    const pQty = d.quantity || 1;

                    listContainer.innerHTML = `
                         <div class="flex justify-between items-center p-3 rounded-xl bg-slate-50 border border-slate-100">
                             <div class="flex items-center gap-3">
                                 <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">1</span>
                                 <span class="font-bold text-slate-700">${pName}</span>
                             </div>
                             <span class="font-bold text-slate-900 bg-white px-2 py-1 rounded border border-slate-100 shadow-sm">x${pQty}</span>
                         </div>
                     `;
                }

                openModal('stockDetailModal');
            }

            async function updateStockStatusFromModal(newStatus) {
                if (!targetImportId) return;

                // Close modals
                closeModal('stockDetailModal');
                closeModal('statusUpdateModal');

                // Call API
                try {
                    const res = await fetch(`${SERVER_URL}/imports/${targetImportId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (res.ok) {
                        showToast('อัปเดตสถานะนำเข้าเรียบร้อยแล้ว');
                        fetchStockImports(); // Refresh Grid
                    } else {
                        showToast('ไม่สามารถอัปเดตสถานะได้', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('เกิดข้อผิดพลาดในการอัปเดตสถานะ', 'error');
                }
            }


            // Forms
            document.getElementById('new-task-form').addEventListener('submit', handleNewTaskSubmit);
            document.getElementById('update-task-form').addEventListener('submit', handleUpdateTaskSubmit);
            document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);

            // Import Forms
            const phoneImportForm = document.getElementById('phone-import-form');
            if (phoneImportForm) {
                phoneImportForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const editId = document.getElementById('phone-import-id').value;
                    const fileInput = document.getElementById('phone-import-file');
                    const imageInput = document.getElementById('phone-import-image');

                    if (!editId && fileInput.files.length === 0) return showToast('กรุณาเลือกไฟล์ Excel', 'warning');

                    const supplier = document.getElementById('phone-import-supplier').value;
                    if (!supplier) return showToast('กรุณาระบุ Supplier', 'warning');

                    const formData = new FormData();
                    formData.append('type', 'phone');

                    // Add Excel files
                    if (fileInput.files.length > 0) {
                        for (let i = 0; i < fileInput.files.length; i++) {
                            formData.append('files', fileInput.files[i]);
                        }
                    }

                    // Add Image files
                    if (imageInput.files.length > 0) {
                        for (let i = 0; i < imageInput.files.length; i++) {
                            formData.append('files', imageInput.files[i]);
                        }
                    }

                    formData.append('companyId', document.getElementById('company-select').value);
                    formData.append('supplier', supplier);

                    const desc = document.getElementById('phone-import-description').value;
                    if (desc) formData.append('description', desc);

                    try {
                        const url = editId ? `${SERVER_URL}/imports/${editId}` : `${SERVER_URL}/imports`;
                        const method = editId ? 'PUT' : 'POST';

                        const res = await fetch(url, {
                            method: method,
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                            body: formData
                        });
                        if (res.ok) {
                            showToast(editId ? 'อัปเดตข้อมูลสำเร็จแล้ว!' : 'แจ้งนำเข้าไฟล์ Excel สำเร็จแล้ว!');
                            closeModal('phoneImportModal');
                            fetchImportRequests();
                        } else {
                            const err = await res.json();
                            showToast('Error: ' + err.message, 'error');
                        }
                    } catch (err) { showToast('Error: ' + err.message, 'error'); }
                });

                document.getElementById('phone-import-file').addEventListener('change', (e) => {
                    const display = document.getElementById('file-name-display');
                    if (e.target.files.length > 0) {
                        display.textContent = e.target.files[0].name;
                        display.classList.remove('hidden');
                        display.classList.add('inline-block'); // Keep this for consistency with original behavior
                    } else {
                        display.textContent = '';
                        display.classList.add('hidden');
                        display.classList.remove('inline-block');
                    }
                });

                // (*** New: Image Preview for Phone Import ***)
                document.getElementById('phone-import-image').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    const preview = document.getElementById('phone-image-preview');
                    const placeholder = document.getElementById('phone-image-placeholder');

                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.src = event.target.result;
                            preview.classList.remove('hidden');
                            placeholder.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        preview.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                        preview.src = '';
                    }
                });
            }

            // --- Dynamic Accessory Import Logic ---
            let accItemCount = 0;

            // Remove legacy listener if exists (it targeted 'accessory-import-form' which is replaced by 'accessory-import-form-multi')
            // We expose these functions to global scope because they are called by onclick attributes in HTML
            window.addAccessoryItemRow = function () {
                const container = document.getElementById('acc-items-container');
                const emptyState = document.getElementById('acc-items-empty');
                if (emptyState) emptyState.classList.add('hidden');

                accItemCount++;
                const rowId = `acc-row-${Date.now()}`;

                const div = document.createElement('div');
                div.className = "grid grid-cols-12 gap-3 p-4 bg-white rounded-xl border border-slate-100 shadow-sm animate-fade-in relative group";
                div.id = rowId;
                div.innerHTML = `
                    <div class="col-span-1 flex items-center justify-center">
                        <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-sm font-bold row-index">#</span>
                    </div>
                    <div class="col-span-7">
                        <label class="block text-xs font-bold text-slate-400 mb-1">ชื่อสินค้า</label>
                        <input type="text" class="acc-item-name form-input-theme w-full" placeholder="ระบุชื่อสินค้า..." required>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-xs font-bold text-slate-400 mb-1">จำนวน</label>
                        <input type="number" class="acc-item-qty form-input-theme w-full text-center font-bold text-indigo-600" value="1" min="1" required>
                    </div>
                    <div class="col-span-1 flex items-center justify-center pt-5">
                        <button type="button" onclick="removeAccessoryRow('${rowId}')" class="text-slate-300 hover:text-red-500 transition-colors p-2">
                            <ion-icon name="trash" class="text-xl"></ion-icon>
                        </button>
                    </div>
                `;
                container.appendChild(div);
                updateAccTotalCount();
            };

            window.removeAccessoryRow = function (id) {
                const row = document.getElementById(id);
                if (row) row.remove();

                const container = document.getElementById('acc-items-container');
                if (container.children.length === 0) {
                    const emptyState = document.getElementById('acc-items-empty');
                    if (emptyState) emptyState.classList.remove('hidden');
                }
                updateAccTotalCount();
            };

            function updateAccTotalCount() {
                const rows = document.querySelectorAll('#acc-items-container > div');
                const countDisplay = document.getElementById('acc-total-items-count');
                if (countDisplay) countDisplay.textContent = rows.length;

                rows.forEach((row, index) => {
                    const idx = row.querySelector('.row-index');
                    if (idx) idx.textContent = index + 1;
                });
            }

            window.submitAccessoryImport = async function () {
                const rows = document.querySelectorAll('#acc-items-container > div');
                if (rows.length === 0) return alert('กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการ');

                const editId = document.getElementById('acc-import-id').value;
                const supplier = document.getElementById('acc-bill-supplier').value;
                const billDate = document.getElementById('acc-bill-date').value;
                const billName = document.getElementById('acc-bill-name').value;
                const imageInput = document.getElementById('acc-bill-image');

                if (!supplier || !billDate) return alert('กรุณาระบุวันที่และชื่อร้านค้า (Supplier)');

                const items = [];
                let isValid = true;
                rows.forEach(row => {
                    const name = row.querySelector('.acc-item-name').value;
                    const qty = row.querySelector('.acc-item-qty').value;
                    if (!name || parseInt(qty) <= 0) isValid = false;
                    items.push({ productName: name, quantity: parseInt(qty) });
                });

                if (!isValid) return alert('กรุณากรอกข้อมูลสินค้าให้ครบถ้วน');

                const formData = new FormData();
                formData.append('type', 'accessory');
                formData.append('companyId', document.getElementById('company-select').value);

                const details = {
                    supplier,
                    importDate: billDate,
                    billName,
                    items
                };
                formData.append('details', JSON.stringify(details));

                if (imageInput.files.length > 0) {
                    for (let i = 0; i < imageInput.files.length; i++) {
                        formData.append('files', imageInput.files[i]);
                    }
                }

                try {
                    const url = editId ? `${SERVER_URL}/imports/${editId}` : `${SERVER_URL}/imports`;
                    const method = editId ? 'PUT' : 'POST';

                    const res = await fetch(url, {
                        method: method,
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                        body: formData
                    });
                    if (res.ok) {
                        alert(editId ? 'อัปเดตแจ้งนำเข้าสำเร็จ' : 'บันทึกแจ้งนำเข้าสำเร็จ');
                        // Reset Form
                        document.getElementById('accessory-import-form-multi').reset();
                        document.getElementById('acc-import-id').value = '';
                        document.getElementById('acc-items-container').innerHTML = '';
                        document.getElementById('acc-items-empty').classList.remove('hidden');
                        document.getElementById('image-preview').classList.add('hidden');
                        document.getElementById('image-preview-placeholder').classList.remove('hidden');
                        updateAccTotalCount();

                        closeModal('accImportModal');
                        fetchImportRequests();
                    } else {
                        const err = await res.json();
                        alert('Error: ' + err.message);
                    }
                } catch (err) { alert('Error: ' + err.message); }
            };

            window.openEditPhoneModal = async function (id) {
                const token = localStorage.getItem('token');
                try {
                    const res = await fetch(`${SERVER_URL}/imports`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await res.json();
                    const allImports = Array.isArray(data) ? data : (data.data || []);
                    const item = allImports.find(i => i._id === id);

                    if (!item) return showToast('ไม่พบข้อมูล', 'error');

                    // Populate
                    document.getElementById('phone-import-id').value = id;
                    document.getElementById('phone-import-supplier').value = item.details?.supplier || '';
                    document.getElementById('phone-import-description').value = item.details?.description || '';

                    // Reset inputs & previews
                    document.getElementById('phone-import-file').value = '';
                    document.getElementById('phone-import-image').value = '';
                    document.getElementById('file-name-display').classList.add('hidden');
                    document.getElementById('phone-image-preview').classList.add('hidden');
                    document.getElementById('phone-image-placeholder').classList.remove('hidden');

                    // (*** New: Show Existing Files ***)
                    const existingContainer = document.getElementById('phone-existing-files');
                    if (existingContainer) existingContainer.remove(); // Clear previous

                    if (item.files && item.files.length > 0) {
                        const container = document.createElement('div');
                        container.id = 'phone-existing-files';
                        container.className = "mt-4 p-3 bg-slate-50 rounded-lg border border-slate-200";
                        container.innerHTML = `<p class="text-xs font-bold text-slate-500 mb-2">ไฟล์เดิมที่แนบไว้ (${item.files.length}):</p>`;

                        const grid = document.createElement('div');
                        grid.className = "flex flex-wrap gap-2";

                        item.files.forEach(f => {
                            const url = f.startsWith('http') ? f : `${SERVER_URL.replace('/api', '')}/${f}`;
                            const isImg = f.match(/\.(jpeg|jpg|gif|png|webp)$/i);
                            if (isImg) {
                                grid.innerHTML += `<a href="${url}" target="_blank"><img src="${url}" class="w-16 h-16 object-cover rounded shadow-sm border border-slate-300 hover:scale-110 transition-transform"></a>`;
                            } else {
                                grid.innerHTML += `<a href="${url}" target="_blank" class="flex items-center gap-1 px-3 py-2 bg-white rounded border border-slate-300 text-xs font-bold text-slate-600 hover:bg-slate-50"><ion-icon name="document-text"></ion-icon> ไฟล์แนบ</a>`;
                            }
                        });
                        container.appendChild(grid);

                        // Insert after file input area (adjust selector as needed)
                        const target = document.getElementById('phone-import-image').closest('.grid');
                        if (target) target.parentNode.insertBefore(container, target.nextSibling);
                    }

                    openModal('phoneImportModal');
                } catch (err) { console.error(err); }
            };

            window.openEditAccModal = async function (id) {
                const token = localStorage.getItem('token');
                try {
                    const res = await fetch(`${SERVER_URL}/imports`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await res.json();
                    const allImports = Array.isArray(data) ? data : (data.data || []);
                    const item = allImports.find(i => i._id === id);

                    if (!item) return alert('ไม่พบข้อมูล');

                    // Reset Form
                    document.getElementById('accessory-import-form-multi').reset();
                    document.getElementById('acc-items-container').innerHTML = '';
                    document.getElementById('acc-import-id').value = id;

                    // Populate fields
                    document.getElementById('acc-bill-supplier').value = item.details?.supplier || '';
                    if (item.details?.importDate) {
                        document.getElementById('acc-bill-date').value = item.details.importDate.split('T')[0];
                    }
                    document.getElementById('acc-bill-name').value = item.details?.billName || '';

                    // Populate items
                    if (item.details?.items && item.details.items.length > 0) {
                        const emptyState = document.getElementById('acc-items-empty');
                        if (emptyState) emptyState.classList.add('hidden');

                        item.details.items.forEach(it => {
                            const container = document.getElementById('acc-items-container');
                            const rowId = `acc-row-${Date.now() + Math.random()}`;
                            const div = document.createElement('div');
                            div.className = "grid grid-cols-12 gap-3 p-4 bg-white rounded-xl border border-slate-100 shadow-sm relative group";
                            div.id = rowId;
                            div.innerHTML = `
                                <div class="col-span-1 flex items-center justify-center">
                                    <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-sm font-bold row-index">#</span>
                                </div>
                                <div class="col-span-7">
                                    <label class="block text-xs font-bold text-slate-400 mb-1">ชื่อสินค้า</label>
                                    <input type="text" class="acc-item-name form-input-theme w-full" value="${it.productName || it.name || ''}" placeholder="ระบุชื่อสินค้า..." required>
                                </div>
                                <div class="col-span-3">
                                    <label class="block text-xs font-bold text-slate-400 mb-1">จำนวน</label>
                                    <input type="number" class="acc-item-qty form-input-theme w-full text-center font-bold text-indigo-600" value="${it.quantity || it.qty || 1}" min="1" required>
                                </div>
                                <div class="col-span-1 flex items-center justify-center pt-5">
                                    <button type="button" onclick="removeAccessoryRow('${rowId}')" class="text-slate-300 hover:text-red-500 transition-colors p-2">
                                        <ion-icon name="trash" class="text-xl"></ion-icon>
                                    </button>
                                </div>
                            `;
                            container.appendChild(div);
                        });
                    } else {
                        addAccessoryItemRow();
                    }

                    // Previews
                    document.getElementById('image-preview').classList.add('hidden');
                    document.getElementById('image-preview-placeholder').classList.remove('hidden');
                    updateAccTotalCount();

                    // (*** New: Show Existing Files for Accessory ***)
                    const existingContainer = document.getElementById('acc-existing-files');
                    if (existingContainer) existingContainer.remove();

                    if (item.files && item.files.length > 0) {
                        const container = document.createElement('div');
                        container.id = 'acc-existing-files';
                        container.className = "col-span-12 mt-4 p-3 bg-slate-50 rounded-lg border border-slate-200";
                        container.innerHTML = `<p class="text-xs font-bold text-slate-500 mb-2">รูปภาพบิลเดิม:</p>`;

                        const grid = document.createElement('div');
                        grid.className = "flex flex-wrap gap-2";

                        item.files.forEach(f => {
                            const url = f.startsWith('http') ? f : `${SERVER_URL.replace('/api', '')}/${f}`;
                            grid.innerHTML += `<a href="${url}" target="_blank"><img src="${url}" class="w-20 h-20 object-cover rounded shadow-sm border border-slate-300 hover:scale-110 transition-transform"></a>`;
                        });
                        container.appendChild(grid);

                        // Insert before form actions
                        const form = document.getElementById('accessory-import-form-multi');
                        if (form) {
                            const lastDiv = form.querySelector('.flex.justify-end'); // The footer buttons
                            if (lastDiv) form.insertBefore(container, lastDiv);
                        }
                    }

                    openModal('accImportModal');
                } catch (err) { console.error(err); }
            };

            // Buttons
            document.getElementById('confirm-delete-button').addEventListener('click', executeDelete);
            document.getElementById('newTaskButton').addEventListener('click', () => {
                fetchAllUsers();
                openModal('newTaskModal');
            });
            // (*** เพิ่ม Listener ปุ่มแสดงงานทั้งหมด ***)
            document.getElementById('showAllTasksBtn').addEventListener('click', () => {
                // 1. ลบ Highlight จากการ์ดสถิติ
                document.querySelectorAll('#stats-cards [data-status]').forEach(card => {
                    card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
                });
                // 2. แสดงงานทั้งหมดจาก Cache
                if (typeof allDashboardTasks !== 'undefined') {
                    renderTaskTable(allDashboardTasks);
                }
            });
            document.getElementById('newUserButton').addEventListener('click', openNewUserModal);
            document.getElementById('notification-bell').addEventListener('click', () => {
                openModal('notificationModal');
                markNotificationsAsRead();
            });
            const mobileBell = document.getElementById('notification-bell-btn-mobile');
            if (mobileBell) {
                mobileBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const mobileDot = document.getElementById('notification-dot-mobile');
                    if (mobileDot) mobileDot.classList.add('hidden');
                    openModal('notificationModal');
                });
            }
            document.getElementById('nav-dashboard').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = 'ผู้รับผิดชอบ';
                e.preventDefault(); updateNavActiveState('dashboard');
                fetchDashboardTasks(); fetchTaskStats();
            });
            document.getElementById('nav-mytasks').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = 'ผู้มอบหมายงาน';
                e.preventDefault(); updateNavActiveState('mytasks');
                fetchMyTasks();
            });
            document.getElementById('nav-admin').addEventListener('click', (e) => {
                e.preventDefault(); updateNavActiveState('admin');
                fetchAllUsersForTable();
            });

            // (*** เพิ่ม: Listener สำหรับเมนู Import ***)
            document.getElementById('nav-import').addEventListener('click', (e) => {
                e.preventDefault();
                updateNavActiveState('import');
                fetchImportRequests(); // เรียกฟังก์ชันดึงข้อมูล (ที่เราเพิ่งสร้าง)
            });

            // (*** เพิ่ม Listener สำหรับเมนู Deposit ***)
            document.getElementById('nav-Storefront_deposit').addEventListener('click', (e) => {
                e.preventDefault();
                updateNavActiveState('deposit'); // เรียกใช้ฟังก์ชันกลาง
                fetchDeposits(); // โหลดข้อมูล
            });

            // Company Change Listener
            document.getElementById('company-select').addEventListener('change', () => {
                if (currentView === 'dashboard') {
                    fetchNotifications(); fetchDashboardTasks(); fetchTaskStats(); fetchAllUsers();
                } else if (currentView === 'admin') {
                    fetchAllUsersForTable();
                } else if (currentView === 'deposit') { // (*** เพิ่ม ***)
                    fetchDeposits(); // รีเฟรชตารางมัดจำเมื่อเปลี่ยนบริษัท
                }
            });

            document.getElementById('user-company-input').addEventListener('change', () => {
                loadManagersForDropdown();
            });

            const branchFilterSelect = document.getElementById('deposit-filter-branch');
            const statusFilterSelect = document.getElementById('deposit-filter-status'); // (*** New Filter ***)

            if (branchFilterSelect) {
                branchFilterSelect.addEventListener('change', () => {
                    fetchDeposits();
                });
            }

            if (statusFilterSelect) {
                statusFilterSelect.addEventListener('change', () => {
                    fetchDeposits();
                });
            }

            const depositDateFilter = document.getElementById('deposit-filter-date');
            if (depositDateFilter) {
                depositDateFilter.addEventListener('change', () => {
                    fetchDeposits();
                });
            }

            const depositSearchInput = document.getElementById('deposit-search-input');
            if (depositSearchInput) {
                depositSearchInput.addEventListener('keyup', () => {
                    fetchDeposits();
                });
            }

            // (*** New Listener: Deposit Due Button ***)
            const depositBellBtn = document.getElementById('btn-filter-due-today');
            if (depositBellBtn) {
                depositBellBtn.addEventListener('click', () => {
                    // Toggle Active state
                    if (depositBellBtn.classList.contains('active-bell')) {
                        depositBellBtn.classList.remove('active-bell');
                        depositBellBtn.classList.remove('ring-2', 'ring-offset-2', 'ring-red-400');
                    } else {
                        depositBellBtn.classList.add('active-bell');
                        depositBellBtn.classList.add('ring-2', 'ring-offset-2', 'ring-red-400');
                    }
                    fetchDeposits();
                });
            }

            // (เสริม) ถ้าเป็น Staff ทั่วไป ซ่อนตัวกรองนี้ไปเลย (เพราะดูได้แค่สาขาตัวเองอยู่แล้ว)
            if (typeof currentUser !== 'undefined' && currentUser && currentUser.role === 'staff') {
                const container = document.getElementById('filter-branch-container');
                if (container) container.style.display = 'none';
            }

            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');

            if (menuToggle && sidebar && overlay) {
                const toggleMenu = () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('hidden');
                };
                menuToggle.addEventListener('click', toggleMenu);
                overlay.addEventListener('click', toggleMenu);

                // ปิดเมนูอัตโนมัติเมื่อกดลิงก์
                document.querySelectorAll('#nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        // เช็คว่าอยู่ในโหมดมือถือ (จอเล็กกว่า 768px)
                        if (window.innerWidth < 768) {
                            toggleMenu();
                        }
                    });
                });
            }



            function renderStockRequestList(requests) {
                const container = document.getElementById('stock-request-table-body');
                if (!container) return;
                container.innerHTML = '';


                if (requests.length === 0) {
                    container.innerHTML = `<tr><td colspan="6" class="px-8 py-20 text-center">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-slate-200">
                                <ion-icon name="file-tray-outline" class="text-4xl"></ion-icon>
                            </div>
                            <p class="text-slate-400 font-bold">ยังไม่มีรายการแจ้งเบิกสินค้า</p>
                        </div>
                    </td></tr>`;
                    return;
                }

                requests.forEach(req => {
                    const date = new Date(req.createdAt).toLocaleDateString('th-TH', {
                        day: '2-digit', month: 'short', year: '2-digit'
                    });
                    const itemsText = req.items.map(i => `<div class="flex justify-between items-center gap-4 py-1.5 border-b border-slate-50 last:border-0"><span class="font-bold text-slate-700">${i.productName}</span><span class="text-indigo-600 font-black px-2 py-0.5 bg-indigo-50 rounded-lg text-[10px]">${i.quantity}</span></div>`).join('');

                    const statusConfig = {
                        'pending': { class: 'bg-amber-50 text-amber-700 ring-1 ring-amber-200', text: 'รอสั่ง', icon: 'time-outline' },
                        'processing': { class: 'bg-blue-50 text-blue-700 ring-1 ring-blue-200', text: 'กำลังสั่ง', icon: 'cart-outline' },
                        'received': { class: 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200', text: 'ได้รับแล้ว', icon: 'checkmark-circle-outline' },
                        'canceled': { class: 'bg-rose-50 text-rose-700 ring-1 ring-rose-200', text: 'ยกเลิก', icon: 'close-circle-outline' }
                    };
                    const config = statusConfig[req.status] || statusConfig['pending'];

                    const tr = document.createElement('tr');
                    tr.className = "group hover:bg-white hover:shadow-xl hover:shadow-indigo-500/5 transition-all duration-300 border-b border-slate-100 last:border-0 bg-slate-50/20";
                    tr.innerHTML = `
                    <td class="px-8 py-6 align-top">
                        <div class="flex flex-col">
                            <span class="text-sm font-black text-slate-800 font-mono">${date}</span>
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">Order Date</span>
                        </div>
                    </td>
                        <td class="px-8 py-6 align-top min-w-[300px]">
                            <div class="mb-3">
                                <span class="text-sm font-black text-indigo-700 flex items-center gap-2">
                                    <ion-icon name="pricetag" class="text-indigo-400"></ion-icon>
                                    ${req.title || 'รายการเบิกทั่วไป'}
                                </span>
                            </div>
                            <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm leading-relaxed">
                                ${itemsText}
                            </div>
                            <div class="flex items-center gap-2 text-[10px] font-black text-slate-400 bg-slate-100/50 w-fit px-3 py-1.5 rounded-xl mt-3">
                                <ion-icon name="person-circle-outline" class="text-sm"></ion-icon>
                                <span>CREATED BY: <span class="text-slate-800 underline underline-offset-2">${req.createdBy?.name || '-'}</span></span>
                            </div>
                        </td>
                        <td class="px-8 py-6 align-top w-40">
                             <span class="inline-flex items-center gap-1.5 px-4 py-2 rounded-2xl text-[11px] font-black shadow-sm ${config.class} transform group-hover:scale-105 transition-transform">
                                <ion-icon name="${config.icon}" class="text-sm"></ion-icon>
                                ${config.text}
                            </span>
                        </td>
                        <td class="px-8 py-6 align-top w-48">
                            ${req.expectedArrivalDate ? `
                                <div class="flex flex-col">
                                    <div class="flex items-center gap-2 text-sm font-black text-slate-800 font-mono">
                                        <ion-icon name="flag" class="text-orange-500"></ion-icon>
                                        ${new Date(req.expectedArrivalDate).toLocaleDateString('th-TH', { day: '2-digit', month: 'short' })}
                                    </div>
                                    <div class="text-[10px] text-orange-600 bg-orange-50 px-2.5 py-1 rounded-full w-fit mt-1.5 border border-orange-100 font-black tracking-widest uppercase">Expected</div>
                                </div>
                            ` : '<span class="text-slate-300 text-xs font-bold italic">Checking...</span>'}
                        </td>
                        <td class="px-8 py-6 align-top text-right w-20">
                            ${req.status === 'pending' ? `
                                <button onclick="deleteStockRequest('${req._id}')" class="p-3 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-2xl transition-all active:scale-90" title="ลบรายการ">
                                    <ion-icon name="trash-outline" class="text-xl"></ion-icon>
                                </button>
                            ` : ''}
                        </td>
                `;
                    container.appendChild(tr);
                });
            }

            // Global Set to store discovered branches


            window.fetchStockRequests = async function () {
                try {
                    const branch = document.getElementById('stock-request-branch-filter')?.value || '';
                    const statusFilterElem = document.getElementById('stock-request-status-filter');
                    const statusFilterVal = statusFilterElem?.value || '';

                    const url = new URL(`${window.location.origin}${SERVER_URL}/stock-requests`);
                    if (branch) url.searchParams.append('branch', branch);
                    // REMOVED: if (status) url.searchParams.append('status', status); -> Fetch ALL for Client-Side Counting

                    const res = await fetch(url.toString(), {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        let requests = await res.json();

                        // 1. Calculate Counts (Client-Side)
                        if (statusFilterElem) {
                            const countAll = requests.length;
                            const countPending = requests.filter(r => r.status === 'pending').length;
                            const countProcessing = requests.filter(r => r.status === 'processing').length;
                            const countReceived = requests.filter(r => r.status === 'received').length;
                            const countCanceled = requests.filter(r => r.status === 'canceled').length;

                            Array.from(statusFilterElem.options).forEach(opt => {
                                if (opt.value === '') opt.textContent = `ทุกสถานะ (${countAll})`;
                                else if (opt.value === 'pending') opt.textContent = `รอสั่ง (${countPending})`;
                                else if (opt.value === 'processing') opt.textContent = `กำลังสั่ง (${countProcessing})`;
                                else if (opt.value === 'received') opt.textContent = `ได้รับแล้ว (${countReceived})`;
                                else if (opt.value === 'canceled') opt.textContent = `ยกเลิก (${countCanceled})`;
                            });
                        }

                        // 2. Filter Display
                        let filteredRequests = requests;

                        // Filter by Status
                        if (statusFilterVal) {
                            filteredRequests = filteredRequests.filter(r => r.status === statusFilterVal);
                        }

                        // Filter by Search Text
                        const searchText = document.getElementById('stock-request-search')?.value.toLowerCase() || '';
                        if (searchText) {
                            filteredRequests = filteredRequests.filter(r => {
                                const titleMatch = (r.title || '').toLowerCase().includes(searchText);
                                const productMatch = r.items.some(i => (i.productName || '').toLowerCase().includes(searchText));
                                return titleMatch || productMatch;
                            });
                        }

                        // Filter by Date
                        const dateFilter = document.getElementById('stock-request-date-filter')?.value;
                        if (dateFilter) {
                            filteredRequests = filteredRequests.filter(r => {
                                const reqDate = new Date(r.createdAt).toISOString().split('T')[0];
                                return reqDate === dateFilter;
                            });
                        }

                        renderStockRequestList(filteredRequests);
                    }
                } catch (err) { console.error(err); }
            };

            window.setManageStatusFilter = function (status) {
                // 1. Update Hidden Input
                document.getElementById('manage-request-status-filter').value = status;

                // 2. Update Visuals
                const buttons = [
                    { id: 'btn-status-all', val: '' },
                    { id: 'btn-status-pending', val: 'pending', color: 'text-amber-600' },
                    { id: 'btn-status-processing', val: 'processing', color: 'text-blue-600' },
                    { id: 'btn-status-received', val: 'received', color: 'text-emerald-600' },
                    { id: 'btn-status-canceled', val: 'canceled', color: 'text-rose-600' }
                ];

                buttons.forEach(btn => {
                    const el = document.getElementById(btn.id);
                    if (el) {
                        if (btn.val === status) {
                            // Active Style
                            el.classList.add('bg-white', 'shadow-sm', 'ring-1', 'ring-black/5');
                            el.classList.remove('text-slate-500');
                            if (btn.color) el.classList.add(btn.color);
                            else el.classList.add('text-indigo-600');
                        } else {
                            // Inactive Style
                            el.classList.remove('bg-white', 'shadow-sm', 'ring-1', 'ring-black/5', 'text-indigo-600', 'text-amber-600', 'text-blue-600', 'text-emerald-600', 'text-rose-600');
                            el.classList.add('text-slate-500');
                        }
                    }
                });

                // 3. Fetch Data
                fetchManageStockRequests();
            };

            window.fetchManageStockRequests = async function () {
                try {
                    const statusFilter = document.getElementById('manage-request-status-filter')?.value || '';
                    const branch = document.getElementById('manage-request-branch-filter')?.value || '';

                    // Fetch ALL to calculate counts (Client-side filtering strategy)
                    const url = new URL(`${window.location.origin}${SERVER_URL}/stock-requests/manage`);
                    if (branch) url.searchParams.append('branch', branch);

                    const res = await fetch(url.toString(), {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        const allRequests = await res.json();

                        // 1. Calculate Counts
                        const counts = {
                            all: allRequests.length,
                            pending: 0,
                            processing: 0,
                            received: 0,
                            canceled: 0
                        };

                        allRequests.forEach(req => {
                            if (counts[req.status] !== undefined) {
                                counts[req.status]++;
                            }
                        });

                        // 2. Update Badges
                        Object.keys(counts).forEach(key => {
                            const badge = document.getElementById(`count-status-${key}`);
                            if (badge) {
                                badge.textContent = counts[key];
                                badge.classList.remove('hidden');
                                if (counts[key] === 0) badge.classList.add('hidden'); // Hide if 0
                            }
                        });

                        // 3. Filter & Render
                        const filtered = statusFilter
                            ? allRequests.filter(req => req.status === statusFilter)
                            : allRequests;

                        renderManageStockRequestList(filtered);
                    }
                } catch (err) { console.error('Fetch manage requests error:', err); }
            };

            function renderManageStockRequestList(requests) {
                const container = document.getElementById('stock-request-manage-table-body');
                if (!container) return;
                container.innerHTML = '';


                if (requests.length === 0) {
                    container.innerHTML = `<tr><td colspan="6" class="px-8 py-20 text-center">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-slate-200">
                                <ion-icon name="file-tray-outline" class="text-4xl"></ion-icon>
                            </div>
                            <p class="text-slate-400 font-bold">ไม่พบรายการแจ้งเบิกในเงื่อนไขนี้</p>
                        </div>
                    </td></tr>`;
                    return;
                }

                requests.forEach(req => {
                    const date = new Date(req.createdAt).toLocaleDateString('th-TH', {
                        day: '2-digit', month: 'short', year: '2-digit'
                    });
                    const itemsText = req.items.map(i => `<div class="flex justify-between items-center gap-4 py-1.5 border-b border-slate-50 last:border-0"><span class="font-bold text-slate-700">${i.productName}</span><span class="text-indigo-600 font-black px-2 py-0.5 bg-indigo-50 rounded-lg text-[10px]">${i.quantity}</span></div>`).join('');

                    const statusConfig = {
                        'pending': { class: 'bg-amber-50 text-amber-700 ring-1 ring-amber-200', text: 'รอสั่ง', icon: 'time-outline' },
                        'processing': { class: 'bg-blue-50 text-blue-700 ring-1 ring-blue-200', text: 'กำลังเตรียมของ', icon: 'cart-outline' },
                        'received': { class: 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200', text: 'ส่งแล้ว', icon: 'checkmark-circle-outline' },
                        'canceled': { class: 'bg-rose-50 text-rose-700 ring-1 ring-rose-200', text: 'ยกเลิก', icon: 'close-circle-outline' }
                    };
                    const config = statusConfig[req.status] || statusConfig['pending'];

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-indigo-50/20 transition-all duration-300 group border-b border-slate-100 last:border-0";
                    tr.innerHTML = `
                        <td class="px-8 py-6 align-top">
                            <div class="flex flex-col">
                                <span class="text-sm font-black text-slate-800 font-mono">${date}</span>
                            </div>
                        </td>
                        <td class="px-8 py-6 align-top">
                           <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-100 shrink-0">
                                    <ion-icon name="person" class="text-lg"></ion-icon>
                                </div>
                                <div>
                                    <div class="text-sm font-black text-slate-800">${req.createdBy?.name || 'Unknown'}</div>
                                    <div class="flex items-center gap-1.5 text-xs text-slate-500 font-bold mt-1">
                                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                        ${req.branch || 'สำนักงานใหญ่'}
                                    </div>
                                </div>
                           </div>
                        </td>
                        <td class="px-8 py-6 align-top min-w-[300px]">
                            <div class="mb-3">
                                <span class="text-sm font-black text-indigo-700 flex items-center gap-2">
                                    <ion-icon name="pricetag" class="text-indigo-400"></ion-icon>
                                    ${req.title || 'รายการเบิกทั่วไป'}
                                </span>
                            </div>
                            <div class="bg-slate-50/50 rounded-2xl p-4 border border-slate-100 shadow-inner group-hover:bg-white transition-colors">
                                ${itemsText}
                            </div>
                            ${req.note ? `<div class="mt-3 text-[11px] text-slate-500 leading-relaxed italic bg-amber-50/50 p-2 rounded-lg border border-amber-100 flex gap-2"><ion-icon name="chatbox-outline" class="text-amber-400 mt-0.5 shrink-0"></ion-icon><span>${req.note}</span></div>` : ''}
                        </td>
                        <td class="px-8 py-6 align-top">
                            <span class="inline-flex items-center gap-1.5 px-4 py-2 rounded-2xl text-[11px] font-black shadow-sm ${config.class} transform group-hover:scale-105 transition-transform">
                                <ion-icon name="${config.icon}" class="text-sm"></ion-icon>
                                ${config.text}
                            </span>
                        </td>
                        <td class="px-8 py-6 align-top">
                            ${req.expectedArrivalDate ? `
                                <div class="flex flex-col">
                                    <div class="flex items-center gap-2 text-sm font-black text-slate-800 font-mono">
                                        <ion-icon name="airplane-outline" class="text-orange-500 rotate-45"></ion-icon>
                                        ${new Date(req.expectedArrivalDate).toLocaleDateString('th-TH', { day: '2-digit', month: 'short' })}
                                    </div>
                                    <span class="text-[10px] text-orange-600 font-black uppercase tracking-wider mt-1">Expected</span>
                                </div>
                            ` : '<span class="text-slate-300 text-xs font-bold italic">N/A</span>'}
                        </td>
                        <td class="px-8 py-6 align-top text-right">
                            <button onclick='openManageRequestModal(${JSON.stringify(req)})' 
                                class="inline-flex items-center gap-2.5 px-5 py-3 bg-white border border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 text-slate-600 hover:text-indigo-700 rounded-2xl text-xs font-black transition-all shadow-sm hover:shadow-xl active:scale-95 group/btn">
                                <ion-icon name="options-outline" class="text-lg group-hover/btn:rotate-180 transition-transform duration-500"></ion-icon>
                                <span>จัดการ</span>
                            </button>
                        </td>
                    `;
                    container.appendChild(tr);
                });
            }

            window.openStockRequestModal = function () {
                const titleInput = document.getElementById('stock-request-title');
                const noteInput = document.getElementById('stock-request-note');
                if (titleInput) titleInput.value = '';
                if (noteInput) noteInput.value = '';

                document.getElementById('stock-request-items-container').innerHTML = '';
                addStockRequestItemRow();
                openModal('stockRequestModal');
            };

            window.addStockRequestItemRow = function () {
                const container = document.getElementById('stock-request-items-container');
                const rowId = `request-row-${Date.now()}`;
                const div = document.createElement('div');
                div.id = rowId;
                div.className = "grid grid-cols-12 gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100 animate-fade-in";
                div.innerHTML = `
                    <div class="col-span-8">
                        <input type="text" class="request-item-name form-input-theme w-full" placeholder="ชื่อสินค้า..." required>
                    </div>
                    <div class="col-span-3">
                        <input type="number" class="request-item-qty form-input-theme w-full text-center" value="1" min="1" required>
                    </div>
                    <div class="col-span-1 flex items-center justify-center">
                        <button type="button" onclick="removeStockRequestItemRow('${rowId}')" class="text-slate-300 hover:text-red-500 transition-colors">
                            <ion-icon name="close-circle" class="text-xl"></ion-icon>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            };

            window.removeStockRequestItemRow = function (id) {
                const row = document.getElementById(id);
                if (row) row.remove();
                if (document.getElementById('stock-request-items-container').children.length === 0) {
                    addStockRequestItemRow();
                }
            };

            window.submitStockRequest = async function () {
                const title = document.getElementById('stock-request-title').value;
                const rows = document.querySelectorAll('#stock-request-items-container > div');
                const items = Array.from(rows).map(row => ({
                    name: row.querySelector('.request-item-name').value,
                    quantity: parseInt(row.querySelector('.request-item-qty').value)
                }));
                const note = document.getElementById('stock-request-note').value;

                if (!title) return showToast('กรุณาระบุชื่อรายการ', 'warning');

                try {
                    const res = await fetch(`${SERVER_URL}/stock-requests`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ title, items, note })
                    });
                    if (res.ok) {
                        showToast('ส่งรายการแจ้งเบิกสำเร็จแล้ว!');
                        closeModal('stockRequestModal');
                        fetchStockRequests();
                    }
                } catch (err) { showToast('Error: ' + err.message, 'error'); }
            };

            let currentManagingRequestId = null;
            window.openManageRequestModal = function (req) {
                currentManagingRequestId = req._id;
                document.getElementById('manage-request-status').value = req.status;

                const itemsContainer = document.getElementById('manage-request-items-list');
                if (itemsContainer) {
                    if (req.items && req.items.length > 0) {
                        itemsContainer.innerHTML = `
                            <div class="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 ml-1">
                                <ion-icon name="list-outline" class="text-sm"></ion-icon>
                                สรุปรายการสินค้า
                            </div>
                            <div class="bg-white/50 rounded-3xl border border-slate-200/60 overflow-hidden shadow-sm">
                                ${req.items.map(item => `
                                    <div class="flex justify-between items-center px-5 py-4 border-b border-slate-100 last:border-0 hover:bg-white transition-colors">
                                        <div class="flex flex-col">
                                            <span class="font-black text-slate-800 text-sm">${item.productName}</span>
                                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Product Name</span>
                                        </div>
                                        <div class="flex flex-col items-end">
                                            <span class="font-black text-indigo-600 text-base">${item.quantity}</span>
                                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Qty</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        itemsContainer.innerHTML = `
                            <div class="text-center py-8 bg-slate-100/50 rounded-3xl border border-dashed border-slate-200">
                                <ion-icon name="alert-circle-outline" class="text-3xl text-slate-300 mb-2"></ion-icon>
                                <p class="text-slate-400 font-bold text-sm">ไม่มีรายการสินค้า</p>
                            </div>
                        `;
                    }
                }

                if (req.expectedArrivalDate) {
                    const date = new Date(req.expectedArrivalDate).toISOString().split('T')[0];
                    document.getElementById('manage-request-arrival').value = date;
                } else {
                    document.getElementById('manage-request-arrival').value = '';
                }
                openModal('manageRequestModal');
            };

            window.updateRequestStatus = async function () {
                const status = document.getElementById('manage-request-status').value;
                const expectedArrival = document.getElementById('manage-request-arrival').value;

                try {
                    const res = await fetch(`${SERVER_URL}/stock-requests/${currentManagingRequestId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ status, expectedArrival })
                    });
                    if (res.ok) {
                        showToast('อัปเดตสถานะสำเร็จแล้ว!');
                        closeModal('manageRequestModal');
                        fetchManageStockRequests();
                    }
                } catch (err) { showToast('Error: ' + err.message, 'error'); }
            };

            window.deleteStockRequest = async function (id) {
                if (!confirm('ยืนยันการลบรายการแจ้งเบิกนี้?')) return;
                try {
                    const res = await fetch(`${SERVER_URL}/stock-requests/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        showToast('ลบรายการแจ้งเบิกเรียบร้อยแล้ว');
                        fetchStockRequests();
                    }
                } catch (err) { showToast('Error: ' + err.message, 'error'); }
            };

            // --- Event Listeners for Stock Requests ---
            const navStockRequest = document.getElementById('nav-stock-request');
            if (navStockRequest) {
                navStockRequest.addEventListener('click', (e) => {
                    e.preventDefault();
                    updateNavActiveState('stock-request');
                    fetchStockRequests();
                });
            }

            const navStockRequestManage = document.getElementById('nav-stock-request-manage');
            if (navStockRequestManage) {
                navStockRequestManage.addEventListener('click', (e) => {
                    e.preventDefault();
                    updateNavActiveState('stock-request-manage');
                    fetchManageStockRequests();
                });
            }

            const manageStatusFilter = document.getElementById('manage-request-status-filter');
            if (manageStatusFilter) {
                manageStatusFilter.addEventListener('change', fetchManageStockRequests);
            }

            const manageBranchFilter = document.getElementById('manage-request-branch-filter');
            if (manageBranchFilter) {
                manageBranchFilter.addEventListener('change', fetchManageStockRequests);
            }

            const stockStatusFilter = document.getElementById('stock-request-status-filter');
            if (stockStatusFilter) {
                stockStatusFilter.addEventListener('change', fetchStockRequests);
            }

            const stockBranchFilter = document.getElementById('stock-request-branch-filter');
            if (stockBranchFilter) {
                stockBranchFilter.addEventListener('change', fetchStockRequests);
            }

            const purForm = document.getElementById('purchasing-form');
            if (purForm) {
                purForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const token = localStorage.getItem('token');
                    const id = document.getElementById('pur-id').value;
                    const companyId = document.getElementById('company-select').value;

                    try {
                        // 1. ดึงข้อมูลเก่ามาก่อนเพื่อความปลอดภัย (ป้องกันข้อมูลลูกค้าหาย)
                        const resGet = await fetch(`${SERVER_URL}/deposits?companyId=${companyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const allDeposits = await resGet.json();
                        const oldData = allDeposits.find(d => d._id === id);

                        if (!oldData) {
                            alert('ไม่พบข้อมูลเดิม');
                            return;
                        }

                        // 2. รวมข้อมูลเก่ากับสถานะใหม่
                        const payload = {
                            ...oldData, // แผ่ข้อมูลเดิม
                            id: oldData._id, // *** สำคัญ: ต้องระบุ id เพื่อให้ Backend รู้ว่าเป็นการแก้ไข ***
                            orderStatus: document.getElementById('pur-status').value,
                            orderNote: document.getElementById('pur-note').value,
                            expectedArrivalDate: document.getElementById('pur-arrival-date').value // ส่งวันที่ไปด้วย
                        };

                        // 3. ส่งกลับไปบันทึก
                        const res = await fetch(`${SERVER_URL}/deposits`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            closeModal('purchasingModal');
                            fetchPurchasingOrders(); // รีเฟรชตาราง
                        } else {
                            alert('บันทึกไม่สำเร็จ');
                        }
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                });
            }


        });

        // Modal Control
        function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // (*** New: Import System Functions ***)
        function switchImportTab(type) {
            const phoneSection = document.getElementById('tab-import-phone');
            const accSection = document.getElementById('tab-import-accessory');
            const phoneBtn = document.getElementById('tab-btn-phone');
            const accBtn = document.getElementById('tab-btn-accessory');

            if (type === 'phone') {
                safeShow(phoneSection);
                safeHide(accSection);

                phoneBtn.classList.remove('text-slate-500', 'hover:bg-slate-50');
                phoneBtn.classList.add('bg-yellow-400', 'text-slate-900', 'shadow-md', 'shadow-yellow-400/30');

                accBtn.classList.add('text-slate-500', 'hover:bg-slate-50');
                accBtn.classList.remove('bg-slate-800', 'text-white', 'shadow-md');
            } else {
                safeHide(phoneSection);
                safeShow(accSection);

                accBtn.classList.remove('text-slate-500', 'hover:bg-slate-50');
                accBtn.classList.add('bg-slate-900', 'text-white', 'shadow-md', 'shadow-slate-900/20');

                phoneBtn.classList.add('text-slate-500', 'hover:bg-slate-50');
                phoneBtn.classList.remove('bg-yellow-400', 'text-slate-900', 'shadow-md', 'shadow-yellow-400/30');
            }
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const placeholder = document.getElementById('image-preview-placeholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ประกาศตัวแปรนี้ไว้ข้างบนสุด (ถ้ายังไม่มี)
        let allImportsData = [];

        async function fetchImportRequests() {
            console.log("--- เริ่มโหลดข้อมูล Import ---");

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('ไม่พบ Token! กรุณา Login ใหม่');
                    window.location.href = 'login.html';
                    return;
                }

                const targetUrl = `${SERVER_URL}/imports?limit=100`;
                console.log("กำลังเรียก URL:", targetUrl);

                const res = await fetch(targetUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!res.ok) {
                    console.error("Server Error:", res.status);
                    return;
                }

                const responseData = await res.json();

                if (Array.isArray(responseData)) {
                    allImportsData = responseData;
                } else if (responseData.data && Array.isArray(responseData.data)) {
                    allImportsData = responseData.data;
                } else {
                    allImportsData = [];
                }

                // Call both render functions
                // Call both render functions and update counts
                if (typeof renderPhoneImportList === 'function') renderPhoneImportList();
                if (typeof renderAccessoryImportList === 'function') renderAccessoryImportList();
                updateImportStatusCounts();

            } catch (e) {
                console.error("Fetch Error:", e);
                showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + e.message, 'error');
            }
        }

        // Helper: Update counts in select options
        function updateImportStatusCounts() {
            // Count Phone Stats
            const phoneItems = allImportsData.filter(i => i.type === 'phone');
            const phoneCounts = {
                all: phoneItems.length,
                pending: phoneItems.filter(i => (i.status || 'pending') === 'pending').length,
                importing: phoneItems.filter(i => i.status === 'importing').length,
                received: phoneItems.filter(i => i.status === 'received').length
            };

            // Update Phone Dropdown
            const phoneSelect = document.getElementById('phone-import-status');
            if (phoneSelect) {
                // Keep selected value
                const currentVal = phoneSelect.value;
                phoneSelect.innerHTML = `
                    <option value="all">ทุกสถานะ (${phoneCounts.all})</option>
                    <option value="pending">รอนำเข้า (${phoneCounts.pending})</option>
                    <option value="importing">กำลังนำเข้า (${phoneCounts.importing})</option>
                    <option value="received">สำเร็จ (${phoneCounts.received})</option>
                `;
                phoneSelect.value = currentVal;
            }

            // Count Accessory Stats
            const accItems = allImportsData.filter(i => i.type === 'accessory' || i.type === 'accessories');
            const accCounts = {
                all: accItems.length,
                pending: accItems.filter(i => (i.status || 'pending') === 'pending').length,
                importing: accItems.filter(i => i.status === 'importing').length,
                received: accItems.filter(i => i.status === 'received').length
            };

            // Update Accessory Dropdown
            const accSelect = document.getElementById('acc-import-status');
            if (accSelect) {
                const currentVal = accSelect.value;
                accSelect.innerHTML = `
                    <option value="all">ทุกสถานะ (${accCounts.all})</option>
                    <option value="pending">รอนำเข้า (${accCounts.pending})</option>
                    <option value="importing">กำลังนำเข้า (${accCounts.importing})</option>
                    <option value="received">สำเร็จ (${accCounts.received})</option>
                `;
                accSelect.value = currentVal;
            }
        }

        // 1. Render Phone List
        function renderPhoneImportList() {
            const searchInput = document.getElementById('phone-import-search');
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';

            const statusInput = document.getElementById('phone-import-status');
            const statusFilter = statusInput ? statusInput.value : 'all';

            // Filter for Phone
            const filteredData = allImportsData.filter(item => {
                if (item.type !== 'phone') return false;

                const s = item.status || 'pending';
                const statusMatch = statusFilter === 'all' || s === statusFilter;

                const supplier = (item.details?.supplier || '').toLowerCase();
                const branch = (item.branch || '').toLowerCase();
                const desc = (item.details?.description || '').toLowerCase();

                const searchMatch = !searchText ||
                    supplier.includes(searchText) ||
                    branch.includes(searchText) ||
                    desc.includes(searchText);

                return statusMatch && searchMatch;
            });

            const phoneList = document.getElementById('phone-import-list');
            if (phoneList) {
                phoneList.innerHTML = '';
                if (filteredData.length === 0) {
                    phoneList.innerHTML = `<tr><td colspan="7" class="px-6 py-10 text-center text-slate-400">ไม่พบรายการ</td></tr>`;
                } else {
                    filteredData.forEach(item => {
                        const dateStr = new Date(item.createdAt).toLocaleDateString('th-TH');
                        const fileCount = item.files ? item.files.length : 0;

                        let fileName = '-';
                        if (fileCount > 0) {
                            fileName = `<div class="flex flex-col gap-1">`;
                            item.files.forEach((rawPath) => {
                                const finalUrl = rawPath.startsWith('http') ? rawPath : `${SERVER_URL.replace('/api', '')}/${rawPath}`;
                                const isExcel = rawPath.toLowerCase().endsWith('.xlsx') || rawPath.toLowerCase().endsWith('.xls');
                                const icon = isExcel ? 'document-text' : 'image';
                                const label = isExcel ? 'Excel' : 'รูปภาพ';

                                fileName += `
                            <a href="${finalUrl}" target="_blank" class="text-indigo-500 font-bold hover:underline flex items-center gap-1 text-xs">
                                <ion-icon name="${icon}"></ion-icon> ${label}
                            </a>`;
                            });
                            fileName += `</div>`;
                        }
                        const branch = item.branch || '-';
                        const createdBy = item.createdBy ? item.createdBy.name : '-';
                        const details = item.details || {};
                        const supplier = details.supplier || '-';
                        const desc = details.description || '-';

                        const userDept = (currentUser?.department || '').toLowerCase();
                        const isSalesTeam = userDept.includes('ขาย') || userDept.includes('sales');
                        const isStockUser = userDept.includes('stock') || userDept.includes('store') || userDept.includes('สต๊อก');
                        const isAdminOrMgr = ['admin', 'manager', 'executive'].includes(currentUser?.role);
                        const canUpdate = !isSalesTeam && (isAdminOrMgr || isStockUser);

                        const statusBadgeOnClick = canUpdate ? `onclick="updateImportAction('${item._id}', '${item.status}')"` : '';
                        const statusBadgeClass = canUpdate ? 'cursor-pointer hover:bg-slate-200 transition-colors' : 'cursor-default opacity-90';
                        const editIcon = canUpdate ? ' <ion-icon name="create-outline"></ion-icon>' : '';

                        let statusBadge = `<span class="px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-xs font-bold ${statusBadgeClass}" ${statusBadgeOnClick}>รอตรวจสอบ${editIcon}</span>`;
                        if (item.status === 'pending') statusBadge = `<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold ring-1 ring-yellow-200 ${statusBadgeClass}" ${statusBadgeOnClick}>รอนำเข้า${editIcon}</span>`;
                        else if (item.status === 'importing') statusBadge = `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold ring-1 ring-blue-200 ${statusBadgeClass}" ${statusBadgeOnClick}>กำลังนำเข้า${editIcon}</span>`;
                        else if (item.status === 'received') statusBadge = `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold ring-1 ring-green-200 ${statusBadgeClass}" ${statusBadgeOnClick}>สำเร็จ${editIcon}</span>`;

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 transition-all border-b border-slate-100 last:border-0";
                        tr.innerHTML = `
                            <td class="px-6 py-4 text-sm font-bold text-slate-600">${dateStr}</td>
                            <td class="px-6 py-4 text-sm">${fileName}</td>
                            <td class="px-6 py-4 text-sm text-slate-600">
                                <span class="font-bold text-slate-800">${supplier}</span>
                                ${desc !== '-' ? `<div class="text-xs text-slate-400 mt-1">${desc}</div>` : ''}
                            </td>
                            <td class="px-6 py-4 text-sm font-bold text-slate-700">${branch}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-sm text-slate-500">${createdBy}</td>
                            <td class="px-6 py-4 text-sm text-right">
                                <button onclick="deleteImportRequest('${item._id}')" class="text-slate-300 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50">
                                    <ion-icon name="trash" class="text-lg"></ion-icon>
                                </button>
                            </td>
                        `;
                        phoneList.appendChild(tr);
                    });
                }
            }
        }

        // 2. Render Accessory List
        function renderAccessoryImportList() {
            const searchInput = document.getElementById('acc-import-search');
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';

            const statusInput = document.getElementById('acc-import-status');
            const statusFilter = statusInput ? statusInput.value : 'all';

            // Filter for Accessory
            const filteredData = allImportsData.filter(item => {
                if (item.type !== 'accessory' && item.type !== 'accessories') return false;

                const s = item.status || 'pending';
                const statusMatch = statusFilter === 'all' || s === statusFilter;

                const details = item.details || {};
                const supplier = (details.supplier || '').toLowerCase();
                const bill = (details.billName || '').toLowerCase();

                // Item names search
                let itemNames = '';
                if (details.items) {
                    itemNames = details.items.map(i => i.productName).join(' ').toLowerCase();
                }

                const searchMatch = !searchText ||
                    supplier.includes(searchText) ||
                    bill.includes(searchText) ||
                    itemNames.includes(searchText);

                return statusMatch && searchMatch;
            });

            const accList = document.getElementById('accessory-import-list');
            if (accList) {
                accList.innerHTML = '';
                if (filteredData.length === 0) {
                    accList.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400">ไม่พบรายการ Accessory</div>`;
                } else {
                    filteredData.forEach(item => {
                        const details = item.details || {};
                        let imgUrl = null;
                        if (item.files && item.files.length > 0) {
                            const rawPath = item.files[0];
                            if (rawPath.startsWith('http')) {
                                imgUrl = rawPath;
                            } else {
                                imgUrl = `${SERVER_URL.replace('/api', '')}/${rawPath}`;
                            }
                        }

                        let statusBadge = `bg-slate-100 text-slate-400`;
                        let statusText = item.status || 'pending';
                        if (statusText === 'pending') { statusBadge = `bg-yellow-100 text-yellow-700 ring-1 ring-yellow-200`; statusText = 'รอนำเข้า'; }
                        else if (statusText === 'importing') { statusBadge = `bg-blue-100 text-blue-700 ring-1 ring-blue-200`; statusText = 'กำลังนำเข้า'; }
                        else if (statusText === 'received') { statusBadge = `bg-green-100 text-green-700 ring-1 ring-green-200`; statusText = 'สำเร็จ'; }
                        else if (statusText === 'rejected' || statusText === 'canceled') { statusBadge = `bg-rose-100 text-rose-700 ring-1 ring-rose-200`; statusText = 'ยกเลิกแล้ว'; }

                        let nameDisplay = details.productName || 'สินค้า';
                        if (details.billName) {
                            nameDisplay = details.billName;
                        }

                        let qtyDisplay = 0;
                        let descDisplay = '-';

                        if (!details.billName && details.items && details.items.length > 0) {
                            if (details.items.length === 1) {
                                nameDisplay = details.items[0].productName;
                                qtyDisplay = details.items[0].quantity;
                                descDisplay = details.items[0].note || '-';
                            } else {
                                nameDisplay = `${details.items[0].productName} <span class="text-slate-400 font-normal text-xs">+${details.items.length - 1} รายการ</span>`;
                                const totalQty = details.items.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0);
                                qtyDisplay = totalQty;
                                descDisplay = details.items.map(i => `${i.productName} (x${i.quantity})`).join(', ');
                            }
                        } else if (details.items && details.items.length > 0) {
                            const totalQty = details.items.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0);
                            qtyDisplay = totalQty;
                            descDisplay = details.items.map(i => `${i.productName} (x${i.quantity})`).join(', ');
                        }

                        const userDept = (currentUser?.department || '').toLowerCase();
                        const isSalesTeam = userDept.includes('ขาย') || userDept.includes('sales');
                        const isStockUser = userDept.includes('stock') || userDept.includes('store') || userDept.includes('สต๊อก');
                        const isAdminOrMgr = ['admin', 'manager', 'executive'].includes(currentUser?.role);
                        const canUpdate = !isSalesTeam && (isAdminOrMgr || isStockUser);

                        const statusActionAttr = canUpdate ? `onclick="updateImportAction('${item._id}', '${item.status}')"` : '';
                        const statusClassAttr = canUpdate ? 'cursor-pointer hover:opacity-80 transition-opacity' : 'cursor-default opacity-90';
                        const accEditIcon = canUpdate ? ' <ion-icon name="create-outline" class="text-xs"></ion-icon>' : '';

                        const card = document.createElement('div');
                        card.className = "bg-white border border-slate-100 rounded-2xl p-4 flex gap-4 hover:shadow-lg transition-all group relative overflow-hidden";
                        card.innerHTML = `
                            <div class="w-24 h-24 rounded-xl bg-slate-50 flex-shrink-0 flex items-center justify-center overflow-hidden border border-slate-100 relative group-hover:border-yellow-400 transition-colors">
                                ${imgUrl ? `<img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">` : `<ion-icon name="receipt-outline" class="text-3xl text-slate-300"></ion-icon>`}
                            </div>
                            <div class="flex-1 min-w-0 flex flex-col justify-between py-1 relative z-10">
                                <div>
                                    <div class="flex justify-between items-start">
                                        <h5 class="font-bold text-slate-800 text-sm truncate pr-2 w-full" title="${descDisplay}">${nameDisplay}</h5>
                                         <button onclick="deleteImportRequest('${item._id}')" class="absolute top-0 right-0 text-slate-300 hover:text-red-500 transition-colors bg-white/80 p-1 rounded-full backdrop-blur-sm opacity-0 group-hover:opacity-100">
                                            <ion-icon name="trash"></ion-icon>
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-2 mt-1 ${statusClassAttr}" ${statusActionAttr}>
                                        <span class="px-2 py-0.5 rounded-md text-[10px] font-bold ${statusBadge}">${statusText}${accEditIcon}</span>
                                        ${details.supplier ? `<span class="text-[10px] text-slate-400 flex items-center gap-1"><ion-icon name="storefront"></ion-icon> ${details.supplier}</span>` : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 mt-2 line-clamp-1">${descDisplay}</p>
                                </div>
                                <div class="flex justify-between items-end mt-2 border-t border-slate-50 pt-2">
                                    <p class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded-lg font-bold">รวม ${qtyDisplay} ชิ้น</p>
                                    <p class="text-[10px] text-slate-400 flex items-center gap-1"><ion-icon name="calendar-outline"></ion-icon> ${new Date(item.details.importDate || item.createdAt).toLocaleDateString('th-TH')}</p>
                                </div>
                            </div>
                        `;
                        accList.appendChild(card);
                    });
                }
            }
        }

        async function updateImportAction(id, currentStatus) {
            const userDept = (currentUser?.department || '').toLowerCase();
            const isSalesTeam = userDept.includes('ขาย') || userDept.includes('sales');
            const isStockUser = userDept.includes('stock') || userDept.includes('store') || userDept.includes('สต๊อก');
            const isAdminOrMgr = ['admin', 'manager', 'executive'].includes(currentUser?.role);

            if (isSalesTeam || (!isAdminOrMgr && !isStockUser)) {
                return showToast('คุณไม่มีสิทธิ์เปลี่ยนสถานะรายการนี้', 'error');
            }

            const statusTh = { 'pending': 'รอนำเข้า', 'importing': 'กำลังนำเข้า', 'received': 'สำเร็จ', 'rejected': 'ยกเลิก' };
            const nextMap = { 'pending': 'importing', 'importing': 'received', 'received': 'pending' };
            const next = nextMap[currentStatus] || 'pending';
            if (confirm(`ต้องการเปลี่ยนสถานะจาก "${statusTh[currentStatus] || currentStatus}" เป็น "${statusTh[next] || next}" หรือไม่?`)) {
                try {
                    const res = await fetch(`${SERVER_URL}/imports/${id}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                        body: JSON.stringify({ status: next })
                    });
                    if (res.ok) {
                        const updated = await res.json();
                        const index = allImportsData.findIndex(i => i._id === id);
                        if (index !== -1) allImportsData[index].status = updated.status;
                        showToast('เปลี่ยนสถานะสำเร็จแล้ว');
                        renderPhoneImportList();
                        renderAccessoryImportList();
                        updateImportStatusCounts();
                    } else { showToast('อัปเดตสถานะไม่สำเร็จ', 'error'); }
                } catch (e) { showToast('Error: ' + e.message, 'error'); }
            }
        }

        async function deleteImportRequest(id) {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบรายการนี้?')) {
                try {
                    const res = await fetch(`${SERVER_URL}/imports/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        showToast('ลบรายการนำเข้าสำเร็จแล้ว');
                        // If it exists in Notification view cache
                        if (typeof allImportsData !== 'undefined') {
                            allImportsData = allImportsData.filter(i => i._id !== id);
                            if (typeof renderPhoneImportList === 'function') {
                                renderPhoneImportList();
                                renderAccessoryImportList();
                                updateImportStatusCounts();
                            }
                        }
                        // Refresh Stock Management View
                        if (typeof fetchStockImports === 'function') fetchStockImports();
                    } else {
                        const errData = await res.json().catch(() => ({}));
                        showToast('ไม่สามารถลบรายการได้: ' + (errData.message || res.statusText), 'error');
                    }
                } catch (e) { showToast('เกิดข้อผิดพลาด: ' + e.message, 'error'); }
            }
        }


        // (*** New: Open Acc Modal ***)
        function openAccessoryImportModal() {
            // Reset
            const form = document.getElementById('accessory-import-form-multi');
            if (form) form.reset();

            const container = document.getElementById('acc-items-container');
            if (container) container.innerHTML = ''; // Clear items

            const emptyState = document.getElementById('acc-items-empty');
            if (emptyState) emptyState.classList.remove('hidden');

            // Preview Image Reset
            const imgPreview = document.getElementById('image-preview');
            const imgPlaceholder = document.getElementById('image-preview-placeholder');
            if (imgPreview) {
                imgPreview.classList.add('hidden');
                imgPreview.src = '';
            }
            if (imgPlaceholder) imgPlaceholder.classList.remove('hidden');

            // Set Default Date
            const dateInput = document.getElementById('acc-bill-date');
            if (dateInput) dateInput.valueAsDate = new Date();

            const countDisplay = document.getElementById('acc-total-items-count');
            if (countDisplay) countDisplay.textContent = '0';

            openModal('accImportModal');
            // Add first row by default (optional, user might want to see empty state first, but let's add one)
            addAccessoryItemRow();
        }

        // (*** New: Add Item Row ***)
        function addAccessoryItemRow() {
            const emptyState = document.getElementById('acc-items-empty');
            if (emptyState) emptyState.classList.add('hidden');

            const container = document.getElementById('acc-items-container');
            const rowId = 'acc-row-' + Date.now();

            const div = document.createElement('div');
            div.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-start md:items-center animate-fade-in group";
            div.id = rowId;
            div.innerHTML = `
                <div class="flex-1 w-full">
                    <input type="text" name="acc-item-name" placeholder="ชื่อสินค้า (เช่น หูฟัง, กระจก)" class="form-input-theme w-full" required>
                </div>
                <div class="w-24">
                    <input type="number" name="acc-item-qty" value="1" min="1" class="form-input-theme w-full text-center" placeholder="จำนวน" required>
                </div>
                <div class="flex-1 w-full">
                    <input type="text" name="acc-item-desc" placeholder="รายละเอียด/หมายเหตุ" class="form-input-theme w-full">
                </div>
                <button type="button" onclick="removeAccessoryItemRow('${rowId}')" class="text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-all">
                    <ion-icon name="trash-outline" class="text-xl"></ion-icon>
                </button>
            `;
            container.appendChild(div);
            updateAccTotalCount();
        }

        function removeAccessoryItemRow(id) {
            const row = document.getElementById(id);
            if (row) row.remove();

            const container = document.getElementById('acc-items-container');
            if (container.children.length === 0) {
                document.getElementById('acc-items-empty').classList.remove('hidden');
            }
            updateAccTotalCount();
        }

        function updateAccTotalCount() {
            const container = document.getElementById('acc-items-container');
            if (container) {
                const count = container.children.length;
                document.getElementById('acc-total-items-count').textContent = count;
            }
        }

        // (*** New: Submit Multi-Item Import ***)
        async function submitAccessoryImport() {
            const fileInput = document.getElementById('acc-bill-image');
            const date = document.getElementById('acc-bill-date').value;
            const supplier = document.getElementById('acc-bill-supplier').value;
            const billName = document.getElementById('acc-bill-name')?.value || '';

            if (!date) return showToast('กรุณาระบุวันที่', 'warning');
            if (!billName) return showToast('กรุณาระบุเลขที่เอกสาร/ชื่อบิล', 'warning');

            // Collect Items
            const rows = document.getElementById('acc-items-container').children;
            if (rows.length === 0) return showToast('กรุณาเพิ่มรายการสินค้าอย่างน้อย 1 รายการ', 'warning');

            let items = [];
            for (let row of rows) {
                const name = row.querySelector('[name="acc-item-name"]').value;
                const qty = row.querySelector('[name="acc-item-qty"]').value;
                const desc = row.querySelector('[name="acc-item-desc"]').value;

                if (!name || !qty) return showToast('กรุณากรอกชื่อสินค้าและจำนวนให้ครบถ้วน', 'warning');
                items.push({
                    productName: name,
                    quantity: Number(qty),
                    note: desc
                });
            }

            const formData = new FormData();
            formData.append('type', 'accessory');
            formData.append('companyId', document.getElementById('company-select').value);
            formData.append('importDate', date);
            if (supplier) formData.append('supplier', supplier);

            const details = {
                supplier,
                billName,
                items
            };

            formData.append('details', JSON.stringify(details));

            if (fileInput.files.length > 0) {
                formData.append('files', fileInput.files[0]);
            }

            try {
                const res = await fetch(`${SERVER_URL}/imports`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });

                if (res.ok) {
                    showToast('บันทึกบิลนำเข้าสำเร็จแล้ว!');
                    closeModal('accImportModal');
                    fetchImportRequests();
                } else {
                    const err = await res.json();
                    showToast('Error: ' + err.message, 'error');
                }
            } catch (err) { showToast('Error: ' + err.message, 'error'); }
        }

        // Expose Functions
        window.openAccessoryImportModal = openAccessoryImportModal;
        window.addAccessoryItemRow = addAccessoryItemRow;
        window.removeAccessoryItemRow = removeAccessoryItemRow;
        window.submitAccessoryImport = submitAccessoryImport;

        // (*** New: Submit Phone Import ***)
        async function submitPhoneImport() {
            const supplier = document.getElementById('phone-import-supplier').value;
            const fileInput = document.getElementById('phone-import-file');
            const desc = document.getElementById('phone-import-description').value;
            const imgInput = document.getElementById('phone-import-image');

            if (!supplier) return showToast('กรุณาระบุ Supplier', 'warning');

            // Validate File (Must have Excel or Image)
            if (fileInput.files.length === 0 && imgInput.files.length === 0) {
                return showToast('กรุณาแนบไฟล์ Excel หรือรูปภาพอย่างน้อย 1 อย่าง', 'warning');
            }

            const formData = new FormData();
            formData.append('type', 'phone');
            formData.append('companyId', document.getElementById('company-select').value); // Assuming global select
            formData.append('importDate', new Date().toISOString());

            const details = {
                supplier,
                description: desc
            };
            formData.append('details', JSON.stringify(details));

            // Append Excel Files
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('files', fileInput.files[i]);
            }
            // Append Images
            for (let i = 0; i < imgInput.files.length; i++) {
                formData.append('files', imgInput.files[i]);
            }

            try {
                // Show Loading? (Optional)

                const res = await fetch(`${SERVER_URL}/imports`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });

                if (res.ok) {
                    showToast('บันทึกการแจ้งนำเข้าสำเร็จ!');
                    closeModal('phoneImportModal');
                    fetchImportRequests(); // Updates list AND counts
                } else {
                    const err = await res.json();
                    showToast('Error: ' + (err.message || 'Upload failed'), 'error');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        window.submitPhoneImport = submitPhoneImport;

        // (*** New: Open Phone Import Modal ***)
        function openPhoneImportModal() {
            const form = document.getElementById('phone-import-form');
            if (form) form.reset();

            const display = document.getElementById('file-name-display');
            if (display) {
                display.textContent = '';
                display.classList.add('hidden');
                display.classList.remove('inline-block');
            }
            // Reset Image Preview
            const imgPreview = document.getElementById('phone-image-preview');
            const imgPlaceholder = document.getElementById('phone-image-placeholder');
            if (imgPreview) {
                imgPreview.classList.add('hidden');
                imgPreview.src = '';
            }
            if (imgPlaceholder) imgPlaceholder.classList.remove('hidden');

            openModal('phoneImportModal');
        }

        // Expose to Window
        window.openPhoneImportModal = openPhoneImportModal;
        window.switchImportTab = switchImportTab;
        window.previewImage = previewImage;
        window.fetchImportRequests = fetchImportRequests;

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
        window.addBranchOrderItemRow = function () {
            const container = document.getElementById('bo-items-container');
            const rowId = 'bo-item-' + Date.now() + Math.random().toString(36).substr(2, 5);

            const div = document.createElement('div');
            div.className = "flex gap-2 items-start animate-fade-in";
            div.id = rowId;
            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" name="bo-product-name" placeholder="ชื่อสินค้า" class="form-input-theme text-sm" required>
                </div>
                <div class="w-24">
                    <input type="number" name="bo-quantity" value="1" min="1" class="form-input-theme text-sm text-center" placeholder="จำนวน" required>
                </div>
                <button type="button" onclick="removeBranchOrderItemRow('${rowId}')" class="p-2 text-slate-300 hover:text-red-500 transition-colors">
                    <ion-icon name="trash"></ion-icon>
                </button>
            `;
            container.appendChild(div);
        };

        window.removeBranchOrderItemRow = function (id) {
            const row = document.getElementById(id);
            if (row) row.remove();
        };

        window.openBranchOrderModal = function () {
            document.getElementById('bo-order-name').value = '';
            document.getElementById('bo-order-date').valueAsDate = new Date();
            document.getElementById('bo-expected-date').value = '';

            // Reset Items
            const container = document.getElementById('bo-items-container');
            container.innerHTML = '';
            addBranchOrderItemRow(); // Add first row

            openModal('branchOrderModal');
        };

        window.submitBranchOrder = async function () {
            const orderName = document.getElementById('bo-order-name').value;
            const orderDate = document.getElementById('bo-order-date').value;
            const expectedDate = document.getElementById('bo-expected-date').value;
            const branch = document.getElementById('bo-branch').value;

            const itemRows = document.querySelectorAll('#bo-items-container > div');
            const items = [];
            let isValid = true;

            itemRows.forEach(row => {
                const name = row.querySelector('input[name="bo-product-name"]').value;
                const qty = row.querySelector('input[name="bo-quantity"]').value;
                if (!name || !qty) isValid = false;
                items.push({ productName: name, quantity: Number(qty) });
            });

            if (!orderName || !orderDate || items.length === 0 || !isValid) {
                return showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
            }

            try {
                // Show loading state if needed
                const btn = document.getElementById('btn-submit-branch-order'); // Add ID to button later if needed

                const res = await fetch(`${SERVER_URL}/branch-stock-orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ orderName, orderDate, expectedDate, branch, items })
                });

                if (res.ok) {
                    showToast('บันทึกรายการสั่งของลงสาขาสำเร็จแล้ว!');
                    closeModal('branchOrderModal');
                    fetchBranchOrders();
                } else {
                    showToast('ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง', 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        };

        window.setBranchOrderStatusFilter = function (status) {
            // 1. Update Hidden Input
            document.getElementById('branch-order-status-filter').value = status;

            // 2. Update Visuals
            const buttons = [
                { id: 'btn-bo-all', val: '' },
                { id: 'btn-bo-pending', val: 'pending', color: 'text-amber-600' },
                { id: 'btn-bo-shipped', val: 'shipped', color: 'text-blue-600' },
                { id: 'btn-bo-arrived', val: 'arrived', color: 'text-emerald-600' },
                { id: 'btn-bo-canceled', val: 'canceled', color: 'text-rose-600' }
            ];

            buttons.forEach(btn => {
                const el = document.getElementById(btn.id);
                if (el) {
                    if (btn.val === status) {
                        // Active Style
                        el.classList.add('bg-white', 'shadow-sm', 'ring-1', 'ring-black/5');
                        el.classList.remove('text-slate-500');
                        if (btn.color) el.classList.add(btn.color);
                        else el.classList.add('text-indigo-600');
                    } else {
                        // Inactive Style
                        el.classList.remove('bg-white', 'shadow-sm', 'ring-1', 'ring-black/5', 'text-indigo-600', 'text-amber-600', 'text-blue-600', 'text-emerald-600', 'text-rose-600');
                        el.classList.add('text-slate-500');
                    }
                }
            });

            // 3. Fetch (or Re-render)
            // Since we plan to client-side filter, we can just call fetch which will use the cached data logic?
            // Or better, just call fetchBranchOrders() which handles the fetch-all-and-filter logic.
            // If we wanted to be super efficient we could cache the last response, but calling fetch again is safer to ensure fresh data.
            fetchBranchOrders();
        };

        window.fetchBranchOrders = async function () {
            const branchFilter = document.getElementById('branch-order-filter-branch').value;
            const statusFilter = document.getElementById('branch-order-status-filter')?.value || '';

            // Fetch ALL orders for the branch (remove status filter from URL to get counts)
            let url = `${SERVER_URL}/branch-stock-orders?`;
            if (branchFilter && branchFilter !== 'all') url += `&branch=${branchFilter}`;

            // Add Loading State
            const tbody = document.getElementById('branch-order-table-body');
            if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-500 mx-auto"></div></td></tr>`;

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (res.ok) {
                    const allOrders = await res.json();

                    // 1. Calculate Counts
                    const counts = {
                        all: allOrders.length,
                        pending: 0,
                        shipped: 0,
                        arrived: 0,
                        canceled: 0
                    };

                    allOrders.forEach(order => {
                        const s = order.status || 'pending';
                        if (counts[s] !== undefined) {
                            counts[s]++;
                        } else {
                            // Fallback for unknown status, treat as pending logic or ignore?
                            // Default logic usually maps empty to pending.
                            if (!order.status) counts.pending++;
                        }
                    });

                    // 2. Update Badges
                    Object.keys(counts).forEach(key => {
                        const badge = document.getElementById(`count-bo-${key}`);
                        if (badge) {
                            badge.textContent = counts[key];
                            badge.classList.remove('hidden');
                            if (counts[key] === 0) badge.classList.add('hidden');
                        }
                    });

                    // 3. Filter Data Client-Side
                    const filteredOrders = statusFilter
                        ? allOrders.filter(order => (order.status || 'pending') === statusFilter)
                        : allOrders;

                    renderBranchOrders(filteredOrders);
                }
            } catch (err) { console.error(err); }
        };

        window.renderBranchOrders = function (orders) {
            const tbody = document.getElementById('branch-order-table-body');
            if (!tbody) return;

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-20 text-center">
                            <div class="flex flex-col items-center justify-center space-y-4">
                                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center text-slate-300 shadow-inner">
                                    <ion-icon name="search-outline" class="text-5xl"></ion-icon>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-lg font-bold text-slate-600">ไม่พบรายการสั่งของในช่วงเวลานี้</p>
                                    <p class="text-sm text-slate-400">ลองเปลี่ยนช่วงวันที่ หรือเลือกสาขาอื่นดูนะครับ</p>
                                </div>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            const canUpdateStatus = (currentUser.department && (currentUser.department.includes('จัดซื้อ') || currentUser.department.includes('Purchase'))) ||
                ['admin', 'executive', 'manager', 'hr'].includes(currentUser.role);

            const rowsHTML = orders.map((order) => {
                const dateStr = new Date(order.orderDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const expectStr = order.expectedDate ? new Date(order.expectedDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';

                let statusHTML = '';
                if (canUpdateStatus) {
                    statusHTML = `
                        <div class="relative inline-block text-left">
                            <select onchange="updateBranchOrderStatus('${order._id}', this.value)" 
                                class="appearance-none font-black text-[10px] uppercase tracking-wider px-4 py-1.5 rounded-full border-2 transition-all outline-none cursor-pointer pr-8
                                ${(!order.status || order.status === 'pending') ? 'bg-slate-50 text-slate-500 border-slate-200 hover:border-slate-300' : ''}
                                ${order.status === 'shipped' ? 'bg-amber-50 text-amber-600 border-amber-200 hover:border-amber-300' : ''}
                                ${order.status === 'arrived' ? 'bg-emerald-50 text-emerald-600 border-emerald-200 hover:border-emerald-300' : ''}
                                ${order.status === 'canceled' ? 'bg-red-50 text-red-600 border-red-200 hover:border-red-300' : ''}
                                ">
                                <option value="pending" ${(!order.status || order.status === 'pending') ? 'selected' : ''}>รอดำเนินการ</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>รอของ</option>
                                <option value="arrived" ${order.status === 'arrived' ? 'selected' : ''}>ของถึงสาขาแล้ว</option>
                                <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>ยกเลิก</option>
                            </select>
                            <div class="absolute right-2.5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                <ion-icon name="chevron-down" class="text-[10px]"></ion-icon>
                            </div>
                        </div>`;
                } else {
                    if (!order.status || order.status === 'pending') {
                        statusHTML = `
                            <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-slate-50 text-slate-500 text-xs font-black border border-slate-200/50 shadow-sm">
                                <span>รอดำเนินการ</span>
                            </div>`;
                    } else if (order.status === 'shipped') {
                        statusHTML = `
                            <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-amber-50 text-amber-600 text-xs font-black border border-amber-200/50 shadow-sm">
                                <ion-icon name="time-outline" class="mr-1.5 text-sm animate-pulse"></ion-icon>
                                <span>รอของ</span>
                            </div>`;
                    } else if (order.status === 'arrived') {
                        statusHTML = `
                            <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-50 text-emerald-600 text-xs font-black border border-emerald-200/50 shadow-sm">
                                <ion-icon name="checkmark-circle" class="mr-1.5 text-sm"></ion-icon>
                                <span>ของถึงสาขาแล้ว</span>
                            </div>`;
                    } else if (order.status === 'canceled') {
                        statusHTML = `
                            <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-red-50 text-red-700 text-xs font-black border border-red-200/50 shadow-sm">
                                <ion-icon name="close-circle-outline" class="mr-1.5 text-sm"></ion-icon>
                                <span>ยกเลิกแลัว</span>
                            </div>`;
                    }
                }

                let productsHTML = '';
                if (order.items && order.items.length > 0) {
                    productsHTML = order.items.map(i => `
                        <div class="flex items-center gap-1.5 mt-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                            <span class="text-xs font-bold text-slate-700">${i.productName}</span>
                            <span class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 ml-1 font-bold">x${i.quantity}</span>
                        </div>
                    `).join('');
                } else if (order.productName) {
                    productsHTML = `
                        <div class="flex items-center gap-1.5 mt-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                            <span class="text-xs font-bold text-slate-700">${order.productName}</span>
                            <span class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 ml-1 font-bold">x${order.quantity}</span>
                        </div>`;
                } else {
                    productsHTML = '<div class="text-xs text-slate-400 italic">No items</div>';
                }

                return `
                    <tr class="group hover:bg-yellow-50/30 transition-all duration-300 border-b border-slate-50 last:border-0">
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter mb-0.5">Order Date</span>
                                <span class="text-sm font-bold text-slate-600">${dateStr}</span>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter mb-0.5">Expected</span>
                                <span class="text-sm font-bold text-slate-700 flex items-center gap-1.5">
                                    <ion-icon name="time-outline" class="text-slate-400"></ion-icon>
                                    ${expectStr}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="text-base font-black text-slate-800 group-hover:text-yellow-600 transition-colors uppercase tracking-tight">${order.orderName}</div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-slate-50 text-slate-400 rounded-xl flex items-center justify-center border border-slate-100 group-hover:border-yellow-200 group-hover:bg-white transition-all shrink-0">
                                    <ion-icon name="cube-outline" class="text-xl"></ion-icon>
                                </div>
                                <div class="flex flex-col">
                                    ${productsHTML}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-5 text-center">
                            <span class="inline-block px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-[10px] font-black uppercase tracking-widest border border-slate-200/50 group-hover:border-indigo-200 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-all">
                                ${order.branch}
                            </span>
                        </td>
                        <td class="px-6 py-5 text-center whitespace-nowrap">
                            ${statusHTML}
                        </td>
                    </tr>`;
            }).join('');

            tbody.innerHTML = rowsHTML;
        };
        window.updateBranchOrderStatus = async function (id, newStatus) {
            console.log(`[DEBUG] Updating Branch Order ${id} to status: ${newStatus}`);
            try {
                const res = await fetch(`${SERVER_URL}/branch-stock-orders/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    console.log(`[DEBUG] Update successful`);
                    showToast('อัปเดตสถานะเรียบร้อยแล้ว!');
                    fetchBranchOrders();
                } else {
                    const errBody = await res.json();
                    console.error(`[DEBUG] Update failed:`, errBody);
                    showToast('ไม่สามารถอัปเดตสถานะได้: ' + (errBody.message || 'Unknown error'), 'error');
                }
            } catch (err) {
                console.error(`[DEBUG] Update error:`, err);
                showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
            }
        };

        window.fetchBranchInventory = async function () {
            const statusFilterElem = document.getElementById('branch-inventory-status-filter');
            const statusFilterVal = statusFilterElem?.value || 'all';

            // New Filters
            const searchInput = document.getElementById('branch-inventory-search')?.value.toLowerCase().trim() || '';
            const dateFilter = document.getElementById('branch-inventory-date-filter')?.value || '';

            // 1. Fetch ALL orders (remove status filter from URL to get total counts)
            let url = `${SERVER_URL}/branch-stock-orders?`; // Always fetch all for counting

            // Add Loading State
            const tbody = document.getElementById('branch-inventory-table-body');
            if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center"><div class="animate-spin rounded-full h-8 w-8 border-emerald-500 mx-auto"></div></td></tr>`;

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (res.ok) {
                    let allOrders = await res.json();

                    // 2. Count Statuses
                    if (statusFilterElem) {
                        const countAll = allOrders.length;
                        const countPending = allOrders.filter(o => (!o.status || o.status === 'pending')).length;
                        const countShipped = allOrders.filter(o => o.status === 'shipped').length;
                        const countArrived = allOrders.filter(o => o.status === 'arrived').length;
                        const countCanceled = allOrders.filter(o => o.status === 'canceled').length;

                        Array.from(statusFilterElem.options).forEach(opt => {
                            if (opt.value === 'all') opt.textContent = `ทุกสถานะ (${countAll})`;
                            else if (opt.value === 'pending') opt.textContent = `⏳ รอดำเนินการ (${countPending})`;
                            else if (opt.value === 'shipped') opt.textContent = `🚚 รอของ (${countShipped})`;
                            else if (opt.value === 'arrived') opt.textContent = `✅ ของถึงสาขาแล้ว (${countArrived})`;
                            else if (opt.value === 'canceled') opt.textContent = `❌ ยกเลิก (${countCanceled})`;
                        });
                    }

                    // 3. Filter Data Client-Side
                    let filteredOrders = allOrders.filter(o => {
                        const s = o.status || 'pending';

                        // Status
                        const matchStatus = (statusFilterVal === 'all') || (s === statusFilterVal);

                        // Date (Expected Arrival)
                        let matchDate = true;
                        if (dateFilter) {
                            if (o.expectedDate) {
                                const exp = new Date(o.expectedDate).toISOString().split('T')[0];
                                matchDate = (exp === dateFilter);
                            } else {
                                matchDate = false;
                            }
                        }

                        // Search Text
                        let matchText = true;
                        if (searchInput) {
                            // Combine searchable text
                            const orderName = o.orderName || '';
                            const itemNames = (o.items || []).map(i => i.itemName || i.productName || i.name || '').join(' ');
                            const combined = `${orderName} ${itemNames}`.toLowerCase();
                            matchText = combined.includes(searchInput);
                        }

                        return matchStatus && matchDate && matchText;
                    });

                    renderBranchInventory(filteredOrders);
                }
            } catch (err) { console.error(err); }
        };

        window.renderBranchInventory = function (orders) {
            const tbody = document.getElementById('branch-inventory-table-body');
            if (!tbody) return;

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-20 text-center">
                            <div class="flex flex-col items-center justify-center space-y-4">
                                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-slate-300 shadow-inner">
                                    <ion-icon name="search-outline" class="text-4xl"></ion-icon>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-base font-bold text-slate-600">ไม่พบรายการของลงสาขา</p>
                                    <p class="text-xs text-slate-400">ลองเปลี่ยนช่วงวันที่ดูนะครับ</p>
                                </div>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            const rowsHTML = orders.map((order) => {
                const dateStr = new Date(order.orderDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const expectStr = order.expectedDate ? new Date(order.expectedDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';

                let statusHTML = '';
                if (!order.status || order.status === 'pending') {
                    statusHTML = `
                        <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-slate-50 text-slate-500 text-[10px] font-black border border-slate-200/50 shadow-sm uppercase tracking-wider">
                            <ion-icon name="ellipsis-horizontal-circle" class="mr-1.5 text-sm"></ion-icon>
                            <span>รอดำเนินการ</span>
                        </div>`;
                } else if (order.status === 'shipped') {
                    statusHTML = `
                        <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-amber-50 text-amber-600 text-[10px] font-black border border-amber-200/50 shadow-sm uppercase tracking-wider">
                            <ion-icon name="airplane-outline" class="mr-1.5 text-sm animate-bounce"></ion-icon>
                            <span>รอของ</span>
                        </div>`;
                } else if (order.status === 'arrived') {
                    statusHTML = `
                        <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-50 text-emerald-600 text-[10px] font-black border border-emerald-200/50 shadow-sm uppercase tracking-wider">
                            <ion-icon name="checkmark-circle" class="mr-1.5 text-sm"></ion-icon>
                            <span>ของถึงสาขาแล้ว</span>
                        </div>`;
                } else if (order.status === 'canceled') {
                    statusHTML = `
                        <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-red-50 text-red-600 text-[10px] font-black border border-red-200/50 shadow-sm uppercase tracking-wider">
                            <ion-icon name="close-circle" class="mr-1.5 text-sm"></ion-icon>
                            <span>ยกเลิกแลัว</span>
                        </div>`;
                }

                // Handle items display (support both old single-item and new multi-items)
                let productsHTML = '';
                if (order.items && order.items.length > 0) {
                    productsHTML = `
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${order.items.map(i => `
                                <div class="flex items-center gap-2 bg-white border border-slate-100 px-3 py-1.5 rounded-xl shadow-sm hover:border-emerald-200 hover:shadow-md transition-all group/item">
                                    <div class="w-6 h-6 rounded-lg bg-emerald-50 text-emerald-500 flex items-center justify-center shrink-0 group-hover/item:bg-emerald-500 group-hover/item:text-white transition-colors">
                                        <ion-icon name="cube" class="text-xs"></ion-icon>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-[11px] font-black text-slate-700 leading-none">${i.productName}</span>
                                        <span class="text-[9px] font-bold text-slate-400 mt-1 uppercase">จำนวน: ${i.quantity}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                } else if (order.productName) {
                    // Fallback for old data
                    productsHTML = `
                        <div class="flex flex-wrap gap-2 mt-2">
                            <div class="flex items-center gap-2 bg-white border border-slate-100 px-3 py-1.5 rounded-xl shadow-sm hover:border-emerald-200 hover:shadow-md transition-all group/item">
                                <div class="w-6 h-6 rounded-lg bg-emerald-50 text-emerald-500 flex items-center justify-center shrink-0 group-hover/item:bg-emerald-500 group-hover/item:text-white transition-colors">
                                    <ion-icon name="cube" class="text-xs"></ion-icon>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-[11px] font-black text-slate-700 leading-none">${order.productName}</span>
                                    <span class="text-[9px] font-bold text-slate-400 mt-1 uppercase">จำนวน: ${order.quantity}</span>
                                </div>
                            </div>
                        </div>`;
                } else {
                    productsHTML = '<div class="text-xs text-slate-400 italic mt-2">ไม่มีข้อมูลสินค้า</div>';
                }

                return `
                    <tr class="group hover:bg-emerald-50/20 transition-all duration-300 border-b border-slate-50 last:border-0">
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5">สั่งเมื่อ</span>
                                <span class="text-sm font-black text-slate-700">${dateStr}</span>
                            </div>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5">คาดว่าจะถึง</span>
                                <span class="text-sm font-black text-slate-700 flex items-center gap-1.5">
                                    <ion-icon name="calendar-outline" class="text-emerald-500"></ion-icon>
                                    ${expectStr}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5">หัวข้อรายการ</span>
                                <div class="text-sm font-black text-slate-800 group-hover:text-emerald-600 transition-colors uppercase tracking-tight">${order.orderName}</div>
                            </div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">รายการสินค้า</span>
                                ${productsHTML}
                            </div>
                        </td>
                        <td class="px-6 py-5 text-center">
                            <span class="inline-block px-4 py-1.5 bg-slate-100 text-slate-600 rounded-full text-[10px] font-black uppercase tracking-widest border border-slate-200/50 shadow-sm group-hover:bg-emerald-500 group-hover:text-white group-hover:border-emerald-500 transition-all">
                                ${order.branch}
                            </span>
                        </td>
                        <td class="px-6 py-5 text-center whitespace-nowrap">
                            ${statusHTML}
                        </td>
                    </tr>`;
            }).join('');

            tbody.innerHTML = rowsHTML;
        };
    </script>
    <div id="toast-container" class="fixed top-6 right-6 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

    <script>
        // Custom Toast Function
        window.showToast = function (message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `glass-toast px-5 py-4 rounded-2xl shadow-2xl flex items-center gap-4 min-w-[320px] pointer-events-auto toast-animate-in border-l-4`;

            let icon = '';
            let iconColor = '';

            if (type === 'success') {
                toast.classList.add('border-emerald-500');
                icon = 'checkmark-circle';
                iconColor = 'text-emerald-500';
            } else if (type === 'error') {
                toast.classList.add('border-red-500');
                icon = 'alert-circle';
                iconColor = 'text-red-500';
            } else {
                toast.classList.add('border-amber-500');
                icon = 'warning';
                iconColor = 'text-amber-500';
            }

            toast.innerHTML = `
                <div class="w-10 h-10 rounded-xl bg-white shadow-sm flex items-center justify-center shrink-0">
                    <ion-icon name="${icon}" class="text-2xl ${iconColor}"></ion-icon>
                </div>
                <div class="flex-1">
                    <p class="text-[13px] font-black text-slate-800 leading-tight">${message}</p>
                </div>
                <button class="text-slate-300 hover:text-slate-500 transition-colors" onclick="this.parentElement.classList.replace('toast-animate-in', 'toast-animate-out'); setTimeout(() => this.parentElement.remove(), 400)">
                    <ion-icon name="close" class="text-xl"></ion-icon>
                </button>
            `;

            container.appendChild(toast);

            // Auto remove
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.replace('toast-animate-in', 'toast-animate-out');
                    setTimeout(() => toast.remove(), 400);
                }
            }, 4000);
        };
    </script>

    <!-- Modal: Claim Status Update -->
    <div id="claimStatusModal" class="modal fixed inset-0 z-[60] items-center justify-center p-4 hidden">
        <div
            class="modal-content relative w-full max-w-sm bg-white rounded-2xl shadow-blue-500/20 shadow-2xl overflow-hidden animate-fade-in-up">
            <div class="bg-slate-50 border-b border-slate-100 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">อัปเดตสถานะเคลม</h3>
                <button onclick="closeModal('claimStatusModal')"
                    class="hover:bg-slate-200 p-1 rounded-full transition-colors text-slate-400 hover:text-slate-600">
                    <ion-icon name="close" class="text-xl"></ion-icon>
                </button>
            </div>
            <div class="p-6">
                <input type="hidden" id="claim-update-id">
                <label class="block text-sm font-bold text-slate-700 mb-2">สถานะใหม่</label>
                <div class="relative">
                    <select id="claim-update-status" class="form-input-theme w-full appearance-none">
                        <option value="pending">รอดำเนินการ</option>
                        <option value="approved">รับสินค้าแล้ว</option>
                        <option value="completed">เสร็จสิ้น</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-500">
                        <ion-icon name="chevron-down-outline"></ion-icon>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button onclick="closeModal('claimStatusModal')"
                        class="flex-1 py-2.5 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors">ยกเลิก</button>
                    <button onclick="submitClaimStatus()"
                        class="flex-1 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-500/30 transition-all">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Claim (Create) -->
    <div id="claimModal" class="modal fixed inset-0 z-50 items-center justify-center p-4 hidden">
        <div class="modal-content relative w-full max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div
                class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4 flex justify-between items-center text-white">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <ion-icon name="hammer"></ion-icon> แจ้งเคลมอุปกรณ์เสริม
                </h3>
                <button onclick="closeModal('claimModal')"
                    class="hover:bg-white/20 p-1.5 rounded-full transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>

            <form onsubmit="submitClaim(event)" class="p-6 space-y-4">
                <!-- Row 1 -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">เลขที่โอนย้าย</label>
                        <input type="text" id="claim-transfer-no" class="form-input-theme w-full"
                            placeholder="ระบุเลขที่..." required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">สาขา</label>
                        <input type="text" id="claim-branch-display"
                            class="form-input-theme w-full bg-slate-100 text-slate-500" readonly>
                    </div>
                </div>

                <!-- Row 2 -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">ชื่อสินค้า</label>
                        <div class="relative group">
                            <select id="claim-product-name" onchange="syncClaimProduct('name')"
                                class="form-input-theme w-full appearance-none pr-10" required>
                                <option value="" disabled selected>เลือกสินค้า...</option>
                            </select>
                            <div
                                class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">
                                <ion-icon name="chevron-down-outline"></ion-icon>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-1">รหัสสินค้า</label>
                        <div class="relative group">
                            <select id="claim-product-code" onchange="syncClaimProduct('code')"
                                class="form-input-theme w-full appearance-none pr-10" required>
                                <option value="" disabled selected>รหัส...</option>
                            </select>
                            <div
                                class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">
                                <ion-icon name="chevron-down-outline"></ion-icon>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 3 -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">จำนวน (ชิ้น)</label>
                    <input type="number" id="claim-quantity" class="form-input-theme w-full" value="1" min="1" required>
                </div>

                <!-- Row 4 -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">ปัญหา / ตำหนิ</label>
                    <textarea id="claim-problem" rows="3" class="form-input-theme w-full"
                        placeholder="ระบุอาการเสีย หรือตำหนิ..." required></textarea>
                </div>

                <div class="pt-4 flex justify-end gap-3 border-t border-slate-100">
                    <button type="button" onclick="closeModal('claimModal')"
                        class="px-5 py-2.5 rounded-xl text-slate-600 hover:bg-slate-50 font-bold transition-colors">ยกเลิก</button>
                    <button type="submit"
                        class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold shadow-lg shadow-orange-500/30 transition-all">บันทึกแจ้งเคลม</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Claim Logic -->
    <script>
        const CLAIM_PRODUCT_PRESETS = [
            { code: 'K16PLUS', name: 'เคส 16plus' },
            { code: 'KG9', name: 'เคส Gen9' },
            { code: 'KA4', name: 'เคส Ipad Air4' },
            { code: 'KA6', name: 'เคส Ipad Air5/6/7' },
            { code: 'KX', name: 'เคส X XS' },
            { code: 'K11', name: 'เคส11' },
            { code: 'K11PM', name: 'เคส11PM' },
            { code: 'K11P', name: 'เคส11Pro' },
            { code: 'K12', name: 'เคส12/12p' },
            { code: 'K12PM', name: 'เคส12pm' },
            { code: 'K13', name: 'เคส13/14' },
            { code: 'K13PM', name: 'เคส13pm' },
            { code: 'K13P', name: 'เคส13pro' },
            { code: 'K14PLUS', name: 'เคส14plus' },
            { code: 'K14PM', name: 'เคส14pm' },
            { code: 'K14P', name: 'เคส14pro' },
            { code: 'K15', name: 'เคส15' },
            { code: 'K15P', name: 'เคส15p' },
            { code: 'K15PLUS', name: 'เคส15plus' },
            { code: 'K15PM', name: 'เคส15pm' },
            { code: 'K16', name: 'เคส16' },
            { code: 'K16PM', name: 'เคส16pm' },
            { code: 'K16P', name: 'เคส16pro' },
            { code: 'K17', name: 'เคส17' },
            { code: 'K17A', name: 'เคส17Air' },
            { code: 'K17PM', name: 'เคส17pm' },
            { code: 'K17P', name: 'เคส17pro' },
            { code: 'K7', name: 'เคส7 8' },
            { code: 'K7P8P', name: 'เคส7+8+' },
            { code: 'KAP3', name: 'เคสAirpods3' },
            { code: 'KG10', name: 'เคสGen10 /Gen11' },
            { code: 'KXR', name: 'เคสXR' },
            { code: 'KXSM', name: 'เคสXs max' },
            { code: 'KSA17', name: 'เคสซัมซุงA17' },
            { code: 'KSA56', name: 'เคสซัมซุงA56' },
            { code: '29', name: 'ชุดชาร์จ Android' },
            { code: '10', name: 'ชุดชาร์จ Iphone11-14' },
            { code: '1100', name: 'ชุดชาร์จ Iphone15-16' },
            { code: 'S001', name: 'ซิม' },
            { code: 'SUMK', name: 'เซทเคสโรสโตร์' },
            { code: 'P00003', name: 'ปากกา Ipad' },
            { code: 'POWER', name: 'เพาเวอร์แบงค์10000M' },
            { code: 'F11P', name: 'ฟิล์ม 11pro/x/xs' },
            { code: 'F13', name: 'ฟิล์ม 13/13pro/14/16e' },
            { code: 'F13PM', name: 'ฟิล์ม 13pm/14plus' },
            { code: 'F14PM', name: 'ฟิล์ม 14pm' },
            { code: 'F14P', name: 'ฟิล์ม 14pro' },
            { code: '5', name: 'ฟิล์ม 15 โฟกัส' },
            { code: 'F15', name: 'ฟิล์ม 15/16' },
            { code: 'F15P', name: 'ฟิล์ม 15p' },
            { code: '6', name: 'ฟิล์ม 15P โฟกัส' },
            { code: 'F15PM', name: 'ฟิล์ม 15pm' },
            { code: '7', name: 'ฟิล์ม 15pm โฟกัส' },
            { code: 'F16PLUS', name: 'ฟิล์ม 16plus/15plus' },
            { code: 'F16PM', name: 'ฟิล์ม 16pm' },
            { code: 'F16P', name: 'ฟิล์ม 16pro' },
            { code: 'F7P8P', name: 'ฟิล์ม 7+8+' },
            { code: 'FA2', name: 'ฟิล์ม Air2' },
            { code: 'FA4', name: 'ฟิล์ม Air4 Air5' },
            { code: 'FA6', name: 'ฟิล์ม Air6/Air7' },
            { code: 'FG9', name: 'ฟิล์ม Gen9 8 7' },
            { code: 'FG10', name: 'ฟิล์ม ipad gen10/11' },
            { code: 'FXR', name: 'ฟิล์ม XR / 11' },
            { code: 'F11PM', name: 'ฟิล์ม11pm/XS Max' },
            { code: 'F12P', name: 'ฟิล์ม12/12pro' },
            { code: 'F12PM', name: 'ฟิล์ม12pm' },
            { code: 'F17', name: 'ฟิล์ม17' },
            { code: 'F17A', name: 'ฟิล์ม17air' },
            { code: 'F17PM', name: 'ฟิล์ม17pm' },
            { code: 'F17P', name: 'ฟิล์ม17pro' },
            { code: 'FSA17', name: 'ฟิล์มซัมซุงA17' },
            { code: 'FSA56', name: 'ฟิล์ม์ซัมซุงA56' },
            { code: 'L13', name: 'เลนส์กล้อง 13' },
            { code: 'L15', name: 'เลนส์กล้อง 15/15plus' },
            { code: 'L15P', name: 'เลนส์กล้อง 15p/15pm' },
            { code: 'L16', name: 'เลนส์กล้อง 16/16plus' },
            { code: 'L16P', name: 'เลนส์กล้อง 16p/16pm' },
            { code: 'L12', name: 'เลนส์กล้อง12' },
            { code: '201', name: 'สายชาร์จ (เทียบ)' },
            { code: '41', name: 'สายชาร์จ C-TO-C (แท้)' },
            { code: '20', name: 'สายชาร์จ Lighning (แท้)' },
            { code: '60', name: 'หัวชาร์จ 20W (เทียบ)' },
            { code: '61', name: 'หัวชาร์จ 20W (แท้)' },
            { code: '28', name: 'หัวชาร์จ Android' },
            { code: '30', name: 'หูฟัง' },
            { code: '83', name: 'หูฟัง Airpods' }
        ];

        function initializeClaimProductPresets() {
            const nameSelect = document.getElementById('claim-product-name');
            const codeSelect = document.getElementById('claim-product-code');

            if (nameSelect.options.length > 1) return; // Already initialized

            CLAIM_PRODUCT_PRESETS.forEach(item => {
                nameSelect.add(new Option(item.name, item.name));
                codeSelect.add(new Option(item.code, item.code));
            });
        }

        function syncClaimProduct(type) {
            const nameSelect = document.getElementById('claim-product-name');
            const codeSelect = document.getElementById('claim-product-code');

            if (type === 'name') {
                const selectedName = nameSelect.value;
                const preset = CLAIM_PRODUCT_PRESETS.find(p => p.name === selectedName);
                if (preset) codeSelect.value = preset.code;
            } else {
                const selectedCode = codeSelect.value;
                const preset = CLAIM_PRODUCT_PRESETS.find(p => p.code === selectedCode);
                if (preset) nameSelect.value = preset.name;
            }
        }

        // Open Modal
        function openClaimModal() {
            // Set Branch
            const branch = (currentUser.role === 'staff') ? currentUser.branch : (currentUser.department || 'สำนักงานใหญ่');
            document.getElementById('claim-branch-display').value = branch;

            // Initialize Presets
            initializeClaimProductPresets();

            // Clear other fields
            document.getElementById('claim-transfer-no').value = '';
            document.getElementById('claim-product-name').value = '';
            document.getElementById('claim-product-code').value = '';
            document.getElementById('claim-quantity').value = '1';
            document.getElementById('claim-problem').value = '';

            openModal('claimModal');
        }

        // --- Filter Logic ---
        function setClaimStatusFilter(status) {
            const statusInput = document.getElementById('claim-status-filter');
            if (statusInput) statusInput.value = status;

            const statusSelect = document.getElementById('claim-status-standard');
            if (statusSelect) statusSelect.value = status;

            // Update UI Active State (Modern)
            const statusButtons = ['all', 'pending', 'approved', 'rejected', 'completed'];
            statusButtons.forEach(s => {
                const btn = document.getElementById(`btn-claim-${s}`);
                if (!btn) return;

                if (s === status) {
                    btn.classList.add('bg-white', 'shadow-sm', 'ring-1', 'ring-black/5');
                    btn.classList.remove('text-slate-500');
                    if (s === 'all') btn.classList.add('text-orange-600');
                    if (s === 'pending') btn.classList.add('text-amber-600');
                    if (s === 'approved') btn.classList.add('text-emerald-600');
                    if (s === 'rejected') btn.classList.add('text-rose-600');
                    if (s === 'completed') btn.classList.add('text-blue-600');
                } else {
                    btn.classList.remove('bg-white', 'shadow-sm', 'ring-1', 'ring-black/5', 'text-orange-600', 'text-amber-600', 'text-emerald-600', 'text-rose-600', 'text-blue-600');
                    btn.classList.add('text-slate-500');
                }
            });

            fetchClaims();
        }

        // Fetch Claims
        async function fetchClaims() {
            try {
                const token = localStorage.getItem('token');

                const filterStandard = document.getElementById('claim-filter-standard');
                const isStandard = filterStandard && !filterStandard.classList.contains('hidden');

                let branch, activeStatus, search, date;

                if (isStandard) {
                    branch = document.getElementById('claim-branch-standard').value;
                    activeStatus = document.getElementById('claim-status-standard').value;
                    search = document.getElementById('claim-search-standard').value;
                    date = document.getElementById('claim-date-standard').value;
                } else {
                    branch = document.getElementById('claim-branch-filter').value;
                    activeStatus = document.getElementById('claim-status-filter').value;
                    search = document.getElementById('claim-search-filter').value;
                    date = document.getElementById('claim-date-filter').value;
                }

                let url = `${SERVER_URL}/claims?branch=${branch}&status=all&search=${encodeURIComponent(search)}&date=${date}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch claims');
                const result = await response.json();

                // Update Status Counts using the full result set (fetched status=all)
                updateClaimStatusCounts(result.data);

                // Filter by activeStatus clientside before rendering table
                const filteredData = (activeStatus === 'all')
                    ? result.data
                    : result.data.filter(item => item.status === activeStatus);

                renderClaimsTable(filteredData);
            } catch (error) {
                console.error('Error fetching claims:', error);
                showToast('ไม่สามารถดึงข้อมูลเคลมได้', 'error');
            }
        }

        function updateClaimStatusCounts(data) {
            if (!data) return;

            // Note: This only counts items in the current filtered result. 
            // In a real production app, you might want a separate API for counts or 
            // fetch all items without filter once. 
            // However, the user asked for the same behavior as the "Stock Import" which might do it differently.
            // Let's see how Stock Import does it. Usually it fetches "all" and then filters clientside OR it has a count API.

            const counts = {
                all: data.length,
                pending: data.filter(i => i.status === 'pending').length,
                approved: data.filter(i => i.status === 'approved').length,
                rejected: data.filter(i => i.status === 'rejected').length,
                completed: data.filter(i => i.status === 'completed').length
            };

            ['all', 'pending', 'approved', 'rejected', 'completed'].forEach(s => {
                // Update Modern Badges
                const badge = document.getElementById(`count-claim-${s}`);
                if (badge) {
                    badge.innerText = counts[s];
                    badge.classList.toggle('hidden', counts[s] === 0);
                }

                // Update Standard Dropdown Options
                const select = document.getElementById('claim-status-standard');
                if (select) {
                    const option = Array.from(select.options).find(o => o.value === s);
                    if (option) {
                        const baseLabels = {
                            all: 'ทุกสถานะ',
                            pending: '⏳ รอดำเนินการ',
                            approved: '✅ รับสินค้าแล้ว',
                            completed: '🔵 เสร็จสิ้น',
                        };
                        option.textContent = `${baseLabels[s] || s} (${counts[s]})`;
                    }
                }
            });
        }

        // Render Table (Updated)
        function renderClaimsTable(data) {
            const tbody = document.getElementById('claim-table-body');
            tbody.innerHTML = '';

            // Check Permissions: Admin/Manager/Executive OR Stock Team can update
            const userDept = (currentUser.department || '').toLowerCase();
            const stockKeywords = ['stock', 'store', 'สต๊อก', 'คลัง', 'warehouse', 'supply'];
            const isStockTeam = stockKeywords.some(keyword => userDept.includes(keyword));

            const canUpdate = ['admin', 'manager', 'executive'].includes(currentUser.role) || isStockTeam;

            // Toggle "Create" button visibility based on view/role?
            // Actually, keep it simple: Stock sees the same view, but maybe we hide the "Create" button via CSS if needed?
            // For now, let's just focus on the Table Actions.

            const createBtn = document.querySelector('#claim-view-content button[onclick="openClaimModal()"]');
            if (createBtn) {
                if (isStockTeam && currentUser.role === 'staff') {
                    createBtn.style.display = 'none'; // Stock Staff usually don't create claims here
                } else {
                    createBtn.style.display = 'inline-flex';
                }
            }

            if (!data || data.length === 0) {
                // Enhanced Empty State
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-20 text-center">
                            <div class="flex flex-col items-center justify-center animate-fade-in">
                                <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6 shadow-inner">
                                    <ion-icon name="file-tray-outline" class="text-5xl text-slate-300"></ion-icon>
                                </div>
                                <h4 class="text-xl font-black text-slate-700">ไม่พบรายการแจ้งเคลม</h4>
                                <p class="text-slate-400 mt-2 font-medium">ลองเปลี่ยนตัวกรอง หรือค้นหาใหม่อีกครั้ง</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            data.forEach((item, index) => {
                const dateObj = new Date(item.createdAt);
                const dateStr = dateObj.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = dateObj.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                const statusBadge = getClaimStatusBadge(item.status);

                let actionHtml = statusBadge;
                if (canUpdate) {
                    actionHtml = `
                    <button onclick="openClaimStatusModal('${item._id}', '${item.status}')" 
                        class="group relative inline-flex items-center justify-center transition-all active:scale-90 hover:-translate-y-0.5">
                        ${statusBadge}
                        <div class="absolute -right-5 top-1/2 -translate-y-1/2 text-slate-300 group-hover:text-orange-500 transition-all opacity-0 group-hover:opacity-100 scale-75 group-hover:scale-100">
                             <ion-icon name="create-outline" class="text-lg"></ion-icon>
                        </div>
                    </button>`;
                }

                const tr = document.createElement('tr');
                tr.className = `group hover:bg-orange-50/40 transition-all duration-300 border-b border-slate-50 last:border-0 animate-fade-in`;
                tr.style.animationDelay = `${index * 50}ms`;

                tr.innerHTML = `
                    <td class="px-6 py-5">
                        <div class="flex flex-col">
                            <span class="text-sm font-black text-slate-700">${dateStr}</span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">${timeStr}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5">
                        <span class="px-2.5 py-1 bg-slate-100 text-slate-700 rounded-lg text-xs font-black border border-slate-200">${item.transferNumber}</span>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-slate-300 group-hover:bg-orange-400 transition-colors"></div>
                            <span class="text-sm font-bold text-slate-600">${item.branch}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex items-center gap-2">
                             <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-[10px] font-black text-slate-500 uppercase">
                                ${(item.createdBy?.name || '?').substring(0, 2)}
                             </div>
                             <span class="text-sm font-bold text-slate-500">${item.createdBy?.name || '-'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex flex-col">
                            <span class="text-sm font-black text-slate-800 leading-tight">${item.productName}</span>
                            <span class="text-[10px] font-bold text-slate-400 font-mono tracking-tight mt-0.5">${item.productCode}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5 text-center">
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-xl bg-slate-900/5 text-slate-700 text-xs font-black">${item.quantity}</span>
                    </td>
                    <td class="px-6 py-5">
                        <p class="text-sm font-medium text-slate-500 max-w-xs truncate" title="${item.problem}">${item.problem}</p>
                    </td>
                    <td class="px-6 py-5 text-center select-none">${actionHtml}</td>
                    <td class="px-6 py-5 text-right">
                        <button onclick="downloadClaimPDF('${item._id}')" 
                            class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-orange-500 rounded-xl transition-all duration-300 shadow-sm hover:shadow-orange-500/30 group/btn"
                            title="ดาวน์โหลด PDF">
                            <ion-icon name="print-outline" class="text-xl transition-transform group-hover/btn:scale-110"></ion-icon>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            // Store data globally for PDF generation
            window.currentClaimsData = data;
        }

        function getClaimStatusBadge(status) {
            const baseClass = "px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-wider shadow-sm flex items-center justify-center gap-1.5 min-w-[100px]";
            if (status === 'pending') return `<span class="${baseClass} bg-amber-50 text-amber-700 ring-1 ring-amber-200/50"><span class="w-1.5 h-1.5 bg-amber-500 rounded-full animate-pulse"></span>รอดำเนินการ</span>`;
            if (status === 'approved') return `<span class="${baseClass} bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200/50"><ion-icon name="checkmark-done" class="text-xs"></ion-icon>รับสินค้าแล้ว</span>`;
            if (status === 'completed') return `<span class="${baseClass} bg-blue-50 text-blue-700 ring-1 ring-blue-200/50"><ion-icon name="checkbox" class="text-xs"></ion-icon>เสร็จสิ้น</span>`;
            return `<span class="${baseClass} bg-slate-100 text-slate-600">${status}</span>`;
        }

        // Submit Claim
        async function submitClaim(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<ion-icon name="sync" class="animate-spin"></ion-icon> กำลังบันทึก...';
            btn.disabled = true;

            const payload = {
                transferNumber: document.getElementById('claim-transfer-no').value,
                productName: document.getElementById('claim-product-name').value,
                productCode: document.getElementById('claim-product-code').value,
                quantity: document.getElementById('claim-quantity').value,
                problem: document.getElementById('claim-problem').value
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${SERVER_URL}/claims`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Create failed');

                showToast('บันทึกการแจ้งเคลมสำเร็จ!', 'success');
                closeModal('claimModal');
                fetchClaims(); // Refresh list
            } catch (error) {
                console.error('Submit Claim Error:', error);
                showToast('เกิดข้อผิดพลาดในการบันทึก', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- Status Update Logic ---
        function openClaimStatusModal(id, currentStatus) {
            document.getElementById('claim-update-id').value = id;
            document.getElementById('claim-update-status').value = currentStatus;
            openModal('claimStatusModal');
        }

        async function submitClaimStatus() {
            const id = document.getElementById('claim-update-id').value;
            const newStatus = document.getElementById('claim-update-status').value;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${SERVER_URL}/claims/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) throw new Error('Update failed');

                showToast('อัปเดตสถานะเรียบร้อย', 'success');
                closeModal('claimStatusModal');
                fetchClaims();
            } catch (error) {
                console.error('Update Status Error:', error);
                showToast('เกิดข้อผิดพลาดในการอัปเดต', 'error');
            }
        }

        // --- Print/PDF Export Logic ---
        function downloadClaimPDF(itemId) {
            // Open document.html in a new tab with the ID
            window.open(`document.html?id=${itemId}`, '_blank');
        }
    </script>

    <!-- Hidden PDF Template -->
    <div id="claim-pdf-template"
        style="position: fixed; top: 0; left: 0; width: 794px; background: white; z-index: -100; visibility: hidden;">
    </div>
</body>

</html>