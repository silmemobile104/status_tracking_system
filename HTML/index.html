<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SILMIN MOBILE</title>
    <link rel="icon" type="image/png" href="/image/icon_silme.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Tom Select -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.default.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans Thai"', 'sans-serif'],
                        display: ['"Outfit"', '"Noto Sans Thai"', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b', // Amber-500
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        body { 
            font-family: 'Inter', 'Noto Sans Thai', sans-serif; 
            background-color: #F8FAFC; /* Slate-50 */
            color: #1E293B; /* Slate-800 */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #fbbf24; }

        /* Modal Transitions */
        .modal { 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.2s ease-out;
            backdrop-filter: blur(4px);
            background-color: rgba(15, 23, 42, 0.4); /* Slate-900/40 */
            display: flex; /* Always flex but hidden by opacity/visibility */
        }
        .modal.active { 
            opacity: 1; 
            visibility: visible; 
        }
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Form Theme */
        .form-input-theme {
            @apply w-full bg-white border border-slate-200 text-slate-800 text-sm rounded-xl block p-3 transition-all duration-200;
            @apply focus:ring-2 focus:ring-yellow-400/50 focus:border-yellow-400 focus:outline-none placeholder-slate-400;
        }
        .form-select-theme {
            @apply w-full bg-white border border-slate-200 text-slate-800 text-sm rounded-xl block p-3 transition-all duration-200;
            @apply focus:ring-2 focus:ring-yellow-400/50 focus:border-yellow-400 focus:outline-none;
        }

        /* Deposit Table */
        .deposit-table th {
            @apply bg-slate-50 text-slate-500 font-semibold text-xs uppercase tracking-wider py-3 px-4 border-b border-slate-200 text-center;
        }
        .deposit-table td {
            @apply py-3 px-4 border-b border-slate-100 text-sm text-slate-600 align-middle;
        }
        .header-received {
            @apply bg-yellow-50 text-yellow-700 !important;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Sidebar & Layout */
        #sidebar {
            position: fixed;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100vh;
            padding-top: 4.5rem;
            z-index: 50; 
        }
        #sidebar.active { transform: translateX(0); }
        
        @media (min-width: 768px) {
            #sidebar {
                position: sticky;
                top: 0;
                transform: translateX(0);
                padding-top: 0;
                height: 100vh;
            }
        }

        #main-content {
            padding-top: 5rem;
            transition: all 0.3s ease-in-out; 
        }
        @media (min-width: 768px) {
            #main-content { padding-top: 0; }
        }
        /* Tom Select Customization */
        .ts-control {
            border-radius: 0.75rem !important; /* rounded-xl */
            border-color: #e2e8f0 !important; /* slate-200 */
            padding: 0.75rem !important; /* p-3 */
            box-shadow: none !important;
            min-height: 46px; /* Match standard input height */
        }
        .ts-control.focus {
            border-color: #facc15 !important; /* yellow-400 */
            box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.5) !important; /* ring-yellow-400/50 */
        }
        .ts-dropdown {
            border-radius: 0.75rem !important;
            border-color: #e2e8f0 !important;
            margin-top: 4px !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }
        .ts-dropdown .option {
            padding: 0.5rem 1rem !important;
        }
        .ts-dropdown .active {
            background-color: #fef9c3 !important; /* yellow-100 */
            color: #854d0e !important; /* yellow-800 */
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans antialiased selection:bg-yellow-200 selection:text-yellow-900">

    <!-- Mobile Header -->
    <div id="mobile-header"
        class="md:hidden bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 flex justify-between items-center fixed top-0 left-0 w-full z-40">
        <button id="menu-toggle"
            class="text-slate-600 hover:text-slate-900 p-1 rounded-lg hover:bg-slate-100 transition-colors">
            <ion-icon name="menu-outline" class="text-2xl"></ion-icon>
        </button>
        <span class="text-lg font-bold text-slate-800 tracking-tight flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
            SILMIN MOBILE
        </span>
        <div id="notification-bell-mobile" class="relative">
            <button id="notification-bell-btn-mobile"
                class="relative p-2 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors">
                <ion-icon name="notifications-outline" class="text-2xl"></ion-icon>
                <span id="notification-dot-mobile"
                    class="hidden absolute top-2 right-2 block h-2 w-2 rounded-full ring-2 ring-white bg-red-500"></span>
            </button>
        </div>
    </div>

    <div id="sidebar-overlay"
        class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <div id="app-wrapper" class="flex min-h-screen">

        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-72 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col shadow-xl md:shadow-none">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="h-20 flex items-center px-8 border-b border-slate-100 hidden md:flex">
                    <img src="/image/icon_silme.png" alt="SILME Icon" class="w-8 h-8 mr-3 rounded-lg shadow-lg" />
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight font-display">SILMIN MOBILE</h1>
                </div>

                <!-- Company Select -->
                <div class="p-6 pb-2">
                    <label for="company-select"
                        class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Workspace</label>
                    <select id="company-select" class="form-select-theme shadow-sm">
                        <option selected value="company_1_id">‡∏ã‡∏¥‡∏•‡∏°‡∏µ‡∏ô ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</option>
                        <option value="company_2_id">‡πÄ‡∏≠‡∏™‡∏à‡∏µ ‡∏û‡∏•‡∏±‡∏™ 2023 ‡∏à‡∏≥‡∏Å‡∏±‡∏î</option>
                    </select>
                </div>

                <!-- Navigation -->
                <nav id="nav-menu" class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
                    <a href="#" onclick="updateNavActiveState('dashboard')" id="nav-dashboard"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="grid-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('mytasks')" id="nav-mytasks"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="document-text-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('deposit')" id="nav-Storefront_deposit"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="wallet-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('purchasing')" id="nav-purchasing"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="cart-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('import')" id="nav-import"
                        class="hidden flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="cloud-upload-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('stock-import')" id="nav-stock-import"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="cube-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('stock-request')" id="nav-stock-request"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="clipboard-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('stock-request-manage')" id="nav-stock-request-manage"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="settings-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('branch-order')" id="nav-branch-order"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="basket-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('branch-order-inventory')" id="nav-branch-order-inventory"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="basket-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('admin')" id="nav-admin"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="people-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
                    </a>
                </nav>

                <!-- User Profile -->
                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <div id="user-profile-widget" class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm">
                                <ion-icon name="person" class="text-xl"></ion-icon>
                            </div>
                            <div class="ml-3">
                                <p id="user-name" class="text-sm font-semibold text-slate-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                                <p id="user-role" class="text-xs text-slate-500 font-medium">...</p>
                            </div>
                        </div>
                        <div class="relative hidden md:block">
                            <button id="notification-bell"
                                class="relative p-2 text-slate-400 hover:text-yellow-600 hover:bg-yellow-50 rounded-full transition-all">
                                <ion-icon name="notifications-outline" class="w-5 h-5"></ion-icon>
                                <span id="notification-dot"
                                    class="hidden absolute top-2 right-2 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                            </button>
                        </div>
                    </div>
                    <button id="logout-button"
                        class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-xl transition-colors">
                        <ion-icon name="log-out-outline" class="w-5 h-5 mr-2"></ion-icon> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto h-screen">
            <div class="max-w-7xl mx-auto">

                <!-- Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div>
                        <h2 id="main-header" class="text-3xl font-bold text-slate-800 font-display">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
                        <p class="text-slate-500 mt-1">System</p>
                    </div>
                    <div id="main-header-buttons" class="flex gap-3">
                        <button id="showAllTasksBtn"
                            class="bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 font-semibold py-2.5 px-5 rounded-xl shadow-sm flex items-center transition-all transform hover:-translate-y-0.5">
                            <ion-icon name="list-outline" class="w-5 h-5 mr-2"></ion-icon> ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button id="newTaskButton"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-yellow-500/30 flex items-center transition-all transform hover:-translate-y-0.5">
                            <ion-icon name="add-circle-outline" class="w-5 h-5 mr-2"></ion-icon> ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </button>
                        <button id="newUserButton"
                            class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-slate-800/30 flex items-center transition-all transform hover:-translate-y-0.5 hidden">
                            <ion-icon name="person-add-outline" class="w-5 h-5 mr-2"></ion-icon> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Content injected by JS -->
                </div>

                <!-- My Tasks Filters -->
                <div id="mytasks-filters" class="hidden mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</h3>
                        <button onclick="filterMyTasks('all')"
                            class="text-sm text-slate-500 hover:text-yellow-600 font-medium flex items-center transition-colors">
                            <ion-icon name="refresh-outline" class="mr-1"></ion-icon> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="filterMyTasks('todo')" id="btn-filter-todo"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-slate-100 rounded-lg text-slate-600 group-hover:bg-slate-200 transition-colors">
                                    <ion-icon name="clipboard-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-todo"
                                    class="bg-slate-100 text-slate-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">‡∏£‡∏≠‡∏ó‡∏≥</span>
                        </button>

                        <button onclick="filterMyTasks('in-progress')" id="btn-filter-inprogress"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-yellow-100 rounded-lg text-yellow-600 group-hover:bg-yellow-200 transition-colors">
                                    <ion-icon name="construct-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-inprogress"
                                    class="bg-yellow-100 text-yellow-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</span>
                        </button>

                        <button onclick="filterMyTasks('for-review')" id="btn-filter-review"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-orange-100 rounded-lg text-orange-600 group-hover:bg-orange-200 transition-colors">
                                    <ion-icon name="search-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-review"
                                    class="bg-orange-100 text-orange-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                        </button>

                        <button onclick="filterMyTasks('completed')" id="btn-filter-completed"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-green-100 rounded-lg text-green-600 group-hover:bg-green-200 transition-colors">
                                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-completed"
                                    class="bg-green-100 text-green-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>
                        </button>
                    </div>
                </div>

                <!-- Task View -->
                <div id="task-view-content"
                    class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div id="loading-tasks" class="text-center p-12 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-4">
                        </div>
                        <p class="text-slate-500 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...</p>
                    </div>
                    <div id="task-error-message"
                        class="hidden p-4 m-6 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100 flex items-center"
                        role="alert">
                        <ion-icon name="alert-circle" class="text-xl mr-2"></ion-icon>
                        <div><span class="font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</span> <span id="task-error-text"></span></div>
                    </div>

                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="text-lg font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>
                        <span id="task-count"
                            class="text-xs font-semibold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">0
                            ‡∏á‡∏≤‡∏ô</span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th>
                                    <th id="header-assignee"
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th>
                                    <th
                                        class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body" class="divide-y divide-slate-100">
                                <tr id="no-task-row" class="text-center">
                                    <td colspan="5"
                                        class="px-6 py-12 text-slate-400 flex flex-col items-center justify-center">
                                        <ion-icon name="folder-open-outline"
                                            class="text-4xl mb-2 text-slate-300"></ion-icon>
                                        ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Deposit View -->
                <div id="deposit-view"
                    class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mt-6 p-6">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h3 class="text-xl font-bold text-slate-800 flex items-center">
                            <div class="p-2 bg-yellow-100 text-yellow-600 rounded-lg mr-3"><ion-icon
                                    name="wallet"></ion-icon></div>
                            <span id="deposit-header-title">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</span>
                        </h3>

                        <div class="flex items-center gap-3">
                            <div id="filter-branch-container">
                                <select id="deposit-filter-branch" class="form-select-theme py-2 pl-3 pr-8 text-sm">
                                    <option value="all" selected>‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                                    <option value="‡∏¢‡∏∞‡∏•‡∏≤">‡∏¢‡∏∞‡∏•‡∏≤</option>
                                    <option value="‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™">‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</option>
                                    <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</option>
                                    <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2</option>
                                    <option value="‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ">‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</option>
                                    <option value="‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°">‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°</option>
                                    <option value="‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ">‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</option>
                                    <option value="‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß">‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß</option>
                                    <option value="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï">‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</option>
                                    <option value="‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä">‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä</option>
                                    <option value="‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà">‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà</option>
                                    <option value="‡∏Å‡∏∞‡∏ó‡∏π‡πâ">‡∏Å‡∏∞‡∏ó‡∏π‡πâ</option>
                                    <option value="‡∏ï‡∏£‡∏±‡∏á">‡∏ï‡∏£‡∏±‡∏á</option>
                                    <option value="‡∏Ñ‡∏∏‡∏£‡∏∏">‡∏Ñ‡∏∏‡∏£‡∏∏</option>
                                    <option value="‡∏ä‡∏∏‡∏°‡∏û‡∏£">‡∏ä‡∏∏‡∏°‡∏û‡∏£</option>
                                    <option value="‡∏™‡∏ï‡∏π‡∏•">‡∏™‡∏ï‡∏π‡∏•</option>
                                    <option value="‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á">‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</option>
                                    <option value="‡∏™‡∏á‡∏Ç‡∏•‡∏≤">‡∏™‡∏á‡∏Ç‡∏•‡∏≤</option>
                                </select>
                            </div>
                            <div id="filter-status-container">
                                <select id="deposit-filter-status" class="form-select-theme py-2 pl-3 pr-8 text-sm">
                                    <option value="all-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" selected>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                    <option value="‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                                </select>
                            </div>
                            <div id="filter-date-container">
                                <input type="date" id="deposit-filter-date" class="form-input-theme py-2 text-sm">
                            </div>
                            <div id="search-container">
                                <input type="text" id="deposit-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..."
                                    class="form-input-theme py-2 pl-3 text-sm w-48">
                            </div>
                            <button id="btn-filter-due-today"
                                class="relative bg-white hover:bg-red-50 text-slate-400 hover:text-red-500 p-2 rounded-xl transition-all border border-slate-200 hover:border-red-200 group"
                                title="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î">
                                <ion-icon name="notifications-outline" class="text-xl"></ion-icon>
                                <!-- Badge -->
                                <span id="deposit-due-badge"
                                    class="hidden absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white shadow-sm animate-pulse">
                                    0
                                </span>
                            </button>
                            <button onclick="openDepositModal()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl shadow-lg shadow-green-600/20 flex items-center font-medium transition-all">
                                <ion-icon name="add-circle" class="mr-2"></ion-icon> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-xl border border-slate-200">
                        <table class="w-full deposit-table border-collapse text-sm">
                            <thead>
                                <tr>
                                    <th rowspan="2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥</th>
                                    <th rowspan="2">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                    <th rowspan="2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                    <th rowspan="2" class="bg-red-50 text-red-700 border-red-100">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥</th>
                                    <th rowspan="2">‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö</th>
                                    <th colspan="8" class="bg-slate-100 text-slate-600 border-b border-slate-200">
                                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                                </tr>
                                <tr>
                                    <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</th>
                                    <th>IMEI</th>
                                    <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°</th>
                                    <th class="bg-blue-50 text-blue-700">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</th>
                                </tr>
                            </thead>
                            <tbody id="deposit-table-body" class="text-slate-600 bg-white">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="purchasing-view" class="hidden space-y-6 mt-6">
                    <!-- Header Section -->
                    <div
                        class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div
                                class="p-3 bg-gradient-to-br from-yellow-400 to-orange-600 text-white rounded-xl shadow-lg shadow-blue-500/30">
                                <ion-icon name="cart" class="text-2xl"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
                                <p class="text-sm text-slate-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 w-full md:w-auto">
                            <!-- Search Input (New) -->
                            <div class="relative w-full md:w-64">
                                <input type="text" id="purchasing-search-input" onkeyup="handlePurchasingSearch()"
                                    class="form-input-theme pl-10 text-sm shadow-sm border-slate-200 focus:border-blue-400 focus:ring-blue-400/50 placeholder-slate-400"
                                    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
                            </div>

                            <!-- (*** ‡πÄ‡∏û‡∏¥‡πà‡∏°) Bell Notification Button *** -->
                            <button id="btn-purchasing-overdue" onclick="filterPurchasingByStatus('overdue')"
                                class="relative p-2.5 bg-white border border-slate-200 rounded-xl text-slate-400 hover:text-red-500 hover:border-red-300 hover:bg-red-50 transition-all shadow-sm active:scale-95 group">
                                <ion-icon name="notifications-outline" class="text-xl"></ion-icon>
                                <!-- Badge (Hidden by default) -->
                                <span id="purchasing-overdue-badge"
                                    class="hidden absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white shadow-sm animate-pulse">
                                    0
                                </span>
                            </button>

                            <div class="relative group w-full md:w-48">
                                <select id="purchasing-filter-branch" onchange="fetchPurchasingOrders()"
                                    class="form-select-theme pl-10 text-sm shadow-sm border-slate-200 hover:border-blue-400 transition-colors cursor-pointer appearance-none">
                                    <option value="all" selected>‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                                    <option value="‡∏¢‡∏∞‡∏•‡∏≤">‡∏¢‡∏∞‡∏•‡∏≤</option>
                                    <option value="‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™">‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</option>
                                    <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</option>
                                    <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2</option>
                                    <option value="‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ">‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</option>
                                    <option value="‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°">‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°</option>
                                    <option value="‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ">‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</option>
                                    <option value="‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß">‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß</option>
                                    <option value="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï">‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</option>
                                    <option value="‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä">‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä</option>
                                    <option value="‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà">‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà</option>
                                    <option value="‡∏Å‡∏∞‡∏ó‡∏π‡πâ">‡∏Å‡∏∞‡∏ó‡∏π‡πâ</option>
                                    <option value="‡∏ï‡∏£‡∏±‡∏á">‡∏ï‡∏£‡∏±‡∏á</option>
                                    <option value="‡∏Ñ‡∏∏‡∏£‡∏∏">‡∏Ñ‡∏∏‡∏£‡∏∏</option>
                                    <option value="‡∏ä‡∏∏‡∏°‡∏û‡∏£">‡∏ä‡∏∏‡∏°‡∏û‡∏£</option>
                                    <option value="‡∏™‡∏ï‡∏π‡∏•">‡∏™‡∏ï‡∏π‡∏•</option>
                                    <option value="‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á">‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</option>
                                    <option value="‡∏™‡∏á‡∏Ç‡∏•‡∏≤">‡∏™‡∏á‡∏Ç‡∏•‡∏≤</option>
                                </select>
                            </div>
                            <button onclick="fetchPurchasingOrders()"
                                class="p-2.5 bg-white border border-slate-200 rounded-xl text-slate-500 hover:text-blue-600 hover:border-blue-300 hover:bg-blue-50 transition-all shadow-sm active:scale-95">
                                <ion-icon name="refresh" class="text-xl"></ion-icon>
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Summary (Optional Enhancement) -->
                    <!-- Statistics Summary (Clickable Filters) -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div onclick="filterPurchasingByStatus('pending')" id="card-filter-pending"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-yellow-600 transition-colors">
                                    ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                                <p id="count-pending" class="text-xl font-bold text-yellow-600">0</p>
                            </div>
                            <div
                                class="p-2 bg-yellow-50 text-yellow-600 rounded-lg group-hover:bg-yellow-100 transition-colors">
                                <ion-icon name="time"></ion-icon>
                            </div>
                        </div>
                        <div onclick="filterPurchasingByStatus('ordered')" id="card-filter-ordered"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-blue-600 transition-colors">
                                    ‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p id="count-ordered" class="text-xl font-bold text-blue-600">0</p>
                            </div>
                            <div
                                class="p-2 bg-blue-50 text-blue-600 rounded-lg group-hover:bg-blue-100 transition-colors">
                                <ion-icon name="cart"></ion-icon>
                            </div>
                        </div>
                        <div onclick="filterPurchasingByStatus('arrived')" id="card-filter-arrived"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-green-600 transition-colors">
                                    ‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p id="count-arrived" class="text-xl font-bold text-green-600">0</p>
                            </div>
                            <div
                                class="p-2 bg-green-50 text-green-600 rounded-lg group-hover:bg-green-100 transition-colors">
                                <ion-icon name="cube"></ion-icon>
                            </div>
                        </div>
                        <div onclick="filterPurchasingByStatus('canceled')" id="card-filter-canceled"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-red-600 transition-colors">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                                <p id="count-canceled" class="text-xl font-bold text-red-600">0</p>
                            </div>
                            <div class="p-2 bg-red-50 text-red-600 rounded-lg group-hover:bg-red-100 transition-colors">
                                <ion-icon name="alert-circle"></ion-icon>
                            </div>
                        </div>
                    </div>

                    <!-- Clear Filter Button (Hidden by default) -->
                    <div id="active-filter-indicator"
                        class="hidden flex items-center justify-between bg-blue-50 text-blue-700 px-4 py-2 rounded-xl border border-blue-100">
                        <span class="text-sm font-semibold flex items-center"><ion-icon name="funnel"
                                class="mr-2"></ion-icon> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á: <span id="filter-name-display"
                                class="ml-1">...</span></span>
                        <button onclick="clearPurchasingFilter()"
                            class="text-xs bg-white border border-blue-200 px-2 py-1 rounded-lg hover:bg-blue-100 transition-colors">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
                    </div>

                    <!-- Cards Container -->
                    <div id="purchasing-list-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Cards will be injected here via JS -->
                    </div>

                    <!-- Empty State (Hidden by default) -->
                    <div id="purchasing-empty-state"
                        class="hidden flex-col items-center justify-center py-16 bg-white rounded-3xl border-2 border-dashed border-slate-200">
                        <div class="p-4 bg-slate-50 rounded-full mb-4">
                            <ion-icon name="basket-outline" class="text-4xl text-slate-300"></ion-icon>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-600">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h4>
                        <p class="text-slate-400 text-sm mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    </div>
                </div>

                <!-- Stock Request View (For Sales) -->
                <div id="stock-request-view" class="hidden space-y-6 mt-6">
                    <div
                        class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-indigo-600 text-white rounded-xl shadow-lg">
                                <ion-icon name="cart-outline" class="text-2xl"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                                <p class="text-sm text-slate-500">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                                </p>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                            <!-- Status Filter -->
                            <div class="relative group flex-1 md:flex-none min-w-[160px]">
                                <ion-icon name="funnel-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                                <select id="stock-request-status-filter" onchange="fetchStockRequests()"
                                    class="pl-11 pr-10 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-all shadow-sm appearance-none w-full">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                    <option value="pending" selected>‚è≥ ‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á</option>
                                    <option value="processing">üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á</option>
                                    <option value="received">‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="canceled">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                                </select>
                                <ion-icon name="chevron-down-outline"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>

                            <button onclick="openStockRequestModal()"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg transition-all flex items-center shrink-0">
                                <ion-icon name="add-circle" class="mr-2 text-xl"></ion-icon> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">
                                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">
                                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                        <th
                                            class="px-6 py-4 text-center text-xs font-semibold text-slate-500 uppercase">
                                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase">
                                            ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏∂‡∏á</th>
                                        <th class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase">
                                            ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-request-table-body" class="divide-y divide-slate-100 text-sm">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- Branch Order View -->
                <div id="branch-order-view" class="hidden space-y-6 mt-6">
                    <!-- Modern Header & Filters -->
                    <div
                        class="bg-white/70 backdrop-blur-md rounded-3xl p-6 shadow-xl shadow-slate-200/50 border border-white flex flex-col lg:flex-row justify-between items-center gap-6">
                        <div class="flex items-center gap-5">
                            <div
                                class="w-14 h-14 bg-gradient-to-br from-yellow-400 to-amber-600 text-white rounded-2xl shadow-lg shadow-yellow-500/30 flex items-center justify-center transform transition-transform hover:scale-110 active:scale-95">
                                <ion-icon name="basket" class="text-3xl"></ion-icon>
                            </div>
                            <div>
                                <h3 id="branch-order-title" class="text-2xl font-black text-slate-800 tracking-tight">
                                    ‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</h3>
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-4 w-full lg:w-auto">


                            <!-- Modern Branch Filter -->
                            <div id="branch-order-filter-branch-container" class="min-w-[180px]">
                                <div class="relative group">
                                    <div
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-yellow-500 transition-colors">
                                        <ion-icon name="business-outline" class="text-lg"></ion-icon>
                                    </div>
                                    <select id="branch-order-filter-branch" onchange="fetchBranchOrders()"
                                        class="w-full bg-slate-100/80 border border-slate-200/60 text-slate-700 text-sm font-bold rounded-2xl pl-10 pr-4 py-3.5 outline-none focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all appearance-none cursor-pointer">
                                        <option value="all" selected>‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ (All Branches)</option>
                                        <option value="‡∏¢‡∏∞‡∏•‡∏≤">‡∏¢‡∏∞‡∏•‡∏≤</option>
                                        <option value="‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™">‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</option>
                                        <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</option>
                                        <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2</option>
                                        <option value="‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ">‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</option>
                                        <option value="‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°">‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°</option>
                                        <option value="‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ">‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</option>
                                        <option value="‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß">‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß</option>
                                        <option value="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï">‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</option>
                                        <option value="‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä">‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä</option>
                                        <option value="‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà">‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà</option>
                                        <option value="‡∏Å‡∏∞‡∏ó‡∏π‡πâ">‡∏Å‡∏∞‡∏ó‡∏π‡πâ</option>
                                        <option value="‡∏ï‡∏£‡∏±‡∏á">‡∏ï‡∏£‡∏±‡∏á</option>
                                        <option value="‡∏Ñ‡∏∏‡∏£‡∏∏">‡∏Ñ‡∏∏‡∏£‡∏∏</option>
                                        <option value="‡∏ä‡∏∏‡∏°‡∏û‡∏£">‡∏ä‡∏∏‡∏°‡∏û‡∏£</option>
                                        <option value="‡∏™‡∏ï‡∏π‡∏•">‡∏™‡∏ï‡∏π‡∏•</option>
                                        <option value="‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á">‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</option>
                                        <option value="‡∏™‡∏á‡∏Ç‡∏•‡∏≤">‡∏™‡∏á‡∏Ç‡∏•‡∏≤</option>
                                    </select>
                                    <div
                                        class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                        <ion-icon name="chevron-down-outline"></ion-icon>
                                    </div>
                                </div>
                            </div>

                            <!-- Status Filter -->
                            <div id="branch-order-filter-status-container" class="min-w-[160px]">
                                <div class="relative group">
                                    <div
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-yellow-500 transition-colors">
                                        <ion-icon name="filter-circle-outline" class="text-lg"></ion-icon>
                                    </div>
                                    <select id="branch-order-filter-status" onchange="fetchBranchOrders()"
                                        class="w-full bg-slate-100/80 border border-slate-200/60 text-slate-700 text-sm font-bold rounded-2xl pl-10 pr-4 py-3.5 outline-none focus:ring-4 focus:ring-yellow-400/20 focus:border-yellow-400 transition-all appearance-none cursor-pointer">
                                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                        <option value="pending" selected>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                        <option value="shipped">‡∏£‡∏≠‡∏Ç‡∏≠‡∏á</option>
                                        <option value="arrived">‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
                                        <option value="canceled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                                    </select>
                                    <div
                                        class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                        <ion-icon name="chevron-down-outline"></ion-icon>
                                    </div>
                                </div>
                            </div>
                            <button id="btn-add-branch-order" onclick="openBranchOrderModal()"
                                class="bg-slate-900 hover:bg-black text-white font-black py-3.5 px-8 rounded-2xl shadow-xl shadow-slate-900/20 transition-all hover:-translate-y-1 active:translate-y-0.5 flex items-center gap-2">
                                <ion-icon name="add-circle" class="text-xl text-yellow-400"></ion-icon>
                                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-hidden animate-fade-in"
                        style="animation-delay: 200ms;">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead class="bg-slate-50/50 backdrop-blur-sm border-b border-slate-100">
                                    <tr>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡πà‡∏á</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    </tr>
                                </thead>
                                <tbody id="branch-order-table-body"
                                    class="divide-y divide-slate-50 text-sm italic-last-row">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Branch Inventory View (Sales) -->
                <div id="branch-inventory-view" class="hidden space-y-6 mt-6">
                    <!-- Modern Header & Filters -->
                    <div
                        class="bg-white/70 backdrop-blur-md rounded-3xl p-6 shadow-xl shadow-slate-200/50 border border-white flex flex-col lg:flex-row justify-between items-center gap-6">
                        <div class="flex items-center gap-5">
                            <div
                                class="w-14 h-14 bg-gradient-to-br from-emerald-400 to-teal-600 text-white rounded-2xl shadow-lg shadow-emerald-500/30 flex items-center justify-center transform transition-transform hover:scale-110 active:scale-95">
                                <ion-icon name="list-box" class="text-3xl"></ion-icon>
                            </div>
                            <div>
                                <h3 id="branch-inventory-title"
                                    class="text-2xl font-black text-slate-800 tracking-tight">
                                    ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</h3>
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-4 w-full lg:w-auto">
                            <!-- Status Filter -->
                            <div class="relative group">
                                <ion-icon name="filter"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-emerald-500 transition-colors"></ion-icon>
                                <select id="branch-inventory-status-filter" onchange="fetchBranchInventory()"
                                    class="pl-9 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none cursor-pointer hover:border-emerald-300 transition-colors shadow-sm appearance-none min-w-[160px]">
                                    <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                    <option value="pending" selected>‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                    <option value="shipped">üöö ‡∏£‡∏≠‡∏Ç‡∏≠‡∏á</option>
                                    <option value="arrived">‚úÖ ‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="canceled">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                                </select>
                                <ion-icon name="chevron-down"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-2xl shadow-slate-200/50 border border-slate-100 overflow-hidden animate-fade-in"
                        style="animation-delay: 200ms;">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead class="bg-slate-50/50 backdrop-blur-sm border-b border-slate-100">
                                    <tr>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡πà‡∏á</th>
                                        <th
                                            class="px-6 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                        <th
                                            class="px-6 py-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    </tr>
                                </thead>
                                <tbody id="branch-inventory-table-body"
                                    class="divide-y divide-slate-50 text-sm italic-last-row">
                                    <!-- Dynamic Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="admin-view-content"
                    class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div id="loading-users" class="text-center p-12 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-4">
                        </div>
                        <p class="text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</p>
                    </div>
                    <div
                        class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center bg-slate-50/50 gap-4">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
                            <span id="user-count"
                                class="text-xs font-semibold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">0
                                ‡∏Ñ‡∏ô</span>
                        </div>
                        <div class="relative w-full sm:w-64">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <ion-icon name="search-outline" class="text-slate-400"></ion-icon>
                            </div>
                            <input type="text" id="user-search-input"
                                class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-xl leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 sm:text-sm transition-shadow"
                                placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ Username...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        Username</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</th>
                                    <th
                                        class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="divide-y divide-slate-100">
                                <tr id="no-user-row" class="text-center">
                                    <td colspan="6" class="px-6 py-12 text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="stock-request-manage-view" class="hidden animate-fade-in space-y-6">
                    <div
                        class="bg-white/80 backdrop-blur-xl p-6 rounded-[2.5rem] shadow-sm border border-slate-200/60 flex flex-col lg:flex-row justify-between items-center gap-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-200 shrink-0">
                                <ion-icon name="clipboard-outline" class="text-2xl text-white"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-black text-slate-800 tracking-tight">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å</h3>
                                <p class="text-sm font-medium text-slate-500">
                                    ‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
                                </p>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                            <!-- Status Filter -->
                            <div class="relative group flex-1 md:flex-none min-w-[160px]">
                                <ion-icon name="funnel-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                                <select id="manage-request-status-filter" onchange="fetchManageStockRequests()"
                                    class="pl-11 pr-10 py-3 rounded-2xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-all shadow-sm appearance-none w-full">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                    <option value="pending" selected>‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                    <option value="processing">üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏≠‡∏á</option>
                                    <option value="received">‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                                    <option value="canceled">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                                </select>
                                <ion-icon name="chevron-down-outline"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>

                            <!-- Branch Filter -->
                            <div class="relative group flex-1 md:flex-none min-w-[200px]">
                                <ion-icon name="business-outline"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                                <select id="manage-request-branch-filter" onchange="fetchManageStockRequests()"
                                    class="pl-11 pr-10 py-3 rounded-2xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-all shadow-sm appearance-none w-full">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                                    <!-- Branches will be populated by JS -->
                                </select>
                                <ion-icon name="chevron-down-outline"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50/50 border-b border-slate-100">
                                    <tr>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏™‡∏≤‡∏Ç‡∏≤ / ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th
                                            class="px-8 py-5 text-left text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                                        <th
                                            class="px-8 py-5 text-right text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                            ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-request-manage-table-body" class="divide-y divide-slate-100">
                                    <!-- JS Injected Rows -->
                                    <tr>
                                        <td colspan="6" class="px-6 py-10 text-center text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="stock-import-view" class="hidden space-y-8 mt-8 animate-fade-in pb-20">
                    <div
                        class="sticky top-4 z-30 bg-white/80 backdrop-blur-xl p-2 rounded-2xl shadow-lg border border-slate-200/60 flex flex-col md:flex-row gap-4 items-center justify-between transition-all">
                        <!-- Type Toggle Switch (Pill Shape) -->
                        <div class="bg-slate-100 p-1.5 rounded-xl flex gap-1 w-full md:w-auto">
                            <button onclick="filterStockType('phone')" id="tab-stock-phone"
                                class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-sm bg-white text-indigo-600 ring-1 ring-black/5">
                                <ion-icon name="phone-portrait" class="text-lg"></ion-icon> Phone (Excel)
                            </button>
                            <button onclick="filterStockType('accessory')" id="tab-stock-accessory"
                                class="flex-1 md:flex-none px-6 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50">
                                <ion-icon name="headset" class="text-lg"></ion-icon> Accessories
                            </button>
                            <button onclick="filterStockType('all')" id="tab-stock-all"
                                class="flex-1 md:flex-none px-4 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50 hidden">
                                ‡∏£‡∏ß‡∏°
                            </button>
                        </div>

                        <!-- Filters Group -->
                        <div class="flex items-center gap-3 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 px-1">
                            <!-- Branch Select -->
                            <div class="relative group">
                                <ion-icon name="storefront"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors"></ion-icon>
                                <select id="stock-import-branch-filter"
                                    class="pl-9 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-colors shadow-sm appearance-none min-w-[160px]">
                                    <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                                    <option value="‡∏¢‡∏∞‡∏•‡∏≤">‡∏¢‡∏∞‡∏•‡∏≤</option>
                                    <option value="‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™">‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</option>
                                    <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</option>
                                    <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2</option>
                                    <option value="‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ">‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</option>
                                    <option value="‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°">‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°</option>
                                    <option value="‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ">‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</option>
                                    <option value="‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß">‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß</option>
                                    <option value="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï">‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</option>
                                    <option value="‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä">‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä</option>
                                    <option value="‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà">‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà</option>
                                    <option value="‡∏Å‡∏∞‡∏ó‡∏π‡πâ">‡∏Å‡∏∞‡∏ó‡∏π‡πâ</option>
                                    <option value="‡∏ï‡∏£‡∏±‡∏á">‡∏ï‡∏£‡∏±‡∏á</option>
                                    <option value="‡∏Ñ‡∏∏‡∏£‡∏∏">‡∏Ñ‡∏∏‡∏£‡∏∏</option>
                                    <option value="‡∏ä‡∏∏‡∏°‡∏û‡∏£">‡∏ä‡∏∏‡∏°‡∏û‡∏£</option>
                                    <option value="‡∏™‡∏ï‡∏π‡∏•">‡∏™‡∏ï‡∏π‡∏•</option>
                                    <option value="‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á">‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</option>
                                    <option value="‡∏™‡∏á‡∏Ç‡∏•‡∏≤">‡∏™‡∏á‡∏Ç‡∏•‡∏≤</option>
                                </select>
                                <ion-icon name="chevron-down"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>

                            <!-- Status Filter (Dropdown Style) -->
                            <div class="relative group">
                                <ion-icon name="filter"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors"></ion-icon>
                                <select id="stock-import-status-filter" onchange="filterStockImports(this.value)"
                                    class="pl-9 pr-8 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-colors shadow-sm appearance-none">
                                    <option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="pending">üü° ‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</option>
                                    <option value="importing">üîµ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</option>
                                    <option value="received">üü¢ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                                    <option value="rejected">üî¥ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                                </select>
                                <ion-icon name="chevron-down"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                            </div>

                            <!-- Date Range Filters -->
                            <div class="h-8 w-px bg-slate-200 mx-1 hidden md:block"></div>
                            <div class="flex items-center gap-2">
                                <div class="relative group">
                                    <ion-icon name="calendar-outline"
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></ion-icon>
                                    <input type="text" onfocus="(this.type='date')" onblur="(this.type='text')"
                                        id="stock-filter-date-start" placeholder="‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"
                                        class="pl-9 pr-2 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none w-32 shadow-sm"
                                        onchange="fetchStockImports()">
                                </div>
                                <span class="text-slate-300">-</span>
                                <div class="relative group">
                                    <ion-icon name="calendar-outline"
                                        class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></ion-icon>
                                    <input type="text" onfocus="(this.type='date')" onblur="(this.type='text')"
                                        id="stock-filter-date-end" placeholder="‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î"
                                        class="pl-9 pr-2 py-2.5 rounded-xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none w-32 shadow-sm"
                                        onchange="fetchStockImports()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Content Views Container -->
                    <div
                        class="bg-white rounded-[2rem] shadow-sm border border-slate-200 min-h-[500px] overflow-hidden relative">
                        <!-- Loading Overlay -->
                        <div id="stock-loading"
                            class="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex flex-col items-center justify-center hidden">
                            <div
                                class="w-12 h-12 border-4 border-indigo-100 border-t-indigo-500 rounded-full animate-spin mb-4">
                            </div>
                            <p class="text-indigo-900 font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                        </div>

                        <!-- PHONE VIEW (Table) -->
                        <div id="stock-view-phone" class="hidden animate-fade-in relative z-10">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-100">
                                    <thead class="bg-slate-50/80 backdrop-blur-sm sticky top-0 z-10">
                                        <tr>
                                            <th
                                                class="px-6 py-5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                                            <th
                                                class="px-6 py-5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                üè™ ‡∏™‡∏≤‡∏Ç‡∏≤ / ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                            <th
                                                class="px-6 py-5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                üì¶ Supplier</th>
                                            <th
                                                class="px-6 py-5 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                üìé ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th>
                                            <th
                                                class="px-6 py-5 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                            <th
                                                class="px-6 py-5 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stock-phone-tbody" class="divide-y divide-slate-100 bg-white">
                                        <!-- JS Injected -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ACCESSORY VIEW (Grid) -->
                        <div id="stock-view-accessory" class="p-6 hidden animate-fade-in relative z-10">
                            <div id="stock-acc-grid"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                <!-- JS Injected Cards -->
                            </div>
                        </div>

                        <!-- Empty State (Common) -->
                        <div id="stock-empty-state"
                            class="hidden absolute inset-0 flex flex-col items-center justify-center text-center p-8 z-0">
                            <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6">
                                <ion-icon name="file-tray-outline" class="text-5xl text-slate-300"></ion-icon>
                            </div>
                            <h4 class="text-xl font-bold text-slate-700">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h4>
                            <p class="text-slate-400 mt-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                        </div>
                    </div>
                    <div id="stock-pagination"
                        class="hidden border-t border-slate-100 bg-slate-50 p-4 flex flex-col md:flex-row justify-between items-center gap-4 relative z-20">
                        <div class="text-xs font-bold text-slate-500">
                            ‡πÅ‡∏™‡∏î‡∏á <span id="pagination-info-start">0</span> - <span id="pagination-info-end">0</span> ‡∏à‡∏≤‡∏Å
                            <span id="pagination-info-total">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btn-prev-page" onclick="changeStockPage(-1)" disabled
                                class="p-2 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                                <ion-icon name="chevron-back"></ion-icon>
                            </button>
                            <span id="pagination-page-display"
                                class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-700 shadow-sm">
                                ‡∏´‡∏ô‡πâ‡∏≤ 1 / 1
                            </span>
                            <button id="btn-next-page" onclick="changeStockPage(1)" disabled
                                class="p-2 rounded-lg bg-white border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm">
                                <ion-icon name="chevron-forward"></ion-icon>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="import-view" class="hidden space-y-6 mt-6">
                    <!-- Header -->
                    <div
                        class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 relative overflow-hidden">
                        <!-- Decorative bg -->
                        <div
                            class="absolute top-0 right-0 w-32 h-32 bg-yellow-400 opacity-10 rounded-full blur-3xl -mr-10 -mt-10">
                        </div>

                        <div class="flex items-center gap-4 relative z-10">
                            <div class="p-3 bg-slate-900 text-yellow-400 rounded-2xl shadow-lg shadow-slate-900/20">
                                <ion-icon name="cloud-upload" class="text-2xl"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                                <p class="text-sm text-slate-500">‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
                            </div>
                        </div>
                        <div class="flex space-x-2 md:space-x-4 min-w-max">
                            <button onclick="switchImportTab('phone')" id="tab-btn-phone"
                                class="flex items-center px-6 py-3 rounded-xl text-sm font-bold transition-all bg-yellow-400 text-slate-900 shadow-md shadow-yellow-400/30">
                                <ion-icon name="phone-portrait-outline" class="mr-2 text-lg"></ion-icon>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (Excel)
                            </button>
                            <button onclick="switchImportTab('accessory')" id="tab-btn-accessory"
                                class="flex items-center px-6 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-slate-50 transition-all">
                                <ion-icon name="headset-outline" class="mr-2 text-lg"></ion-icon>
                                ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Accessories (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)
                            </button>
                        </div>
                    </div>
                    <!-- (*** New: Filter Toolbar ***) -->
                    <div
                        class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
                        <div class="flex items-center gap-4 w-full md:w-auto flex-1">
                            <div class="relative w-full md:w-64">
                                <ion-icon name="search"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></ion-icon>
                                <input type="text" id="import-filter-search" oninput="renderImportLists()"
                                    class="w-full pl-10 pr-4 py-2 rounded-xl border border-slate-200 focus:border-yellow-400 focus:ring-2 focus:ring-yellow-100 outline-none text-sm font-bold text-slate-700 transition-all"
                                    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Supplier, ‡∏™‡∏≤‡∏Ç‡∏≤...">
                            </div>

                            <div class="flex items-center gap-2">
                                <ion-icon name="filter" class="text-slate-400"></ion-icon>
                                <select id="import-filter-status" onchange="renderImportLists()"
                                    class="pl-2 pr-8 py-2 rounded-xl border border-slate-200 focus:border-yellow-400 focus:ring-2 focus:ring-yellow-100 outline-none text-sm font-bold text-slate-700 bg-white cursor-pointer">
                                    <option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="pending" selected>‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</option>
                                    <option value="importing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</option>
                                    <option value="received">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Phone Import Section -->
                    <div id="tab-import-phone" class="space-y-6 animate-fade-in">
                        <!-- Upload Button Area -->
                        <button onclick="openPhoneImportModal()"
                            class="bg-slate-900 hover:bg-black text-yellow-400 px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2 group">
                            <div
                                class="p-1 bg-yellow-400 text-slate-900 rounded-lg group-hover:scale-110 transition-transform">
                                <ion-icon name="add"></ion-icon>
                            </div>
                            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>
                        </button>

                        <!-- (*** New: Phone Import Modal ***) -->
                        <div id="phoneImportModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
                            <div
                                class="modal-content relative w-full max-w-lg bg-white rounded-3xl shadow-2xl overflow-hidden ring-4 ring-yellow-400/20 transform transition-all scale-100">
                                <!-- Header -->
                                <div
                                    class="bg-slate-900 p-6 flex justify-between items-center text-white relative overflow-hidden">
                                    <div
                                        class="absolute top-0 right-0 w-24 h-24 bg-yellow-400 rounded-full opacity-10 blur-xl -mr-10 -mt-10">
                                    </div>
                                    <h3 class="text-xl font-bold flex items-center gap-3 relative z-10">
                                        <div
                                            class="p-2 bg-yellow-400 text-slate-900 rounded-lg shadow-lg shadow-yellow-400/50">
                                            <ion-icon name="cloud-upload"></ion-icon>
                                        </div>
                                        <span class="text-white tracking-wide">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå Excel</span>
                                    </h3>
                                    <button onclick="closeModal('phoneImportModal')"
                                        class="hover:bg-white/10 p-2 rounded-full transition-colors relative z-10 text-slate-400 hover:text-white">
                                        <ion-icon name="close" class="text-2xl"></ion-icon>
                                    </button>
                                </div>

                                <!-- Form Body -->
                                <div class="p-8">
                                    <form id="phone-import-form" class="space-y-6">
                                        <!-- Files Container -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <!-- Excel File Input -->
                                            <div>
                                                <label class="block text-sm font-bold text-slate-700 mb-2">1. ‡πÑ‡∏ü‡∏•‡πå Excel
                                                    (.xlsx, .xls)</label>
                                                <div
                                                    class="border-2 border-dashed border-slate-200 rounded-2xl p-4 text-center hover:bg-slate-50 hover:border-yellow-400 transition-all cursor-pointer relative group bg-slate-50/30 h-32 flex flex-col items-center justify-center">
                                                    <input type="file" id="phone-import-file" accept=".xlsx, .xls"
                                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer text-sm">
                                                    <ion-icon name="document-text-outline"
                                                        class="text-2xl text-slate-300 mb-1 group-hover:text-yellow-500 transition-colors"></ion-icon>
                                                    <p class="font-bold text-slate-600 text-xs">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</p>
                                                    <p id="file-name-display"
                                                        class="mt-1 text-[10px] font-bold text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-lg hidden truncate max-w-[90%]">
                                                    </p>
                                                </div>
                                            </div>

                                            <!-- Image File Input -->
                                            <div>
                                                <label class="block text-sm font-bold text-slate-700 mb-2">2.
                                                    ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                                                <div
                                                    class="border-2 border-dashed border-slate-200 rounded-2xl p-4 text-center hover:bg-slate-50 hover:border-blue-400 transition-all cursor-pointer relative group bg-slate-50/30 h-32 flex flex-col items-center justify-center overflow-hidden">
                                                    <input type="file" id="phone-import-image" accept="image/*"
                                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer text-sm">

                                                    <div id="phone-image-placeholder"
                                                        class="flex flex-col items-center">
                                                        <ion-icon name="image-outline"
                                                            class="text-2xl text-slate-300 mb-1 group-hover:text-blue-500 transition-colors"></ion-icon>
                                                        <p class="font-bold text-slate-600 text-xs">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                                                    </div>

                                                    <img id="phone-image-preview"
                                                        class="absolute inset-0 w-full h-full object-cover hidden"
                                                        src="">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Supplier Input -->
                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">Supplier
                                                (‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤)</label>
                                            <input type="text" id="phone-import-supplier" class="form-input-theme"
                                                required placeholder="‡πÄ‡∏ä‡πà‡∏ô Samsung Thailand, Com7...">
                                        </div>

                                        <!-- Description Input -->
                                        <div>
                                            <label
                                                class="block text-sm font-bold text-slate-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                                            <textarea id="phone-import-description" rows="2"
                                                class="form-input-theme resize-none"
                                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..."></textarea>
                                        </div>

                                        <!-- Submit Button -->
                                        <div class="pt-2">
                                            <button type="submit"
                                                class="w-full bg-slate-900 hover:bg-black text-yellow-400 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                                                <ion-icon name="checkmark-circle"></ion-icon>
                                                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- History List -->
                        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                                <h4 class="text-lg font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤(‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå)</h4>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-white border-b border-slate-100">
                                        <tr>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</th>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                Supplier</th> <!-- (New Header) -->
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                ‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                            <th
                                                class="px-6 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                            <th
                                                class="px-6 py-4 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th> <!-- (New) -->
                                        </tr>
                                    </thead>
                                    <tbody id="phone-import-list" class="divide-y divide-slate-100">
                                        <!-- Items will be injected here -->
                                        <tr>
                                            <td colspan="5" class="px-6 py-10 text-center text-slate-400">
                                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Accessory Import Section -->
                    <div id="tab-import-accessory" class="hidden space-y-6 animate-fade-in">
                        <button onclick="openAccessoryImportModal()"
                            class="bg-slate-900 hover:bg-black text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2 group">
                            <div class="p-1 bg-white/20 rounded-lg group-hover:scale-110 transition-transform">
                                <ion-icon name="add"></ion-icon>
                            </div>
                            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ö‡∏¥‡∏•)</span>
                        </button>

                        <!-- Full Width List -->
                        <div class="col-span-full">
                            <div
                                class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden h-full flex flex-col">
                                <div
                                    class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                    <h4 class="text-lg font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤(Accessories)</h4>
                                </div>
                                <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 flex-grow overflow-y-auto max-h-[600px] custom-scrollbar"
                                    id="accessory-import-list">
                                    <!-- Accessor Cards Injected Here -->
                                    <div class="col-span-full py-12 text-center text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- (*** New: Accessory Import Modal (Multi-Item) ***) -->
                    <div id="accImportModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
                        <div
                            class="modal-content relative w-full h-full max-w-4xl max-h-[90vh] bg-white rounded-3xl shadow-2xl overflow-hidden ring-4 ring-slate-900/10 flex flex-col transform transition-all scale-100">
                            <!-- Header -->
                            <div
                                class="bg-slate-900 p-6 flex justify-between items-center text-white flex-shrink-0 relative overflow-hidden">
                                <div
                                    class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full blur-2xl -mr-10 -mt-10">
                                </div>
                                <h3 class="text-xl font-bold flex items-center gap-3 relative z-10">
                                    <div class="p-2 bg-white/10 rounded-lg backdrop-blur-sm">
                                        <ion-icon name="receipt-outline"></ion-icon>
                                    </div>
                                    <span class="tracking-wide">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (Accessories)</span>
                                </h3>
                                <button onclick="closeModal('accImportModal')"
                                    class="hover:bg-white/10 p-2 rounded-full transition-colors text-slate-400 hover:text-white relative z-10">
                                    <ion-icon name="close" class="text-2xl"></ion-icon>
                                </button>
                            </div>

                            <!-- Body (Scrollable) -->
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-8 bg-slate-50">
                                <form id="accessory-import-form-multi" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                                    <!-- Left Column: Bill Image & Info -->
                                    <div class="lg:col-span-4 space-y-6">
                                        <div
                                            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 sticky top-0">
                                            <h5 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                                <ion-icon name="image" class="text-yellow-500"></ion-icon>
                                                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•
                                            </h5>

                                            <div class="space-y-4">
                                                <!-- Image Upload -->
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 mb-2 uppercase">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                                                    <div
                                                        class="border-2 border-dashed border-slate-200 rounded-xl p-2 text-center hover:bg-slate-50 hover:border-yellow-400 transition-all cursor-pointer relative bg-slate-50/50 group h-48 flex items-center justify-center">
                                                        <input type="file" id="acc-bill-image" accept="image/*"
                                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                                            onchange="previewImage(this)">
                                                        <div id="image-preview-placeholder"
                                                            class="flex flex-col items-center pointer-events-none transition-opacity">
                                                            <div
                                                                class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mb-2 group-hover:bg-yellow-100 group-hover:text-yellow-600 transition-colors">
                                                                <ion-icon name="camera"
                                                                    class="text-2xl text-slate-400 group-hover:text-yellow-600"></ion-icon>
                                                            </div>
                                                            <span
                                                                class="text-xs font-bold text-slate-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</span>
                                                        </div>
                                                        <img id="image-preview" src=""
                                                            class="hidden w-full h-full object-contain rounded-lg relative z-0">
                                                    </div>
                                                </div>

                                                <!-- Bill Name (New) -->
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 mb-1 uppercase">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                                                        / ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏¥‡∏•</label>
                                                    <input type="text" id="acc-bill-name"
                                                        class="form-input-theme w-full"
                                                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠..." required>
                                                </div>

                                                <!-- Date & Supplier -->
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 mb-1 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ö‡∏¥‡∏•</label>
                                                    <input type="date" id="acc-bill-date"
                                                        class="form-input-theme w-full" required>
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-xs font-bold text-slate-500 mb-1 uppercase">Supplier
                                                        (‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠)</label>
                                                    <input type="text" id="acc-bill-supplier"
                                                        class="form-input-theme w-full" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤...">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column: Items List -->
                                    <div class="lg:col-span-8 space-y-6">
                                        <div class="flex justify-between items-center">
                                            <h5 class="font-bold text-slate-800 flex items-center gap-2">
                                                <ion-icon name="list" class="text-blue-500"></ion-icon>
                                                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏•
                                            </h5>
                                            <button type="button" onclick="addAccessoryItemRow()"
                                                class="text-sm font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-2 rounded-lg transition-colors flex items-center gap-1">
                                                <ion-icon name="add-circle"></ion-icon> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                            </button>
                                        </div>

                                        <!-- Items Container -->
                                        <div id="acc-items-container" class="space-y-3">
                                            <!-- Dynamic Rows will be added here -->
                                        </div>

                                        <!-- Empty State Helper -->
                                        <div id="acc-items-empty"
                                            class="text-center py-10 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50">
                                            <ion-icon name="basket-outline"
                                                class="text-4xl text-slate-300 mb-2"></ion-icon>
                                            <p class="text-slate-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                                            <button type="button" onclick="addAccessoryItemRow()"
                                                class="mt-2 text-xs font-bold text-blue-500 hover:underline">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Footer -->
                            <div
                                class="bg-white p-6 border-t border-slate-100 flex justify-between items-center flex-shrink-0 z-20">
                                <div class="text-sm text-slate-500">
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <span id="acc-total-items-count"
                                        class="font-bold text-slate-900">0</span>
                                </div>
                                <div class="flex gap-3">
                                    <button type="button" onclick="closeModal('accImportModal')"
                                        class="px-6 py-2.5 rounded-xl text-slate-500 font-bold hover:bg-slate-50 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button type="button" onclick="submitAccessoryImport()"
                                        class="bg-slate-900 hover:bg-black text-yellow-400 px-8 py-2.5 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2">
                                        <ion-icon name="checkmark-circle"></ion-icon>
                                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- View: Stock Request (Sales) -->
    <div id="stock-request-view" class="hidden animate-fade-in space-y-6">
        <div
            class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-100 gap-4">
            <div>
                <h3 class="text-xl font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <p class="text-sm text-slate-500 mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏Å‡∏•‡∏≤‡∏á</p>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                <select id="stock-request-branch-filter" class="form-select-theme py-2.5 min-w-[160px] shadow-sm">
                    <option value="">‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</option>
                    <!-- Branches populated by JS -->
                </select>
                <button onclick="openStockRequestModal()"
                    class="w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg shadow-yellow-500/30 transition-all flex items-center justify-center gap-2">
                    <ion-icon name="add-circle" class="text-xl"></ion-icon>
                    <span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">
                                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">
                                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">
                                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏∂‡∏á</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                            </th>
                            <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                            </th>
                        </tr>
                    </thead>
                    <tbody id="stock-request-table-body" class="divide-y divide-slate-100">
                        <!-- JS Injected Rows -->
                        <tr>
                            <td colspan="6" class="px-6 py-10 text-center text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- New Task Modal -->
    <div id="newTaskModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <button onclick="closeModal('newTaskModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8">
                <form id="new-task-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="taskTitle"
                                class="block text-sm font-semibold text-slate-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="taskTitle" name="title" required class="form-input-theme"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå">
                        </div>
                        <div>
                            <label for="taskAssignTo"
                                class="block text-sm font-semibold text-slate-700 mb-2">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ</label>
                            <select id="taskAssignTo" name="assignedTo" required class="form-select-theme">
                                <option value="" disabled selected>--- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ---</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="taskDesc"
                            class="block text-sm font-semibold text-slate-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label>
                        <textarea id="taskDesc" name="description" rows="4" class="form-input-theme"
                            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="taskDueDate"
                                class="block text-sm font-semibold text-slate-700 mb-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
                            <input type="date" id="taskDueDate" name="dueDate" class="form-input-theme">
                        </div>
                        <div>
                            <label for="taskPriority"
                                class="block text-sm font-semibold text-slate-700 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
                            <select id="taskPriority" name="priority" class="form-select-theme">
                                <option value="low">‡∏ï‡πà‡∏≥</option>
                                <option value="medium" selected>‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                                <option value="high">‡∏™‡∏π‡∏á</option>
                            </select>
                        </div>
                    </div>
                    <div id="new-task-error"
                        class="hidden p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('newTaskModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" id="submit-task-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all flex items-center">
                            <span id="submit-task-text">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</span>
                            <div id="submit-task-spinner"
                                class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent">
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="depositModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div
                class="bg-gradient-to-r from-yellow-500 to-orange-600 p-6 flex justify-between items-center text-white">
                <h3 class="text-xl font-bold flex items-center"><ion-icon name="wallet" class="mr-2"></ion-icon>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥</h3>
                <button onclick="closeModal('depositModal')" class="hover:text-yellow-100 transition-colors"><ion-icon
                        name="close" class="text-2xl"></ion-icon></button>
            </div>
            <div class="p-8 max-h-[80vh] overflow-y-auto">
                <form id="deposit-form" class="space-y-6">
                    <input type="hidden" id="dep-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 border-b border-slate-100">
                        <div class="col-span-2 font-bold text-slate-800 flex items-center text-lg">
                            <div
                                class="w-8 h-8 rounded-lg bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3">
                                <ion-icon name="document-text"></ion-icon>
                            </div>
                            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥
                        </div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏î‡∏à‡∏≥</label><input
                                type="date" id="dep-date" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö</label><input
                                type="date" id="dep-pickup" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input
                                type="text" id="dep-name" class="form-input-theme" required></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input
                                type="text" id="dep-phone" class="form-input-theme" required></div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥
                                (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="number" id="dep-amount"
                                class="form-input-theme bg-red-50 text-red-600 font-bold border-red-100 focus:ring-red-500 focus:border-red-500 text-lg"
                                required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                        <div
                            class="col-span-2 font-bold text-slate-800 flex items-center text-lg bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <ion-icon name="gift" class="mr-3 text-yellow-500 text-xl"></ion-icon> ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                            (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)
                        </div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                (‡∏£‡∏∏‡πà‡∏ô/‡∏™‡∏µ/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏)</label><select id="dep-product" class="form-select-theme"
                                placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°..."></select>
                        </div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°
                                (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="dep-price" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</label><input
                                type="text" id="dep-bill" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">IMEI</label><input
                                type="text" id="dep-imei" class="form-input-theme"></div>

                        <label for="dep-success"
                            class="col-span-2 flex items-center mt-2 p-4 bg-green-50 rounded-xl border border-green-200 cursor-pointer hover:bg-green-100 transition-colors">

                            <input type="checkbox" id="dep-success"
                                class="w-5 h-5 text-green-600 rounded focus:ring-green-500 mr-3">

                            <span class="font-bold text-green-800 cursor-pointer select-none">
                                ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
                            </span>
                        </label>
                    </div>

                    <div class="flex justify-end gap-3 pt-6 border-t border-slate-100">
                        <button type="button" onclick="closeModal('depositModal')"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <form id="update-task-form">
                <input type="hidden" id="detail-task-id" name="taskId">
                <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800" id="detail-task-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h3>
                    <button type="button" class="text-slate-400 hover:text-slate-600 transition-colors"
                        onclick="closeModal('taskDetailModal')">
                        <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                    </button>
                </div>

                <div class="p-8 space-y-6">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-sm font-semibold text-slate-500 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                        <p id="detail-task-desc" class="text-slate-700 whitespace-pre-wrap leading-relaxed">...</p>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</p>
                                <p id="detail-task-creator" class="text-sm font-semibold text-slate-800">...</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3">
                                <ion-icon name="calendar"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</p>
                                <p id="detail-task-dueDate" class="text-sm font-semibold text-slate-800">...</p>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6">
                        <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center"><ion-icon
                                name="time-outline" class="mr-2"></ion-icon> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</h4>
                        <div id="detail-task-comments-list"
                            class="space-y-3 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                            <p class="text-sm text-slate-400 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</p>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6 bg-yellow-50/50 -mx-8 px-8 -mb-8 pb-8">
                        <div class="mb-4">
                            <label for="detail-task-status"
                                class="block text-sm font-bold text-slate-700 mb-2">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</label>
                            <select id="detail-task-status" name="status" class="form-select-theme">
                                <option value="todo">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (To Do)</option>
                                <option value="in-progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (In Progress)</option>
                                <option value="for-review">‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (For Review)</option>
                                <option value="completed">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (Completed)</option>
                            </select>
                        </div>
                        <div>
                            <label for="detail-task-comment"
                                class="block text-sm font-bold text-slate-700 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <textarea id="detail-task-comment" name="commentText" rows="3" class="form-input-theme"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö Link ‡∏ú‡∏•‡∏á‡∏≤‡∏ô..."></textarea>
                        </div>
                    </div>
                </div>

                <div id="update-task-error"
                    class="hidden mx-8 mb-6 p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>

                <div class="px-8 py-4 border-t border-slate-100 bg-white flex justify-between items-center">
                    <button type="button" id="delete-task-btn"
                        class="text-red-600 hover:text-red-700 font-medium text-sm flex items-center px-3 py-2 rounded-lg hover:bg-red-50 transition-colors"
                        style="display: none;">
                        <ion-icon name="trash-outline" class="text-lg mr-2"></ion-icon> ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
                    </button>
                    <div class="flex gap-3">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('taskDetailModal')">‡∏õ‡∏¥‡∏î</button>
                        <button type="submit" id="save-task-details-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="branchOrderModal" class="modal fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/40 transition-opacity" aria-hidden="true"
            onclick="closeModal('branchOrderModal')"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="modal-content inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-pink-100 sm:mx-0 sm:h-10 sm:w-10">
                        <ion-icon name="basket" class="text-pink-600 text-xl"></ion-icon>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-slate-900" id="modal-title">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô
                                    ‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏°‡∏µ.‡∏Ñ.)</label>
                                <input type="text" id="bo-order-name" class="form-input-theme" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</label>
                                    <input type="date" id="bo-order-date" class="form-input-theme" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á</label>
                                    <input type="date" id="bo-expected-date" class="form-input-theme">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
                                <select id="bo-branch" class="form-select-theme">
                                    <option value="‡∏¢‡∏∞‡∏•‡∏≤">‡∏¢‡∏∞‡∏•‡∏≤</option>
                                    <option value="‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™">‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</option>
                                    <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà</option>
                                    <option value="‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2">‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2</option>
                                    <option value="‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ">‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ</option>
                                    <option value="‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°">‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°</option>
                                    <option value="‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ">‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ</option>
                                    <option value="‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß">‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß</option>
                                    <option value="‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï">‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï</option>
                                    <option value="‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä">‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä</option>
                                    <option value="‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà">‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà</option>
                                    <option value="‡∏Å‡∏∞‡∏ó‡∏π‡πâ">‡∏Å‡∏∞‡∏ó‡∏π‡πâ</option>
                                    <option value="‡∏ï‡∏£‡∏±‡∏á">‡∏ï‡∏£‡∏±‡∏á</option>
                                    <option value="‡∏Ñ‡∏∏‡∏£‡∏∏">‡∏Ñ‡∏∏‡∏£‡∏∏</option>
                                    <option value="‡∏ä‡∏∏‡∏°‡∏û‡∏£">‡∏ä‡∏∏‡∏°‡∏û‡∏£</option>
                                    <option value="‡∏™‡∏ï‡∏π‡∏•">‡∏™‡∏ï‡∏π‡∏•</option>
                                    <option value="‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á">‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</option>
                                    <option value="‡∏™‡∏á‡∏Ç‡∏•‡∏≤">‡∏™‡∏á‡∏Ç‡∏•‡∏≤</option>
                                </select>
                            </div>

                            <!-- Dynamic Items Section -->
                            <div class="border-t border-slate-100 pt-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                                    <button type="button" onclick="addBranchOrderItemRow()"
                                        class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold px-2 py-1 rounded-lg transition-colors">
                                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                                    </button>
                                </div>
                                <div id="bo-items-container" class="space-y-3 max-h-60 overflow-y-auto pr-1">
                                    <!-- Items will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitBranchOrder()"
                    class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-sm px-4 py-2 bg-pink-600 text-base font-medium text-white hover:bg-pink-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </button>
                <button type="button" onclick="closeModal('branchOrderModal')"
                    class="mt-3 w-full inline-flex justify-center rounded-xl border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>
    </div>


    <!-- Confirm Modal for Status Change -->
    <div id="statusUpdateModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 transform transition-all border border-slate-100">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <ion-icon name="sync-circle" class="text-indigo-500 text-2xl"></ion-icon>
                    ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                </h3>
                <button onclick="closeModal('statusUpdateModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <button onclick="updateStockStatusFromModal('pending')"
                    class="group flex items-center justify-between p-4 rounded-2xl bg-amber-50 border border-amber-100 hover:bg-amber-100 hover:border-amber-200 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-amber-500 text-white flex items-center justify-center shadow-lg shadow-amber-500/20 group-hover:scale-110 transition-transform">
                            <ion-icon name="time-outline" class="text-xl"></ion-icon>
                        </div>
                        <div>
                            <div class="font-bold text-amber-900">‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</div>
                            <div class="text-xs text-amber-700/60 font-medium tracking-wide uppercase">Pending Review
                            </div>
                        </div>
                    </div>
                    <ion-icon name="chevron-forward-outline"
                        class="text-amber-400 group-hover:translate-x-1 transition-transform"></ion-icon>
                </button>

                <button onclick="updateStockStatusFromModal('importing')"
                    class="group flex items-center justify-between p-4 rounded-2xl bg-blue-50 border border-blue-100 hover:bg-blue-100 hover:border-blue-200 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-blue-500 text-white flex items-center justify-center shadow-lg shadow-blue-500/20 group-hover:scale-110 transition-transform">
                            <ion-icon name="bus-outline" class="text-xl"></ion-icon>
                        </div>
                        <div>
                            <div class="font-bold text-blue-900">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</div>
                            <div class="text-xs text-blue-700/60 font-medium tracking-wide uppercase">Processing</div>
                        </div>
                    </div>
                    <ion-icon name="chevron-forward-outline"
                        class="text-blue-400 group-hover:translate-x-1 transition-transform"></ion-icon>
                </button>

                <button onclick="updateStockStatusFromModal('received')"
                    class="group flex items-center justify-between p-4 rounded-2xl bg-emerald-50 border border-emerald-100 hover:bg-emerald-100 hover:border-emerald-200 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-500/20 group-hover:scale-110 transition-transform">
                            <ion-icon name="checkmark-circle-outline" class="text-xl"></ion-icon>
                        </div>
                        <div>
                            <div class="font-bold text-emerald-900">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß)</div>
                            <div class="text-xs text-emerald-700/60 font-medium tracking-wide uppercase">Received</div>
                        </div>
                    </div>
                    <ion-icon name="chevron-forward-outline"
                        class="text-emerald-400 group-hover:translate-x-1 transition-transform"></ion-icon>
                </button>

                <button onclick="updateStockStatusFromModal('rejected')"
                    class="group flex items-center justify-between p-4 rounded-2xl bg-rose-50 border border-rose-100 hover:bg-rose-100 hover:border-rose-200 transition-all text-left">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-rose-500 text-white flex items-center justify-center shadow-lg shadow-rose-500/20 group-hover:scale-110 transition-transform">
                            <ion-icon name="close-circle-outline" class="text-xl"></ion-icon>
                        </div>
                        <div>
                            <div class="font-bold text-rose-900">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
                            <div class="text-xs text-rose-700/60 font-medium tracking-wide uppercase">Rejected</div>
                        </div>
                    </div>
                    <ion-icon name="chevron-forward-outline"
                        class="text-rose-400 group-hover:translate-x-1 transition-transform"></ion-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- (*** NEW: Stock Detail Modal for Accessories ***) -->
    <div id="stockDetailModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-5xl h-[90vh] bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row">
            <!-- Left Column: Image Area -->
            <div class="w-full md:w-1/2 bg-slate-900 relative flex items-center justify-center group overflow-hidden">
                <img id="detail-bill-image" src=""
                    class="max-w-full max-h-full object-contain shadow-2xl transition-transform duration-500 group-hover:scale-105"
                    alt="Bill Image">

                <div class="absolute top-4 left-4 z-10">
                    <span
                        class="px-3 py-1 bg-black/50 text-white text-xs font-bold rounded-full backdrop-blur-md">‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡∏ö‡∏¥‡∏•</span>
                </div>

                <!-- Expand Button -->
                <a id="detail-bill-link" href="#" target="_blank"
                    class="absolute bottom-6 right-6 p-3 bg-white text-slate-900 rounded-full shadow-lg hover:bg-yellow-400 transition-colors"
                    title="‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°">
                    <ion-icon name="expand-outline" class="text-xl"></ion-icon>
                </a>
            </div>

            <!-- Right Column: Info & Actions -->
            <div class="w-full md:w-1/2 flex flex-col h-full">
                <!-- Header -->
                <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50/50">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span id="detail-branch-badge"
                                class="px-2 py-0.5 rounded-md bg-white border border-slate-200 text-xs font-bold text-slate-600 shadow-sm">‡∏™‡∏≤‡∏Ç‡∏≤...</span>
                            <span id="detail-date-display" class="text-xs text-slate-400">...</span>
                        </div>
                        <h3 id="detail-supplier-title" class="text-xl font-bold text-slate-800 line-clamp-1">Supplier
                            Name</h3>
                        <p id="detail-by-user" class="text-xs text-slate-500 mt-0.5">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏î‡∏¢: ...</p>
                    </div>
                    <button onclick="closeModal('stockDetailModal')" class="text-slate-400 hover:text-slate-600 p-1">
                        <ion-icon name="close" class="text-2xl"></ion-icon>
                    </button>
                </div>

                <!-- Items List (Scrollable) -->
                <div class="flex-1 overflow-y-auto p-6 bg-white custom-scrollbar">
                    <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <ion-icon name="list-circle" class="text-indigo-500 text-lg"></ion-icon> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
                    </h4>
                    <div id="detail-items-list" class="space-y-3">
                        <!-- Items injected here -->
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="p-6 border-t border-slate-100 bg-slate-50/30">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-bold text-slate-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</span>
                        <span id="detail-current-status" class="px-3 py-1 rounded-full text-xs font-bold">...</span>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-action-importing" onclick="updateStockStatusFromModal('importing')"
                            class="col-span-1 py-3 rounded-xl bg-blue-100 text-blue-700 font-bold hover:bg-blue-200 transition-colors flex items-center justify-center gap-2">
                            <ion-icon name="timer-outline"></ion-icon> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                        </button>
                        <button id="btn-action-received" onclick="updateStockStatusFromModal('received')"
                            class="col-span-1 py-3 rounded-xl bg-green-100 text-green-700 font-bold hover:bg-green-200 transition-colors flex items-center justify-center gap-2">
                            <ion-icon name="checkmark-circle-outline"></ion-icon> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                        </button>
                        <button id="btn-action-reject" onclick="updateStockStatusFromModal('rejected')"
                            class="col-span-2 py-3 rounded-xl bg-white border border-red-200 text-red-500 font-bold hover:bg-red-50 transition-colors flex items-center justify-center gap-2">
                            <ion-icon name="close-circle-outline"></ion-icon> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =============================================== -->
    <!-- View: Admin (User Management) -->
    <!-- =============================================== -->
    <div id="admin-view-content" class="hidden animate-fade-in">
        <div class="modal-content relative w-full max-w-md bg-white rounded-2xl shadow-2xl p-6 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <ion-icon name="warning" class="text-3xl"></ion-icon>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
            <p class="text-slate-500 mb-6" id="confirm-message">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?
                ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
            <p id="confirm-error-message" class="text-xs text-red-600 mb-4"></p>

            <div class="flex justify-center gap-3">
                <button type="button"
                    class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                    onclick="closeModal('confirmModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" id="confirm-delete-button" data-task-id=""
                    class="px-6 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg shadow-red-600/30 transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800" id="user-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
                <button onclick="closeModal('userModal')" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8">
                <form id="user-form" class="space-y-6">
                    <input type="hidden" id="user-id" name="userId">
                    <input type="hidden" id="form-mode" name="mode" value="create">

                    <div>
                        <label for="user-company-input" class="block text-sm font-semibold text-slate-700 mb-2">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                            (Company)</label>
                        <select id="user-company-input" name="companyId" required class="form-select-theme">
                            <option value="company_1_id">‡∏ã‡∏¥‡∏•‡∏°‡∏µ‡∏ô ‡πÇ‡∏°‡∏ö‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</option>
                            <option value="company_2_id">‡πÄ‡∏≠‡∏™‡∏à‡∏µ ‡∏û‡∏•‡∏±‡∏™ 2023 ‡∏à‡∏≥‡∏Å‡∏±‡∏î</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="user-name-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="user-name-input" name="name" required class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-role-input" class="block text-sm font-semibold text-slate-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                                (Role)</label>
                            <select id="user-role-input" name="role" required class="form-select-theme">
                                <option value="staff">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Staff)</option>
                                <option value="manager">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Manager)</option>
                                <option value="hr">‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (HR)</option>
                                <option value="executive">‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive)</option>
                            </select>
                        </div>
                    </div>

                    <div id="auth-section"
                        class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                        <div>
                            <label for="user-username-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">Username (‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</label>
                            <input type="text" id="user-username-input" name="username" required
                                class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-password-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">Password</label>
                            <input type="password" id="user-password-input" name="password" class="form-input-theme"
                                placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="user-department-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                            <input type="text" id="user-department-input" name="department" required
                                class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-branch-input" class="block text-sm font-semibold text-slate-700 mb-2">‡∏™‡∏≤‡∏Ç‡∏≤
                                (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <input type="text" id="user-branch-input" name="branch" class="form-input-theme">
                        </div>
                    </div>

                    <div>
                        <label for="user-reportsTo-input"
                            class="block text-sm font-semibold text-slate-700 mb-2">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Reports To)</label>
                        <select id="user-reportsTo-input" name="reportsTo" class="form-select-theme">
                            <option value="">--- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ---</option>
                        </select>
                    </div>

                    <div id="user-form-error"
                        class="hidden p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>

                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('userModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" id="submit-user-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-slate-800">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                    <button onclick="deleteAllNotifications()"
                        class="text-xs text-red-500 hover:text-red-700 font-medium bg-red-50 px-2 py-1 rounded-lg transition-colors">
                        ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
                <button onclick="closeModal('notificationModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>

            <div id="notification-list" class="max-h-[60vh] overflow-y-auto custom-scrollbar">
                <p class="text-center text-slate-400 p-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50/50 flex justify-end">
                <button type="button"
                    class="px-6 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium transition-colors"
                    onclick="closeModal('notificationModal')">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
    <div id="purchasingModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div
                class="bg-gradient-to-r from-blue-600 to-indigo-600 p-5 flex justify-between items-center text-white shadow-md">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                        <ion-icon name="cart" class="text-xl"></ion-icon>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
                        <p class="text-blue-100 text-xs font-light">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠</p>
                    </div>
                </div>
                <button onclick="closeModal('purchasingModal')"
                    class="hover:bg-white/10 p-2 rounded-full transition-colors"><ion-icon name="close"
                        class="text-2xl"></ion-icon></button>
            </div>
            <div class="p-6">
                <form id="purchasing-form" class="space-y-4">
                    <input type="hidden" id="pur-id">

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6 shadow-inner">
                        <div class="flex items-start gap-3">
                            <div class="mt-1 p-1.5 bg-yellow-100 text-yellow-600 rounded-md">
                                <ion-icon name="cube"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-semibold uppercase tracking-wider">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                                <p id="pur-product-display"
                                    class="font-bold text-slate-800 text-lg leading-tight mt-0.5">...</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-200 flex items-start gap-3">
                            <div class="mt-1 p-1.5 bg-green-100 text-green-600 rounded-md">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-semibold uppercase tracking-wider">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                                <p id="pur-customer-display" class="font-medium text-slate-700 mt-0.5">...</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <select id="pur-status" class="form-select-theme">
                            <option value="pending">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Pending)</option>
                            <option value="ordered">üöö ‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (Ordered)</option>
                            <option value="arrived">‚úÖ ‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß (Arrived)</option>
                            <option value="canceled">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Canceled)</option>
                        </select>
                    </div>

                    <!-- (*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á ***) -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á (Expected
                            Arrival)</label>
                        <input type="date" id="pur-arrival-date" class="form-input-theme">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏)</label>
                        <textarea id="pur-note" rows="3" class="form-input-theme"
                            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                    </div>

                    <div class="pt-4 flex justify-end gap-3">
                        <button type="button" onclick="closeModal('purchasingModal')"
                            class="px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit"
                            class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-600/30">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- (*** New: Deposit Detail Modal ***) -->
    <div id="depositDetailModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-sm bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div
                class="bg-gradient-to-r from-teal-500 to-emerald-600 p-4 flex justify-between items-center text-white shadow-md">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <ion-icon name="information-circle"></ion-icon> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                </h3>
                <button onclick="closeModal('depositDetailModal')"
                    class="hover:bg-white/10 p-1 rounded-full transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-6 space-y-4">

                <!-- Customer Context -->
                <div class="text-center border-b border-slate-100 pb-4 mb-2">
                    <p class="text-xs text-slate-400 font-semibold mb-1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                    <p id="detail-customer-name" class="font-bold text-slate-800 text-lg">...</p>
                </div>

                <!-- Purchasing Status -->
                <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div class="flex items-center gap-2 text-slate-600 font-medium">
                        <ion-icon name="cart" class="text-blue-500 text-lg"></ion-icon>
                        <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠</span>
                    </div>
                    <div id="detail-status-badge">...</div>
                </div>

                <!-- Expected Arrival -->
                <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div class="flex items-center gap-2 text-slate-600 font-medium">
                        <ion-icon name="calendar" class="text-orange-500 text-lg"></ion-icon>
                        <span>‡∏Ç‡∏≠‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</span>
                    </div>
                    <span id="detail-arrival-date" class="font-bold text-slate-800">...</span>
                </div>

                <!-- Close Button -->
                <div class="pt-2">
                    <button onclick="closeModal('depositDetailModal')"
                        class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl font-medium transition-colors">
                        ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Stock Request (Create) -->
    <div id="stockRequestModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                <button onclick="closeModal('stockRequestModal')" class="text-slate-400 hover:text-slate-600">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label for="stock-request-title" class="block text-sm font-bold text-slate-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏™ iPhone 15, ‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à)</label>
                    <input type="text" id="stock-request-title" class="form-input-theme w-full"
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å..." required>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-semibold text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label>
                    <button type="button" onclick="addStockRequestItemRow()"
                        class="text-sm font-bold text-yellow-600 bg-yellow-50 hover:bg-yellow-100 px-3 py-1.5 rounded-lg transition-all flex items-center gap-1">
                        <ion-icon name="add-circle"></ion-icon> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß
                    </button>
                </div>

                <div id="stock-request-items-container"
                    class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Dynamic rows added by JS -->
                </div>

                <div>
                    <label for="stock-request-note"
                        class="block text-sm font-semibold text-slate-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea id="stock-request-note" rows="3" class="form-input-theme"
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏µ, ‡∏Ç‡∏ô‡∏≤‡∏î, ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å..."></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-slate-50">
                    <button type="button" onclick="closeModal('stockRequestModal')"
                        class="px-6 py-2.5 rounded-xl text-slate-500 font-medium hover:bg-slate-50 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" onclick="submitStockRequest()"
                        class="px-8 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Manage Stock Request (Purchasing) -->
    <div id="manageRequestModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-lg bg-white rounded-[2.5rem] shadow-2xl overflow-hidden ring-1 ring-slate-200">
            <!-- Header -->
            <div
                class="bg-gradient-to-r from-slate-900 to-indigo-950 px-8 py-8 flex justify-between items-center text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 w-48 h-48 bg-indigo-500/10 rounded-full blur-3xl -mr-20 -mt-20">
                </div>
                <div class="relative z-10">
                    <h3 class="text-2xl font-black tracking-tight flex items-center gap-3">
                        <div class="p-2.5 bg-white/10 rounded-xl backdrop-blur-md">
                            <ion-icon name="build-outline" class="text-xl"></ion-icon>
                        </div>
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å
                    </h3>
                    <p class="text-indigo-200/70 text-sm font-medium mt-1">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏ß‡∏•‡∏™‡∏≤‡∏£</p>
                </div>
                <button onclick="closeModal('manageRequestModal')"
                    class="hover:bg-white/10 p-2.5 rounded-2xl transition-all text-indigo-300 hover:text-white relative z-10 active:scale-90">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>

            <!-- Body -->
            <div class="p-8 space-y-8 bg-slate-50/30">
                <!-- Items Summary Section -->
                <div id="manage-request-items-list">
                    <!-- Items will be injected here -->
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Status Selection -->
                    <div class="space-y-2">
                        <label for="manage-request-status"
                            class="block text-xs font-black text-slate-500 uppercase tracking-widest ml-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</label>
                        <div class="relative group">
                            <ion-icon name="swap-horizontal-outline"
                                class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                            <select id="manage-request-status"
                                class="w-full pl-11 pr-10 py-3.5 rounded-2xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none cursor-pointer hover:border-indigo-300 transition-all shadow-sm appearance-none">
                                <option value="pending">‚è≥ ‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á</option>
                                <option value="processing">üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á</option>
                                <option value="received">‚úÖ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
                                <option value="canceled">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                            </select>
                            <ion-icon name="chevron-down"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></ion-icon>
                        </div>
                    </div>

                    <!-- Arrival Date -->
                    <div class="space-y-2">
                        <label for="manage-request-arrival"
                            class="block text-xs font-black text-slate-500 uppercase tracking-widest ml-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á</label>
                        <div class="relative group">
                            <ion-icon name="calendar-clear-outline"
                                class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-hover:text-indigo-500 transition-colors z-10"></ion-icon>
                            <input type="date" id="manage-request-arrival"
                                class="w-full pl-11 pr-4 py-3.5 rounded-2xl border border-slate-200 bg-white text-sm font-bold text-slate-700 focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all shadow-sm">
                        </div>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('manageRequestModal')"
                        class="flex-1 py-4 rounded-2xl text-slate-500 font-bold hover:bg-slate-100 transition-all border border-transparent hover:border-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" onclick="updateRequestStatus()"
                        class="flex-[2] py-4 rounded-2xl bg-slate-900 hover:bg-indigo-950 text-white font-black shadow-xl shadow-slate-900/20 transition-all flex items-center justify-center gap-2 active:scale-[0.98]">
                        <ion-icon name="save-outline" class="text-xl"></ion-icon>
                        <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = '/api';
        let currentUser = null;
        let currentView = 'dashboard';
        let notificationPollInterval = null;
        let allDashboardTasks = [];
        let allMyTasks = [];

        // --- Helper Functions ---
        const getRoleName = (role) => {
            switch (role) {
                case 'executive': return '‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£';
                case 'manager': return '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£';
                case 'hr': return '‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (HR)';
                case 'staff': return '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
                default: return role;
            }
        };
        const getStatusTag = (status) => {
            const map = {
                'todo': { text: '‡∏£‡∏≠‡∏ó‡∏≥', bg: 'bg-slate-100', color: 'text-slate-600' },
                'in-progress': { text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥', bg: 'bg-yellow-100', color: 'text-yellow-700' },
                'for-review': { text: '‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', bg: 'bg-orange-100', color: 'text-orange-700' },
                'completed': { text: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', bg: 'bg-green-100', color: 'text-green-700' },
                'overdue': { text: '‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î', bg: 'bg-red-100', color: 'text-red-700' },
                // Import Statuses
                'pending': { text: '‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', bg: 'bg-yellow-50', color: 'text-yellow-700' },
                'importing': { text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', bg: 'bg-blue-50', color: 'text-blue-700' },
                'received': { text: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', bg: 'bg-green-50', color: 'text-green-700' },
                'rejected': { text: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', bg: 'bg-red-50', color: 'text-red-700' }
            };
            const s = map[status] || map['todo'];
            return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${s.bg} ${s.color}">${s.text}</span>`;
        };
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const safeHide = (el) => { if (el) el.classList.add('hidden'); };
        const safeShow = (el) => { if (el) el.classList.remove('hidden'); };

        const initializeAuth = () => {
            const token = localStorage.getItem('token');
            const userString = localStorage.getItem('user');

            if (!token || !userString) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userString);

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = getRoleName(currentUser.role);

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å (‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå)
            const userDept = (currentUser.department || '').trim();

            // Populate Branches
            populateBranchSelects();

            // =======================================================
            // 1. ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" (Sales / Storefront)
            // =======================================================
            const depositNav = document.getElementById('nav-Storefront_deposit');
            if (depositNav) {
                const isSalesTeam = userDept.includes('‡∏Ç‡∏≤‡∏¢') || userDept.includes('Sales');

                // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô: ‡∏ó‡∏µ‡∏°‡∏Ç‡∏≤‡∏¢, Admin, Executive, Manager, ‡∏´‡∏£‡∏∑‡∏≠ HR
                if (isSalesTeam || ['admin', 'executive', 'manager', 'hr'].includes(currentUser.role)) {
                    depositNav.style.display = 'flex';
                } else {
                    depositNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2. [‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" (Purchasing)
            // =======================================================
            const purchasingNav = document.getElementById('nav-purchasing');
            if (purchasingNav) {
                const isPurchasing = userDept.includes('‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠') || userDept.includes('Purchase');

                // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô: ‡∏ó‡∏µ‡∏°‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠, Admin, Executive, ‡∏´‡∏£‡∏∑‡∏≠ Manager
                // (HR ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏Å‡πá‡πÄ‡∏ï‡∏¥‡∏° 'hr' ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô array ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö)
                if (isPurchasing || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    purchasingNav.style.display = 'flex';
                } else {
                    purchasingNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2.1 [‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤" (Import Notification)
            // =======================================================
            const importNav = document.getElementById('nav-import');
            if (importNav) {
                const isSales = userDept.includes('‡∏Ç‡∏≤‡∏¢') || userDept.includes('Sales');
                // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô: ‡∏ó‡∏µ‡∏°‡∏Ç‡∏≤‡∏¢ (Sales), Admin, Executive, Manager
                if (isSales || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    importNav.classList.remove('hidden');
                    importNav.style.display = 'flex';
                } else {
                    importNav.classList.add('hidden');
                    importNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2.2 [‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤" (Stock Import)
            // =======================================================
            const stockImportNav = document.getElementById('nav-stock-import');
            if (stockImportNav) {
                const isStockTeam = userDept.includes('Store') || userDept.includes('Stock') || userDept.includes('‡∏™‡∏ï‡πä‡∏≠‡∏Å');
                if (isStockTeam || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    stockImportNav.classList.remove('hidden');
                    stockImportNav.style.display = 'flex';
                } else {
                    stockImportNav.classList.add('hidden');
                    stockImportNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2.3 [‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" ‡πÅ‡∏•‡∏∞ "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å"
            // =======================================================
            const stockRequestNav = document.getElementById('nav-stock-request');
            const stockRequestManageNav = document.getElementById('nav-stock-request-manage');

            if (stockRequestNav) {
                const isSales = userDept.includes('‡∏Ç‡∏≤‡∏¢') || userDept.includes('Sales');
                if (isSales || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    stockRequestNav.style.display = 'flex';
                } else {
                    stockRequestNav.style.display = 'none';
                }
            }

            if (stockRequestManageNav) {
                const isPurchasing = userDept.includes('‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠') || userDept.includes('Purchase');
                if (isPurchasing || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    stockRequestManageNav.style.display = 'flex';
                    stockRequestManageNav.classList.remove('hidden');
                } else {
                    stockRequestManageNav.style.display = 'none';
                    stockRequestManageNav.classList.add('hidden');
                }
            }

            // =======================================================
            // 2.4 [‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏°‡∏ô‡∏π "‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤" ‡πÅ‡∏•‡∏∞ "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤"
            // =======================================================
            const branchOrderNav = document.getElementById('nav-branch-order');
            const branchOrderInvNav = document.getElementById('nav-branch-order-inventory');

            if (branchOrderNav && branchOrderInvNav) {
                const isPurchasing = userDept.includes('‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠') || userDept.includes('Purchase');
                const isSales = userDept.includes('‡∏Ç‡∏≤‡∏¢') || userDept.includes('Sales');

                // Logic for "‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤" (Management/Purchasing/HR)
                const canManageOrders = isPurchasing || ['admin', 'executive', 'manager', 'hr'].includes(currentUser.role);
                // Logic for "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤" (Sales/Management/HR)
                const canViewInventory = isSales || ['executive', 'manager', 'hr', 'admin'].includes(currentUser.role);

                if (canManageOrders) {
                    branchOrderNav.style.display = 'flex';
                    branchOrderNav.classList.remove('hidden');
                } else {
                    branchOrderNav.style.display = 'none';
                    branchOrderNav.classList.add('hidden');
                }

                if (canViewInventory) {
                    branchOrderInvNav.style.display = 'flex';
                    branchOrderInvNav.classList.remove('hidden');
                } else {
                    branchOrderInvNav.style.display = 'none';
                    branchOrderInvNav.classList.add('hidden');
                }
            }

            // =======================================================
            // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Role Logic)
            // =======================================================
            if (currentUser.role === 'staff') {
                // --- ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Staff) ---
                safeHide(document.getElementById('nav-dashboard'));
                safeHide(document.getElementById('nav-admin'));

                if (document.getElementById('company-select')) {
                    document.getElementById('company-select').parentElement.style.display = 'none';
                }

                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Header
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = '‡∏ú‡∏π‡πâ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';

                // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ "‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                updateNavActiveState('mytasks');
                fetchMyTasks();

            } else if (currentUser.role === 'executive') {
                // --- ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive) ---
                safeHide(document.getElementById('nav-mytasks'));

                // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                updateNavActiveState('dashboard');
                fetchDashboardTasks();
                fetchTaskStats();
                fetchAllUsers();

            } else if (currentUser.role === 'manager' || currentUser.role === 'hr') {
                // --- ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Manager) ‡πÅ‡∏•‡∏∞ HR ---
                // (‡πÅ‡∏™‡∏î‡∏á Dashboard ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π My Tasks ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ã‡πà‡∏≠‡∏ô)

                updateNavActiveState('dashboard');
                fetchDashboardTasks();
                fetchTaskStats();
                fetchAllUsers();
            }

            // =======================================================
            // 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Logout / Notifications)
            // =======================================================
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                clearInterval(notificationPollInterval);
                window.location.href = 'login.html';
            });

            fetchNotifications();
            notificationPollInterval = setInterval(fetchNotifications, 60000);
        };

        // ------------------------------------------
        // --- (A) TASK FUNCTIONS ---
        // ------------------------------------------
        const fetchTaskStats = async () => {
            const token = localStorage.getItem('token');
            const selectedCompanyId = document.getElementById('company-select').value;
            const statsDiv = document.getElementById('stats-cards');
            statsDiv.innerHTML = `<div class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</div>`;
            try {
                const response = await fetch(`${SERVER_URL}/tasks/stats?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { statsDiv.innerHTML = `<div class="text-sm text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`; return; }
                const stats = await response.json();

                statsDiv.innerHTML = `
                    <div onclick="filterTasksByStatus('todo')" data-status="todo" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-gray-100 text-gray-600"><ion-icon name="clipboard-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</p><p class="text-2xl font-bold text-gray-900">${stats.todo || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('in-progress')" data-status="in-progress" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-yellow-100 text-yellow-600"><ion-icon name="ellipsis-horizontal-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p><p class="text-2xl font-bold text-gray-900">${stats.inProgress || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('for-review')" data-status="for-review" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-amber-100 text-amber-600"><ion-icon name="search-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">‡∏™‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p><p class="text-2xl font-bold text-gray-900">${stats.forReview || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('completed')" data-status="completed" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-green-100 text-green-600"><ion-icon name="checkmark-done-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p><p class="text-2xl font-bold text-gray-900">${stats.completed || 0}</p></div></div>
                    </div>
                `;
            } catch (error) {
                console.error('Fetch Stats Error:', error);
                statsDiv.innerHTML = `<div class="text-sm text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>`;
            }
        };

        const fetchAllUsers = async () => {
            const token = localStorage.getItem('token');
            const selectElement = document.getElementById('taskAssignTo');
            const selectedCompanyId = document.getElementById('company-select').value;
            selectElement.innerHTML = '<option value="" disabled selected>--- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... ---</option>';
            selectElement.disabled = true;
            try {
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                if (!response.ok) { selectElement.innerHTML = '<option value="" disabled selected>--- ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ---</option>'; return; }
                const users = await response.json();
                selectElement.innerHTML = '';
                selectElement.disabled = false;
                selectElement.prepend(new Option('--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ---', '', true, true));
                if (selectElement.tomselect) {
                    selectElement.tomselect.destroy();
                }
                users.forEach(user => {
                    if (user && user._id) {
                        const option = document.createElement('option');
                        option.value = user._id;
                        option.textContent = `${user.name} (${user.branch || user.department})`;
                        selectElement.appendChild(option);
                    }
                });
            } catch (error) {
                selectElement.innerHTML = '<option value="" disabled selected>--- ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Server Down?) ---</option>';
            }
        };

        const fetchDashboardTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = '';
            const selectedCompanyId = document.getElementById('company-select').value;
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=dashboard&companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();

                allDashboardTasks = tasks;      // ‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á Cache
                renderTaskTable(tasks);         // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏õ‡∏Å‡∏ï‡∏¥)
                filterTasksByStatus('todo');

            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };

        const fetchMyTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = '';
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=mytasks`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();
                allMyTasks = tasks;     // 1. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏•‡∏≤‡∏á
                updateMyTaskCounts();   // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°
                filterMyTasks('todo'); // 3. Default ‡πÅ‡∏™‡∏î‡∏á Todo
            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };

        const renderTaskTable = (tasks) => {
            const taskTableBody = document.getElementById('task-table-body');

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ element ‡∏ô‡∏µ‡πâ)
            const countElement = document.getElementById('task-count');
            if (countElement) countElement.textContent = `${tasks.length} ‡∏á‡∏≤‡∏ô`;

            // 1. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô
            if (tasks.length === 0) {
                taskTableBody.innerHTML = `<tr id="no-task-row" class="text-center"><td colspan="5" class="px-6 py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</td></tr>`;
                return;
            }

            taskTableBody.innerHTML = '';

            // 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô
            tasks.forEach((task, index) => {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'completed';
                const statusDisplay = isOverdue ? getStatusTag('overdue') : getStatusTag(task.status);

                // --- LOGIC ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö VS ‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô) ---
                let personName = 'Unknown User';
                let personSubText = '-';
                let personImageChar = '?';
                let showBranchBadge = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå Badge ‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏´‡∏°

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentView ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)
                const isMyTasksView = (typeof currentView !== 'undefined' && currentView === 'mytasks');

                if (isMyTasksView) {
                    // >> ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô: ‡πÅ‡∏™‡∏î‡∏á "‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô" (Created By)
                    if (task.createdBy) {
                        personName = task.createdBy.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
                        personSubText = '‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô'; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        personImageChar = personName.charAt(0);
                    } else {
                        personName = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        personSubText = '‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô';
                    }
                    // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå Badge ‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πá‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ)
                    showBranchBadge = false;

                } else {
                    // >> ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô (Dashboard): ‡πÅ‡∏™‡∏î‡∏á "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" (Assigned To)
                    if (task.assignedTo) {
                        personName = task.assignedTo.name || 'Unknown User';
                        // ‡∏î‡∏∂‡∏á‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏Å)
                        personSubText = task.assignedTo.branch || task.assignedTo.department || 'N/A';
                        personImageChar = personName.charAt(0);
                    }
                    // ‡πÅ‡∏™‡∏î‡∏á Badge ‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤
                    showBranchBadge = true;
                }

                // --- LOGIC ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ Badge ---
                let nameDisplayHtml = personName;

                // ‡∏ñ‡πâ‡∏≤ Logic ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå Badge ‡πÅ‡∏•‡∏∞ Task ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Branch
                if (showBranchBadge && task.branch) {
                    nameDisplayHtml += ` <span class="ml-2 px-2 py-0.5 text-xs rounded bg-indigo-100 text-indigo-800 border border-indigo-200">‡∏™‡∏≤‡∏Ç‡∏≤${task.branch}</span>`;
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition-colors duration-150';
                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ú‡∏•‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏µ event ‡πÅ‡∏¢‡∏Å)
                row.onclick = (e) => {
                    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏ã‡πâ‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (Optional)
                    if (!e.target.closest('button')) openDetailModal(task._id);
                };

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="ml-0">
                                <div class="text-sm font-medium text-gray-900">
                                    <span class="font-bold text-yellow-600 mr-2">${index + 1}.</span>${task.title}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <img class="h-8 w-8 rounded-full object-cover shadow-sm" 
                                 src="https://placehold.co/100x100/e0e7ff/4f46e5?text=${encodeURIComponent(personImageChar)}" 
                                 alt="">
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900 flex items-center">
                                    ${nameDisplayHtml}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? 'text-red-500 font-bold' : 'text-gray-500'}">
                        ${formatDate(task.dueDate)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-amber-600 hover:text-amber-800 bg-amber-50 hover:bg-amber-100 px-3 py-1 rounded-md transition-colors" onclick="openDetailModal('${task._id}')">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                        </button>
                    </td>
                `;
                taskTableBody.appendChild(row);
            });
        };

        const filterTasksByStatus = (status) => {
            // 1. ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const statCards = document.querySelectorAll('#stats-cards [data-status]');
            statCards.forEach(card => {
                if (card.getAttribute('data-status') === status) {
                    card.classList.add('ring-2', 'ring-amber-500', 'shadow-lg');
                } else {
                    card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
                }
            });

            // 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Cache
            const filteredTasks = allDashboardTasks.filter(task => task.status === status);

            // 3. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            renderTaskTable(filteredTasks);
        };

        const clearTaskFilterHighlights = () => {
            const statCards = document.querySelectorAll('#stats-cards [data-status]');
            statCards.forEach(card => {
                card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
            });
        };

        const handleNewTaskSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const submitButton = document.getElementById('submit-task-btn');
            const errorBox = document.getElementById('new-task-error');
            if (!data.assignedTo || data.assignedTo === "") {
                errorBox.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏á‡∏≤‡∏ô'; safeShow(errorBox); return;
            }
            const postData = { ...data, companyId: document.getElementById('company-select').value, dueDate: data.dueDate ? new Date(data.dueDate).toISOString() : null };
            submitButton.disabled = true; submitButton.querySelector('#submit-task-text').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...'; safeShow(submitButton.querySelector('#submit-task-spinner'));
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(postData)
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('newTaskModal'); form.reset(); fetchDashboardTasks(); fetchTaskStats();
                fetchNotifications();
            } catch (error) {
                errorBox.textContent = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.querySelector('#submit-task-text').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô'; safeHide(submitButton.querySelector('#submit-task-spinner'));
            }
        };

        const openDetailModal = async (taskId) => {
            openModal('taskDetailModal');
            const token = localStorage.getItem('token');
            const errorBox = document.getElementById('update-task-error');
            const deleteTaskBtn = document.getElementById('delete-task-btn');
            safeHide(errorBox);
            document.getElementById('detail-task-title').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
            document.getElementById('detail-task-desc').textContent = "...";
            document.getElementById('detail-task-creator').textContent = "...";
            document.getElementById('detail-task-dueDate').textContent = "...";
            document.getElementById('detail-task-comment').value = '';
            document.getElementById('save-task-details-btn').disabled = true;

            const handleDeleteTask = async () => {
                const taskTitle = document.getElementById('detail-task-title').textContent;
                const confirmMsg = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-delete-button');
                confirmMsg.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô: "${taskTitle}"? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`;
                confirmBtn.setAttribute('data-task-id', taskId);
                document.getElementById('confirm-error-message').textContent = '';
                openModal('confirmModal');
            };

            deleteTaskBtn.replaceWith(deleteTaskBtn.cloneNode(true));
            document.getElementById('delete-task-btn').addEventListener('click', handleDeleteTask);

            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                const task = await response.json();
                document.getElementById('detail-task-id').value = task._id;
                document.getElementById('detail-task-title').textContent = task.title;
                document.getElementById('detail-task-desc').textContent = task.description || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)';
                document.getElementById('detail-task-status').value = task.status;
                document.getElementById('detail-task-creator').textContent = task.createdBy ? task.createdBy.name : 'N/A';
                document.getElementById('detail-task-dueDate').textContent = formatDate(task.dueDate);
                const commentsList = document.getElementById('detail-task-comments-list');
                commentsList.innerHTML = '';
                if (task.comments && task.comments.length > 0) {
                    task.comments.slice().reverse().forEach(comment => {
                        const commentEl = document.createElement('div');
                        commentEl.className = 'text-sm pb-2 mb-2 border-b border-gray-200';
                        commentEl.innerHTML = `<p class="text-gray-800">${comment.text}</p><p class="text-xs text-gray-500">‡πÇ‡∏î‡∏¢: ${comment.name} - ${new Date(comment.timestamp).toLocaleString('th-TH')}</p>`;
                        commentsList.appendChild(commentEl);
                    });
                } else {
                    commentsList.innerHTML = '<p class="text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</p>';
                }
                const userRole = currentUser.role;
                if (userRole === 'executive' || userRole === 'manager' || userRole === 'hr') {
                    document.getElementById('delete-task-btn').style.display = 'inline-flex';
                } else {
                    document.getElementById('delete-task-btn').style.display = 'none';
                }
            } catch (error) {
                console.error('Open Detail Modal Error:', error);
                errorBox.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ (Error: ' + error.message + ')';
                safeShow(errorBox);
            } finally {
                document.getElementById('save-task-details-btn').disabled = false;
            }
        };

        const handleUpdateTaskSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const status = document.getElementById('detail-task-status').value;
            const taskId = document.getElementById('detail-task-id').value;
            const commentText = document.getElementById('detail-task-comment').value;
            const errorBox = document.getElementById('update-task-error');
            const submitButton = document.getElementById('save-task-details-btn');
            submitButton.disabled = true; submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status, commentText: commentText })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
                fetchNotifications();
            } catch (error) {
                errorBox.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
            }
        };

        const executeDelete = async () => {
            const token = localStorage.getItem('token');
            const deleteButton = document.getElementById('confirm-delete-button');
            const errorMsg = document.getElementById('confirm-error-message');
            const taskId = deleteButton.getAttribute('data-task-id');
            if (!taskId) { errorMsg.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏á‡∏≤‡∏ô'; return; }
            deleteButton.disabled = true; deleteButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...'; errorMsg.textContent = '';
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('confirmModal'); closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
            } catch (error) {
                errorMsg.textContent = `‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`;
            } finally {
                deleteButton.disabled = false; deleteButton.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
            }
        };

        // ------------------------------------------
        // --- (B) USER FUNCTIONS ---
        // ------------------------------------------
        const fetchAllUsersForTable = async () => {
            safeShow(document.getElementById('loading-users'));
            const token = localStorage.getItem('token');
            const userTableBody = document.getElementById('user-table-body');
            userTableBody.innerHTML = '';
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                safeHide(document.getElementById('loading-users'));
                if (!response.ok) { throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'); }
                const users = await response.json();
                document.getElementById('user-count').textContent = `${users.length} ‡∏Ñ‡∏ô`;
                if (users.length === 0) {
                    userTableBody.innerHTML = `<tr id="no-user-row" class="text-center"><td colspan="6" class="px-6 py-4 text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50';
                    row.setAttribute('data-name', (user.name || '').toLowerCase());
                    row.setAttribute('data-username', (user.username || '').toLowerCase());
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${user.name}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.username}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${getRoleName(user.role)}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.branch || user.department}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.reportsTo ? user.reportsTo.name : '-'}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-amber-600 hover:text-amber-800" onclick="openEditUserModal('${user._id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="text-red-600 hover:text-red-900 ml-4" onclick="executeDeleteUser('${user._id}', '${user.name}')">‡∏•‡∏ö</button>
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });
            } catch (error) {
                safeHide(document.getElementById('loading-users'));
                userTableBody.innerHTML = `<tr class="text-center"><td colspan="6" class="px-6 py-4 text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</td></tr>`;
            }
        };

        // ------------------------------------------
        // --- (C) NOTIFICATION FUNCTIONS ---
        // ------------------------------------------
        const filterUsersByName = (query) => {
            const rows = document.querySelectorAll('#user-table-body tr:not(#no-user-row)');
            const lowerQuery = query.toLowerCase();

            rows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const username = row.getAttribute('data-username') || '';

                if (name.includes(lowerQuery) || username.includes(lowerQuery)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        // Add listener for search input
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('user-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterUsersByName(e.target.value);
                });
            }
        });

        const fetchNotifications = async () => {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server
                const response = await fetch(`${SERVER_URL}/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();

                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Array ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Object)
                const notifications = Array.isArray(data) ? data : (data.notifications || []);

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô
                const unreadCount = typeof data.unreadCount === 'number'
                    ? data.unreadCount
                    : notifications.filter(n => !n.isRead).length;

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á (Red Dot) ---

                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏à‡∏∏‡∏î (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á Desktop ‡πÅ‡∏•‡∏∞ Mobile)
                const toggleDot = (elementId, show) => {
                    const el = document.getElementById(elementId);
                    if (el) {
                        if (show) el.classList.remove('hidden');
                        else el.classList.add('hidden');
                    }
                };

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á 2 ‡∏à‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                const hasUnread = unreadCount > 0;
                toggleDot('notification-dot', hasUnread);          // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Desktop
                toggleDot('notification-dot-mobile', hasUnread);   // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mobile (‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô Dropdown ---
                const listContainer = document.getElementById('notification-list');
                if (listContainer) {
                    listContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤

                    if (notifications.length === 0) {
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                        listContainer.innerHTML = `
                            <div class="px-4 py-6 text-sm text-gray-500 text-center flex flex-col items-center">
                                <ion-icon name="notifications-off-outline" class="text-2xl mb-2 text-gray-300"></ion-icon>
                                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
                            </div>`;
                    } else {
                        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        notifications.forEach(notif => {
                            const item = document.createElement('div');
                            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô (bg-blue-50)
                            item.className = `px-4 py-3 border-b hover:bg-gray-50 transition-colors cursor-pointer ${!notif.isRead ? 'bg-blue-50' : ''}`;

                            // ‡πÉ‡∏™‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ HTML
                            item.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">${notif.title || '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'}</p>
                                        <p class="text-xs text-gray-500 mt-1">${notif.message || '-'}</p>
                                        <p class="text-[10px] text-gray-400 mt-2">
                                            ${new Date(notif.createdAt).toLocaleString('th-TH')}
                                        </p>
                                    </div>
                                    ${!notif.isRead ? '<span class="h-2 w-2 bg-blue-600 rounded-full mt-1 flex-shrink-0"></span>' : ''}
                                </div>
                            `;

                            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event ‡∏Ñ‡∏•‡∏¥‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
                            item.onclick = () => {
                                // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏™‡πà Logic ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô markAsRead(notif._id)
                                console.log('Clicked notification:', notif._id);
                            };

                            listContainer.appendChild(item);
                        });
                    }
                }

            } catch (error) {
                console.warn('Could not fetch notifications:', error.message);
            }
        };

        const updateNotificationUI = (notifications, unreadCount) => {
            const dot = document.getElementById('notification-dot');
            const list = document.getElementById('notification-list');

            if (unreadCount > 0) {
                safeShow(dot);
            } else {
                safeHide(dot);
            }

            if (notifications && notifications.length > 0) {
                list.innerHTML = '';
                notifications.forEach(noti => {
                    const taskTitle = noti.task ? noti.task.title : '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
                    const taskAction = noti.task ? `onclick="openDetailModal('${noti.task._id}'); closeModal('notificationModal');"` : '';

                    const item = document.createElement('div');
                    item.className = `flex justify-between items-start p-3 border-b hover:bg-gray-50 cursor-pointer ${noti.isRead ? 'bg-white' : 'bg-blue-50'}`;

                    item.innerHTML = `
                        <div ${taskAction} class="flex-1">
                            <p class="text-sm text-gray-800 font-medium">${noti.message}</p>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<p class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>';
            }
        };

        const markNotificationsAsRead = async () => {
            const token = localStorage.getItem('token');
            const dot = document.getElementById('notification-dot');
            safeHide(dot);

            try {
                await fetch(`${SERVER_URL}/notifications/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.warn('Could not mark notifications as read:', error.message);
            }
        };

        // ------------------------------------------
        const deleteNotification = async (id) => {
            const token = localStorage.getItem('token');
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            try {
                const response = await fetch(`${SERVER_URL}/notifications/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    fetchNotifications();
                } else {
                    alert('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
            } catch (error) {
                console.error('Delete Notification Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
            }
        };

        const deleteAllNotifications = async () => {
            const token = localStorage.getItem('token');
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            try {
                const response = await fetch(`${SERVER_URL}/notifications`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    fetchNotifications();
                } else {
                    alert('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
            } catch (error) {
                console.error('Delete All Notifications Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
            }
        };

        // --- (D) DEPOSIT FUNCTIONS ---
        // ------------------------------------------
        // ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html
        function getOrderStatusBadge(status) {
            status = status || 'pending';
            switch (status) {
                case 'ordered':
                    return `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold border border-blue-200 whitespace-nowrap">‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`;
                case 'arrived':
                    return `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold border border-green-200 whitespace-nowrap">‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`;
                case 'canceled':
                    return `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold border border-red-200 whitespace-nowrap">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>`;
                default:
                    return `<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-[10px] font-bold border border-yellow-200 whitespace-nowrap">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
            }
        }

        async function fetchDeposits() {
            try {
                const token = localStorage.getItem('token');
                const selectedCompanyId = document.getElementById('company-select').value;

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Header Title) ---
                // ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô" ‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥ - ‡∏™‡∏≤‡∏Ç‡∏≤..."
                const titleElem = document.getElementById('deposit-header-title');
                const filterBranchElem = document.getElementById('deposit-filter-branch');

                if (titleElem) {
                    if (typeof currentUser !== 'undefined' && currentUser && currentUser.role === 'staff') {
                        // ‡∏Å‡∏£‡∏ì‡∏µ Staff: ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏á Staff ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏™‡∏°‡∏≠
                        const branchName = currentUser.branch || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á/null/undefined ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' ‡πÅ‡∏ó‡∏ô
                        titleElem.textContent = `‡∏™‡∏≤‡∏Ç‡∏≤ ${branchName}`;
                    } else {
                        // ‡∏Å‡∏£‡∏ì‡∏µ Admin/Manager: ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Dropdown
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Text) ‡∏Ç‡∏≠‡∏á option ‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
                        let branchName = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                        if (filterBranchElem && filterBranchElem.value !== 'all' && filterBranchElem.selectedIndex > -1) {
                            branchName = filterBranchElem.options[filterBranchElem.selectedIndex].text;
                        }
                        titleElem.textContent = `‡∏™‡∏≤‡∏Ç‡∏≤ ${branchName}`;
                    }
                }

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° URL ‡πÅ‡∏•‡∏∞ Parameter ---
                let url = `${SERVER_URL}/deposits?companyId=${selectedCompanyId}`;

                // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Dropdown ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà API
                if (filterBranchElem) {
                    const branchVal = filterBranchElem.value;
                    if (branchVal && branchVal !== 'all') {
                        url += `&branch=${encodeURIComponent(branchVal)}`;
                    }
                }

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server ---
                // console.log('Fetching URL:', url); 
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                let deposits = await res.json();

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3.5: Client-Side Filters (Status, Date, Search) ---
                const statusFilterElem = document.getElementById('deposit-filter-status');
                const dateFilterElem = document.getElementById('deposit-filter-date');
                const searchInputElem = document.getElementById('deposit-search-input');
                const bellBtn = document.getElementById('btn-filter-due-today');
                const badgeElem = document.getElementById('deposit-due-badge');

                // (*** New: Calculate Due Count for Badge ***)
                const todayStr = new Date().toISOString().split('T')[0];
                const dueItems = deposits.filter(d => {
                    if (d.isSuccess) return false; // ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
                    if (!d.pickupDueDate) return false;

                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
                    const dueStr = new Date(d.pickupDueDate).toISOString().split('T')[0];
                    // ‡∏ô‡∏±‡∏ö‡∏ñ‡πâ‡∏≤ "‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö <= ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" (‡∏Ñ‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏¢‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß)
                    return dueStr <= todayStr;
                });

                if (badgeElem && bellBtn) {
                    const count = dueItems.length;
                    badgeElem.textContent = count;
                    if (count > 0) {
                        badgeElem.classList.remove('hidden');
                        bellBtn.classList.add('text-red-500', 'bg-red-50', 'border-red-200');
                        bellBtn.classList.remove('text-slate-400', 'bg-white', 'border-slate-200');
                    } else {
                        badgeElem.classList.add('hidden');
                        bellBtn.classList.remove('text-red-500', 'bg-red-50', 'border-red-200');
                        bellBtn.classList.add('text-slate-400', 'bg-white', 'border-slate-200');
                    }
                }

                // 0. Filter by "Due Today + Overdue" (Bell Button)
                if (bellBtn && bellBtn.classList.contains('active-bell')) {
                    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Due Items ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô
                    deposits = dueItems;
                }
                // If Bell is NOT active, use normal Date Picker Logic
                else if (dateFilterElem && dateFilterElem.value) {
                    const filterDate = dateFilterElem.value; // YYYY-MM-DD
                    deposits = deposits.filter(d => {
                        return d.depositDate && d.depositDate.startsWith(filterDate);
                    });
                }

                // 1. Filter by Status
                if (statusFilterElem) {
                    const statusVal = statusFilterElem.value;
                    if (statusVal === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
                        deposits = deposits.filter(d => !d.isSuccess);
                    } else if (statusVal === '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') {
                        deposits = deposits.filter(d => d.isSuccess);
                    }
                }

                // 2. (Depreacted Logic: Date logic moved above to handle priority)

                // 3. Filter by Search (Name/Phone)
                if (searchInputElem && searchInputElem.value) {
                    const searchText = searchInputElem.value.toLowerCase().trim();
                    deposits = deposits.filter(d => {
                        const name = (d.customerName || '').toLowerCase();
                        const phone = (d.phoneNumber || '').toLowerCase();
                        return name.includes(searchText) || phone.includes(searchText);
                    });
                }

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
                const tbody = document.getElementById('deposit-table-body');
                tbody.innerHTML = '';

                if (deposits.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ</td></tr>`;
                    return;
                }

                deposits.forEach(d => {
                    const price = d.price || 0;
                    const deposit = d.depositAmount || 0;
                    const balance = price > 0 ? (price - deposit) : 0;

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-yellow-50 transition-colors cursor-pointer border-b";
                    tr.onclick = () => openDepositModal(d);

                    tr.innerHTML = `
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.depositDate)}</td>
                        <td class="font-medium border p-2 text-gray-800">${d.customerName}</td>
                        <td class="text-center border p-2 text-gray-600">${d.phoneNumber}</td>
                        <td class="text-right border p-2 font-bold text-red-600 bg-red-50">${deposit.toLocaleString()}</td>
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.pickupDueDate)}</td>
                                
                        <td class="text-center border p-2 text-xs">${d.billNo || '-'}</td>
                        <td class="text-center border p-2 text-xs font-mono text-gray-500">${d.imei || '-'}</td>
                        <td class="text-xs border p-2">${d.product || '-'}</td>
                        <td class="text-right border p-2 bg-red-50 text-xs">${price ? price.toLocaleString() : '-'}</td>
                        <td class="text-right border p-2 font-bold bg-blue-50 text-blue-800">${price ? balance.toLocaleString() : '-'}</td>
                        
                        <td class="text-center border p-2">
                            ${d.isSuccess
                            ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded-md text-xs font-bold border border-green-200 inline-block w-24">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>'
                            : '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-md text-xs font-bold border border-yellow-200 inline-block w-24">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>'}
                        </td>
                        <td class="text-center border p-2 text-xs text-gray-500">${d.signName || ''}</td>
                        <td class="text-center border p-2 text-xs">
                           <button onclick="event.stopPropagation(); openDepositDetailModal({ 
                               customerName: '${d.customerName}', 
                               orderStatus: '${d.orderStatus}', 
                               expectedArrivalDate: '${d.expectedArrivalDate || ''}' 
                           })" class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded-md transition-colors text-xs font-bold">
                               ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                           </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error("Error fetching deposits:", e);
                // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Error ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                const tbody = document.getElementById('deposit-table-body');
                if (tbody) tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
            }
        }

        let productTomSelect = null;

        async function fetchProducts() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${SERVER_URL}/deposits/products`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) return [];
                return await res.json();
            } catch (e) {
                console.error("Error fetching products:", e);
                return [];
            }
        }

        // Global variables for purchasing view
        let allPurchasingOrders = [];
        let currentStatusFilter = 'all';
        let currentSearchText = '';

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Fetch & Store)
        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Fetch & Store)
        async function fetchPurchasingOrders(initialStatus = null) {
            const token = localStorage.getItem('token');
            const container = document.getElementById('purchasing-list-container');
            const emptyState = document.getElementById('purchasing-empty-state');
            const branchFilter = document.getElementById('purchasing-filter-branch').value;
            const companyId = document.getElementById('company-select').value;

            // Loading State
            container.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-16">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mb-4"></div>
                    <p class="text-slate-400 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...</p>
                </div>
            `;
            emptyState.classList.add('hidden');

            try {
                let url = `${SERVER_URL}/deposits?companyId=${companyId}&viewMode=purchasing`;
                if (branchFilter && branchFilter !== 'all') {
                    url += `&branch=${encodeURIComponent(branchFilter)}`;
                }

                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to fetch');

                const deposits = await res.json();
                allPurchasingOrders = deposits; // Store data

                // Set Filter Logic
                if (initialStatus) {
                    currentStatusFilter = initialStatus;
                    // Trigger UI update for the filter buttons
                    // Note: filterPurchasingByStatus sets currentStatusFilter and calls renderPurchasingOrders
                    filterPurchasingByStatus(initialStatus);
                } else {
                    // Reset filters if no initialStatus provided
                    currentStatusFilter = 'all';
                    currentSearchText = '';
                    document.getElementById('purchasing-search-input').value = '';
                    clearPurchasingFilterUI();
                    renderPurchasingOrders();
                }

                updatePurchasingStats(deposits);

            } catch (e) {
                console.error(e);
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 bg-red-50 rounded-2xl border border-red-100">
                        <ion-icon name="alert-circle" class="text-4xl text-red-400 mb-2"></ion-icon>
                        <p class="text-red-700 font-semibold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        <button onclick="fetchPurchasingOrders()" class="mt-4 text-sm bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg hover:bg-red-50">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                `;
            }
        }

        function renderPurchasingOrders() {
            const container = document.getElementById('purchasing-list-container');
            const emptyState = document.getElementById('purchasing-empty-state');
            const searchText = currentSearchText.toLowerCase();

            container.innerHTML = '';

            // Filter Data
            const filtered = allPurchasingOrders.filter(d => {
                // Status Filter
                if (currentStatusFilter !== 'all') {
                    if (currentStatusFilter === 'overdue') {
                        // (*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: Logic ‡∏Å‡∏£‡∏≠‡∏á Overdue ***)
                        if ((d.orderStatus || 'pending') !== 'ordered') return false;
                        if (!d.expectedArrivalDate) return false;

                        const arrivalDate = new Date(d.expectedArrivalDate);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (arrivalDate >= today) return false;

                    } else {
                        if ((d.orderStatus || 'pending') !== currentStatusFilter) return false;
                    }
                }

                // Search Filter
                if (searchText) {
                    const searchMatch = (d.customerName || '').toLowerCase().includes(searchText) ||
                        (d.phoneNumber || '').toLowerCase().includes(searchText) ||
                        (d.product || '').toLowerCase().includes(searchText) ||
                        (d.branch || '').toLowerCase().includes(searchText);
                    if (!searchMatch) return false;
                }
                return true;
            });

            filtered.forEach(d => {
                // Status Logic
                let statusConfig = { text: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', color: 'bg-yellow-100 text-yellow-700 border-yellow-200', icon: 'time' };
                const status = d.orderStatus || 'pending';

                if (status === 'ordered') statusConfig = { text: '‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', color: 'bg-blue-100 text-blue-700 border-blue-200', icon: 'cart' };
                else if (status === 'arrived') statusConfig = { text: '‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß', color: 'bg-green-100 text-green-700 border-green-200', icon: 'checkmark-circle' };
                else if (status === 'canceled') statusConfig = { text: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', color: 'bg-red-100 text-red-700 border-red-200', icon: 'close-circle' };

                const dataString = JSON.stringify(d).replace(/'/g, "&#39;");

                // (*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: Logic ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Overdue ***)
                let arrivalDateDisplay = '';
                let overdueClass = '';
                let overdueBadge = '';

                if (d.expectedArrivalDate && d.orderStatus === 'ordered') {
                    const arrivalDate = new Date(d.expectedArrivalDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏Ñ‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà

                    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô String ‡∏™‡∏±‡πâ‡∏ô‡πÜ
                    const dateStr = arrivalDate.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    arrivalDateDisplay = `<p class="text-xs text-slate-500 mt-1">‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏∂‡∏á: <span class="font-medium text-slate-700">${dateStr}</span></p>`;

                    if (arrivalDate < today) {
                        overdueClass = 'ring-2 ring-red-500 bg-red-50'; // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î
                        overdueBadge = `<span class="absolute top-2 right-2 px-2 py-0.5 bg-red-600 text-white text-[10px] font-bold rounded-full shadow-md animate-pulse">! ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>`;
                    }
                } else if (d.expectedArrivalDate) {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏â‡∏¢‡πÜ ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô
                    const dateStr = new Date(d.expectedArrivalDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    arrivalDateDisplay = `<p class="text-xs text-slate-400 mt-1">‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏∂‡∏á: ${dateStr}</p>`;
                }

                const card = document.createElement('div');
                card.className = `bg-white rounded-2xl p-5 shadow-sm border border-slate-100 hover:shadow-md transition-shadow group relative overflow-hidden ${overdueClass}`;

                const statusColorMap = {
                    'pending': 'bg-yellow-400',
                    'ordered': 'bg-blue-500',
                    'arrived': 'bg-green-500',
                    'canceled': 'bg-red-500'
                };
                const sidebarColor = statusColorMap[status] || 'bg-slate-300';

                card.innerHTML = `
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 ${sidebarColor}"></div>
                    <div class="flex justify-between items-start mb-4 pl-3">
                        <div>
                            <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-md font-medium mb-2 inline-block">
                                <ion-icon name="storefront-outline" class="align-middle mr-1"></ion-icon>${d.branch || '-'}
                            </span>
                            <h4 class="font-bold text-slate-800 text-lg leading-tight line-clamp-2" title="${d.product || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}">${d.product || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}</h4>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="${statusConfig.color} px-2.5 py-1 rounded-full text-xs font-bold border flex items-center gap-1 shadow-sm">
                                <ion-icon name="${statusConfig.icon}"></ion-icon> ${statusConfig.text}
                            </span>
                        </div>
                    </div>
                    
                    <div class="space-y-3 pl-3">
                        <div class="flex items-center gap-3 text-sm text-slate-600">
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-slate-700">${d.customerName}</p>
                                <p class="text-xs text-slate-400">${d.phoneNumber}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 text-xs bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <div>
                                <p class="text-slate-400 font-medium">‡∏ß‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏±‡∏ö</p>
                                <p class="font-semibold text-slate-700 mt-0.5 flex items-center gap-1">
                                    <ion-icon name="calendar-outline"></ion-icon> ${formatDateShort(d.pickupDueDate)}
                                </p>
                            </div>
                            <div>
                                <p class="text-slate-400 font-medium">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥</p>
                                <p class="font-mono font-semibold text-red-500 mt-0.5">‡∏ø${(d.depositAmount || 0).toLocaleString()}</p>
                            </div>
                        </div>

                            ${d.orderNote ? `
                            <div class="text-xs text-slate-500 bg-yellow-50/50 p-2 rounded-lg border border-yellow-100/50 flex gap-2">
                                <ion-icon name="document-text-outline" class="text-yellow-500 mt-0.5"></ion-icon>
                                <span class="line-clamp-2 italic">"${d.orderNote}"</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-100 flex justify-end pl-3">
                        <button onclick='openPurchasingModal(${dataString})' 
                            class="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-xl font-medium transition-all shadow-lg shadow-slate-800/20 active:scale-95">
                            <ion-icon name="create-outline"></ion-icon> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Helpers
        function updatePurchasingStats(deposits) {
            const pending = deposits.filter(d => !d.orderStatus || d.orderStatus === 'pending').length;
            const ordered = deposits.filter(d => d.orderStatus === 'ordered').length;
            const arrived = deposits.filter(d => d.orderStatus === 'arrived').length;
            const canceled = deposits.filter(d => d.orderStatus === 'canceled').length;

            document.getElementById('count-pending').textContent = pending;
            document.getElementById('count-ordered').textContent = ordered;
            document.getElementById('count-arrived').textContent = arrived;
            document.getElementById('count-canceled').textContent = canceled;

            // (*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Overdue ***)
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const overdueCount = deposits.filter(d => {
                if (d.orderStatus === 'ordered' && d.expectedArrivalDate) {
                    const arr = new Date(d.expectedArrivalDate);
                    return arr < today;
                }
                return false;
            }).length;

            const badge = document.getElementById('purchasing-overdue-badge');
            const btn = document.getElementById('btn-purchasing-overdue');

            if (badge && btn) {
                badge.textContent = overdueCount;
                if (overdueCount > 0) {
                    badge.classList.remove('hidden');
                    btn.classList.add('text-red-500', 'bg-red-50', 'border-red-200');
                    btn.classList.remove('text-slate-400', 'bg-white', 'border-slate-200');
                } else {
                    badge.classList.add('hidden');
                    btn.classList.remove('text-red-500', 'bg-red-50', 'border-red-200');
                    btn.classList.add('text-slate-400', 'bg-white', 'border-slate-200');
                }
            }

        }

        function handlePurchasingSearch() {
            currentSearchText = document.getElementById('purchasing-search-input').value.trim();
            renderPurchasingOrders();
        }

        function filterPurchasingByStatus(status) {
            currentStatusFilter = status;

            // Highlight Logic
            ['pending', 'ordered', 'arrived', 'canceled'].forEach(s => {
                const card = document.getElementById(`card-filter-${s}`);
                if (card) {
                    if (s === status) {
                        card.classList.add('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-slate-50');
                    } else {
                        card.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-slate-50');
                    }
                }
            });

            // Show indicator
            const indicator = document.getElementById('active-filter-indicator');
            const nameDisplay = document.getElementById('filter-name-display');

            if (indicator && nameDisplay) {
                indicator.classList.remove('hidden');

                let statusName = '';
                if (status === 'pending') statusName = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                else if (status === 'ordered') statusName = '‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß';
                else if (status === 'arrived') statusName = '‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß';
                else if (status === 'canceled') statusName = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                else if (status === 'overdue') statusName = 'üîî ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î (Overdue)';

                nameDisplay.textContent = statusName;
            }

            renderPurchasingOrders();
        }



        function clearPurchasingFilter() {
            currentStatusFilter = 'all';
            clearPurchasingFilterUI();
            renderPurchasingOrders();
        }

        function clearPurchasingFilterUI() {
            ['pending', 'ordered', 'arrived', 'canceled'].forEach(s => {
                document.getElementById(`card-filter-${s}`).classList.remove('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-slate-50');
            });
            document.getElementById('active-filter-indicator').classList.add('hidden');
        }


        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        function openPurchasingModal(data) {
            document.getElementById('pur-id').value = data._id;
            document.getElementById('pur-product-display').textContent = data.product || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            document.getElementById('pur-customer-display').textContent = `${data.customerName} (‡πÇ‡∏ó‡∏£: ${data.phoneNumber})`;
            document.getElementById('pur-status').value = data.orderStatus || 'pending';
            document.getElementById('pur-note').value = data.orderNote || '';

            // Set Date
            const dateInput = document.getElementById('pur-arrival-date');
            if (data.expectedArrivalDate) {
                const d = new Date(data.expectedArrivalDate);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            } else {
                dateInput.value = '';
            }

            openModal('purchasingModal');
        }

        async function openDepositModal(data = null) {
            openModal('depositModal');

            // Initialize Tom Select if not already done
            if (!productTomSelect) {
                productTomSelect = new TomSelect('#dep-product', {
                    create: true,
                    sortField: { field: "text", direction: "asc" },
                    placeholder: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°...",
                    valueField: 'text',
                    labelField: 'text',
                    searchField: 'text',
                    options: [],
                    maxOptions: null
                });
            }

            // Load products
            productTomSelect.clear();
            productTomSelect.clearOptions();

            const defaultProducts = [
                // iPhone 13
                "13 128 ‡∏î‡∏≥ New",
                "13 128 ‡∏Ç‡∏≤‡∏ß New",

                // iPhone 15
                "15 128 ‡∏î‡∏≥ New",
                "15 128 ‡∏ö‡∏•‡∏π New",
                "15 128 ‡∏ä‡∏°‡∏û‡∏π New",
                "15 256 ‡∏ö‡∏•‡∏π New",

                // iPhone 16
                "16 128 ‡∏î‡∏≥ New",
                "16 128 ‡∏ö‡∏•‡∏π New",
                "16 128 ‡∏ä‡∏°‡∏û‡∏π New",
                "16 128 ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß New",
                "16 128 ‡∏Ç‡∏≤‡∏ß New",
                "16 256 ‡∏ö‡∏•‡∏π New",

                // iPhone 16 Plus
                "16 Plus 128 ‡∏î‡∏≥ New",
                "16 Plus 128 ‡∏ä‡∏°‡∏û‡∏π New",
                "16 Plus 128 ‡∏Ç‡∏≤‡∏ß New",

                // iPhone 16 Pro
                "16 Pro 128 ‡∏î‡∏≥ New",
                "16 Pro 128 Black Titanium",
                "16 Pro 128 Graphite",

                // iPhone 16 Pro Max
                "16 Pro Max 256 Black Titanium",
                "16 Pro Max 256 Desert",
                "16 Pro Max 256 Desert Titanium",
                "16 Pro Max 256 Graphite",
                "16 Pro Max 256 Silver",
                "16 Pro Max 256 White Titanium",

                // iPhone 17
                "17 256 ‡∏î‡∏≥ New",
                "17 256 ‡∏ö‡∏•‡∏π New",
                "17 256 Lavender",
                "17 256 Purple",
                "17 256 ‡∏Ç‡∏≤‡∏ß New",

                // iPhone 17 Pro
                "17 Pro 256 Orange",
                "17 Pro 256 ‡∏ö‡∏•‡∏π New",

                // iPhone 17 Pro Max
                "17 Pro Max 256 Blue",
                "17 Pro Max 256 Orange",
                "17 Pro Max 256 White",

                // iPad Gen 11
                "iPad Gen11 128 ‡∏Ç‡∏≤‡∏ß New",
                "iPad Gen11 128 ‡∏ö‡∏•‡∏π New",
                "iPad Gen11 128 ‡∏ä‡∏°‡∏û‡∏π New",

                // iPad Air 7
                "iPad Air7 128 ‡∏Ç‡∏≤‡∏ß New",
                "iPad Air7 128 ‡∏°‡πà‡∏ß‡∏á New",
                "iPad Air7 128 ‡πÄ‡∏ó‡∏≤ New",
                "iPad Air7 128 ‡∏ö‡∏•‡∏π New"
            ];

            const serverProducts = await fetchProducts();
            // Merge and dedup
            const allProducts = Array.from(new Set([...defaultProducts, ...serverProducts])).sort();

            allProducts.forEach(p => productTomSelect.addOption({ text: p }));
            document.getElementById('deposit-form').reset();
            document.getElementById('dep-id').value = '';

            if (data) {
                document.getElementById('dep-id').value = data._id;
                document.getElementById('dep-date').value = data.depositDate ? data.depositDate.split('T')[0] : '';
                document.getElementById('dep-pickup').value = data.pickupDueDate ? data.pickupDueDate.split('T')[0] : '';
                document.getElementById('dep-name').value = data.customerName;
                document.getElementById('dep-phone').value = data.phoneNumber;
                document.getElementById('dep-amount').value = data.depositAmount;

                // Set product value
                if (data.product) {
                    productTomSelect.addOption({ text: data.product }); // Ensure option exists
                    productTomSelect.setValue(data.product);
                }
                document.getElementById('dep-price').value = data.price || '';
                document.getElementById('dep-bill').value = data.billNo || '';
                document.getElementById('dep-imei').value = data.imei || '';
                document.getElementById('dep-success').checked = data.isSuccess;
            } else {
                document.getElementById('dep-date').value = new Date().toISOString().split('T')[0];
            }
        }

        // (*** New: Open Detail Modal ***)
        function openDepositDetailModal(data) {
            // 1. Populate Data
            document.getElementById('detail-customer-name').textContent = data.customerName || '-';

            // Status Badge
            const statusBadge = getOrderStatusBadge(data.orderStatus);
            document.getElementById('detail-status-badge').innerHTML = statusBadge;

            // Arrival Date
            if (data.expectedArrivalDate) {
                const d = new Date(data.expectedArrivalDate);
                const dateStr = d.toLocaleDateString('th-TH', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                document.getElementById('detail-arrival-date').textContent = dateStr;
                document.getElementById('detail-arrival-date').className = "font-bold text-blue-600";
            } else {
                document.getElementById('detail-arrival-date').textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
                document.getElementById('detail-arrival-date').className = "font-bold text-slate-400";
            }

            // 2. Open Modal
            openModal('depositDetailModal');
        }

        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const payload = {
                id: document.getElementById('dep-id').value,
                depositDate: document.getElementById('dep-date').value,
                pickupDueDate: document.getElementById('dep-pickup').value,
                customerName: document.getElementById('dep-name').value,
                phoneNumber: document.getElementById('dep-phone').value,
                depositAmount: document.getElementById('dep-amount').value,

                product: document.getElementById('dep-product').value,
                price: document.getElementById('dep-price').value,
                billNo: document.getElementById('dep-bill').value,
                imei: document.getElementById('dep-imei').value,
                isSuccess: document.getElementById('dep-success').checked
            };

            try {
                const res = await fetch(`${SERVER_URL}/deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    closeModal('depositModal');
                    fetchDeposits();
                } else {
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                }
            } catch (err) { alert('Error: ' + err.message); }
        });

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric', year: '2-digit' });
        }


        // ------------------------------------------
        // --- (F) IMPORT NOTIFICATION FUNCTIONS ---
        // ------------------------------------------
        let startImportTab = 'phone';

        function switchImportTab(tab) {
            startImportTab = tab;
            const btnPhone = document.getElementById('tab-btn-phone');
            const btnAcc = document.getElementById('tab-btn-accessory');
            const viewPhone = document.getElementById('tab-import-phone');
            const viewAcc = document.getElementById('tab-import-accessory');

            if (tab === 'phone') {
                // Active Phone
                btnPhone.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold transition-all bg-indigo-50 text-indigo-600 ring-2 ring-indigo-100";
                btnAcc.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold text-slate-500 hover:bg-slate-50 transition-all";
                safeShow(viewPhone);
                safeHide(viewAcc);
            } else {
                // Active Accessory
                btnAcc.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold transition-all bg-pink-50 text-pink-600 ring-2 ring-pink-100";
                btnPhone.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold text-slate-500 hover:bg-slate-50 transition-all";
                safeShow(viewAcc);
                safeHide(viewPhone);
            }
            fetchImportRequests();
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const placeholder = document.getElementById('image-preview-placeholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function fetchImportRequests() {
            const token = localStorage.getItem('token');
            const companyId = document.getElementById('company-select').value;
            try {
                const res = await fetch(`${SERVER_URL}/imports?companyId=${companyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) return;
                const responseData = await res.json();
                const data = Array.isArray(responseData) ? responseData : (responseData.data || []);

                // Render Phone List
                const phoneList = document.getElementById('phone-import-list');
                const phoneData = data.filter(d => d.type === 'phone');
                if (phoneList) {
                    phoneList.innerHTML = '';
                    if (phoneData.length === 0) {
                        phoneList.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</td></tr>`;
                    } else {
                        phoneData.forEach(item => {
                            const fileLink = (item.files && item.files.length > 0) ? item.files[0] : '#';
                            const linkClass = (fileLink !== '#') ? 'text-indigo-600 hover:underline' : 'text-gray-400 cursor-not-allowed';
                            const targetAttr = (fileLink !== '#') ? 'target="_blank"' : '';

                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-slate-50";
                            tr.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatDateShort(item.createdAt)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <a href="${fileLink}" ${targetAttr} class="${linkClass} flex items-center">
                                        <ion-icon name="document-text" class="mr-1"></ion-icon> Download
                                    </a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.branch}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${getStatusTag(item.status)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.createdBy ? item.createdBy.name : '-'}</td>
                            `;
                            phoneList.appendChild(tr);
                        });
                    }
                }

                // Render Accessory List
                const accList = document.getElementById('accessory-import-list');
                const accData = data.filter(d => d.type === 'accessory');
                if (accList) {
                    accList.innerHTML = '';
                    if (accData.length === 0) {
                        accList.innerHTML = `<div class="col-span-full text-center py-8 text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</div>`;
                    } else {
                        accData.forEach(item => {
                            const card = document.createElement('div');
                            card.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex gap-4";

                            let imgUrl = 'https://placehold.co/100';
                            if (item.files && item.files.length > 0) {
                                imgUrl = `${SERVER_URL.replace('/api', '')}/${item.files[0]}`;
                            }

                            // Handle Multi-Item vs Single Item
                            let accName = item.details?.productName || item.details?.name || 'Unknown';
                            let accQty = item.details?.quantity || '-';

                            if (item.details?.items && item.details.items.length > 0) {
                                const totalQty = item.details.items.reduce((sum, i) => sum + (i.qty || 0), 0);
                                const firstItem = item.details.items[0].name;
                                const moreCount = item.details.items.length - 1;

                                accName = moreCount > 0 ? `${firstItem} (+${moreCount})` : firstItem;
                                accQty = totalQty;
                            }

                            const accDate = item.details ? formatDateShort(item.details.importDate || item.createdAt) : '-';

                            // Safe Status Tag
                            const statusTagHtml = (typeof getStatusTag === 'function') ? getStatusTag(item.status) : `<span class="text-xs">${item.status}</span>`;

                            card.innerHTML = `
                                 <img src="${imgUrl}" class="w-20 h-20 object-cover rounded-lg bg-slate-100 border border-slate-200" loading="lazy" onerror="this.src='https://placehold.co/100?text=No+Image'">
                                 <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <h5 class="font-bold text-slate-800 text-sm line-clamp-1" title="${accName}">${accName}</h5>
                                        ${statusTagHtml}
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span class="font-semibold text-slate-700">${accQty}</span> ‡∏ä‡∏¥‡πâ‡∏ô</p>
                                    <p class="text-xs text-slate-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${accDate}</p>
                                    <div class="mt-2 flex items-center text-xs text-slate-400">
                                        <ion-icon name="person" class="mr-1"></ion-icon> ${item.createdBy ? item.createdBy.name : '-'} (${item.branch})
                                    </div>
                                 </div>
                            `;
                            accList.appendChild(card);
                        });
                    }
                }
            } catch (err) {
                console.error(err);
                const accList = document.getElementById('accessory-import-list');
                if (accList) accList.innerHTML = `<div class="col-span-full text-center py-8 text-red-400">Error loading data: ${err.message}</div>`;
            }
        }

        // ------------------------------------------
        // --- (E) GENERAL HELPERS & INIT ---
        // ------------------------------------------

        const loadManagersForDropdown = async () => {
            const token = localStorage.getItem('token');
            const select = document.getElementById('user-reportsTo-input');
            select.innerHTML = '<option value="">--- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... ---</option>';
            try {
                const selectedCompanyId = document.getElementById('user-company-input').value;
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                const users = await response.json();
                select.innerHTML = '<option value="">--- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ---</option>';
                const managers = users.filter(u => u.role === 'manager' || u.role === 'hr' || u.role === 'executive');
                managers.forEach(user => {
                    select.appendChild(new Option(`${user.name} (${getRoleName(user.role)})`, user._id));
                });
            } catch (error) {
                select.innerHTML = `<option value="">--- ${error.message} ---</option>`;
            }
        };

        const populateBranchSelects = () => {
            const branches = ['‡∏¢‡∏∞‡∏•‡∏≤', '‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™', '‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ', '‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà', '‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà2', '‡πÇ‡∏Ñ‡∏•‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°', '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ', '‡∏õ‡∏≤‡∏Å‡πÅ‡∏°‡∏ß', '‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï', '‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä', '‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà', '‡∏Å‡∏∞‡∏ó‡∏π‡πâ', '‡∏ï‡∏£‡∏±‡∏á', '‡∏Ñ‡∏∏‡∏£‡∏∏', '‡∏ä‡∏∏‡∏°‡∏û‡∏£', '‡∏™‡∏ï‡∏π‡∏•', '‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á', '‡∏™‡∏á‡∏Ç‡∏•‡∏≤'];
            const selects = ['deposit-filter-branch', 'purchasing-filter-branch', 'manage-request-branch-filter', 'stock-request-branch-filter'];

            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    // Keep the first option (all)
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption);

                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        select.appendChild(option);
                    });
                }
            });
        };

        const openNewUserModal = () => {
            document.getElementById('user-form').reset();
            document.getElementById('user-modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('form-mode').value = 'create';
            document.getElementById('user-id').value = '';
            safeHide(document.getElementById('user-form-error'));
            document.getElementById('user-username-input').disabled = false;
            document.getElementById('user-username-input').required = true;
            document.getElementById('user-password-input').placeholder = "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å";
            document.getElementById('user-password-input').required = true;
            safeShow(document.getElementById('auth-section'));

            const currentCompany = document.getElementById('company-select').value;
            const userCompanySelect = document.getElementById('user-company-input');
            userCompanySelect.value = currentCompany;
            userCompanySelect.disabled = false;

            safeHide(document.getElementById('user-reportsTo-input').parentElement);

            openModal('userModal');
        };

        const openEditUserModal = async (id) => {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
                const users = await response.json();
                const user = users.find(u => u._id === id);

                if (user) {
                    document.getElementById('user-form').reset();
                    document.getElementById('user-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                    document.getElementById('form-mode').value = 'edit';
                    document.getElementById('user-id').value = user._id;
                    safeHide(document.getElementById('user-form-error'));

                    document.getElementById('user-username-input').disabled = true;
                    document.getElementById('user-username-input').required = false;
                    document.getElementById('user-password-input').placeholder = "‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô";
                    document.getElementById('user-password-input').required = false;
                    safeShow(document.getElementById('auth-section'));

                    document.getElementById('user-name-input').value = user.name;
                    document.getElementById('user-role-input').value = user.role;
                    document.getElementById('user-username-input').value = user.username;
                    document.getElementById('user-department-input').value = user.department;
                    document.getElementById('user-branch-input').value = user.branch || '';

                    const userCompanySelect = document.getElementById('user-company-input');
                    userCompanySelect.value = user.companyId;
                    userCompanySelect.disabled = true;

                    const reportsToDiv = document.getElementById('user-reportsTo-input').parentElement;
                    safeShow(reportsToDiv);

                    await loadManagersForDropdown();

                    document.getElementById('user-reportsTo-input').value = user.reportsTo ? user.reportsTo._id : '';
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                }
                openModal('userModal');
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            }
        };

        const handleUserFormSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const mode = data.mode;
            const userId = data.userId;
            const submitButton = document.getElementById('submit-user-btn');
            const errorBox = document.getElementById('user-form-error');
            submitButton.disabled = true;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            safeHide(errorBox);
            let url = '';
            let method = '';
            let body = {};

            if (mode === 'create') {
                url = `${SERVER_URL}/auth/register`;
                method = 'POST';
                body = {
                    name: data.name,
                    username: data.username,
                    password: data.password,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                    companyId: data.companyId
                };
            } else {
                url = `${SERVER_URL}/users/admin/${userId}`;
                method = 'PUT';
                body = {
                    name: data.name,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                };
                if (data.password && data.password.trim() !== '') {
                    body.password = data.password;
                }
            }
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                closeModal('userModal');
                fetchAllUsersForTable();
                fetchAllUsers();
            } catch (error) {
                errorBox.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`;
                safeShow(errorBox);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            }
        };

        const executeDeleteUser = async (id, name) => {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "${name}"?`)) {
                return;
            }
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                fetchAllUsersForTable();
                fetchAllUsers();
            } catch (error) {
                alert(`‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
            }
        };

        // --- NAVIGATION LOGIC (‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß) ---
        const updateNavActiveState = (activeView) => {
            const statsCards = document.getElementById('stats-cards');
            const myTasksFilters = document.getElementById('mytasks-filters');
            const taskView = document.getElementById('task-view-content');
            const adminView = document.getElementById('admin-view-content');
            const depositView = document.getElementById('deposit-view'); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Deposit View

            const mainHeader = document.getElementById('main-header');
            const newTaskBtn = document.getElementById('newTaskButton');
            const newUserBtn = document.getElementById('newUserButton');
            const showAllTasksBtn = document.getElementById('showAllTasksBtn');

            const navDashboard = document.getElementById('nav-dashboard');
            const navMyTasks = document.getElementById('nav-mytasks');
            const navAdmin = document.getElementById('nav-admin');
            const navDeposit = document.getElementById('nav-Storefront_deposit'); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Deposit Nav

            const companySelectDiv = document.getElementById('company-select').parentElement;
            const navPurchasing = document.getElementById('nav-purchasing');
            const purchasingView = document.getElementById('purchasing-view');
            const navImport = document.getElementById('nav-import');      // [New]
            const importView = document.getElementById('import-view');    // [New]
            const navStockImport = document.getElementById('nav-stock-import'); // [Stock Import]
            const stockImportView = document.getElementById('stock-import-view'); // [Stock Import]

            const navStockRequest = document.getElementById('nav-stock-request');
            const stockRequestView = document.getElementById('stock-request-view');
            const navStockRequestManage = document.getElementById('nav-stock-request-manage');
            const stockRequestManageView = document.getElementById('stock-request-manage-view');

            const navBranchOrder = document.getElementById('nav-branch-order'); // [Branch Order - Purchasing]
            const navBranchOrderInventory = document.getElementById('nav-branch-order-inventory'); // [Branch Order - Sales]
            const branchOrderView = document.getElementById('branch-order-view'); // [Order Management View]
            const branchInventoryView = document.getElementById('branch-inventory-view'); // [Inventory View]

            // Only toggle visibility if changing views (prevents flicker on refresh)
            if (activeView !== currentView) {
                // Reset Nav Styles
                [navDashboard, navMyTasks, navAdmin, navDeposit, navPurchasing, navImport, navStockImport, navStockRequest, navStockRequestManage, navBranchOrder, navBranchOrderInventory].forEach(el => {
                    if (el) {
                        el.classList.remove('bg-amber-500', 'text-white');
                        el.classList.add('text-slate-600', 'hover:bg-slate-50');
                    }
                });

                // Hide All Views
                safeHide(statsCards);
                safeHide(taskView);
                safeHide(adminView);
                safeHide(depositView); // Hide Deposit View
                safeHide(purchasingView);
                safeHide(importView);     // [New]
                safeHide(stockImportView); // [Stock Import]
                safeHide(stockRequestView);
                safeHide(stockRequestManageView);
                safeHide(branchOrderView);
                safeHide(branchInventoryView);
            }

            // Update state
            currentView = activeView;

            // Hide Buttons & Filters
            safeHide(newTaskBtn); safeHide(newUserBtn);
            safeHide(showAllTasksBtn);
            safeHide(myTasksFilters);

            currentView = activeView;

            if (activeView === 'dashboard') {
                safeShow(statsCards); safeShow(taskView);
                if (currentUser.role !== 'staff') safeShow(newTaskBtn);
                safeShow(showAllTasksBtn);
                mainHeader.textContent = "‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î";
                navDashboard.classList.add('bg-amber-500', 'text-white');
                navDashboard.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'block';
            }
            else if (activeView === 'mytasks') {
                safeShow(taskView);
                safeShow(myTasksFilters);
                mainHeader.textContent = "‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô";
                navMyTasks.classList.add('bg-amber-500', 'text-white');
                navMyTasks.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'admin') {
                safeShow(adminView); safeShow(newUserBtn);
                mainHeader.textContent = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
                navAdmin.classList.add('bg-amber-500', 'text-white');
                navAdmin.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'deposit') { // (*** ‡πÉ‡∏´‡∏°‡πà ***)
                safeShow(depositView);
                mainHeader.textContent = "‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô";
                navDeposit.classList.add('bg-amber-500', 'text-white');
                navDeposit.classList.remove('text-gray-600', 'hover:bg-gray-100');
                // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πá‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏î‡πâ
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'purchasing') { // [‡πÄ‡∏û‡∏¥‡πà‡∏°]
                safeShow(purchasingView);
                mainHeader.textContent = "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠";
                navPurchasing.classList.add('bg-amber-500', 'text-white');
                navPurchasing.classList.remove('text-slate-600', 'hover:bg-slate-50');
                if (companySelectDiv) companySelectDiv.style.display = 'none';

                // Default to Pending
                if (typeof fetchPurchasingOrders === 'function') {
                    fetchPurchasingOrders('pending');
                }
            }
            else if (activeView === 'import') { // [New]
                safeShow(importView);
                mainHeader.textContent = "‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
                navImport.classList.add('bg-amber-500', 'text-white');
                navImport.classList.remove('text-slate-600', 'hover:bg-slate-50');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                fetchImportRequests();
            }
            else if (activeView === 'stock-import') { // [New Stock]
                const stockImportView = document.getElementById('stock-import-view');
                const navStockImport = document.getElementById('nav-stock-import');
                safeShow(stockImportView);
                mainHeader.textContent = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤";
                if (navStockImport) {
                    navStockImport.classList.add('bg-amber-500', 'text-white');
                    navStockImport.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                // Reset to Phone and Pending on entry
                if (typeof filterStockType === 'function' && typeof filterStockImports === 'function') {
                    filterStockType('phone', false);
                    filterStockImports('pending', false);
                    fetchStockImports();
                } else if (typeof fetchStockImports === 'function') {
                    fetchStockImports();
                }
            }
            else if (activeView === 'stock-request') {
                safeShow(stockRequestView);
                mainHeader.textContent = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
                if (navStockRequest) {
                    navStockRequest.classList.add('bg-amber-500', 'text-white');
                    navStockRequest.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                fetchStockRequests();
            }
            else if (activeView === 'stock-request-manage') {
                safeShow(stockRequestManageView);
                mainHeader.textContent = "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
                if (navStockRequestManage) {
                    navStockRequestManage.classList.add('bg-amber-500', 'text-white');
                    navStockRequestManage.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                fetchManageStockRequests();
            }
            else if (activeView === 'branch-order') {
                if (typeof fetchBranchOrders === 'function') fetchBranchOrders();
                safeShow(branchOrderView);
                mainHeader.textContent = "‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤";
                if (navBranchOrder) {
                    navBranchOrder.classList.add('bg-amber-500', 'text-white');
                    navBranchOrder.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'branch-order-inventory') {
                if (typeof fetchBranchInventory === 'function') fetchBranchInventory();
                safeShow(branchInventoryView);
                mainHeader.textContent = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤";
                if (navBranchOrderInventory) {
                    navBranchOrderInventory.classList.add('bg-amber-500', 'text-white');
                    navBranchOrderInventory.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }

            if (currentUser && currentUser.role === 'staff') {
                if (document.getElementById('company-select')) document.getElementById('company-select').disabled = true;
            }
        };

        const updateMyTaskCounts = () => {
            if (!allMyTasks) return;
            document.getElementById('mytask-count-todo').textContent = allMyTasks.filter(t => t.status === 'todo').length;
            document.getElementById('mytask-count-inprogress').textContent = allMyTasks.filter(t => t.status === 'in-progress').length;
            document.getElementById('mytask-count-review').textContent = allMyTasks.filter(t => t.status === 'for-review').length;
            document.getElementById('mytask-count-completed').textContent = allMyTasks.filter(t => t.status === 'completed').length;
        };

        const filterMyTasks = (status) => {
            ['todo', 'inprogress', 'review', 'completed'].forEach(id => {
                document.getElementById(`btn-filter-${id}`).classList.remove('ring-2', 'ring-offset-1', 'ring-gray-400');
            });

            let filtered = [];
            if (status === 'all') {
                filtered = allMyTasks;
            } else {
                filtered = allMyTasks.filter(t => t.status === status);
                let btnId = '';
                if (status === 'todo') btnId = 'todo';
                else if (status === 'in-progress') btnId = 'inprogress';
                else if (status === 'for-review') btnId = 'review';
                else if (status === 'completed') btnId = 'completed';

                if (btnId) {
                    document.getElementById(`btn-filter-${btnId}`).classList.add('ring-2', 'ring-offset-1', 'ring-gray-400');
                }
            }
            renderTaskTable(filtered);
        };

        // --- INIT & LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth();


            // ============================================
            // STOCK IMPORT LOGIC
            // ============================================
            let currentStockFilter = 'pending';
            let currentStockImportType = 'phone'; // Default to Phone
            let currentStockBranch = 'all'; // [New] Branch Filter
            let targetImportId = null;
            let targetImportStatus = null;

            // Pagination Vars
            let currentStockPage = 1;
            let currentStockLimit = 20;
            let currentStockTotalPages = 1;

            // (*** Updated Stock Functions ***)
            function renderStockImportTable(data) {
                const phoneTbody = document.getElementById('stock-phone-tbody');
                const accGrid = document.getElementById('stock-acc-grid');
                const emptyState = document.getElementById('stock-empty-state');
                const loading = document.getElementById('stock-loading');

                if (loading) loading.classList.add('hidden');

                // Clear both
                if (phoneTbody) phoneTbody.innerHTML = '';
                if (accGrid) accGrid.innerHTML = '';

                if (!data || data.length === 0) {
                    if (emptyState) emptyState.classList.remove('hidden');
                    return;
                } else {
                    if (emptyState) emptyState.classList.add('hidden');
                }

                // Render based on current mode
                if (currentStockImportType === 'phone') {
                    // --- RENDER TABLE ---
                    data.forEach(item => {
                        const date = new Date(item.createdAt).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const branch = item.branch || '-';
                        const createdBy = item.createdBy ? item.createdBy.name : '-';
                        const supplier = item.details?.supplier || '-';
                        const desc = item.details?.description || '-';

                        // File
                        const fileCount = item.files ? item.files.length : 0;
                        let fileLink = '';

                        if (fileCount > 0) {
                            fileLink = `<div class="flex flex-col gap-1">`;
                            item.files.forEach((rawPath, idx) => {
                                const finalUrl = rawPath.startsWith('http') ? rawPath : `${SERVER_URL.replace('/api', '')}/${rawPath}`;
                                const isExcel = rawPath.toLowerCase().endsWith('.xlsx') || rawPath.toLowerCase().endsWith('.xls');

                                const icon = isExcel ? 'document-text' : 'image';
                                const label = isExcel ? '‡πÇ‡∏´‡∏•‡∏î Excel' : '‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
                                const colorClass = isExcel ? 'bg-indigo-50 text-indigo-600 border-indigo-200 hover:bg-indigo-100' : 'bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100';

                                fileLink += `
                                    <a href="${finalUrl}" target="_blank" class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg ${colorClass} transition-colors text-xs font-bold">
                                        <ion-icon name="${icon}"></ion-icon> ${label}
                                    </a>`;
                            });
                            fileLink += `</div>`;
                        } else {
                            fileLink = `<span class="text-slate-400 text-xs">-</span>`;
                        }

                        // Status
                        const statusBadge = getStockStatusBadge(item.status);

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50/80 transition-colors border-b border-slate-50 last:border-0 group";
                        tr.innerHTML = `
                            <td class="px-6 py-4">
                                <span class="text-sm font-bold text-slate-600">${date}</span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs uppercase tracking-tighter border border-slate-200">
                                        ${branch.substring(0, 2)}
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-slate-700">${branch}</div>
                                        <div class="text-xs text-slate-400">${createdBy}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-bold text-slate-800">${supplier}</div>
                            </td>
                            <td class="px-6 py-4 text-sm">${fileLink}</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="openStatusModal('${item._id}', '${item.status}')" class="hover:scale-105 active:scale-95 transition-transform">
                                    ${statusBadge}
                                </button>
                            </td>
                             <td class="px-6 py-4 text-right">
                                <button onclick="deleteImportRequest('${item._id}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                    <ion-icon name="trash-outline" class="text-lg"></ion-icon>
                                </button>
                            </td>
                        `;
                        phoneTbody.appendChild(tr);
                    });

                } else {
                    // --- RENDER GRID (ACCESSORIES) ---
                    data.forEach(item => {
                        const date = new Date(item.createdAt).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
                        const branch = item.branch || 'Unknown';
                        const itemsCount = item.details?.items?.length || 1;
                        let title = item.details?.billName || item.details?.productName || `${itemsCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        if (itemsCount > 1 && !item.details?.billName) title = `‡∏ö‡∏¥‡∏•‡∏£‡∏ß‡∏° (${itemsCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;

                        // Image
                        let imgUrl = 'image/placeholder.jpg'; // Path placeholder
                        if (item.files && item.files.length > 0) {
                            const rawPath = item.files[0];
                            imgUrl = rawPath.startsWith('http') ? rawPath : `${SERVER_URL.replace('/api', '')}/${rawPath}`;
                        } else {
                            // Fallback icon
                        }

                        // Status
                        const statusBadge = getStockStatusBadge(item.status);

                        const card = document.createElement('div');
                        card.className = "bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden cursor-pointer group flex flex-col h-full";
                        card.onclick = (e) => {
                            // prevent opening if clicked on specific action buttons if any (but here whole card is clickable)
                            openImportDetailModal(item);
                        };

                        card.innerHTML = `
                            <div class="relative h-48 bg-slate-100 overflow-hidden">
                                <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" loading="lazy" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
                                <div class="absolute top-3 left-3">
                                    <span class="px-2 py-1 bg-white/90 backdrop-blur-sm rounded-lg text-xs font-bold text-slate-700 shadow-sm flex items-center gap-1">
                                        <ion-icon name="storefront"></ion-icon> ${branch}
                                    </span>
                                </div>
                                <div class="absolute top-3 right-3">
                                     <span class="px-2 py-1 bg-black/50 backdrop-blur-md rounded-lg text-xs font-bold text-white border border-white/20">
                                        ${date}
                                    </span>
                                </div>
                            </div>
                            <div class="p-5 flex-1 flex flex-col">
                                <h4 class="font-bold text-slate-800 text-lg mb-1 line-clamp-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏• : ${title}</h4>
                                <p class="text-sm text-slate-500 mb-4 flex items-center gap-1">
                                    <ion-icon name="person-circle-outline"></ion-icon> ${item.createdBy?.name || '-'}
                                </p>
                                <div class="mt-auto flex items-center justify-between pt-4 border-t border-slate-50">
                                   ${statusBadge}
                                   <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-indigo-500 group-hover:text-white transition-colors">
                                        <ion-icon name="arrow-forward"></ion-icon>
                                   </div>
                                </div>
                            </div>
                        `;
                        accGrid.appendChild(card);
                    });
                }

                // Update Dashboard Stats (Simple Client-side count based on loaded data - ideal for 'All')
                // Note: If filters strictly limit data, these stats will only reflect filtered data.
                // Ideal solution: Separate stats API. For now, we update specific stats if we are in 'all' mode.
                updateStockStatsUI(data);
            }

            function getStockStatusBadge(status) {
                if (status === 'pending') return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 ring-1 ring-yellow-500/20"><div class="w-1.5 h-1.5 rounded-full bg-yellow-500 mr-1.5 animate-pulse"></div>‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>`;
                if (status === 'importing') return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 ring-1 ring-blue-500/20"><div class="w-1.5 h-1.5 rounded-full bg-blue-500 mr-1.5"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</span>`;
                if (status === 'received') return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 ring-1 ring-green-500/20"><div class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></div>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</span>`;
                return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 ring-1 ring-slate-500/20">${status}</span>`;
            }

            function updateStockStatsUI(data) {
                if (currentStockFilter !== 'all') return; // Don't update global stats if filtered

                const all = data.length;
                const pending = data.filter(i => i.status === 'pending').length;
                const importing = data.filter(i => i.status === 'importing').length;
                const received = data.filter(i => i.status === 'received').length;

                const anim = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = val;
                };

                anim('stat-stock-all', all);
                anim('stat-stock-pending', pending);
                anim('stat-stock-importing', importing);
                anim('stat-stock-received', received); // (*** New ***)
            }

            window.changeStockPage = function (delta) {
                const newPage = currentStockPage + delta;
                if (newPage >= 1 && newPage <= currentStockTotalPages) {
                    currentStockPage = newPage;
                    fetchStockImports();
                }
            };

            function updatePaginationUI(meta) {
                const paginationEl = document.getElementById('stock-pagination');
                if (!paginationEl) return;

                if (meta.total > 0) {
                    paginationEl.classList.remove('hidden');

                    const start = (meta.page - 1) * currentStockLimit + 1;
                    const end = Math.min(meta.page * currentStockLimit, meta.total);

                    document.getElementById('pagination-info-start').textContent = start;
                    document.getElementById('pagination-info-end').textContent = end;
                    document.getElementById('pagination-info-total').textContent = meta.total;
                    document.getElementById('pagination-page-display').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${meta.page} / ${meta.totalPages}`;

                    const btnPrev = document.getElementById('btn-prev-page');
                    const btnNext = document.getElementById('btn-next-page');

                    if (btnPrev) btnPrev.disabled = (meta.page <= 1);
                    if (btnNext) btnNext.disabled = (meta.page >= meta.totalPages);
                } else {
                    paginationEl.classList.add('hidden');
                }
            }

            async function fetchStockImports() {
                try {
                    let url = `${SERVER_URL}/imports?t=${Date.now()}`;

                    // Pagination
                    url += `&page=${currentStockPage}&limit=${currentStockLimit}`;

                    if (currentStockImportType && currentStockImportType !== 'all') {
                        url += `&type=${currentStockImportType}`;
                    }

                    if (currentStockFilter !== 'all') {
                        url += `&status=${currentStockFilter}`;
                    }
                    if (currentStockBranch !== 'all') {
                        url += `&branch=${encodeURIComponent(currentStockBranch)}`;
                    }

                    // Date Filters
                    const startEl = document.getElementById('stock-filter-date-start');
                    const endEl = document.getElementById('stock-filter-date-end');
                    if (startEl && startEl.value) url += `&startDate=${startEl.value}`;
                    if (endEl && endEl.value) url += `&endDate=${endEl.value}`;

                    if (document.getElementById('stock-loading')) document.getElementById('stock-loading').classList.remove('hidden');

                    const res = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!res.ok) throw new Error('Failed to fetch');

                    const responseData = await res.json();

                    // Support both old array format (fallback) and new paginated object
                    const data = Array.isArray(responseData) ? responseData : (responseData.data || []);
                    const total = responseData.total || data.length;
                    const totalPages = responseData.totalPages || 1;

                    // Update State
                    currentStockTotalPages = totalPages;
                    updatePaginationUI({ page: currentStockPage, total, totalPages });

                    renderStockImportTable(data);

                    const countEl = document.getElementById('stock-import-count');
                    // if (countEl) countEl.textContent = `${total}`;

                } catch (err) {
                    console.error(err);
                }
            }

            function filterStockImports(status, doFetch = true) {
                currentStockFilter = status;
                currentStockPage = 1; // Reset page
                // Update UI buttons
                ['pending', 'importing', 'received', 'all'].forEach(s => {
                    const btn = document.getElementById(`filter-stock-${s}`);
                    if (btn) {
                        let base = "px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2";
                        if (s === status) {
                            btn.className = base + " text-white bg-indigo-600 shadow-md ring-1 ring-slate-200";
                            // Fix inner dots colors if needed
                            const dot = btn.querySelector('div');
                            if (dot && s !== 'all') dot.className = "w-2 h-2 rounded-full border border-white/30 " + (s === 'pending' ? 'bg-yellow-400' : (s === 'importing' ? 'bg-blue-400' : 'bg-green-400'));
                        } else {
                            btn.className = base + " text-slate-500 hover:text-slate-700 hover:bg-white/50";
                            const dot = btn.querySelector('div');
                            if (dot && s !== 'all') dot.className = "w-2 h-2 rounded-full " + (s === 'pending' ? 'bg-yellow-400' : (s === 'importing' ? 'bg-blue-500' : 'bg-green-500'));
                        }
                    }
                });

                // Sync Dropdown
                const statusSelect = document.getElementById('stock-import-status-filter');
                if (statusSelect) statusSelect.value = status;

                if (doFetch) fetchStockImports();
            }

            function filterStockType(type, doFetch = true) {
                currentStockImportType = type;
                currentStockPage = 1; // Reset page

                const phoneTab = document.getElementById('tab-stock-phone');
                const accTab = document.getElementById('tab-stock-accessory');
                const allTab = document.getElementById('tab-stock-all'); // Not really used for view switch, but for button style

                // View Contrainers
                const phoneView = document.getElementById('stock-view-phone');
                const accView = document.getElementById('stock-view-accessory');

                // Toggle Views
                if (type === 'phone') {
                    if (phoneView) phoneView.classList.remove('hidden');
                    if (accView) accView.classList.add('hidden');
                } else if (type === 'accessory') {
                    if (phoneView) phoneView.classList.add('hidden');
                    if (accView) accView.classList.remove('hidden');
                } else {
                    // Should technically show both or redirect to one, defaulting to phone for now if 'all'
                    if (phoneView) phoneView.classList.remove('hidden');
                    if (accView) accView.classList.add('hidden');
                }

                // Update Button Styles
                const baseClass = "flex-1 md:flex-none px-6 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all";
                const activeClass = baseClass + " shadow-sm bg-white text-indigo-600 ring-1 ring-black/5";
                const inactiveClass = baseClass + " text-slate-500 hover:text-slate-700 hover:bg-slate-200/50";

                if (phoneTab) phoneTab.className = (type === 'phone') ? activeClass : inactiveClass;
                if (accTab) accTab.className = (type === 'accessory') ? activeClass : inactiveClass;
                // if (allTab) allTab.className = (type === 'all') ? activeClass : inactiveClass;

                if (doFetch) fetchStockImports();
            }

            // Expose Stock Functions to Window
            window.filterStockImports = filterStockImports;
            window.fetchStockImports = fetchStockImports;
            window.openStatusModal = openStatusModal;
            window.filterStockType = filterStockType;
            window.updateStockStatusFromModal = updateStockStatusFromModal;
            window.openImportDetailModal = openImportDetailModal;

            // [New] Branch Filter Listener
            const stockBranchSelect = document.getElementById('stock-import-branch-filter');
            if (stockBranchSelect) {
                stockBranchSelect.addEventListener('change', (e) => {
                    currentStockBranch = e.target.value;
                    fetchStockImports();
                });
            }

            // Status Modal Selection
            function openStatusModal(id, currentStatus) {
                targetImportId = id;
                openModal('statusUpdateModal');
            }

            // *** NEW: Open Detail Modal for Accessory ***
            let currentDetailItem = null;
            function openImportDetailModal(item) {
                currentDetailItem = item;
                targetImportId = item._id;

                const d = item.details || {};
                const supplier = d.supplier || '-';
                const billName = d.billName || '-'; // (*** New: Bill Name ***)
                const branch = item.branch || '-';
                const createdBy = item.createdBy ? item.createdBy.name : '-';
                const date = new Date(item.createdAt).toLocaleDateString('th-TH');

                // Populate Info
                document.getElementById('detail-supplier-title').innerHTML = `${supplier} <span class="text-xs font-normal text-slate-400">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏• : ${billName}</span>`;
                document.getElementById('detail-branch-badge').textContent = branch;
                document.getElementById('detail-date-display').textContent = date;
                document.getElementById('detail-by-user').textContent = `‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏î‡∏¢: ${createdBy}`;
                document.getElementById('detail-current-status').textContent = item.status;

                // Image
                const imgEl = document.getElementById('detail-bill-image');
                const linkEl = document.getElementById('detail-bill-link');
                if (item.files && item.files.length > 0) {
                    const rawPath = item.files[0];
                    const path = rawPath.startsWith('http') ? rawPath : `${SERVER_URL.replace('/api', '')}/${rawPath}`;
                    imgEl.src = path;
                    linkEl.href = path;
                } else {
                    imgEl.src = 'image/placeholder.jpg';
                    linkEl.href = '#';
                }

                // Items List
                const listContainer = document.getElementById('detail-items-list');
                listContainer.innerHTML = '';

                if (d.items && d.items.length > 0) {
                    d.items.forEach((subItem, index) => {
                        // Fix: Support both productName/quantity and legacy name/qty
                        const pName = subItem.productName || subItem.name || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                        const pQty = subItem.quantity || subItem.qty || 0;
                        const pNote = subItem.note || '';

                        const div = document.createElement('div');
                        div.className = "flex justify-between items-center p-3 rounded-xl bg-slate-50 border border-slate-100";
                        div.innerHTML = `
                             <div class="flex items-center gap-3">
                                 <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">${index + 1}</span>
                                 <div>
                                     <span class="font-bold text-slate-700 block">${pName}</span>
                                     ${pNote ? `<span class="text-xs text-slate-400 font-normal">${pNote}</span>` : ''}
                                 </div>
                             </div>
                             <span class="font-bold text-slate-900 bg-white px-2 py-1 rounded border border-slate-100 shadow-sm">x${pQty}</span>
                         `;
                        listContainer.appendChild(div);
                    });
                } else {
                    // Single Item Fallback
                    const pName = d.productName || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
                    const pQty = d.quantity || 1;

                    listContainer.innerHTML = `
                         <div class="flex justify-between items-center p-3 rounded-xl bg-slate-50 border border-slate-100">
                             <div class="flex items-center gap-3">
                                 <span class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold">1</span>
                                 <span class="font-bold text-slate-700">${pName}</span>
                             </div>
                             <span class="font-bold text-slate-900 bg-white px-2 py-1 rounded border border-slate-100 shadow-sm">x${pQty}</span>
                         </div>
                     `;
                }

                openModal('stockDetailModal');
            }

            async function updateStockStatusFromModal(newStatus) {
                if (!targetImportId) return;

                // Close modals
                closeModal('stockDetailModal');
                closeModal('statusUpdateModal');

                // Call API
                try {
                    const res = await fetch(`${SERVER_URL}/imports/${targetImportId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (res.ok) {
                        fetchStockImports(); // Refresh Grid
                    } else {
                        alert('Failed to update status');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error updating status');
                }
            }


            // Forms
            document.getElementById('new-task-form').addEventListener('submit', handleNewTaskSubmit);
            document.getElementById('update-task-form').addEventListener('submit', handleUpdateTaskSubmit);
            document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);

            // Import Forms
            const phoneImportForm = document.getElementById('phone-import-form');
            if (phoneImportForm) {
                phoneImportForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fileInput = document.getElementById('phone-import-file');
                    const imageInput = document.getElementById('phone-import-image'); // (*** New: Image Input ***)

                    if (fileInput.files.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel');

                    const supplier = document.getElementById('phone-import-supplier').value;
                    if (!supplier) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Supplier');

                    const formData = new FormData();
                    formData.append('type', 'phone');

                    // Add Excel
                    formData.append('files', fileInput.files[0]);

                    // Add Image (if any)
                    if (imageInput.files.length > 0) {
                        formData.append('files', imageInput.files[0]);
                    }

                    formData.append('companyId', document.getElementById('company-select').value);
                    formData.append('supplier', supplier);

                    const desc = document.getElementById('phone-import-description').value;
                    if (desc) formData.append('description', desc);

                    try {
                        const res = await fetch(`${SERVER_URL}/imports`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                            body: formData
                        });
                        if (res.ok) {
                            alert('‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                            closeModal('phoneImportModal');
                            fetchImportRequests();
                        } else {
                            const err = await res.json();
                            alert('Error: ' + err.message);
                        }
                    } catch (err) { alert('Error: ' + err.message); }
                });

                document.getElementById('phone-import-file').addEventListener('change', (e) => {
                    const display = document.getElementById('file-name-display');
                    if (e.target.files.length > 0) {
                        display.textContent = e.target.files[0].name;
                        display.classList.remove('hidden');
                        display.classList.add('inline-block'); // Keep this for consistency with original behavior
                    } else {
                        display.textContent = '';
                        display.classList.add('hidden');
                        display.classList.remove('inline-block');
                    }
                });

                // (*** New: Image Preview for Phone Import ***)
                document.getElementById('phone-import-image').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    const preview = document.getElementById('phone-image-preview');
                    const placeholder = document.getElementById('phone-image-placeholder');

                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            preview.src = event.target.result;
                            preview.classList.remove('hidden');
                            placeholder.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        preview.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                        preview.src = '';
                    }
                });
            }

            // --- Dynamic Accessory Import Logic ---
            let accItemCount = 0;

            // Remove legacy listener if exists (it targeted 'accessory-import-form' which is replaced by 'accessory-import-form-multi')
            // We expose these functions to global scope because they are called by onclick attributes in HTML
            window.addAccessoryItemRow = function () {
                const container = document.getElementById('acc-items-container');
                const emptyState = document.getElementById('acc-items-empty');
                if (emptyState) emptyState.classList.add('hidden');

                accItemCount++;
                const rowId = `acc-row-${Date.now()}`;

                const div = document.createElement('div');
                div.className = "grid grid-cols-12 gap-3 p-4 bg-white rounded-xl border border-slate-100 shadow-sm animate-fade-in relative group";
                div.id = rowId;
                div.innerHTML = `
                    <div class="col-span-1 flex items-center justify-center">
                        <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-sm font-bold row-index">#</span>
                    </div>
                    <div class="col-span-7">
                        <label class="block text-xs font-bold text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" class="acc-item-name form-input-theme w-full" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." required>
                    </div>
                    <div class="col-span-3">
                        <label class="block text-xs font-bold text-slate-400 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                        <input type="number" class="acc-item-qty form-input-theme w-full text-center font-bold text-indigo-600" value="1" min="1" required>
                    </div>
                    <div class="col-span-1 flex items-center justify-center pt-5">
                        <button type="button" onclick="removeAccessoryRow('${rowId}')" class="text-slate-300 hover:text-red-500 transition-colors p-2">
                            <ion-icon name="trash" class="text-xl"></ion-icon>
                        </button>
                    </div>
                `;
                container.appendChild(div);
                updateAccTotalCount();
            };

            window.removeAccessoryRow = function (id) {
                const row = document.getElementById(id);
                if (row) row.remove();

                const container = document.getElementById('acc-items-container');
                if (container.children.length === 0) {
                    const emptyState = document.getElementById('acc-items-empty');
                    if (emptyState) emptyState.classList.remove('hidden');
                }
                updateAccTotalCount();
            };

            function updateAccTotalCount() {
                const rows = document.querySelectorAll('#acc-items-container > div');
                const countDisplay = document.getElementById('acc-total-items-count');
                if (countDisplay) countDisplay.textContent = rows.length;

                rows.forEach((row, index) => {
                    const idx = row.querySelector('.row-index');
                    if (idx) idx.textContent = index + 1;
                });
            }

            window.submitAccessoryImport = async function () {
                const rows = document.querySelectorAll('#acc-items-container > div');
                if (rows.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

                const supplier = document.getElementById('acc-bill-supplier').value;
                const billDate = document.getElementById('acc-bill-date').value;
                const billName = document.getElementById('acc-bill-name').value; // (*** New: Get Bill Name ***)
                const imageInput = document.getElementById('acc-bill-image');

                if (!supplier || !billDate) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Supplier)');

                const items = [];
                let isValid = true;
                rows.forEach(row => {
                    const name = row.querySelector('.acc-item-name').value;
                    const qty = row.querySelector('.acc-item-qty').value;
                    if (!name || parseInt(qty) <= 0) isValid = false;
                    items.push({ name, qty: parseInt(qty) });
                });

                if (!isValid) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');

                const formData = new FormData();
                formData.append('type', 'accessory');
                formData.append('companyId', document.getElementById('company-select').value);

                const details = {
                    supplier,
                    billDate,
                    billName, // (*** New: Include Bill Name ***)
                    items
                };
                formData.append('details', JSON.stringify(details));

                if (imageInput.files.length > 0) {
                    formData.append('files', imageInput.files[0]);
                } else {
                    // (Optional) Warning if no image
                    // if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                }

                try {
                    const res = await fetch(`${SERVER_URL}/imports`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                        body: formData
                    });
                    if (res.ok) {
                        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        // Reset Form
                        document.getElementById('accessory-import-form-multi').reset();
                        document.getElementById('acc-items-container').innerHTML = '';
                        document.getElementById('acc-items-empty').classList.remove('hidden');
                        document.getElementById('image-preview').classList.add('hidden');
                        document.getElementById('image-preview-placeholder').classList.remove('hidden');
                        updateAccTotalCount();

                        closeModal('accImportModal');
                        fetchImportRequests();
                    } else {
                        const err = await res.json();
                        alert('Error: ' + err.message);
                    }
                } catch (err) { alert('Error: ' + err.message); }
            };

            // Buttons
            document.getElementById('confirm-delete-button').addEventListener('click', executeDelete);
            document.getElementById('newTaskButton').addEventListener('click', () => {
                fetchAllUsers();
                openModal('newTaskModal');
            });
            // (*** ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ***)
            document.getElementById('showAllTasksBtn').addEventListener('click', () => {
                // 1. ‡∏•‡∏ö Highlight ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                document.querySelectorAll('#stats-cards [data-status]').forEach(card => {
                    card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
                });
                // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Cache
                if (typeof allDashboardTasks !== 'undefined') {
                    renderTaskTable(allDashboardTasks);
                }
            });
            document.getElementById('newUserButton').addEventListener('click', openNewUserModal);
            document.getElementById('notification-bell').addEventListener('click', () => {
                openModal('notificationModal');
                markNotificationsAsRead();
            });
            const mobileBell = document.getElementById('notification-bell-btn-mobile');
            if (mobileBell) {
                mobileBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const mobileDot = document.getElementById('notification-dot-mobile');
                    if (mobileDot) mobileDot.classList.add('hidden');
                    openModal('notificationModal');
                });
            }
            document.getElementById('nav-dashboard').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö';
                e.preventDefault(); updateNavActiveState('dashboard');
                fetchDashboardTasks(); fetchTaskStats();
            });
            document.getElementById('nav-mytasks').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = '‡∏ú‡∏π‡πâ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
                e.preventDefault(); updateNavActiveState('mytasks');
                fetchMyTasks();
            });
            document.getElementById('nav-admin').addEventListener('click', (e) => {
                e.preventDefault(); updateNavActiveState('admin');
                fetchAllUsersForTable();
            });

            // (*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π Import ***)
            document.getElementById('nav-import').addEventListener('click', (e) => {
                e.preventDefault();
                updateNavActiveState('import');
                fetchImportRequests(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á)
            });

            // (*** ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π Deposit ***)
            document.getElementById('nav-Storefront_deposit').addEventListener('click', (e) => {
                e.preventDefault();
                updateNavActiveState('deposit'); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á
                fetchDeposits(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            });

            // Company Change Listener
            document.getElementById('company-select').addEventListener('change', () => {
                if (currentView === 'dashboard') {
                    fetchNotifications(); fetchDashboardTasks(); fetchTaskStats(); fetchAllUsers();
                } else if (currentView === 'admin') {
                    fetchAllUsersForTable();
                } else if (currentView === 'deposit') { // (*** ‡πÄ‡∏û‡∏¥‡πà‡∏° ***)
                    fetchDeposits(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                }
            });

            document.getElementById('user-company-input').addEventListener('change', () => {
                loadManagersForDropdown();
            });

            const branchFilterSelect = document.getElementById('deposit-filter-branch');
            const statusFilterSelect = document.getElementById('deposit-filter-status'); // (*** New Filter ***)

            if (branchFilterSelect) {
                branchFilterSelect.addEventListener('change', () => {
                    fetchDeposits();
                });
            }

            if (statusFilterSelect) {
                statusFilterSelect.addEventListener('change', () => {
                    fetchDeposits();
                });
            }

            const depositDateFilter = document.getElementById('deposit-filter-date');
            if (depositDateFilter) {
                depositDateFilter.addEventListener('change', () => {
                    fetchDeposits();
                });
            }

            const depositSearchInput = document.getElementById('deposit-search-input');
            if (depositSearchInput) {
                depositSearchInput.addEventListener('keyup', () => {
                    fetchDeposits();
                });
            }

            // (*** New Listener: Deposit Due Button ***)
            const depositBellBtn = document.getElementById('btn-filter-due-today');
            if (depositBellBtn) {
                depositBellBtn.addEventListener('click', () => {
                    // Toggle Active state
                    if (depositBellBtn.classList.contains('active-bell')) {
                        depositBellBtn.classList.remove('active-bell');
                        depositBellBtn.classList.remove('ring-2', 'ring-offset-2', 'ring-red-400');
                    } else {
                        depositBellBtn.classList.add('active-bell');
                        depositBellBtn.classList.add('ring-2', 'ring-offset-2', 'ring-red-400');
                    }
                    fetchDeposits();
                });
            }

            // (‡πÄ‡∏™‡∏£‡∏¥‡∏°) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Staff ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏™‡∏≤‡∏Ç‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
            if (typeof currentUser !== 'undefined' && currentUser && currentUser.role === 'staff') {
                const container = document.getElementById('filter-branch-container');
                if (container) container.style.display = 'none';
            }

            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');

            if (menuToggle && sidebar && overlay) {
                const toggleMenu = () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('hidden');
                };
                menuToggle.addEventListener('click', toggleMenu);
                overlay.addEventListener('click', toggleMenu);

                // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå
                document.querySelectorAll('#nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 768px)
                        if (window.innerWidth < 768) {
                            toggleMenu();
                        }
                    });
                });
            }



            function renderStockRequestList(requests) {
                const container = document.getElementById('stock-request-table-body');
                if (!container) return;
                container.innerHTML = '';


                if (requests.length === 0) {
                    container.innerHTML = `<tr><td colspan="6" class="px-8 py-20 text-center">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-slate-200">
                                <ion-icon name="file-tray-outline" class="text-4xl"></ion-icon>
                            </div>
                            <p class="text-slate-400 font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                        </div>
                    </td></tr>`;
                    return;
                }

                requests.forEach(req => {
                    const date = new Date(req.createdAt).toLocaleDateString('th-TH', {
                        day: '2-digit', month: 'short', year: '2-digit'
                    });
                    const itemsText = req.items.map(i => `<div class="flex justify-between items-center gap-4 py-1.5 border-b border-slate-50 last:border-0"><span class="font-bold text-slate-700">${i.productName}</span><span class="text-indigo-600 font-black px-2 py-0.5 bg-indigo-50 rounded-lg text-[10px]">${i.quantity}</span></div>`).join('');

                    const statusConfig = {
                        'pending': { class: 'bg-amber-50 text-amber-700 ring-1 ring-amber-200', text: '‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á', icon: 'time-outline' },
                        'processing': { class: 'bg-blue-50 text-blue-700 ring-1 ring-blue-200', text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á', icon: 'cart-outline' },
                        'received': { class: 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200', text: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß', icon: 'checkmark-circle-outline' },
                        'canceled': { class: 'bg-rose-50 text-rose-700 ring-1 ring-rose-200', text: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', icon: 'close-circle-outline' }
                    };
                    const config = statusConfig[req.status] || statusConfig['pending'];

                    const tr = document.createElement('tr');
                    tr.className = "group hover:bg-white hover:shadow-xl hover:shadow-indigo-500/5 transition-all duration-300 border-b border-slate-100 last:border-0 bg-slate-50/20";
                    tr.innerHTML = `
                        <td class="px-8 py-6 align-top">
                            <div class="flex flex-col">
                                <span class="text-sm font-black text-slate-800 font-mono">${date}</span>
                                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">Order Date</span>
                            </div>
                        </td>
                        <td class="px-8 py-6 align-top min-w-[300px]">
                            <div class="mb-3">
                                <span class="text-sm font-black text-indigo-700 flex items-center gap-2">
                                    <ion-icon name="pricetag" class="text-indigo-400"></ion-icon>
                                    ${req.title || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}
                                </span>
                            </div>
                            <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm leading-relaxed">
                                ${itemsText}
                            </div>
                            <div class="flex items-center gap-2 text-[10px] font-black text-slate-400 bg-slate-100/50 w-fit px-3 py-1.5 rounded-xl mt-3">
                                <ion-icon name="person-circle-outline" class="text-sm"></ion-icon>
                                <span>CREATED BY: <span class="text-slate-800 underline underline-offset-2">${req.createdBy?.name || '-'}</span></span>
                            </div>
                        </td>
                        <td class="px-8 py-6 align-top w-40">
                             <span class="inline-flex items-center gap-1.5 px-4 py-2 rounded-2xl text-[11px] font-black shadow-sm ${config.class} transform group-hover:scale-105 transition-transform">
                                <ion-icon name="${config.icon}" class="text-sm"></ion-icon>
                                ${config.text}
                            </span>
                        </td>
                        <td class="px-8 py-6 align-top w-48">
                            ${req.expectedArrivalDate ? `
                                <div class="flex flex-col">
                                    <div class="flex items-center gap-2 text-sm font-black text-slate-800 font-mono">
                                        <ion-icon name="flag" class="text-orange-500"></ion-icon>
                                        ${new Date(req.expectedArrivalDate).toLocaleDateString('th-TH', { day: '2-digit', month: 'short' })}
                                    </div>
                                    <div class="text-[10px] text-orange-600 bg-orange-50 px-2.5 py-1 rounded-full w-fit mt-1.5 border border-orange-100 font-black tracking-widest uppercase">Expected</div>
                                </div>
                            ` : '<span class="text-slate-300 text-xs font-bold italic">Checking...</span>'}
                        </td>
                        <td class="px-8 py-6 align-top text-right w-20">
                            ${req.status === 'pending' ? `
                                <button onclick="deleteStockRequest('${req._id}')" class="p-3 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-2xl transition-all active:scale-90" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                                    <ion-icon name="trash-outline" class="text-xl"></ion-icon>
                                </button>
                            ` : ''}
                        </td>
                    `;
                    container.appendChild(tr);
                });
            }

            // Global Set to store discovered branches


            window.fetchStockRequests = async function () {
                try {
                    const branch = document.getElementById('stock-request-branch-filter')?.value || '';
                    const status = document.getElementById('stock-request-status-filter')?.value || '';
                    const url = new URL(`${window.location.origin}${SERVER_URL}/stock-requests`);
                    if (branch) url.searchParams.append('branch', branch);
                    if (status) url.searchParams.append('status', status);

                    const res = await fetch(url.toString(), {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        const requests = await res.json();
                        renderStockRequestList(requests);
                    }
                } catch (err) { console.error(err); }
            };

            window.fetchManageStockRequests = async function () {
                try {
                    const status = document.getElementById('manage-request-status-filter')?.value || '';
                    const branch = document.getElementById('manage-request-branch-filter')?.value || '';
                    const url = new URL(`${window.location.origin}${SERVER_URL}/stock-requests/manage`);
                    if (status) url.searchParams.append('status', status);
                    if (branch) url.searchParams.append('branch', branch);

                    const res = await fetch(url.toString(), {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        const requests = await res.json();
                        renderManageStockRequestList(requests);
                    }
                } catch (err) { console.error('Fetch manage requests error:', err); }
            };

            function renderManageStockRequestList(requests) {
                const container = document.getElementById('stock-request-manage-table-body');
                if (!container) return;
                container.innerHTML = '';


                if (requests.length === 0) {
                    container.innerHTML = `<tr><td colspan="6" class="px-8 py-20 text-center">
                        <div class="flex flex-col items-center gap-3">
                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-slate-200">
                                <ion-icon name="file-tray-outline" class="text-4xl"></ion-icon>
                            </div>
                            <p class="text-slate-400 font-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ</p>
                        </div>
                    </td></tr>`;
                    return;
                }

                requests.forEach(req => {
                    const date = new Date(req.createdAt).toLocaleDateString('th-TH', {
                        day: '2-digit', month: 'short', year: '2-digit'
                    });
                    const itemsText = req.items.map(i => `<div class="flex justify-between items-center gap-4 py-1.5 border-b border-slate-50 last:border-0"><span class="font-bold text-slate-700">${i.productName}</span><span class="text-indigo-600 font-black px-2 py-0.5 bg-indigo-50 rounded-lg text-[10px]">${i.quantity}</span></div>`).join('');

                    const statusConfig = {
                        'pending': { class: 'bg-amber-50 text-amber-700 ring-1 ring-amber-200', text: '‡∏£‡∏≠‡∏™‡∏±‡πà‡∏á', icon: 'time-outline' },
                        'processing': { class: 'bg-blue-50 text-blue-700 ring-1 ring-blue-200', text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡∏≠‡∏á', icon: 'cart-outline' },
                        'received': { class: 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200', text: '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', icon: 'checkmark-circle-outline' },
                        'canceled': { class: 'bg-rose-50 text-rose-700 ring-1 ring-rose-200', text: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', icon: 'close-circle-outline' }
                    };
                    const config = statusConfig[req.status] || statusConfig['pending'];

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-indigo-50/20 transition-all duration-300 group border-b border-slate-100 last:border-0";
                    tr.innerHTML = `
                        <td class="px-8 py-6 align-top">
                            <div class="flex flex-col">
                                <span class="text-sm font-black text-slate-800 font-mono">${date}</span>
                            </div>
                        </td>
                        <td class="px-8 py-6 align-top">
                           <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-100 shrink-0">
                                    <ion-icon name="person" class="text-lg"></ion-icon>
                                </div>
                                <div>
                                    <div class="text-sm font-black text-slate-800">${req.createdBy?.name || 'Unknown'}</div>
                                    <div class="flex items-center gap-1.5 text-xs text-slate-500 font-bold mt-1">
                                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                        ${req.branch || '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà'}
                                    </div>
                                </div>
                           </div>
                        </td>
                        <td class="px-8 py-6 align-top min-w-[300px]">
                            <div class="mb-3">
                                <span class="text-sm font-black text-indigo-700 flex items-center gap-2">
                                    <ion-icon name="pricetag" class="text-indigo-400"></ion-icon>
                                    ${req.title || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}
                                </span>
                            </div>
                            <div class="bg-slate-50/50 rounded-2xl p-4 border border-slate-100 shadow-inner group-hover:bg-white transition-colors">
                                ${itemsText}
                            </div>
                            ${req.note ? `<div class="mt-3 text-[11px] text-slate-500 leading-relaxed italic bg-amber-50/50 p-2 rounded-lg border border-amber-100 flex gap-2"><ion-icon name="chatbox-outline" class="text-amber-400 mt-0.5 shrink-0"></ion-icon><span>${req.note}</span></div>` : ''}
                        </td>
                        <td class="px-8 py-6 align-top">
                            <span class="inline-flex items-center gap-1.5 px-4 py-2 rounded-2xl text-[11px] font-black shadow-sm ${config.class} transform group-hover:scale-105 transition-transform">
                                <ion-icon name="${config.icon}" class="text-sm"></ion-icon>
                                ${config.text}
                            </span>
                        </td>
                        <td class="px-8 py-6 align-top">
                            ${req.expectedArrivalDate ? `
                                <div class="flex flex-col">
                                    <div class="flex items-center gap-2 text-sm font-black text-slate-800 font-mono">
                                        <ion-icon name="airplane-outline" class="text-orange-500 rotate-45"></ion-icon>
                                        ${new Date(req.expectedArrivalDate).toLocaleDateString('th-TH', { day: '2-digit', month: 'short' })}
                                    </div>
                                    <span class="text-[10px] text-orange-600 font-black uppercase tracking-wider mt-1">Expected</span>
                                </div>
                            ` : '<span class="text-slate-300 text-xs font-bold italic">N/A</span>'}
                        </td>
                        <td class="px-8 py-6 align-top text-right">
                            <button onclick='openManageRequestModal(${JSON.stringify(req)})' 
                                class="inline-flex items-center gap-2.5 px-5 py-3 bg-white border border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 text-slate-600 hover:text-indigo-700 rounded-2xl text-xs font-black transition-all shadow-sm hover:shadow-xl active:scale-95 group/btn">
                                <ion-icon name="options-outline" class="text-lg group-hover/btn:rotate-180 transition-transform duration-500"></ion-icon>
                                <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span>
                            </button>
                        </td>
                    `;
                    container.appendChild(tr);
                });
            }

            window.openStockRequestModal = function () {
                const titleInput = document.getElementById('stock-request-title');
                const noteInput = document.getElementById('stock-request-note');
                if (titleInput) titleInput.value = '';
                if (noteInput) noteInput.value = '';

                document.getElementById('stock-request-items-container').innerHTML = '';
                addStockRequestItemRow();
                openModal('stockRequestModal');
            };

            window.addStockRequestItemRow = function () {
                const container = document.getElementById('stock-request-items-container');
                const rowId = `request-row-${Date.now()}`;
                const div = document.createElement('div');
                div.id = rowId;
                div.className = "grid grid-cols-12 gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100 animate-fade-in";
                div.innerHTML = `
                    <div class="col-span-8">
                        <input type="text" class="request-item-name form-input-theme w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." required>
                    </div>
                    <div class="col-span-3">
                        <input type="number" class="request-item-qty form-input-theme w-full text-center" value="1" min="1" required>
                    </div>
                    <div class="col-span-1 flex items-center justify-center">
                        <button type="button" onclick="removeStockRequestItemRow('${rowId}')" class="text-slate-300 hover:text-red-500 transition-colors">
                            <ion-icon name="close-circle" class="text-xl"></ion-icon>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            };

            window.removeStockRequestItemRow = function (id) {
                const row = document.getElementById(id);
                if (row) row.remove();
                if (document.getElementById('stock-request-items-container').children.length === 0) {
                    addStockRequestItemRow();
                }
            };

            window.submitStockRequest = async function () {
                const title = document.getElementById('stock-request-title').value;
                const rows = document.querySelectorAll('#stock-request-items-container > div');
                const items = Array.from(rows).map(row => ({
                    name: row.querySelector('.request-item-name').value,
                    quantity: parseInt(row.querySelector('.request-item-qty').value)
                }));
                const note = document.getElementById('stock-request-note').value;

                if (!title) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

                try {
                    const res = await fetch(`${SERVER_URL}/stock-requests`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ title, items, note })
                    });
                    if (res.ok) {
                        alert('‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        closeModal('stockRequestModal');
                        fetchStockRequests();
                    }
                } catch (err) { alert('Error: ' + err.message); }
            };

            let currentManagingRequestId = null;
            window.openManageRequestModal = function (req) {
                currentManagingRequestId = req._id;
                document.getElementById('manage-request-status').value = req.status;

                const itemsContainer = document.getElementById('manage-request-items-list');
                if (itemsContainer) {
                    if (req.items && req.items.length > 0) {
                        itemsContainer.innerHTML = `
                            <div class="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 ml-1">
                                <ion-icon name="list-outline" class="text-sm"></ion-icon>
                                ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                            </div>
                            <div class="bg-white/50 rounded-3xl border border-slate-200/60 overflow-hidden shadow-sm">
                                ${req.items.map(item => `
                                    <div class="flex justify-between items-center px-5 py-4 border-b border-slate-100 last:border-0 hover:bg-white transition-colors">
                                        <div class="flex flex-col">
                                            <span class="font-black text-slate-800 text-sm">${item.productName}</span>
                                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Product Name</span>
                                        </div>
                                        <div class="flex flex-col items-end">
                                            <span class="font-black text-indigo-600 text-base">${item.quantity}</span>
                                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Qty</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        itemsContainer.innerHTML = `
                            <div class="text-center py-8 bg-slate-100/50 rounded-3xl border border-dashed border-slate-200">
                                <ion-icon name="alert-circle-outline" class="text-3xl text-slate-300 mb-2"></ion-icon>
                                <p class="text-slate-400 font-bold text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                            </div>
                        `;
                    }
                }

                if (req.expectedArrivalDate) {
                    const date = new Date(req.expectedArrivalDate).toISOString().split('T')[0];
                    document.getElementById('manage-request-arrival').value = date;
                } else {
                    document.getElementById('manage-request-arrival').value = '';
                }
                openModal('manageRequestModal');
            };

            window.updateRequestStatus = async function () {
                const status = document.getElementById('manage-request-status').value;
                const expectedArrival = document.getElementById('manage-request-arrival').value;

                try {
                    const res = await fetch(`${SERVER_URL}/stock-requests/${currentManagingRequestId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ status, expectedArrival })
                    });
                    if (res.ok) {
                        alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        closeModal('manageRequestModal');
                        fetchManageStockRequests();
                    }
                } catch (err) { alert('Error: ' + err.message); }
            };

            window.deleteStockRequest = async function (id) {
                if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏ô‡∏µ‡πâ?')) return;
                try {
                    const res = await fetch(`${SERVER_URL}/stock-requests/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        fetchStockRequests();
                    }
                } catch (err) { alert('Error: ' + err.message); }
            };

            // --- Event Listeners for Stock Requests ---
            const navStockRequest = document.getElementById('nav-stock-request');
            if (navStockRequest) {
                navStockRequest.addEventListener('click', (e) => {
                    e.preventDefault();
                    updateNavActiveState('stock-request');
                    fetchStockRequests();
                });
            }

            const navStockRequestManage = document.getElementById('nav-stock-request-manage');
            if (navStockRequestManage) {
                navStockRequestManage.addEventListener('click', (e) => {
                    e.preventDefault();
                    updateNavActiveState('stock-request-manage');
                    fetchManageStockRequests();
                });
            }

            const manageStatusFilter = document.getElementById('manage-request-status-filter');
            if (manageStatusFilter) {
                manageStatusFilter.addEventListener('change', fetchManageStockRequests);
            }

            const manageBranchFilter = document.getElementById('manage-request-branch-filter');
            if (manageBranchFilter) {
                manageBranchFilter.addEventListener('change', fetchManageStockRequests);
            }

            const stockStatusFilter = document.getElementById('stock-request-status-filter');
            if (stockStatusFilter) {
                stockStatusFilter.addEventListener('change', fetchStockRequests);
            }

            const stockBranchFilter = document.getElementById('stock-request-branch-filter');
            if (stockBranchFilter) {
                stockBranchFilter.addEventListener('change', fetchStockRequests);
            }

            const purForm = document.getElementById('purchasing-form');
            if (purForm) {
                purForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const token = localStorage.getItem('token');
                    const id = document.getElementById('pur-id').value;
                    const companyId = document.getElementById('company-select').value;

                    try {
                        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢)
                        const resGet = await fetch(`${SERVER_URL}/deposits?companyId=${companyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const allDeposits = await resGet.json();
                        const oldData = allDeposits.find(d => d._id === id);

                        if (!oldData) {
                            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°');
                            return;
                        }

                        // 2. ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà
                        const payload = {
                            ...oldData, // ‡πÅ‡∏ú‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
                            id: oldData._id, // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ id ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Backend ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ***
                            orderStatus: document.getElementById('pur-status').value,
                            orderNote: document.getElementById('pur-note').value,
                            expectedArrivalDate: document.getElementById('pur-arrival-date').value // ‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                        };

                        // 3. ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        const res = await fetch(`${SERVER_URL}/deposits`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            closeModal('purchasingModal');
                            fetchPurchasingOrders(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        } else {
                            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        }
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                });
            }


        });

        // Modal Control
        function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // (*** New: Import System Functions ***)
        function switchImportTab(type) {
            const phoneSection = document.getElementById('tab-import-phone');
            const accSection = document.getElementById('tab-import-accessory');
            const phoneBtn = document.getElementById('tab-btn-phone');
            const accBtn = document.getElementById('tab-btn-accessory');

            if (type === 'phone') {
                safeShow(phoneSection);
                safeHide(accSection);

                phoneBtn.classList.remove('text-slate-500', 'hover:bg-slate-50');
                phoneBtn.classList.add('bg-yellow-400', 'text-slate-900', 'shadow-md', 'shadow-yellow-400/30');

                accBtn.classList.add('text-slate-500', 'hover:bg-slate-50');
                accBtn.classList.remove('bg-slate-800', 'text-white', 'shadow-md');
            } else {
                safeHide(phoneSection);
                safeShow(accSection);

                accBtn.classList.remove('text-slate-500', 'hover:bg-slate-50');
                accBtn.classList.add('bg-slate-900', 'text-white', 'shadow-md', 'shadow-slate-900/20');

                phoneBtn.classList.add('text-slate-500', 'hover:bg-slate-50');
                phoneBtn.classList.remove('bg-yellow-400', 'text-slate-900', 'shadow-md', 'shadow-yellow-400/30');
            }
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const placeholder = document.getElementById('image-preview-placeholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
        let allImportsData = [];

        async function fetchImportRequests() {
            console.log("--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Import ---");

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Element ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î" (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ ID ‡∏Ç‡∏≠‡∏á loading spinner ‡∏ñ‡πâ‡∏≤‡∏ó‡∏£‡∏≤‡∏ö ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Token! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà');
                    window.location.href = 'login.html';
                    return;
                }

                // *** ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏ó‡∏µ‡πà 1: URL ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ /api/imports ***
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ SERVER_URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ /api ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏•‡∏ö /api ‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å
                const targetUrl = `${SERVER_URL}/imports?limit=100`;
                console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å URL:", targetUrl);

                const res = await fetch(targetUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log("Status Code:", res.status);

                if (!res.ok) {
                    const errText = await res.text();
                    console.error("Server Error:", errText);

                    if (res.status === 401) {
                        alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                        window.location.href = 'login.html';
                    } else if (res.status === 404) {
                        alert(`‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (404) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ URL: ${targetUrl}`);
                    } else {
                        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å Server (${res.status}): ${errText}`);
                    }
                    return;
                }

                const responseData = await res.json();
                console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:", responseData);

                // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏™‡∏°‡∏≠
                if (Array.isArray(responseData)) {
                    allImportsData = responseData;
                } else if (responseData.data && Array.isArray(responseData.data)) {
                    allImportsData = responseData.data;
                } else {
                    console.warn("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:", responseData);
                    allImportsData = [];
                }

                // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÉ‡∏™‡πà Try-Catch ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡πÑ‡∏ß‡πâ)
                try {
                    if (typeof renderImportLists === 'function') {
                        renderImportLists();
                        console.log("‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    } else {
                        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 'renderImportLists' ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì!");
                    }
                } catch (renderError) {
                    console.error("Error ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (renderImportLists):", renderError);
                    alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: " + renderError.message);
                }

            } catch (e) {
                console.error("Fetch Error:", e);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + e.message);
            }
        }

        function renderImportLists() {
            const searchInput = document.getElementById('import-filter-search');
            // Check if element exists to avoid error if HTML update failed
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';

            const statusInput = document.getElementById('import-filter-status');
            const statusFilter = statusInput ? statusInput.value : 'all';

            // Filter Data
            const filteredData = allImportsData.filter(item => {
                const s = item.status || 'pending';
                const statusMatch = statusFilter === 'all' || s === statusFilter;

                // Search: Supplier, Branch, Description, Type
                const supplier = (item.details?.supplier || '').toLowerCase();
                const branch = (item.branch || '').toLowerCase();
                const desc = (item.details?.description || item.details?.note || '').toLowerCase();
                const type = item.type.toLowerCase();

                const searchMatch = !searchText ||
                    supplier.includes(searchText) ||
                    branch.includes(searchText) ||
                    desc.includes(searchText) ||
                    type.includes(searchText);

                return statusMatch && searchMatch;
            });

            // Update Count
            const countDisplay = document.getElementById('import-count-display');
            if (countDisplay) countDisplay.textContent = `‡∏û‡∏ö ${filteredData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            // 1. Phone List
            const phoneList = document.getElementById('phone-import-list');
            if (phoneList) {
                phoneList.innerHTML = '';
                const phoneItems = filteredData.filter(d => d.type === 'phone');
                if (phoneItems.length === 0) {
                    phoneList.innerHTML = `<tr><td colspan="7" class="px-6 py-10 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;
                } else {
                    phoneItems.forEach(item => {
                        const dateStr = new Date(item.createdAt).toLocaleDateString('th-TH');
                        const fileCount = item.files ? item.files.length : 0;

                        let fileName = '-';
                        if (fileCount > 0) {
                            fileName = `<div class="flex flex-col gap-1">`;
                            item.files.forEach((rawPath, idx) => {
                                const finalUrl = rawPath.startsWith('http') ? rawPath : `${SERVER_URL.replace('/api', '')}/${rawPath}`;
                                const isExcel = rawPath.toLowerCase().endsWith('.xlsx') || rawPath.toLowerCase().endsWith('.xls');
                                const icon = isExcel ? 'document-text' : 'image';
                                const label = isExcel ? 'Excel' : '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';

                                fileName += `
                            <a href="${finalUrl}" target="_blank" class="text-indigo-500 font-bold hover:underline flex items-center gap-1 text-xs">
                                <ion-icon name="${icon}"></ion-icon> ${label}
                            </a>`;
                            });
                            fileName += `</div>`;
                        }
                        const branch = item.branch || '-';
                        const createdBy = item.createdBy ? item.createdBy.name : '-';
                        const details = item.details || {};
                        const supplier = details.supplier || '-';
                        const desc = details.description || '-';

                        let statusBadge = `<span class="px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-xs font-bold cursor-pointer hover:bg-slate-200 transition-colors" onclick="updateImportAction('${item._id}', '${item.status}')">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö <ion-icon name="create-outline"></ion-icon></span>`;
                        if (item.status === 'pending') statusBadge = `<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold ring-1 ring-yellow-200 cursor-pointer hover:bg-yellow-200 transition-colors" onclick="updateImportAction('${item._id}', '${item.status}')">‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ <ion-icon name="create-outline"></ion-icon></span>`;
                        else if (item.status === 'importing') statusBadge = `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold ring-1 ring-blue-200 cursor-pointer hover:bg-blue-200 transition-colors" onclick="updateImportAction('${item._id}', '${item.status}')">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ <ion-icon name="create-outline"></ion-icon></span>`;
                        else if (item.status === 'received') statusBadge = `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold ring-1 ring-green-200 cursor-pointer hover:bg-green-200 transition-colors" onclick="updateImportAction('${item._id}', '${item.status}')">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à <ion-icon name="create-outline"></ion-icon></span>`;

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50 transition-all border-b border-slate-100 last:border-0";
                        tr.innerHTML = `
                            <td class="px-6 py-4 text-sm font-bold text-slate-600">${dateStr}</td>
                            <td class="px-6 py-4 text-sm">${fileName}</td>
                            <td class="px-6 py-4 text-sm text-slate-600">
                                <span class="font-bold text-slate-800">${supplier}</span>
                                ${desc !== '-' ? `<div class="text-xs text-slate-400 mt-1">${desc}</div>` : ''}
                            </td>
                            <td class="px-6 py-4 text-sm font-bold text-slate-700">${branch}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-sm text-slate-500">${createdBy}</td>
                            <td class="px-6 py-4 text-sm text-right">
                                <button onclick="deleteImportRequest('${item._id}')" class="text-slate-300 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50">
                                    <ion-icon name="trash" class="text-lg"></ion-icon>
                                </button>
                            </td>
                        `;
                        phoneList.appendChild(tr);
                    });
                }
            }

            // 2. Accessory List
            const accList = document.getElementById('accessory-import-list');
            if (accList) {
                accList.innerHTML = '';
                const accItems = filteredData.filter(d => d.type === 'accessory' || d.type === 'accessories');
                if (accItems.length === 0) {
                    accList.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Accessory</div>`;
                } else {
                    accItems.forEach(item => {
                        const details = item.details || {};
                        // (*** Fix: Handle Absolute Cloudinary URLs ***)
                        let imgUrl = null;
                        if (item.files && item.files.length > 0) {
                            const rawPath = item.files[0];
                            if (rawPath.startsWith('http')) {
                                imgUrl = rawPath; // Use absolute URL (Cloudinary)
                            } else {
                                imgUrl = `${SERVER_URL.replace('/api', '')}/${rawPath}`; // Use local path
                            }
                        }

                        let statusBadge = `bg-slate-100 text-slate-400`;
                        let statusText = item.status;
                        if (item.status === 'pending') { statusBadge = `bg-yellow-100 text-yellow-700 ring-1 ring-yellow-200`; statusText = '‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'; }
                        else if (item.status === 'importing') { statusBadge = `bg-blue-100 text-blue-700 ring-1 ring-blue-200`; statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'; }
                        else if (item.status === 'received') { statusBadge = `bg-green-100 text-green-700 ring-1 ring-green-200`; statusText = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; }

                        let nameDisplay = details.productName || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';

                        // (*** New: Use Bill Name if available ***)
                        if (details.billName) {
                            nameDisplay = details.billName;
                        }

                        // Only construct from items if billName is missing
                        if (!details.billName && details.items && details.items.length > 0) {
                            if (details.items.length === 1) {
                                nameDisplay = details.items[0].productName;
                                qtyDisplay = details.items[0].quantity;
                                descDisplay = details.items[0].note || '-';
                            } else {
                                nameDisplay = `${details.items[0].productName} <span class="text-slate-400 font-normal text-xs">+${details.items.length - 1} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`;
                                const totalQty = details.items.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0);
                                qtyDisplay = totalQty;
                                descDisplay = details.items.map(i => `${i.productName} (x${i.quantity})`).join(', ');
                            }
                        } else if (details.items && details.items.length > 0) {
                            // Correct calculation for Qty/Desc even if Bill Name is used
                            const totalQty = details.items.reduce((sum, i) => sum + (Number(i.quantity) || 0), 0);
                            qtyDisplay = totalQty;
                            descDisplay = details.items.map(i => `${i.productName} (x${i.quantity})`).join(', ');
                        }

                        const card = document.createElement('div');
                        card.className = "bg-white border border-slate-100 rounded-2xl p-4 flex gap-4 hover:shadow-lg transition-all group relative overflow-hidden";
                        card.innerHTML = `
                            <div class="w-24 h-24 rounded-xl bg-slate-50 flex-shrink-0 flex items-center justify-center overflow-hidden border border-slate-100 relative group-hover:border-yellow-400 transition-colors">
                                ${imgUrl ? `<img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">` : `<ion-icon name="receipt-outline" class="text-3xl text-slate-300"></ion-icon>`}
                            </div>
                            <div class="flex-1 min-w-0 flex flex-col justify-between py-1 relative z-10">
                                <div>
                                    <div class="flex justify-between items-start">
                                        <h5 class="font-bold text-slate-800 text-sm truncate pr-2 w-full" title="${descDisplay}">${nameDisplay}</h5>
                                         <button onclick="deleteImportRequest('${item._id}')" class="absolute top-0 right-0 text-slate-300 hover:text-red-500 transition-colors bg-white/80 p-1 rounded-full backdrop-blur-sm opacity-0 group-hover:opacity-100">
                                            <ion-icon name="trash"></ion-icon>
                                        </button>
                                    </div>
                                    <div class="flex items-center gap-2 mt-1 cursor-pointer hover:opacity-80 transition-opacity" onclick="updateImportAction('${item._id}', '${item.status}')">
                                        <span class="px-2 py-0.5 rounded-md text-[10px] font-bold ${statusBadge}">${statusText} <ion-icon name="create-outline" class="text-xs"></ion-icon></span>
                                        ${details.supplier ? `<span class="text-[10px] text-slate-400 flex items-center gap-1"><ion-icon name="storefront"></ion-icon> ${details.supplier}</span>` : ''}
                                    </div>
                                    <p class="text-xs text-slate-500 mt-2 line-clamp-1">${descDisplay}</p>
                                </div>
                                <div class="flex justify-between items-end mt-2 border-t border-slate-50 pt-2">
                                    <p class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded-lg font-bold">‡∏£‡∏ß‡∏° ${qtyDisplay} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                                    <p class="text-[10px] text-slate-400 flex items-center gap-1"><ion-icon name="calendar-outline"></ion-icon> ${new Date(item.details.importDate || item.createdAt).toLocaleDateString('th-TH')}</p>
                                </div>
                            </div>
                        `;
                        accList.appendChild(card);
                    });
                }
            }
        }

        async function updateImportAction(id, currentStatus) {
            const nextMap = { 'pending': 'importing', 'importing': 'received', 'received': 'pending' };
            const next = nextMap[currentStatus] || 'pending';
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å "${currentStatus}" ‡πÄ‡∏õ‡πá‡∏ô "${next}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                try {
                    const res = await fetch(`${SERVER_URL}/imports/${id}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                        body: JSON.stringify({ status: next })
                    });
                    if (res.ok) {
                        const updated = await res.json();
                        const index = allImportsData.findIndex(i => i._id === id);
                        if (index !== -1) allImportsData[index].status = updated.status;
                        renderImportLists();
                    } else { alert('Update Failed'); }
                } catch (e) { alert('Error: ' + e.message); }
            }
        }

        async function deleteImportRequest(id) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
                try {
                    const res = await fetch(`${SERVER_URL}/imports/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (res.ok) {
                        // If it exists in Notification view cache
                        if (typeof allImportsData !== 'undefined') {
                            allImportsData = allImportsData.filter(i => i._id !== id);
                            if (typeof renderImportLists === 'function') renderImportLists();
                        }
                        // Refresh Stock Management View
                        if (typeof fetchStockImports === 'function') fetchStockImports();
                    } else {
                        const errData = await res.json().catch(() => ({}));
                        alert('Delete Failed: ' + (errData.message || res.statusText));
                    }
                } catch (e) { alert('Error: ' + e.message); }
            }
        }


        // (*** New: Open Acc Modal ***)
        function openAccessoryImportModal() {
            // Reset
            const form = document.getElementById('accessory-import-form-multi');
            if (form) form.reset();

            const container = document.getElementById('acc-items-container');
            if (container) container.innerHTML = ''; // Clear items

            const emptyState = document.getElementById('acc-items-empty');
            if (emptyState) emptyState.classList.remove('hidden');

            // Preview Image Reset
            const imgPreview = document.getElementById('image-preview');
            const imgPlaceholder = document.getElementById('image-preview-placeholder');
            if (imgPreview) {
                imgPreview.classList.add('hidden');
                imgPreview.src = '';
            }
            if (imgPlaceholder) imgPlaceholder.classList.remove('hidden');

            // Set Default Date
            const dateInput = document.getElementById('acc-bill-date');
            if (dateInput) dateInput.valueAsDate = new Date();

            const countDisplay = document.getElementById('acc-total-items-count');
            if (countDisplay) countDisplay.textContent = '0';

            openModal('accImportModal');
            // Add first row by default (optional, user might want to see empty state first, but let's add one)
            addAccessoryItemRow();
        }

        // (*** New: Add Item Row ***)
        function addAccessoryItemRow() {
            const emptyState = document.getElementById('acc-items-empty');
            if (emptyState) emptyState.classList.add('hidden');

            const container = document.getElementById('acc-items-container');
            const rowId = 'acc-row-' + Date.now();

            const div = document.createElement('div');
            div.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-start md:items-center animate-fade-in group";
            div.id = rowId;
            div.innerHTML = `
                <div class="flex-1 w-full">
                    <input type="text" name="acc-item-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏π‡∏ü‡∏±‡∏á, ‡∏Å‡∏£‡∏∞‡∏à‡∏Å)" class="form-input-theme w-full" required>
                </div>
                <div class="w-24">
                    <input type="number" name="acc-item-qty" value="1" min="1" class="form-input-theme w-full text-center" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required>
                </div>
                <div class="flex-1 w-full">
                    <input type="text" name="acc-item-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" class="form-input-theme w-full">
                </div>
                <button type="button" onclick="removeAccessoryItemRow('${rowId}')" class="text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-all">
                    <ion-icon name="trash-outline" class="text-xl"></ion-icon>
                </button>
            `;
            container.appendChild(div);
            updateAccTotalCount();
        }

        function removeAccessoryItemRow(id) {
            const row = document.getElementById(id);
            if (row) row.remove();

            const container = document.getElementById('acc-items-container');
            if (container.children.length === 0) {
                document.getElementById('acc-items-empty').classList.remove('hidden');
            }
            updateAccTotalCount();
        }

        function updateAccTotalCount() {
            const container = document.getElementById('acc-items-container');
            if (container) {
                const count = container.children.length;
                document.getElementById('acc-total-items-count').textContent = count;
            }
        }

        // (*** New: Submit Multi-Item Import ***)
        async function submitAccessoryImport() {
            const fileInput = document.getElementById('acc-bill-image');
            const date = document.getElementById('acc-bill-date').value;
            const supplier = document.getElementById('acc-bill-supplier').value;
            const billName = document.getElementById('acc-bill-name')?.value || ''; // (*** New: Bill Name ***)

            if (!date) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
            if (!billName) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏¥‡∏•');

            // Collect Items
            const rows = document.getElementById('acc-items-container').children;
            if (rows.length === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

            let items = [];
            for (let row of rows) {
                const name = row.querySelector('[name="acc-item-name"]').value;
                const qty = row.querySelector('[name="acc-item-qty"]').value;
                const desc = row.querySelector('[name="acc-item-desc"]').value;

                if (!name || !qty) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                items.push({
                    productName: name,
                    quantity: Number(qty),
                    note: desc
                });
            }

            const formData = new FormData();
            formData.append('type', 'accessory');
            formData.append('companyId', document.getElementById('company-select').value);
            formData.append('importDate', date); // (*** Fix: Mapped to Model 'importDate' ***)
            if (supplier) formData.append('supplier', supplier);

            const details = {
                supplier,
                billName, // (*** New ***)
                items
            };

            // (*** DEBUG: CHECK PAYLOAD ***)
            alert("Sending Details: " + JSON.stringify(details, null, 2));

            formData.append('details', JSON.stringify(details));

            if (fileInput.files.length > 0) {
                formData.append('files', fileInput.files[0]);
            }

            try {
                const res = await fetch(`${SERVER_URL}/imports`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });

                if (res.ok) {
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    closeModal('accImportModal');
                    fetchImportRequests();
                } else {
                    const err = await res.json();
                    alert('Error: ' + err.message);
                }
            } catch (err) { alert('Error: ' + err.message); }
        }

        // Expose Functions
        window.openAccessoryImportModal = openAccessoryImportModal;
        window.addAccessoryItemRow = addAccessoryItemRow;
        window.removeAccessoryItemRow = removeAccessoryItemRow;
        window.submitAccessoryImport = submitAccessoryImport;

        // (*** New: Open Phone Import Modal ***)
        function openPhoneImportModal() {
            const form = document.getElementById('phone-import-form');
            if (form) form.reset();

            const display = document.getElementById('file-name-display');
            if (display) {
                display.textContent = '';
                display.classList.add('hidden');
                display.classList.remove('inline-block');
            }
            openModal('phoneImportModal');
        }

        // Expose to Window
        window.openPhoneImportModal = openPhoneImportModal;
        window.switchImportTab = switchImportTab;
        window.previewImage = previewImage;
        window.fetchImportRequests = fetchImportRequests;

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
        window.addBranchOrderItemRow = function () {
            const container = document.getElementById('bo-items-container');
            const rowId = 'bo-item-' + Date.now() + Math.random().toString(36).substr(2, 5);

            const div = document.createElement('div');
            div.className = "flex gap-2 items-start animate-fade-in";
            div.id = rowId;
            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" name="bo-product-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="form-input-theme text-sm" required>
                </div>
                <div class="w-24">
                    <input type="number" name="bo-quantity" value="1" min="1" class="form-input-theme text-sm text-center" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required>
                </div>
                <button type="button" onclick="removeBranchOrderItemRow('${rowId}')" class="p-2 text-slate-300 hover:text-red-500 transition-colors">
                    <ion-icon name="trash"></ion-icon>
                </button>
            `;
            container.appendChild(div);
        };

        window.removeBranchOrderItemRow = function (id) {
            const row = document.getElementById(id);
            if (row) row.remove();
        };

        window.openBranchOrderModal = function () {
            document.getElementById('bo-order-name').value = '';
            document.getElementById('bo-order-date').valueAsDate = new Date();
            document.getElementById('bo-expected-date').value = '';

            // Reset Items
            const container = document.getElementById('bo-items-container');
            container.innerHTML = '';
            addBranchOrderItemRow(); // Add first row

            openModal('branchOrderModal');
        };

        window.submitBranchOrder = async function () {
            const orderName = document.getElementById('bo-order-name').value;
            const orderDate = document.getElementById('bo-order-date').value;
            const expectedDate = document.getElementById('bo-expected-date').value;
            const branch = document.getElementById('bo-branch').value;

            const itemRows = document.querySelectorAll('#bo-items-container > div');
            const items = [];
            let isValid = true;

            itemRows.forEach(row => {
                const name = row.querySelector('input[name="bo-product-name"]').value;
                const qty = row.querySelector('input[name="bo-quantity"]').value;
                if (!name || !qty) isValid = false;
                items.push({ productName: name, quantity: Number(qty) });
            });

            if (!orderName || !orderDate || items.length === 0 || !isValid) {
                return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
            }

            try {
                const res = await fetch(`${SERVER_URL}/branch-stock-orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ orderName, orderDate, expectedDate, branch, items })
                });

                if (res.ok) {
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    closeModal('branchOrderModal');
                    fetchBranchOrders();
                } else {
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
            } catch (err) { alert('Error: ' + err.message); }
        };

        window.fetchBranchOrders = async function () {
            const branchFilter = document.getElementById('branch-order-filter-branch').value;
            const statusFilter = document.getElementById('branch-order-filter-status').value;

            let url = `${SERVER_URL}/branch-stock-orders?`;
            if (branchFilter && branchFilter !== 'all') url += `&branch=${branchFilter}`;
            if (statusFilter && statusFilter !== 'all') url += `&status=${statusFilter}`;

            // Add Loading State
            const tbody = document.getElementById('branch-order-table-body');
            if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-500 mx-auto"></div></td></tr>`;

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    renderBranchOrders(data);
                }
            } catch (err) { console.error(err); }
        };

        window.renderBranchOrders = function (orders) {
            const tbody = document.getElementById('branch-order-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-20 text-center">
                            <div class="flex flex-col items-center justify-center space-y-4 animate-fade-in">
                                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center text-slate-300 shadow-inner">
                                    <ion-icon name="search-outline" class="text-5xl"></ion-icon>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-lg font-bold text-slate-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</p>
                                    <p class="text-sm text-slate-400">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
                                </div>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            const canUpdateStatus = (currentUser.department && (currentUser.department.includes('‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠') || currentUser.department.includes('Purchase'))) ||
                ['admin', 'executive', 'manager', 'hr'].includes(currentUser.role);

            orders.forEach((order, index) => {
                const tr = document.createElement('tr');
                tr.className = "group hover:bg-yellow-50/30 transition-all duration-300 border-b border-slate-50 last:border-0 animate-fade-in";

                // Add staggered animation delay
                tr.style.animationDelay = `${index * 50}ms`;

                const dateStr = new Date(order.orderDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const expectStr = order.expectedDate ? new Date(order.expectedDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';

                let statusHTML = '';
                if (canUpdateStatus) {
                    statusHTML = `
                        <div class="relative inline-block text-left">
                            <select onchange="updateBranchOrderStatus('${order._id}', this.value)" 
                                class="appearance-none font-black text-[10px] uppercase tracking-wider px-4 py-1.5 rounded-full border-2 transition-all outline-none cursor-pointer pr-8
                                ${(!order.status || order.status === 'pending') ? 'bg-slate-50 text-slate-500 border-slate-200 hover:border-slate-300' : ''}
                                ${order.status === 'shipped' ? 'bg-amber-50 text-amber-600 border-amber-200 hover:border-amber-300' : ''}
                                ${order.status === 'arrived' ? 'bg-emerald-50 text-emerald-600 border-emerald-200 hover:border-emerald-300' : ''}
                                ${order.status === 'canceled' ? 'bg-red-50 text-red-600 border-red-200 hover:border-red-300' : ''}
                                ">
                                <option value="pending" ${(!order.status || order.status === 'pending') ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>‡∏£‡∏≠‡∏Ç‡∏≠‡∏á</option>
                                <option value="arrived" ${order.status === 'arrived' ? 'selected' : ''}>‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
                                <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                            </select>
                            <div class="absolute right-2.5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                <ion-icon name="chevron-down" class="text-[10px]"></ion-icon>
                            </div>
                        </div>`;
                } else {
                    if (!order.status || order.status === 'pending') {
                        statusHTML = `
                            <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-slate-50 text-slate-500 text-xs font-black border border-slate-200/50 shadow-sm">
                                <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                            </div>`;
                    } else if (order.status === 'shipped') {
                        statusHTML = `
                            <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-amber-50 text-amber-600 text-xs font-black border border-amber-200/50 shadow-sm">
                                <ion-icon name="time-outline" class="mr-1.5 text-sm animate-pulse"></ion-icon>
                                <span>‡∏£‡∏≠‡∏Ç‡∏≠‡∏á</span>
                            </div>`;
                    } else if (order.status === 'arrived') {
                        statusHTML = `
                            <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-50 text-emerald-600 text-xs font-black border border-emerald-200/50 shadow-sm">
                                <ion-icon name="checkmark-circle" class="mr-1.5 text-sm"></ion-icon>
                                <span>‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</span>
                            </div>`;
                    } else if (order.status === 'canceled') {
                        statusHTML = `
                            <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-red-50 text-red-700 text-xs font-black border border-red-200/50 shadow-sm">
                                <ion-icon name="close-circle-outline" class="mr-1.5 text-sm"></ion-icon>
                                <span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏±‡∏ß</span>
                            </div>`;
                    }
                }

                // Handle items display (support both old single-item and new multi-items)
                let productsHTML = '';
                if (order.items && order.items.length > 0) {
                    productsHTML = order.items.map(i => `
                        <div class="flex items-center gap-1.5 mt-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                            <span class="text-xs font-bold text-slate-700">${i.productName}</span>
                            <span class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 ml-1 font-bold">x${i.quantity}</span>
                        </div>
                    `).join('');
                } else if (order.productName) {
                    // Fallback for old data
                    productsHTML = `
                        <div class="flex items-center gap-1.5 mt-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                            <span class="text-xs font-bold text-slate-700">${order.productName}</span>
                            <span class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 ml-1 font-bold">x${order.quantity}</span>
                        </div>`;
                } else {
                    productsHTML = '<div class="text-xs text-slate-400 italic">No items</div>';
                }

                tr.innerHTML = `
                    <td class="px-6 py-5 whitespace-nowrap">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter mb-0.5">Order Date</span>
                            <span class="text-sm font-bold text-slate-600">${dateStr}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5 whitespace-nowrap">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter mb-0.5">Expected</span>
                            <span class="text-sm font-bold text-slate-700 flex items-center gap-1.5">
                                <ion-icon name="time-outline" class="text-slate-400"></ion-icon>
                                ${expectStr}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="text-base font-black text-slate-800 group-hover:text-yellow-600 transition-colors uppercase tracking-tight">${order.orderName}</div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 bg-slate-50 text-slate-400 rounded-xl flex items-center justify-center border border-slate-100 group-hover:border-yellow-200 group-hover:bg-white transition-all shrink-0">
                                <ion-icon name="cube-outline" class="text-xl"></ion-icon>
                            </div>
                            <div class="flex flex-col">
                                ${productsHTML}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-5 text-center">
                        <span class="inline-block px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-[10px] font-black uppercase tracking-widest border border-slate-200/50 group-hover:border-indigo-200 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-all">
                            ${order.branch}
                        </span>
                    </td>
                    <td class="px-6 py-5 text-center whitespace-nowrap">
                        ${statusHTML}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };
        window.updateBranchOrderStatus = async function (id, newStatus) {
            console.log(`[DEBUG] Updating Branch Order ${id} to status: ${newStatus}`);
            try {
                const res = await fetch(`${SERVER_URL}/branch-stock-orders/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    console.log(`[DEBUG] Update successful`);
                    fetchBranchOrders();
                } else {
                    const errBody = await res.json();
                    console.error(`[DEBUG] Update failed:`, errBody);
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ: ' + (errBody.message || 'Unknown error'));
                }
            } catch (err) {
                console.error(`[DEBUG] Update error:`, err);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
            }
        };

        window.fetchBranchInventory = async function () {
            const statusFilter = document.getElementById('branch-inventory-status-filter').value;

            let url = `${SERVER_URL}/branch-stock-orders?`;
            if (statusFilter && statusFilter !== 'all') url += `&status=${statusFilter}`;

            // Add Loading State
            const tbody = document.getElementById('branch-inventory-table-body');
            if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center"><div class="animate-spin rounded-full h-8 w-8 border-emerald-500 mx-auto"></div></td></tr>`;

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    renderBranchInventory(data);
                }
            } catch (err) { console.error(err); }
        };

        window.renderBranchInventory = function (orders) {
            const tbody = document.getElementById('branch-inventory-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-20 text-center">
                            <div class="flex flex-col items-center justify-center space-y-4 animate-fade-in">
                                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center text-slate-300 shadow-inner">
                                    <ion-icon name="search-outline" class="text-4xl"></ion-icon>
                                </div>
                                <div class="space-y-1">
                                    <p class="text-base font-bold text-slate-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</p>
                                    <p class="text-xs text-slate-400">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
                                </div>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            orders.forEach((order, index) => {
                const tr = document.createElement('tr');
                tr.className = "group hover:bg-emerald-50/20 transition-all duration-300 border-b border-slate-50 last:border-0 animate-fade-in";
                tr.style.animationDelay = `${index * 50}ms`;

                const dateStr = new Date(order.orderDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const expectStr = order.expectedDate ? new Date(order.expectedDate).toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';

                let statusHTML = '';
                if (!order.status || order.status === 'pending') {
                    statusHTML = `
                        <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-slate-50 text-slate-500 text-[10px] font-black border border-slate-200/50 shadow-sm uppercase tracking-wider">
                            <ion-icon name="ellipsis-horizontal-circle" class="mr-1.5 text-sm"></ion-icon>
                            <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                        </div>`;
                } else if (order.status === 'shipped') {
                    statusHTML = `
                        <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-amber-50 text-amber-600 text-[10px] font-black border border-amber-200/50 shadow-sm uppercase tracking-wider">
                            <ion-icon name="airplane-outline" class="mr-1.5 text-sm animate-bounce"></ion-icon>
                            <span>‡∏£‡∏≠‡∏Ç‡∏≠‡∏á</span>
                        </div>`;
                } else if (order.status === 'arrived') {
                    statusHTML = `
                        <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-50 text-emerald-600 text-[10px] font-black border border-emerald-200/50 shadow-sm uppercase tracking-wider">
                            <ion-icon name="checkmark-circle" class="mr-1.5 text-sm"></ion-icon>
                            <span>‡∏Ç‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</span>
                        </div>`;
                } else if (order.status === 'canceled') {
                    statusHTML = `
                        <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-red-50 text-red-600 text-[10px] font-black border border-red-200/50 shadow-sm uppercase tracking-wider">
                            <ion-icon name="close-circle" class="mr-1.5 text-sm"></ion-icon>
                            <span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏±‡∏ß</span>
                        </div>`;
                }

                // Handle items display (support both old single-item and new multi-items)
                let productsHTML = '';
                if (order.items && order.items.length > 0) {
                    productsHTML = `
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${order.items.map(i => `
                                <div class="flex items-center gap-2 bg-white border border-slate-100 px-3 py-1.5 rounded-xl shadow-sm hover:border-emerald-200 hover:shadow-md transition-all group/item">
                                    <div class="w-6 h-6 rounded-lg bg-emerald-50 text-emerald-500 flex items-center justify-center shrink-0 group-hover/item:bg-emerald-500 group-hover/item:text-white transition-colors">
                                        <ion-icon name="cube" class="text-xs"></ion-icon>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-[11px] font-black text-slate-700 leading-none">${i.productName}</span>
                                        <span class="text-[9px] font-bold text-slate-400 mt-1 uppercase">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${i.quantity}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                } else if (order.productName) {
                    // Fallback for old data
                    productsHTML = `
                        <div class="flex flex-wrap gap-2 mt-2">
                            <div class="flex items-center gap-2 bg-white border border-slate-100 px-3 py-1.5 rounded-xl shadow-sm hover:border-emerald-200 hover:shadow-md transition-all group/item">
                                <div class="w-6 h-6 rounded-lg bg-emerald-50 text-emerald-500 flex items-center justify-center shrink-0 group-hover/item:bg-emerald-500 group-hover/item:text-white transition-colors">
                                    <ion-icon name="cube" class="text-xs"></ion-icon>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-[11px] font-black text-slate-700 leading-none">${order.productName}</span>
                                    <span class="text-[9px] font-bold text-slate-400 mt-1 uppercase">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${order.quantity}</span>
                                </div>
                            </div>
                        </div>`;
                } else {
                    productsHTML = '<div class="text-xs text-slate-400 italic mt-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
                }

                tr.innerHTML = `
                    <td class="px-6 py-5 whitespace-nowrap">
                        <div class="flex flex-col">
                            <div class="flex items-center gap-1.5 mb-1">
                                <ion-icon name="calendar-clear" class="text-slate-400 text-xs"></ion-icon>
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Order Date</span>
                            </div>
                            <span class="text-sm font-black text-slate-700">${dateStr}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5 whitespace-nowrap">
                        <div class="flex flex-col">
                            <div class="flex items-center gap-1.5 mb-1">
                                <ion-icon name="calendar-clear" class="text-slate-400 text-xs"></ion-icon>
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Expected</span>
                            </div>
                            <span class="text-sm font-black text-slate-700">${expectStr}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2">
                                <span class="text-base font-black text-slate-800 tracking-tight group-hover:text-emerald-600 transition-colors uppercase">${order.orderName}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex flex-col">
                            ${productsHTML}
                        </div>
                    </td>
                    <td class="px-6 py-5 text-center">
                        <div class="inline-flex items-center justify-center gap-2 bg-emerald-50 border border-emerald-100 px-4 py-2 rounded-2xl shadow-sm group-hover:bg-emerald-500 group-hover:text-white transition-all duration-300">
                            <ion-icon name="business" class="text-lg text-emerald-500 group-hover:text-white transition-colors"></ion-icon>
                            <span class="text-xs font-black uppercase tracking-widest">${order.branch}</span>
                        </div>
                    </td>
                    <td class="px-6 py-5 text-center">
                        ${statusHTML}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };
    </script>
</body>

</html>