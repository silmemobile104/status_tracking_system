<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SILMIN MOBILE</title>
    <link rel="icon" type="image/png" href="/image/icon_silme.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Tom Select -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.default.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans Thai"', 'sans-serif'],
                        display: ['"Outfit"', '"Noto Sans Thai"', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b', // Amber-500
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        body { 
            font-family: 'Inter', 'Noto Sans Thai', sans-serif; 
            background-color: #F8FAFC; /* Slate-50 */
            color: #1E293B; /* Slate-800 */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #fbbf24; }

        /* Modal Transitions */
        .modal { 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.2s ease-out;
            backdrop-filter: blur(4px);
            background-color: rgba(15, 23, 42, 0.4); /* Slate-900/40 */
            display: flex; /* Always flex but hidden by opacity/visibility */
        }
        .modal.active { 
            opacity: 1; 
            visibility: visible; 
        }
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Form Theme */
        .form-input-theme {
            @apply w-full bg-white border border-slate-200 text-slate-800 text-sm rounded-xl block p-3 transition-all duration-200;
            @apply focus:ring-2 focus:ring-yellow-400/50 focus:border-yellow-400 focus:outline-none placeholder-slate-400;
        }
        .form-select-theme {
            @apply w-full bg-white border border-slate-200 text-slate-800 text-sm rounded-xl block p-3 transition-all duration-200;
            @apply focus:ring-2 focus:ring-yellow-400/50 focus:border-yellow-400 focus:outline-none;
        }

        /* Deposit Table */
        .deposit-table th {
            @apply bg-slate-50 text-slate-500 font-semibold text-xs uppercase tracking-wider py-3 px-4 border-b border-slate-200 text-center;
        }
        .deposit-table td {
            @apply py-3 px-4 border-b border-slate-100 text-sm text-slate-600 align-middle;
        }
        .header-received {
            @apply bg-yellow-50 text-yellow-700 !important;
        }
        
        /* Sidebar & Layout */
        #sidebar {
            position: fixed;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100vh;
            padding-top: 4.5rem;
            z-index: 50; 
        }
        #sidebar.active { transform: translateX(0); }
        
        @media (min-width: 768px) {
            #sidebar {
                position: sticky;
                top: 0;
                transform: translateX(0);
                padding-top: 0;
                height: 100vh;
            }
        }

        #main-content {
            padding-top: 5rem;
            transition: all 0.3s ease-in-out; 
        }
        @media (min-width: 768px) {
            #main-content { padding-top: 0; }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans antialiased selection:bg-yellow-200 selection:text-yellow-900">

    <!-- Mobile Header -->
    <div id="mobile-header"
        class="md:hidden bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 flex justify-between items-center fixed top-0 left-0 w-full z-40">
        <button id="menu-toggle"
            class="text-slate-600 hover:text-slate-900 p-1 rounded-lg hover:bg-slate-100 transition-colors">
            <ion-icon name="menu-outline" class="text-2xl"></ion-icon>
        </button>
        <span class="text-lg font-bold text-slate-800 tracking-tight flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
            SILMIN MOBILE
        </span>
        <div id="notification-bell-mobile" class="relative">
            <button id="notification-bell-btn-mobile"
                class="relative p-2 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors">
                <ion-icon name="notifications-outline" class="text-2xl"></ion-icon>
                <span id="notification-dot-mobile"
                    class="hidden absolute top-2 right-2 block h-2 w-2 rounded-full ring-2 ring-white bg-red-500"></span>
            </button>
        </div>
    </div>

    <div id="sidebar-overlay"
        class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <div id="app-wrapper" class="flex min-h-screen">

        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-72 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col shadow-xl md:shadow-none">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="h-20 flex items-center px-8 border-b border-slate-100 hidden md:flex">
                    <img 
                        src="/image/icon_silme.png" 
                        alt="SILME Icon"
                        class="w-8 h-8 mr-3 rounded-lg shadow-lg"
                    />
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight font-display">SILMIN MOBILE</h1>
                </div>

                <!-- Company Select -->
                <div class="p-6 pb-2">
                    <label for="company-select"
                        class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Workspace</label>
                    <select id="company-select" class="form-select-theme shadow-sm">
                        <option selected value="company_1_id">ซิลมีน โมบาย จำกัด</option>
                        <option value="company_2_id">เอสจี พลัส 2023 จำกัด</option>
                    </select>
                </div>

                <!-- Navigation -->
                <nav id="nav-menu" class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
                    <a href="#" onclick="updateNavActiveState('dashboard')" id="nav-dashboard"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="grid-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">แดชบอร์ด</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('mytasks')" id="nav-mytasks"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="document-text-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">งานของฉัน</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('deposit')" id="nav-Storefront_deposit"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="wallet-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">เงินค่ามัดจำหน้าร้าน</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('admin')" id="nav-admin"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="people-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">จัดการผู้ใช้</span>
                    </a>
                    <a href="#" id="nav-settings"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="settings-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">ตั้งค่า</span>
                    </a>
                </nav>

                <!-- User Profile -->
                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <div id="user-profile-widget" class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm">
                                <ion-icon name="person" class="text-xl"></ion-icon>
                            </div>
                            <div class="ml-3">
                                <p id="user-name" class="text-sm font-semibold text-slate-800">กำลังโหลด...</p>
                                <p id="user-role" class="text-xs text-slate-500 font-medium">...</p>
                            </div>
                        </div>
                        <div class="relative hidden md:block">
                            <button id="notification-bell"
                                class="relative p-2 text-slate-400 hover:text-yellow-600 hover:bg-yellow-50 rounded-full transition-all">
                                <ion-icon name="notifications-outline" class="w-5 h-5"></ion-icon>
                                <span id="notification-dot"
                                    class="hidden absolute top-2 right-2 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                            </button>
                        </div>
                    </div>
                    <button id="logout-button"
                        class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-xl transition-colors">
                        <ion-icon name="log-out-outline" class="w-5 h-5 mr-2"></ion-icon> ออกจากระบบ
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto h-screen">
            <div class="max-w-7xl mx-auto">

                <!-- Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div>
                        <h2 id="main-header" class="text-3xl font-bold text-slate-800 font-display">แดชบอร์ด</h2>
                        <p class="text-slate-500 mt-1">System</p>
                    </div>
                    <div id="main-header-buttons" class="flex gap-3">
                        <button id="newTaskButton"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-yellow-500/30 flex items-center transition-all transform hover:-translate-y-0.5">
                            <ion-icon name="add-circle-outline" class="w-5 h-5 mr-2"></ion-icon> สั่งงานใหม่
                        </button>
                        <button id="newUserButton"
                            class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-slate-800/30 flex items-center transition-all transform hover:-translate-y-0.5 hidden">
                            <ion-icon name="person-add-outline" class="w-5 h-5 mr-2"></ion-icon> เพิ่มผู้ใช้ใหม่
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Content injected by JS -->
                </div>

                <!-- My Tasks Filters -->
                <div id="mytasks-filters" class="hidden mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-700">สถานะงาน</h3>
                        <button onclick="filterMyTasks('all')"
                            class="text-sm text-slate-500 hover:text-yellow-600 font-medium flex items-center transition-colors">
                            <ion-icon name="refresh-outline" class="mr-1"></ion-icon> แสดงทั้งหมด
                        </button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="filterMyTasks('todo')" id="btn-filter-todo"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-slate-100 rounded-lg text-slate-600 group-hover:bg-slate-200 transition-colors">
                                    <ion-icon name="clipboard-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-todo"
                                    class="bg-slate-100 text-slate-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">รอทำ</span>
                        </button>

                        <button onclick="filterMyTasks('in-progress')" id="btn-filter-inprogress"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-yellow-100 rounded-lg text-yellow-600 group-hover:bg-yellow-200 transition-colors">
                                    <ion-icon name="construct-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-inprogress"
                                    class="bg-yellow-100 text-yellow-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">กำลังทำ</span>
                        </button>

                        <button onclick="filterMyTasks('for-review')" id="btn-filter-review"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-orange-100 rounded-lg text-orange-600 group-hover:bg-orange-200 transition-colors">
                                    <ion-icon name="search-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-review"
                                    class="bg-orange-100 text-orange-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">รอตรวจสอบ</span>
                        </button>

                        <button onclick="filterMyTasks('completed')" id="btn-filter-completed"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-green-100 rounded-lg text-green-600 group-hover:bg-green-200 transition-colors">
                                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-completed"
                                    class="bg-green-100 text-green-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">เสร็จสิ้น</span>
                        </button>
                    </div>
                </div>

                <!-- Task View -->
                <div id="task-view-content"
                    class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div id="loading-tasks" class="text-center p-12 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-4">
                        </div>
                        <p class="text-slate-500 font-medium">กำลังดึงข้อมูลงาน...</p>
                    </div>
                    <div id="task-error-message"
                        class="hidden p-4 m-6 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100 flex items-center"
                        role="alert">
                        <ion-icon name="alert-circle" class="text-xl mr-2"></ion-icon>
                        <div><span class="font-bold">เกิดข้อผิดพลาด:</span> <span id="task-error-text"></span></div>
                    </div>

                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="text-lg font-bold text-slate-800">รายการงาน</h3>
                        <span id="task-count"
                            class="text-xs font-semibold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">0
                            งาน</span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ชื่องาน</th>
                                    <th id="header-assignee"
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ผู้รับผิดชอบ</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        สถานะ</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        วันครบกำหนด</th>
                                    <th
                                        class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body" class="divide-y divide-slate-100">
                                <tr id="no-task-row" class="text-center">
                                    <td colspan="5"
                                        class="px-6 py-12 text-slate-400 flex flex-col items-center justify-center">
                                        <ion-icon name="folder-open-outline"
                                            class="text-4xl mb-2 text-slate-300"></ion-icon>
                                        ไม่มีงานที่ต้องแสดงในขณะนี้
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Deposit View -->
                <div id="deposit-view"
                    class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mt-6 p-6">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h3 class="text-xl font-bold text-slate-800 flex items-center">
                            <div class="p-2 bg-yellow-100 text-yellow-600 rounded-lg mr-3"><ion-icon
                                    name="wallet"></ion-icon></div>
                            <span id="deposit-header-title">เงินค่ามัดจำหน้าร้าน</span>
                        </h3>

                        <div class="flex items-center gap-3">
                            <div id="filter-branch-container">
                                <select id="deposit-filter-branch" class="form-select-theme py-2 pl-3 pr-8 text-sm">
                                    <option value="all" selected>ดูทุกสาขา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                </select>
                            </div>

                            <button onclick="openDepositModal()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl shadow-lg shadow-green-600/20 flex items-center font-medium transition-all">
                                <ion-icon name="add-circle" class="mr-2"></ion-icon> เพิ่มรายการ
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-xl border border-slate-200">
                        <table class="w-full deposit-table border-collapse text-sm">
                            <thead>
                                <tr>
                                    <th rowspan="2">วันที่มัดจำ</th>
                                    <th rowspan="2">ลูกค้า</th>
                                    <th rowspan="2">เบอร์โทร</th>
                                    <th rowspan="2" class="bg-red-50 text-red-700 border-red-100">ยอดมัดจำ</th>
                                    <th rowspan="2">นัดรับ</th>
                                    <th colspan="7" class="bg-slate-100 text-slate-600 border-b border-slate-200">
                                        ข้อมูลรับเครื่อง</th>
                                </tr>
                                <tr>
                                    <th>บิล</th>
                                    <th>IMEI</th>
                                    <th>สินค้า</th>
                                    <th>ราคาเต็ม</th>
                                    <th class="bg-blue-50 text-blue-700">ค้างชำระ</th>
                                    <th>สถานะ</th>
                                    <th>ผู้ทำรายการ</th>
                                </tr>
                            </thead>
                            <tbody id="deposit-table-body" class="text-slate-600 bg-white">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Admin View -->
                <div id="admin-view-content"
                    class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div id="loading-users" class="text-center p-12 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-4">
                        </div>
                        <p class="text-slate-500">กำลังดึงข้อมูลผู้ใช้...</p>
                    </div>
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="text-lg font-bold text-slate-800">รายชื่อผู้ใช้ในระบบ</h3>
                        <span id="user-count"
                            class="text-xs font-semibold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">0
                            คน</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ชื่อ-สกุล</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        Username</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ตำแหน่ง</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        แผนก / สาขา</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        หัวหน้า</th>
                                    <th
                                        class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="divide-y divide-slate-100">
                                <tr id="no-user-row" class="text-center">
                                    <td colspan="6" class="px-6 py-12 text-slate-400">ไม่มีผู้ใช้ในระบบ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- New Task Modal -->
    <div id="newTaskModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">สั่งงานใหม่</h3>
                <button onclick="closeModal('newTaskModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8">
                <form id="new-task-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="taskTitle"
                                class="block text-sm font-semibold text-slate-700 mb-2">ชื่องาน</label>
                            <input type="text" id="taskTitle" name="title" required class="form-input-theme"
                                placeholder="เช่น สรุปยอดขายประจำสัปดาห์">
                        </div>
                        <div>
                            <label for="taskAssignTo"
                                class="block text-sm font-semibold text-slate-700 mb-2">มอบหมายให้</label>
                            <select id="taskAssignTo" name="assignedTo" required class="form-select-theme">
                                <option value="" disabled selected>--- กำลังโหลดรายชื่อพนักงาน ---</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="taskDesc"
                            class="block text-sm font-semibold text-slate-700 mb-2">รายละเอียดงาน</label>
                        <textarea id="taskDesc" name="description" rows="4" class="form-input-theme"
                            placeholder="รายละเอียด..."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="taskDueDate"
                                class="block text-sm font-semibold text-slate-700 mb-2">กำหนดส่ง</label>
                            <input type="date" id="taskDueDate" name="dueDate" class="form-input-theme">
                        </div>
                        <div>
                            <label for="taskPriority"
                                class="block text-sm font-semibold text-slate-700 mb-2">ความสำคัญ</label>
                            <select id="taskPriority" name="priority" class="form-select-theme">
                                <option value="low">ต่ำ</option>
                                <option value="medium" selected>ปานกลาง</option>
                                <option value="high">สูง</option>
                            </select>
                        </div>
                    </div>
                    <div id="new-task-error"
                        class="hidden p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('newTaskModal')">ยกเลิก</button>
                        <button type="submit" id="submit-task-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all flex items-center">
                            <span id="submit-task-text">สร้างงาน</span>
                            <div id="submit-task-spinner"
                                class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent">
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="depositModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div
                class="bg-gradient-to-r from-yellow-500 to-orange-600 p-6 flex justify-between items-center text-white">
                <h3 class="text-xl font-bold flex items-center"><ion-icon name="wallet" class="mr-2"></ion-icon>
                    บันทึกรายการมัดจำ</h3>
                <button onclick="closeModal('depositModal')" class="hover:text-yellow-100 transition-colors"><ion-icon
                        name="close" class="text-2xl"></ion-icon></button>
            </div>
            <div class="p-8 max-h-[80vh] overflow-y-auto">
                <form id="deposit-form" class="space-y-6">
                    <input type="hidden" id="dep-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 border-b border-slate-100">
                        <div class="col-span-2 font-bold text-slate-800 flex items-center text-lg">
                            <div
                                class="w-8 h-8 rounded-lg bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3">
                                <ion-icon name="document-text"></ion-icon>
                            </div>
                            ข้อมูลการมัดจำ
                        </div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">วันที่มัดจำ</label><input
                                type="date" id="dep-date" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">วันที่นัดรับ</label><input
                                type="date" id="dep-pickup" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ชื่อลูกค้า</label><input
                                type="text" id="dep-name" class="form-input-theme" required></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">เบอร์โทร</label><input
                                type="text" id="dep-phone" class="form-input-theme" required></div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ยอดมัดจำ
                                (บาท)</label>
                            <input type="number" id="dep-amount"
                                class="form-input-theme bg-red-50 text-red-600 font-bold border-red-100 focus:ring-red-500 focus:border-red-500 text-lg"
                                required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                        <div
                            class="col-span-2 font-bold text-slate-800 flex items-center text-lg bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <ion-icon name="gift" class="mr-3 text-yellow-500 text-xl"></ion-icon> ส่วนรับเครื่อง
                            (กรอกเมื่อมารับของ)
                        </div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">สินค้า
                                (รุ่น/สี/ความจุ)</label><input type="text" id="dep-product" class="form-input-theme">
                        </div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ราคาเครื่องเต็ม
                                (บาท)</label><input type="number" id="dep-price" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">เลขที่บิล</label><input
                                type="text" id="dep-bill" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">IMEI</label><input
                                type="text" id="dep-imei" class="form-input-theme"></div>

                        <div class="col-span-2 flex items-center mt-2 p-4 bg-green-50 rounded-xl border border-green-200 cursor-pointer hover:bg-green-100 transition-colors"
                            onclick="document.getElementById('dep-success').click()">
                            <input type="checkbox" id="dep-success"
                                class="w-5 h-5 text-green-600 rounded focus:ring-green-500 mr-3">
                            <label for="dep-success"
                                class="font-bold text-green-800 cursor-pointer select-none">ทำรายการสำเร็จ
                                (รับเครื่องแล้ว)</label>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-6 border-t border-slate-100">
                        <button type="button" onclick="closeModal('depositModal')"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors">ยกเลิก</button>
                        <button type="submit"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">บันทึกข้อมูล</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <form id="update-task-form">
                <input type="hidden" id="detail-task-id" name="taskId">
                <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800" id="detail-task-title">กำลังโหลด...</h3>
                    <button type="button" class="text-slate-400 hover:text-slate-600 transition-colors"
                        onclick="closeModal('taskDetailModal')">
                        <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                    </button>
                </div>

                <div class="p-8 space-y-6">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-sm font-semibold text-slate-500 mb-1">รายละเอียด</p>
                        <p id="detail-task-desc" class="text-slate-700 whitespace-pre-wrap leading-relaxed">...</p>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">ผู้สั่งงาน</p>
                                <p id="detail-task-creator" class="text-sm font-semibold text-slate-800">...</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3">
                                <ion-icon name="calendar"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">กำหนดส่ง</p>
                                <p id="detail-task-dueDate" class="text-sm font-semibold text-slate-800">...</p>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6">
                        <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center"><ion-icon
                                name="time-outline" class="mr-2"></ion-icon> ประวัติการอัปเดต</h4>
                        <div id="detail-task-comments-list"
                            class="space-y-3 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                            <p class="text-sm text-slate-400 italic">ไม่มีประวัติการอัปเดต</p>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6 bg-yellow-50/50 -mx-8 px-8 -mb-8 pb-8">
                        <div class="mb-4">
                            <label for="detail-task-status"
                                class="block text-sm font-bold text-slate-700 mb-2">อัปเดตสถานะงาน</label>
                            <select id="detail-task-status" name="status" class="form-select-theme">
                                <option value="todo">มอบหมายแล้ว (To Do)</option>
                                <option value="in-progress">กำลังดำเนินการ (In Progress)</option>
                                <option value="for-review">ส่งตรวจสอบ (For Review)</option>
                                <option value="completed">สำเร็จแล้ว (Completed)</option>
                            </select>
                        </div>
                        <div>
                            <label for="detail-task-comment"
                                class="block text-sm font-bold text-slate-700 mb-2">เพิ่มคำอธิบาย</label>
                            <textarea id="detail-task-comment" name="commentText" rows="3" class="form-input-theme"
                                placeholder="เช่น อัปเดตความคืบหน้า หรือแนบ Link ผลงาน..."></textarea>
                        </div>
                    </div>
                </div>

                <div id="update-task-error"
                    class="hidden mx-8 mb-6 p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>

                <div class="px-8 py-4 border-t border-slate-100 bg-white flex justify-between items-center">
                    <button type="button" id="delete-task-btn"
                        class="text-red-600 hover:text-red-700 font-medium text-sm flex items-center px-3 py-2 rounded-lg hover:bg-red-50 transition-colors"
                        style="display: none;">
                        <ion-icon name="trash-outline" class="text-lg mr-2"></ion-icon> ลบงานนี้
                    </button>
                    <div class="flex gap-3">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('taskDetailModal')">ปิด</button>
                        <button type="submit" id="save-task-details-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">บันทึกการเปลี่ยนแปลง</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-md bg-white rounded-2xl shadow-2xl p-6 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <ion-icon name="warning" class="text-3xl"></ion-icon>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">ยืนยันการลบ</h3>
            <p class="text-slate-500 mb-6" id="confirm-message">คุณแน่ใจหรือไม่ว่าต้องการลบงานนี้?
                การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <p id="confirm-error-message" class="text-xs text-red-600 mb-4"></p>

            <div class="flex justify-center gap-3">
                <button type="button"
                    class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                    onclick="closeModal('confirmModal')">ยกเลิก</button>
                <button type="button" id="confirm-delete-button" data-task-id=""
                    class="px-6 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg shadow-red-600/30 transition-all">ยืนยันลบ</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800" id="user-modal-title">เพิ่มผู้ใช้ใหม่</h3>
                <button onclick="closeModal('userModal')" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8">
                <form id="user-form" class="space-y-6">
                    <input type="hidden" id="user-id" name="userId">
                    <input type="hidden" id="form-mode" name="mode" value="create">

                    <div>
                        <label for="user-company-input" class="block text-sm font-semibold text-slate-700 mb-2">บริษัท
                            (Company)</label>
                        <select id="user-company-input" name="companyId" required class="form-select-theme">
                            <option value="company_1_id">ซิลมีน โมบาย จำกัด</option>
                            <option value="company_2_id">เอสจี พลัส 2023 จำกัด</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="user-name-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">ชื่อ-สกุล</label>
                            <input type="text" id="user-name-input" name="name" required class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-role-input" class="block text-sm font-semibold text-slate-700 mb-2">ตำแหน่ง
                                (Role)</label>
                            <select id="user-role-input" name="role" required class="form-select-theme">
                                <option value="staff">พนักงาน (Staff)</option>
                                <option value="manager">ผู้จัดการ (Manager)</option>
                                <option value="hr">ฝ่ายบุคคล (HR)</option>
                                <option value="executive">ผู้บริหาร (Executive)</option>
                            </select>
                        </div>
                    </div>

                    <div id="auth-section"
                        class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                        <div>
                            <label for="user-username-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">Username (รหัสพนักงาน)</label>
                            <input type="text" id="user-username-input" name="username" required
                                class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-password-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">Password</label>
                            <input type="password" id="user-password-input" name="password" class="form-input-theme"
                                placeholder="เว้นว่างไว้หากไม่ต้องการเปลี่ยน">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="user-department-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">แผนก</label>
                            <input type="text" id="user-department-input" name="department" required
                                class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-branch-input" class="block text-sm font-semibold text-slate-700 mb-2">สาขา
                                (ถ้ามี)</label>
                            <input type="text" id="user-branch-input" name="branch" class="form-input-theme">
                        </div>
                    </div>

                    <div>
                        <label for="user-reportsTo-input"
                            class="block text-sm font-semibold text-slate-700 mb-2">หัวหน้างาน (Reports To)</label>
                        <select id="user-reportsTo-input" name="reportsTo" class="form-select-theme">
                            <option value="">--- ไม่มีหัวหน้า ---</option>
                        </select>
                    </div>

                    <div id="user-form-error"
                        class="hidden p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>

                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('userModal')">ยกเลิก</button>
                        <button type="submit" id="submit-user-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">การแจ้งเตือน</h3>
                <button onclick="closeModal('notificationModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>

            <div id="notification-list" class="max-h-[60vh] overflow-y-auto custom-scrollbar">
                <p class="text-center text-slate-400 p-8">ไม่มีการแจ้งเตือนใหม่</p>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50/50 flex justify-end">
                <button type="button"
                    class="px-6 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium transition-colors"
                    onclick="closeModal('notificationModal')">ปิด</button>
            </div>
        </div>
    </div>
    <script>
        const SERVER_URL = '/api';
        let currentUser = null;
        let currentView = 'dashboard';
        let notificationPollInterval = null;
        let allDashboardTasks = [];
        let allMyTasks = [];

        // --- Helper Functions ---
        const getRoleName = (role) => {
            switch (role) {
                case 'executive': return 'ผู้บริหาร';
                case 'manager': return 'ผู้จัดการ';
                case 'hr': return 'ฝ่ายบุคคล (HR)';
                case 'staff': return 'พนักงาน';
                default: return role;
            }
        };
        const getStatusTag = (status) => {
            const map = {
                'todo': { text: 'รอทำ', bg: 'bg-slate-100', color: 'text-slate-600' },
                'in-progress': { text: 'กำลังทำ', bg: 'bg-yellow-100', color: 'text-yellow-700' },
                'for-review': { text: 'ส่งตรวจสอบ', bg: 'bg-orange-100', color: 'text-orange-700' },
                'completed': { text: 'เสร็จสิ้น', bg: 'bg-green-100', color: 'text-green-700' },
                'overdue': { text: 'เลยกำหนด', bg: 'bg-red-100', color: 'text-red-700' },
            };
            const s = map[status] || map['todo'];
            return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${s.bg} ${s.color}">${s.text}</span>`;
        };
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const safeHide = (el) => { if (el) el.classList.add('hidden'); };
        const safeShow = (el) => { if (el) el.classList.remove('hidden'); };

        // (*** 2. (ใหม่) เพิ่ม Helper สำหรับเวลา ***)
        const timeAgo = (date) => {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " ปีก่อน";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " เดือนก่อน";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " วันก่อน";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " ชั่วโมงก่อน";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " นาทีก่อน";
            return "เมื่อสักครู่";
        };

        // --- Core Functions ---
        const initializeAuth = () => {
            const token = localStorage.getItem('token');
            const userString = localStorage.getItem('user');

            if (!token || !userString) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userString);

            // แสดงชื่อและตำแหน่ง
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = getRoleName(currentUser.role);

            // --- ส่วนที่แก้ไข: ควบคุมการแสดงเมนู "เงินค่ามัดจำหน้าร้าน" ---
            const depositNav = document.getElementById('nav-Storefront_deposit');
            if (depositNav) {
                // 1. ดึงชื่อแผนก (เผื่อเช็คคำว่า "ขาย")
                const userDept = (currentUser.department || '').trim();
                const isSalesTeam = userDept.includes('ขาย') || userDept.includes('Sales');

                // 2. เงื่อนไขใหม่: แสดงถ้าเป็น...
                // - ทีมขาย (มีคำว่า "ขาย" ในแผนก)
                // - หรือเป็น Admin
                // - หรือเป็น ผู้บริหาร (executive)
                // - หรือเป็น ผู้จัดการ (manager)
                // - หรือเป็น HR (hr)
                if (isSalesTeam ||
                    currentUser.role === 'admin' ||
                    currentUser.role === 'executive' ||
                    currentUser.role === 'manager' ||
                    currentUser.role === 'hr') {

                    depositNav.style.display = 'flex'; // แสดงเมนู
                } else {
                    depositNav.style.display = 'none'; // ซ่อนเมนู
                }
            }
            // -------------------------------------------------------

            // Logic เดิมของการจัดการ Role (Staff, Manager, Executive)
            if (currentUser.role === 'staff') {
                safeHide(document.getElementById('nav-dashboard'));
                safeHide(document.getElementById('nav-admin'));
                safeHide(document.getElementById('nav-settings'));

                if (document.getElementById('company-select')) {
                    document.getElementById('company-select').parentElement.style.display = 'none';
                }

                updateNavActiveState('mytasks');
                fetchMyTasks();

            } else if (currentUser.role === 'executive') {
                safeHide(document.getElementById('nav-mytasks'));
                updateNavActiveState('dashboard');
                fetchDashboardTasks();
                fetchTaskStats();
                fetchAllUsers();

            } else if (currentUser.role === 'manager' || currentUser.role === 'hr') {
                updateNavActiveState('dashboard');
                fetchDashboardTasks();
                fetchTaskStats();
                fetchAllUsers();
            }

            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                clearInterval(notificationPollInterval);
                window.location.href = 'login.html';
            });

            fetchNotifications();
            notificationPollInterval = setInterval(fetchNotifications, 60000);
        };

        // ------------------------------------------
        // --- (A) TASK FUNCTIONS ---
        // ------------------------------------------
        const fetchTaskStats = async () => {
            const token = localStorage.getItem('token');
            const selectedCompanyId = document.getElementById('company-select').value;
            const statsDiv = document.getElementById('stats-cards');
            statsDiv.innerHTML = `<div class="text-sm text-gray-500">กำลังโหลดสถิติ...</div>`;
            try {
                const response = await fetch(`${SERVER_URL}/tasks/stats?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { statsDiv.innerHTML = `<div class="text-sm text-red-500">โหลดสถิติไม่สำเร็จ</div>`; return; }
                const stats = await response.json();

                statsDiv.innerHTML = `
                    <div onclick="filterTasksByStatus('todo')" data-status="todo" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-gray-100 text-gray-600"><ion-icon name="clipboard-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">สั่งแล้ว</p><p class="text-2xl font-bold text-gray-900">${stats.todo || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('in-progress')" data-status="in-progress" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-yellow-100 text-yellow-600"><ion-icon name="ellipsis-horizontal-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">กำลังดำเนินการ</p><p class="text-2xl font-bold text-gray-900">${stats.inProgress || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('for-review')" data-status="for-review" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-amber-100 text-amber-600"><ion-icon name="search-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">ส่งตรวจสอบ</p><p class="text-2xl font-bold text-gray-900">${stats.forReview || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('completed')" data-status="completed" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-green-100 text-green-600"><ion-icon name="checkmark-done-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">งานที่เสร็จสิ้น</p><p class="text-2xl font-bold text-gray-900">${stats.completed || 0}</p></div></div>
                    </div>
                `;
            } catch (error) {
                console.error('Fetch Stats Error:', error);
                statsDiv.innerHTML = `<div class="text-sm text-red-500">เกิดข้อผิดพลาดในการโหลดสถิติ</div>`;
            }
        };

        const fetchAllUsers = async () => {
            const token = localStorage.getItem('token');
            const selectElement = document.getElementById('taskAssignTo');
            const selectedCompanyId = document.getElementById('company-select').value;
            selectElement.innerHTML = '<option value="" disabled selected>--- กำลังโหลด... ---</option>';
            selectElement.disabled = true;
            try {
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                if (!response.ok) { selectElement.innerHTML = '<option value="" disabled selected>--- โหลดรายชื่อไม่สำเร็จ ---</option>'; return; }
                const users = await response.json();
                selectElement.innerHTML = '';
                selectElement.disabled = false;
                selectElement.prepend(new Option('--- เลือกผู้รับผิดชอบ ---', '', true, true));
                if (selectElement.tomselect) {
                    selectElement.tomselect.destroy();
                }
                users.forEach(user => {
                    if (user && user._id) {
                        const option = document.createElement('option');
                        option.value = user._id;
                        option.textContent = `${user.name} (${user.branch || user.department})`;
                        selectElement.appendChild(option);
                    }
                });
            } catch (error) {
                selectElement.innerHTML = '<option value="" disabled selected>--- โหลดรายชื่อไม่สำเร็จ (Server Down?) ---</option>';
            }
        };

        const fetchDashboardTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = '';
            const selectedCompanyId = document.getElementById('company-select').value;
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=dashboard&companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || 'ไม่สามารถดึงข้อมูลงานได้';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();

                allDashboardTasks = tasks;      // เก็บงานทั้งหมดลง Cache
                renderTaskTable(tasks);         // แสดงผลทั้งหมด (ปกติ)
                filterTasksByStatus('todo');

            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };

        const fetchMyTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = '';
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=mytasks`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || 'ไม่สามารถดึงข้อมูลงานได้';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();
                allMyTasks = tasks;     // 1. เก็บข้อมูลทั้งหมดไว้ในตัวแปรกลาง
                updateMyTaskCounts();   // 2. อัปเดตตัวเลขบนปุ่ม
                renderTaskTable(tasks); // 3. แสดงผลทั้งหมดก่อน
            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };

        const renderTaskTable = (tasks) => {
            const taskTableBody = document.getElementById('task-table-body');

            // อัปเดตจำนวนงาน (ถ้ามี element นี้)
            const countElement = document.getElementById('task-count');
            if (countElement) countElement.textContent = `${tasks.length} งาน`;

            // 1. กรณีไม่มีงาน
            if (tasks.length === 0) {
                taskTableBody.innerHTML = `<tr id="no-task-row" class="text-center"><td colspan="5" class="px-6 py-4 text-gray-500">ไม่มีงานที่ต้องแสดงในขณะนี้</td></tr>`;
                return;
            }

            taskTableBody.innerHTML = '';

            // 2. วนลูปแสดงงาน
            tasks.forEach((task, index) => {
                // ตรวจสอบงานเกินกำหนด
                const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'completed';
                const statusDisplay = isOverdue ? getStatusTag('overdue') : getStatusTag(task.status);

                // --- LOGIC การเลือกแสดงชื่อ (ผู้รับผิดชอบ VS ผู้สั่งงาน) ---
                let personName = 'Unknown User';
                let personSubText = '-';
                let personImageChar = '?';
                let showBranchBadge = false; // ตัวแปรเช็คว่าจะโชว์ Badge สาขาไหม

                // ตรวจสอบว่าเป็นหน้า "งานของฉัน" หรือไม่ (ต้องมีตัวแปร currentView ในระบบ)
                const isMyTasksView = (typeof currentView !== 'undefined' && currentView === 'mytasks');

                if (isMyTasksView) {
                    // >> กรณีหน้างานของฉัน: แสดง "ผู้สั่งงาน" (Created By)
                    if (task.createdBy) {
                        personName = task.createdBy.name || 'ไม่ระบุชื่อ';
                        personSubText = 'ผู้สั่งงาน'; // ข้อความระบุสถานะ
                        personImageChar = personName.charAt(0);
                    } else {
                        personName = 'ไม่ระบุ';
                        personSubText = 'ผู้สั่งงาน';
                    }
                    // ปกติผู้สั่งงานไม่ต้องโชว์ Badge สาขาก็ได้ (หรือถ้าต้องการก็เปิดได้)
                    showBranchBadge = false;

                } else {
                    // >> กรณีหน้าอื่น (Dashboard): แสดง "ผู้รับผิดชอบ" (Assigned To)
                    if (task.assignedTo) {
                        personName = task.assignedTo.name || 'Unknown User';
                        // ดึงสังกัด (ถ้ามีสาขาให้แสดงสาขา ถ้าไม่มีให้แสดงแผนก)
                        personSubText = task.assignedTo.branch || task.assignedTo.department || 'N/A';
                        personImageChar = personName.charAt(0);
                    }
                    // แสดง Badge สาขาเฉพาะเมื่อดูในมุมมองผู้รับผิดชอบ และงานนั้นมีระบุสาขา
                    showBranchBadge = true;
                }

                // --- LOGIC การแสดงชื่อและ Badge ---
                let nameDisplayHtml = personName;

                // ถ้า Logic อนุญาตให้โชว์ Badge และ Task มีข้อมูล Branch
                if (showBranchBadge && task.branch) {
                    nameDisplayHtml += ` <span class="ml-2 px-2 py-0.5 text-xs rounded bg-indigo-100 text-indigo-800 border border-indigo-200">สาขา${task.branch}</span>`;
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition-colors duration-150';
                // คลิกที่แถวเพื่อดูรายละเอียด (ถ้าเผลอคลิกปุ่มจะไม่ซ้อนทับกัน เพราะปุ่มมี event แยก)
                row.onclick = (e) => {
                    // ป้องกันการเปิด Modal ซ้อนถ้าคลิกโดนปุ่ม "เพิ่มเติม" โดยตรง (Optional)
                    if (!e.target.closest('button')) openDetailModal(task._id);
                };

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="ml-0">
                                <div class="text-sm font-medium text-gray-900">
                                    <span class="font-bold text-yellow-600 mr-2">${index + 1}.</span>${task.title}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <img class="h-8 w-8 rounded-full object-cover shadow-sm" 
                                 src="https://placehold.co/100x100/e0e7ff/4f46e5?text=${encodeURIComponent(personImageChar)}" 
                                 alt="">
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900 flex items-center">
                                    ${nameDisplayHtml}
                                </div>
                                <div class="text-xs text-gray-500">${personSubText}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? 'text-red-500 font-bold' : 'text-gray-500'}">
                        ${formatDate(task.dueDate)}
                        <div class="text-xs font-normal text-gray-400">${timeAgo(task.dueDate)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-amber-600 hover:text-amber-800 bg-amber-50 hover:bg-amber-100 px-3 py-1 rounded-md transition-colors" onclick="openDetailModal('${task._id}')">
                            เพิ่มเติม
                        </button>
                    </td>
                `;
                taskTableBody.appendChild(row);
            });
        };

        const filterTasksByStatus = (status) => {
            // 1. ไฮไลท์การ์ดที่เลือก
            const statCards = document.querySelectorAll('#stats-cards [data-status]');
            statCards.forEach(card => {
                if (card.getAttribute('data-status') === status) {
                    card.classList.add('ring-2', 'ring-amber-500', 'shadow-lg');
                } else {
                    card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
                }
            });

            // 2. กรองงานจาก Cache
            const filteredTasks = allDashboardTasks.filter(task => task.status === status);

            // 3. วาดตารางใหม่
            renderTaskTable(filteredTasks);
        };

        const clearTaskFilterHighlights = () => {
            const statCards = document.querySelectorAll('#stats-cards [data-status]');
            statCards.forEach(card => {
                card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
            });
        };

        const handleNewTaskSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const submitButton = document.getElementById('submit-task-btn');
            const errorBox = document.getElementById('new-task-error');
            if (!data.assignedTo || data.assignedTo === "") {
                errorBox.textContent = 'กรุณาเลือกผู้รับผิดชอบงาน'; safeShow(errorBox); return;
            }
            const postData = { ...data, companyId: document.getElementById('company-select').value, dueDate: data.dueDate ? new Date(data.dueDate).toISOString() : null };
            submitButton.disabled = true; submitButton.querySelector('#submit-task-text').textContent = 'กำลังสร้าง...'; safeShow(submitButton.querySelector('#submit-task-spinner'));
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(postData)
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('newTaskModal'); form.reset(); fetchDashboardTasks(); fetchTaskStats();
                fetchNotifications();
            } catch (error) {
                errorBox.textContent = `สร้างงานไม่สำเร็จ: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.querySelector('#submit-task-text').textContent = 'สร้างงาน'; safeHide(submitButton.querySelector('#submit-task-spinner'));
            }
        };

        const openDetailModal = async (taskId) => {
            openModal('taskDetailModal');
            const token = localStorage.getItem('token');
            const errorBox = document.getElementById('update-task-error');
            const deleteTaskBtn = document.getElementById('delete-task-btn');
            safeHide(errorBox);
            document.getElementById('detail-task-title').textContent = "กำลังโหลด...";
            document.getElementById('detail-task-desc').textContent = "...";
            document.getElementById('detail-task-creator').textContent = "...";
            document.getElementById('detail-task-dueDate').textContent = "...";
            document.getElementById('detail-task-comment').value = '';
            document.getElementById('save-task-details-btn').disabled = true;

            const handleDeleteTask = async () => {
                const taskTitle = document.getElementById('detail-task-title').textContent;
                const confirmMsg = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-delete-button');
                confirmMsg.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบงาน: "${taskTitle}"? การกระทำนี้ไม่สามารถย้อนกลับได้`;
                confirmBtn.setAttribute('data-task-id', taskId);
                document.getElementById('confirm-error-message').textContent = '';
                openModal('confirmModal');
            };

            deleteTaskBtn.replaceWith(deleteTaskBtn.cloneNode(true));
            document.getElementById('delete-task-btn').addEventListener('click', handleDeleteTask);

            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                const task = await response.json();
                document.getElementById('detail-task-id').value = task._id;
                document.getElementById('detail-task-title').textContent = task.title;
                document.getElementById('detail-task-desc').textContent = task.description || '(ไม่มีรายละเอียด)';
                document.getElementById('detail-task-status').value = task.status;
                document.getElementById('detail-task-creator').textContent = task.createdBy ? task.createdBy.name : 'N/A';
                document.getElementById('detail-task-dueDate').textContent = formatDate(task.dueDate);
                const commentsList = document.getElementById('detail-task-comments-list');
                commentsList.innerHTML = '';
                if (task.comments && task.comments.length > 0) {
                    task.comments.slice().reverse().forEach(comment => {
                        const commentEl = document.createElement('div');
                        commentEl.className = 'text-sm pb-2 mb-2 border-b border-gray-200';
                        commentEl.innerHTML = `<p class="text-gray-800">${comment.text}</p><p class="text-xs text-gray-500">โดย: ${comment.name} - ${new Date(comment.timestamp).toLocaleString('th-TH')}</p>`;
                        commentsList.appendChild(commentEl);
                    });
                } else {
                    commentsList.innerHTML = '<p class="text-sm text-gray-500">ไม่มีประวัติการอัปเดต</p>';
                }
                const userRole = currentUser.role;
                if (userRole === 'executive' || userRole === 'manager' || userRole === 'hr') {
                    document.getElementById('delete-task-btn').style.display = 'inline-flex';
                } else {
                    document.getElementById('delete-task-btn').style.display = 'none';
                }
            } catch (error) {
                console.error('Open Detail Modal Error:', error);
                errorBox.textContent = 'ไม่สามารถดึงข้อมูลงานได้ (Error: ' + error.message + ')';
                safeShow(errorBox);
            } finally {
                document.getElementById('save-task-details-btn').disabled = false;
            }
        };

        const handleUpdateTaskSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const status = document.getElementById('detail-task-status').value;
            const taskId = document.getElementById('detail-task-id').value;
            const commentText = document.getElementById('detail-task-comment').value;
            const errorBox = document.getElementById('update-task-error');
            const submitButton = document.getElementById('save-task-details-btn');
            submitButton.disabled = true; submitButton.textContent = 'กำลังบันทึก...';
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status, commentText: commentText })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
                fetchNotifications();
            } catch (error) {
                errorBox.textContent = `อัปเดตไม่สำเร็จ: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.textContent = 'บันทึกการเปลี่ยนแปลง';
            }
        };

        const executeDelete = async () => {
            const token = localStorage.getItem('token');
            const deleteButton = document.getElementById('confirm-delete-button');
            const errorMsg = document.getElementById('confirm-error-message');
            const taskId = deleteButton.getAttribute('data-task-id');
            if (!taskId) { errorMsg.textContent = 'เกิดข้อผิดพลาด: ไม่พบ ID งาน'; return; }
            deleteButton.disabled = true; deleteButton.textContent = 'กำลังลบ...'; errorMsg.textContent = '';
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('confirmModal'); closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
            } catch (error) {
                errorMsg.textContent = `ลบไม่สำเร็จ: ${error.message}`;
            } finally {
                deleteButton.disabled = false; deleteButton.textContent = 'ตกลง';
            }
        };

        // ------------------------------------------
        // --- (B) USER FUNCTIONS ---
        // ------------------------------------------
        const fetchAllUsersForTable = async () => {
            safeShow(document.getElementById('loading-users'));
            const token = localStorage.getItem('token');
            const userTableBody = document.getElementById('user-table-body');
            userTableBody.innerHTML = '';
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                safeHide(document.getElementById('loading-users'));
                if (!response.ok) { throw new Error('ไม่สามารถดึงข้อมูลผู้ใช้'); }
                const users = await response.json();
                document.getElementById('user-count').textContent = `${users.length} คน`;
                if (users.length === 0) {
                    userTableBody.innerHTML = `<tr id="no-user-row" class="text-center"><td colspan="6" class="px-6 py-4 text-slate-500">ไม่มีผู้ใช้ในระบบ</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${user.name}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.username}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${getRoleName(user.role)}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.branch || user.department}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.reportsTo ? user.reportsTo.name : '-'}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-amber-600 hover:text-amber-800" onclick="openEditUserModal('${user._id}')">แก้ไข</button>
                            <button class="text-red-600 hover:text-red-900 ml-4" onclick="executeDeleteUser('${user._id}', '${user.name}')">ลบ</button>
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });
            } catch (error) {
                safeHide(document.getElementById('loading-users'));
                userTableBody.innerHTML = `<tr class="text-center"><td colspan="6" class="px-6 py-4 text-red-500">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
            }
        };

        // ------------------------------------------
        // --- (C) NOTIFICATION FUNCTIONS ---
        // ------------------------------------------
        const fetchNotifications = async () => {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                // 1. ดึงข้อมูลจาก Server
                const response = await fetch(`${SERVER_URL}/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();

                // จัดการโครงสร้างข้อมูล (รองรับทั้งแบบส่งมาเป็น Array โดยตรง หรือส่งมาเป็น Object)
                const notifications = Array.isArray(data) ? data : (data.notifications || []);

                // คำนวณจำนวนที่ยังไม่อ่าน
                const unreadCount = typeof data.unreadCount === 'number'
                    ? data.unreadCount
                    : notifications.filter(n => !n.isRead).length;

                // --- ส่วนที่ 1: จัดการจุดแดง (Red Dot) ---

                // ฟังก์ชันช่วยเปิด/ปิดจุด (ใช้ได้ทั้ง Desktop และ Mobile)
                const toggleDot = (elementId, show) => {
                    const el = document.getElementById(elementId);
                    if (el) {
                        if (show) el.classList.remove('hidden');
                        else el.classList.add('hidden');
                    }
                };

                // อัปเดตจุดแดงทั้ง 2 จุดพร้อมกัน
                const hasUnread = unreadCount > 0;
                toggleDot('notification-dot', hasUnread);          // สำหรับ Desktop
                toggleDot('notification-dot-mobile', hasUnread);   // สำหรับ Mobile (ที่คุณเพิ่งเพิ่ม)

                // --- ส่วนที่ 2: แสดงรายการแจ้งเตือนใน Dropdown ---
                const listContainer = document.getElementById('notification-list');
                if (listContainer) {
                    listContainer.innerHTML = ''; // ล้างรายการเก่า

                    if (notifications.length === 0) {
                        // กรณีไม่มีการแจ้งเตือน
                        listContainer.innerHTML = `
                            <div class="px-4 py-6 text-sm text-gray-500 text-center flex flex-col items-center">
                                <ion-icon name="notifications-off-outline" class="text-2xl mb-2 text-gray-300"></ion-icon>
                                ไม่มีการแจ้งเตือนใหม่
                            </div>`;
                    } else {
                        // วนลูปสร้างรายการ
                        notifications.forEach(notif => {
                            const item = document.createElement('div');
                            // ถ้ายังไม่อ่าน ให้พื้นหลังเป็นสีฟ้าอ่อน (bg-blue-50)
                            item.className = `px-4 py-3 border-b hover:bg-gray-50 transition-colors cursor-pointer ${!notif.isRead ? 'bg-blue-50' : ''}`;

                            // ใส่เนื้อหา HTML
                            item.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">${notif.title || 'การแจ้งเตือน'}</p>
                                        <p class="text-xs text-gray-500 mt-1">${notif.message || '-'}</p>
                                        <p class="text-[10px] text-gray-400 mt-2">
                                            ${new Date(notif.createdAt).toLocaleString('th-TH')}
                                        </p>
                                    </div>
                                    ${!notif.isRead ? '<span class="h-2 w-2 bg-blue-600 rounded-full mt-1 flex-shrink-0"></span>' : ''}
                                </div>
                            `;

                            // เพิ่ม Event คลิก (เช่น กดแล้วไปหน้างาน หรือทำเครื่องหมายว่าอ่านแล้ว)
                            item.onclick = () => {
                                // ตรงนี้ใส่ Logic เพิ่มเติมได้ เช่น markAsRead(notif._id)
                                console.log('Clicked notification:', notif._id);
                            };

                            listContainer.appendChild(item);
                        });
                    }
                }

            } catch (error) {
                console.warn('Could not fetch notifications:', error.message);
            }
        };

        const updateNotificationUI = (notifications, unreadCount) => {
            const dot = document.getElementById('notification-dot');
            const list = document.getElementById('notification-list');

            if (unreadCount > 0) {
                safeShow(dot);
            } else {
                safeHide(dot);
            }

            if (notifications && notifications.length > 0) {
                list.innerHTML = '';
                notifications.forEach(noti => {
                    const taskTitle = noti.task ? noti.task.title : 'งานนี้ถูกลบแล้ว';
                    const taskAction = noti.task ? `onclick="openDetailModal('${noti.task._id}'); closeModal('notificationModal');"` : '';

                    const item = document.createElement('div');
                    item.className = `block p-3 border-b hover:bg-gray-50 cursor-pointer ${noti.isRead ? 'bg-white' : 'bg-blue-50'}`;

                    item.innerHTML = `
                        <div ${taskAction}>
                            <p class="text-sm text-gray-800 font-medium">${noti.message}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <span class="font-semibold text-amber-600">${taskTitle}</span> • ${timeAgo(noti.createdAt)}
                            </p>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<p class="text-center text-gray-500 p-4">ไม่มีการแจ้งเตือนใหม่</p>';
            }
        };

        const markNotificationsAsRead = async () => {
            const token = localStorage.getItem('token');
            const dot = document.getElementById('notification-dot');
            safeHide(dot);

            try {
                await fetch(`${SERVER_URL}/notifications/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.warn('Could not mark notifications as read:', error.message);
            }
        };

        // ------------------------------------------
        // --- (D) DEPOSIT FUNCTIONS ---
        // ------------------------------------------
        // ในไฟล์ index.html
        async function fetchDeposits() {
            try {
                const token = localStorage.getItem('token');
                const selectedCompanyId = document.getElementById('company-select').value;

                // --- ส่วนที่ 1: อัปเดตหัวข้อตาราง (Header Title) ---
                // ส่วนนี้จะเปลี่ยนข้อความ "รายการเงินค่ามัดจำหน้าร้าน" เป็น "รายการเงินค่ามัดจำ - สาขา..."
                const titleElem = document.getElementById('deposit-header-title');
                const filterBranchElem = document.getElementById('deposit-filter-branch');

                if (titleElem) {
                    if (typeof currentUser !== 'undefined' && currentUser && currentUser.role === 'staff') {
                        // กรณี Staff: ให้แสดงสาขาของ Staff คนนั้นเสมอ
                        const branchName = currentUser.branch || 'ทั้งหมด'; // ถ้าเป็นค่าว่าง/null/undefined ให้ใช้คำว่า 'ทั้งหมด' แทน
                        titleElem.textContent = `รายการเงินค่ามัดจำ - สาขา ${branchName}`;
                    } else {
                        // กรณี Admin/Manager: ให้แสดงตามที่เลือกใน Dropdown
                        // ถ้าเลือก "ทั้งหมด" หรือยังไม่เลือก ให้แสดงคำว่า "ทั้งหมด"
                        // ถ้าเลือกสาขาเจาะจง ให้ดึงข้อความ (Text) ของ option นั้นมาแสดง
                        let branchName = 'ทั้งหมด';
                        if (filterBranchElem && filterBranchElem.value !== 'all' && filterBranchElem.selectedIndex > -1) {
                            branchName = filterBranchElem.options[filterBranchElem.selectedIndex].text;
                        }
                        titleElem.textContent = `รายการเงินค่ามัดจำ - ${branchName}`;
                    }
                }

                // --- ส่วนที่ 2: เตรียม URL และ Parameter ---
                let url = `${SERVER_URL}/deposits?companyId=${selectedCompanyId}`;

                // ดึงค่าจาก Dropdown ตัวกรองสาขา เพื่อส่งไปที่ API
                if (filterBranchElem) {
                    const branchVal = filterBranchElem.value;
                    if (branchVal && branchVal !== 'all') {
                        url += `&branch=${encodeURIComponent(branchVal)}`;
                    }
                }

                // --- ส่วนที่ 3: ส่งคำสั่งไปที่ Server ---
                // console.log('Fetching URL:', url); 
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const deposits = await res.json();

                // --- ส่วนที่ 4: วาดตาราง ---
                const tbody = document.getElementById('deposit-table-body');
                tbody.innerHTML = '';

                if (deposits.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-slate-500">ไม่พบข้อมูลในสาขานี้</td></tr>`;
                    return;
                }

                deposits.forEach(d => {
                    const price = d.price || 0;
                    const deposit = d.depositAmount || 0;
                    const balance = price > 0 ? (price - deposit) : 0;

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-yellow-50 transition-colors cursor-pointer border-b";
                    tr.onclick = () => openDepositModal(d);

                    tr.innerHTML = `
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.depositDate)}</td>
                        <td class="font-medium border p-2 text-gray-800">${d.customerName}</td>
                        <td class="text-center border p-2 text-gray-600">${d.phoneNumber}</td>
                        <td class="text-right border p-2 font-bold text-red-600 bg-red-50">${deposit.toLocaleString()}</td>
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.pickupDueDate)}</td>
                
                        <td class="text-center border p-2 text-xs">${d.billNo || '-'}</td>
                        <td class="text-center border p-2 text-xs font-mono text-gray-500">${d.imei || '-'}</td>
                        <td class="text-xs border p-2">${d.product || '-'}</td>
                        <td class="text-right border p-2 bg-red-50 text-xs">${price ? price.toLocaleString() : '-'}</td>
                        <td class="text-right border p-2 font-bold bg-blue-50 text-blue-800">${price ? balance.toLocaleString() : '-'}</td>
                        <td class="text-center border p-2 bg-green-50">
                            ${d.isSuccess ? '<ion-icon name="checkmark-circle" class="text-green-600 text-xl"></ion-icon>' : '<span class="text-gray-300">-</span>'}
                        </td>
                        <td class="text-center border p-2 text-xs text-gray-500">${d.signName || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error("Error fetching deposits:", e);
                // อาจจะแสดง Error บนหน้าจอด้วยก็ได้ถ้าต้องการ
                const tbody = document.getElementById('deposit-table-body');
                if (tbody) tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
            }
        }

        function openDepositModal(data = null) {
            openModal('depositModal');
            document.getElementById('deposit-form').reset();
            document.getElementById('dep-id').value = '';

            if (data) {
                document.getElementById('dep-id').value = data._id;
                document.getElementById('dep-date').value = data.depositDate ? data.depositDate.split('T')[0] : '';
                document.getElementById('dep-pickup').value = data.pickupDueDate ? data.pickupDueDate.split('T')[0] : '';
                document.getElementById('dep-name').value = data.customerName;
                document.getElementById('dep-phone').value = data.phoneNumber;
                document.getElementById('dep-amount').value = data.depositAmount;

                document.getElementById('dep-product').value = data.product || '';
                document.getElementById('dep-price').value = data.price || '';
                document.getElementById('dep-bill').value = data.billNo || '';
                document.getElementById('dep-imei').value = data.imei || '';
                document.getElementById('dep-success').checked = data.isSuccess;
            } else {
                document.getElementById('dep-date').value = new Date().toISOString().split('T')[0];
            }
        }

        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const payload = {
                id: document.getElementById('dep-id').value,
                depositDate: document.getElementById('dep-date').value,
                pickupDueDate: document.getElementById('dep-pickup').value,
                customerName: document.getElementById('dep-name').value,
                phoneNumber: document.getElementById('dep-phone').value,
                depositAmount: document.getElementById('dep-amount').value,

                product: document.getElementById('dep-product').value,
                price: document.getElementById('dep-price').value,
                billNo: document.getElementById('dep-bill').value,
                imei: document.getElementById('dep-imei').value,
                isSuccess: document.getElementById('dep-success').checked
            };

            try {
                const res = await fetch(`${SERVER_URL}/deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    closeModal('depositModal');
                    fetchDeposits();
                } else {
                    alert('บันทึกไม่สำเร็จ โปรดลองใหม่');
                }
            } catch (err) { alert('Error: ' + err.message); }
        });

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric', year: '2-digit' });
        }


        // ------------------------------------------
        // --- (E) GENERAL HELPERS & INIT ---
        // ------------------------------------------

        const loadManagersForDropdown = async () => {
            const token = localStorage.getItem('token');
            const select = document.getElementById('user-reportsTo-input');
            select.innerHTML = '<option value="">--- กำลังโหลด... ---</option>';
            try {
                const selectedCompanyId = document.getElementById('user-company-input').value;
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('โหลดรายชื่อหัวหน้าไม่สำเร็จ');
                const users = await response.json();
                select.innerHTML = '<option value="">--- ไม่มีหัวหน้า ---</option>';
                const managers = users.filter(u => u.role === 'manager' || u.role === 'hr' || u.role === 'executive');
                managers.forEach(user => {
                    select.appendChild(new Option(`${user.name} (${getRoleName(user.role)})`, user._id));
                });
            } catch (error) {
                select.innerHTML = `<option value="">--- ${error.message} ---</option>`;
            }
        };

        const openNewUserModal = () => {
            document.getElementById('user-form').reset();
            document.getElementById('user-modal-title').textContent = 'เพิ่มผู้ใช้ใหม่';
            document.getElementById('form-mode').value = 'create';
            document.getElementById('user-id').value = '';
            safeHide(document.getElementById('user-form-error'));
            document.getElementById('user-username-input').disabled = false;
            document.getElementById('user-username-input').required = true;
            document.getElementById('user-password-input').placeholder = "ต้องกรอก";
            document.getElementById('user-password-input').required = true;
            safeShow(document.getElementById('auth-section'));

            const currentCompany = document.getElementById('company-select').value;
            const userCompanySelect = document.getElementById('user-company-input');
            userCompanySelect.value = currentCompany;
            userCompanySelect.disabled = false;

            safeHide(document.getElementById('user-reportsTo-input').parentElement);

            openModal('userModal');
        };

        const openEditUserModal = async (id) => {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('ไม่สามารถดึงข้อมูลผู้ใช้ได้');
                const users = await response.json();
                const user = users.find(u => u._id === id);

                if (user) {
                    document.getElementById('user-form').reset();
                    document.getElementById('user-modal-title').textContent = 'แก้ไขผู้ใช้';
                    document.getElementById('form-mode').value = 'edit';
                    document.getElementById('user-id').value = user._id;
                    safeHide(document.getElementById('user-form-error'));

                    document.getElementById('user-username-input').disabled = true;
                    document.getElementById('user-username-input').required = false;
                    document.getElementById('user-password-input').placeholder = "เว้นว่างไว้หากไม่ต้องการเปลี่ยน";
                    document.getElementById('user-password-input').required = false;
                    safeShow(document.getElementById('auth-section'));

                    document.getElementById('user-name-input').value = user.name;
                    document.getElementById('user-role-input').value = user.role;
                    document.getElementById('user-username-input').value = user.username;
                    document.getElementById('user-department-input').value = user.department;
                    document.getElementById('user-branch-input').value = user.branch || '';

                    const userCompanySelect = document.getElementById('user-company-input');
                    userCompanySelect.value = user.companyId;
                    userCompanySelect.disabled = true;

                    const reportsToDiv = document.getElementById('user-reportsTo-input').parentElement;
                    safeShow(reportsToDiv);

                    await loadManagersForDropdown();

                    document.getElementById('user-reportsTo-input').value = user.reportsTo ? user.reportsTo._id : '';
                } else {
                    throw new Error('ไม่พบข้อมูลผู้ใช้');
                }
                openModal('userModal');
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการดึงข้อมูล: ' + error.message);
            }
        };

        const handleUserFormSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const mode = data.mode;
            const userId = data.userId;
            const submitButton = document.getElementById('submit-user-btn');
            const errorBox = document.getElementById('user-form-error');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';
            safeHide(errorBox);
            let url = '';
            let method = '';
            let body = {};

            if (mode === 'create') {
                url = `${SERVER_URL}/auth/register`;
                method = 'POST';
                body = {
                    name: data.name,
                    username: data.username,
                    password: data.password,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                    companyId: data.companyId
                };
            } else {
                url = `${SERVER_URL}/users/admin/${userId}`;
                method = 'PUT';
                body = {
                    name: data.name,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                };
                if (data.password && data.password.trim() !== '') {
                    body.password = data.password;
                }
            }
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                closeModal('userModal');
                fetchAllUsersForTable();
                fetchAllUsers();
            } catch (error) {
                errorBox.textContent = `บันทึกไม่สำเร็จ: ${error.message}`;
                safeShow(errorBox);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึก';
            }
        };

        const executeDeleteUser = async (id, name) => {
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้: "${name}"?`)) {
                return;
            }
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                fetchAllUsersForTable();
                fetchAllUsers();
            } catch (error) {
                alert(`ลบไม่สำเร็จ: ${error.message}`);
            }
        };

        // --- NAVIGATION LOGIC (รวมระบบแล้ว) ---
        const updateNavActiveState = (activeView) => {
            const statsCards = document.getElementById('stats-cards');
            const myTasksFilters = document.getElementById('mytasks-filters');
            const taskView = document.getElementById('task-view-content');
            const adminView = document.getElementById('admin-view-content');
            const depositView = document.getElementById('deposit-view'); // เพิ่ม Deposit View

            const mainHeader = document.getElementById('main-header');
            const newTaskBtn = document.getElementById('newTaskButton');
            const newUserBtn = document.getElementById('newUserButton');

            const navDashboard = document.getElementById('nav-dashboard');
            const navMyTasks = document.getElementById('nav-mytasks');
            const navAdmin = document.getElementById('nav-admin');
            const navDeposit = document.getElementById('nav-Storefront_deposit'); // เพิ่ม Deposit Nav

            const companySelectDiv = document.getElementById('company-select').parentElement;

            // Reset Nav Styles
            [navDashboard, navMyTasks, navAdmin, navDeposit].forEach(el => {
                el.classList.remove('bg-amber-500', 'text-white');
                el.classList.add('text-gray-600', 'hover:bg-gray-100');
            });

            // Hide All Views
            safeHide(statsCards);
            safeHide(taskView);
            safeHide(adminView);
            safeHide(depositView); // Hide Deposit View

            // Hide Buttons & Filters
            safeHide(newTaskBtn); safeHide(newUserBtn);
            safeHide(myTasksFilters);

            currentView = activeView;

            if (activeView === 'dashboard') {
                safeShow(statsCards); safeShow(taskView);
                if (currentUser.role !== 'staff') safeShow(newTaskBtn);
                mainHeader.textContent = "แดชบอร์ด";
                navDashboard.classList.add('bg-amber-500', 'text-white');
                navDashboard.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'block';
            }
            else if (activeView === 'mytasks') {
                safeShow(taskView);
                safeShow(myTasksFilters);
                mainHeader.textContent = "งานของฉัน";
                navMyTasks.classList.add('bg-amber-500', 'text-white');
                navMyTasks.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'admin') {
                safeShow(adminView); safeShow(newUserBtn);
                mainHeader.textContent = "จัดการผู้ใช้";
                navAdmin.classList.add('bg-amber-500', 'text-white');
                navAdmin.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'block';
            }
            else if (activeView === 'deposit') { // (*** ใหม่ ***)
                safeShow(depositView);
                mainHeader.textContent = "เงินค่ามัดจำหน้าร้าน";
                navDeposit.classList.add('bg-amber-500', 'text-white');
                navDeposit.classList.remove('text-gray-600', 'hover:bg-gray-100');
                // ปกติหน้าร้านก็ควรเลือกบริษัทได้
                if (companySelectDiv) companySelectDiv.style.display = 'block';
            }

            if (currentUser && currentUser.role === 'staff') {
                if (document.getElementById('company-select')) document.getElementById('company-select').disabled = true;
            }
        };

        const updateMyTaskCounts = () => {
            if (!allMyTasks) return;
            document.getElementById('mytask-count-todo').textContent = allMyTasks.filter(t => t.status === 'todo').length;
            document.getElementById('mytask-count-inprogress').textContent = allMyTasks.filter(t => t.status === 'in-progress').length;
            document.getElementById('mytask-count-review').textContent = allMyTasks.filter(t => t.status === 'for-review').length;
            document.getElementById('mytask-count-completed').textContent = allMyTasks.filter(t => t.status === 'completed').length;
        };

        const filterMyTasks = (status) => {
            ['todo', 'inprogress', 'review', 'completed'].forEach(id => {
                document.getElementById(`btn-filter-${id}`).classList.remove('ring-2', 'ring-offset-1', 'ring-gray-400');
            });

            let filtered = [];
            if (status === 'all') {
                filtered = allMyTasks;
            } else {
                filtered = allMyTasks.filter(t => t.status === status);
                let btnId = '';
                if (status === 'todo') btnId = 'todo';
                else if (status === 'in-progress') btnId = 'inprogress';
                else if (status === 'for-review') btnId = 'review';
                else if (status === 'completed') btnId = 'completed';

                if (btnId) {
                    document.getElementById(`btn-filter-${btnId}`).classList.add('ring-2', 'ring-offset-1', 'ring-gray-400');
                }
            }
            renderTaskTable(filtered);
        };

        // --- INIT & LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth();

            // Forms
            document.getElementById('new-task-form').addEventListener('submit', handleNewTaskSubmit);
            document.getElementById('update-task-form').addEventListener('submit', handleUpdateTaskSubmit);
            document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);

            // Buttons
            document.getElementById('confirm-delete-button').addEventListener('click', executeDelete);
            document.getElementById('newTaskButton').addEventListener('click', () => {
                fetchAllUsers();
                openModal('newTaskModal');
            });
            document.getElementById('newUserButton').addEventListener('click', openNewUserModal);
            document.getElementById('notification-bell').addEventListener('click', () => {
                openModal('notificationModal');
                markNotificationsAsRead();
            });
            const mobileBell = document.getElementById('notification-bell-btn-mobile');
            if (mobileBell) {
                mobileBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const mobileDot = document.getElementById('notification-dot-mobile');
                    if (mobileDot) mobileDot.classList.add('hidden');
                    openModal('notificationModal');
                });
            }
            document.getElementById('nav-dashboard').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = 'ผู้รับผิดชอบ';
                e.preventDefault(); updateNavActiveState('dashboard');
                fetchDashboardTasks(); fetchTaskStats();
            });
            document.getElementById('nav-mytasks').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = 'ผู้มอบหมายงาน';
                e.preventDefault(); updateNavActiveState('mytasks');
                fetchMyTasks();
            });
            document.getElementById('nav-admin').addEventListener('click', (e) => {
                e.preventDefault(); updateNavActiveState('admin');
                fetchAllUsersForTable();
            });

            // (*** เพิ่ม Listener สำหรับเมนู Deposit ***)
            document.getElementById('nav-Storefront_deposit').addEventListener('click', (e) => {
                e.preventDefault();
                updateNavActiveState('deposit'); // เรียกใช้ฟังก์ชันกลาง
                fetchDeposits(); // โหลดข้อมูล
            });

            // Company Change Listener
            document.getElementById('company-select').addEventListener('change', () => {
                if (currentView === 'dashboard') {
                    fetchNotifications(); fetchDashboardTasks(); fetchTaskStats(); fetchAllUsers();
                } else if (currentView === 'admin') {
                    fetchAllUsersForTable();
                } else if (currentView === 'deposit') { // (*** เพิ่ม ***)
                    fetchDeposits(); // รีเฟรชตารางมัดจำเมื่อเปลี่ยนบริษัท
                }
            });

            document.getElementById('user-company-input').addEventListener('change', () => {
                loadManagersForDropdown();
            });

            const branchFilterSelect = document.getElementById('deposit-filter-branch');
            if (branchFilterSelect) {
                branchFilterSelect.addEventListener('change', () => {
                    fetchDeposits(); // เรียกฟังก์ชันโหลดข้อมูลใหม่
                });

                // (เสริม) ถ้าเป็น Staff ทั่วไป ซ่อนตัวกรองนี้ไปเลย (เพราะดูได้แค่สาขาตัวเองอยู่แล้ว)
                if (currentUser && currentUser.role === 'staff') {
                    const container = document.getElementById('filter-branch-container');
                    if (container) container.style.display = 'none';
                }
            }
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');

            if (menuToggle && sidebar && overlay) {
                const toggleMenu = () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('hidden');
                };
                menuToggle.addEventListener('click', toggleMenu);
                overlay.addEventListener('click', toggleMenu);

                // ปิดเมนูอัตโนมัติเมื่อกดลิงก์
                document.querySelectorAll('#nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        // เช็คว่าอยู่ในโหมดมือถือ (จอเล็กกว่า 768px)
                        if (window.innerWidth < 768) {
                            toggleMenu();
                        }
                    });
                });
            }
        });

        // Modal Control
        function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
    </script>
</body>

</html>