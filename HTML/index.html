<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SILMIN MOBILE</title>
    <link rel="icon" type="image/png" href="/image/icon_silme.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Tom Select -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.default.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans Thai"', 'sans-serif'],
                        display: ['"Outfit"', '"Noto Sans Thai"', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b', // Amber-500
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        body { 
            font-family: 'Inter', 'Noto Sans Thai', sans-serif; 
            background-color: #F8FAFC; /* Slate-50 */
            color: #1E293B; /* Slate-800 */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #fbbf24; }

        /* Modal Transitions */
        .modal { 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.2s ease-out;
            backdrop-filter: blur(4px);
            background-color: rgba(15, 23, 42, 0.4); /* Slate-900/40 */
            display: flex; /* Always flex but hidden by opacity/visibility */
        }
        .modal.active { 
            opacity: 1; 
            visibility: visible; 
        }
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Form Theme */
        .form-input-theme {
            @apply w-full bg-white border border-slate-200 text-slate-800 text-sm rounded-xl block p-3 transition-all duration-200;
            @apply focus:ring-2 focus:ring-yellow-400/50 focus:border-yellow-400 focus:outline-none placeholder-slate-400;
        }
        .form-select-theme {
            @apply w-full bg-white border border-slate-200 text-slate-800 text-sm rounded-xl block p-3 transition-all duration-200;
            @apply focus:ring-2 focus:ring-yellow-400/50 focus:border-yellow-400 focus:outline-none;
        }

        /* Deposit Table */
        .deposit-table th {
            @apply bg-slate-50 text-slate-500 font-semibold text-xs uppercase tracking-wider py-3 px-4 border-b border-slate-200 text-center;
        }
        .deposit-table td {
            @apply py-3 px-4 border-b border-slate-100 text-sm text-slate-600 align-middle;
        }
        .header-received {
            @apply bg-yellow-50 text-yellow-700 !important;
        }
        
        /* Sidebar & Layout */
        #sidebar {
            position: fixed;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100vh;
            padding-top: 4.5rem;
            z-index: 50; 
        }
        #sidebar.active { transform: translateX(0); }
        
        @media (min-width: 768px) {
            #sidebar {
                position: sticky;
                top: 0;
                transform: translateX(0);
                padding-top: 0;
                height: 100vh;
            }
        }

        #main-content {
            padding-top: 5rem;
            transition: all 0.3s ease-in-out; 
        }
        @media (min-width: 768px) {
            #main-content { padding-top: 0; }
        }
        /* Tom Select Customization */
        .ts-control {
            border-radius: 0.75rem !important; /* rounded-xl */
            border-color: #e2e8f0 !important; /* slate-200 */
            padding: 0.75rem !important; /* p-3 */
            box-shadow: none !important;
            min-height: 46px; /* Match standard input height */
        }
        .ts-control.focus {
            border-color: #facc15 !important; /* yellow-400 */
            box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.5) !important; /* ring-yellow-400/50 */
        }
        .ts-dropdown {
            border-radius: 0.75rem !important;
            border-color: #e2e8f0 !important;
            margin-top: 4px !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }
        .ts-dropdown .option {
            padding: 0.5rem 1rem !important;
        }
        .ts-dropdown .active {
            background-color: #fef9c3 !important; /* yellow-100 */
            color: #854d0e !important; /* yellow-800 */
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans antialiased selection:bg-yellow-200 selection:text-yellow-900">

    <!-- Mobile Header -->
    <div id="mobile-header"
        class="md:hidden bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 flex justify-between items-center fixed top-0 left-0 w-full z-40">
        <button id="menu-toggle"
            class="text-slate-600 hover:text-slate-900 p-1 rounded-lg hover:bg-slate-100 transition-colors">
            <ion-icon name="menu-outline" class="text-2xl"></ion-icon>
        </button>
        <span class="text-lg font-bold text-slate-800 tracking-tight flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
            SILMIN MOBILE
        </span>
        <div id="notification-bell-mobile" class="relative">
            <button id="notification-bell-btn-mobile"
                class="relative p-2 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors">
                <ion-icon name="notifications-outline" class="text-2xl"></ion-icon>
                <span id="notification-dot-mobile"
                    class="hidden absolute top-2 right-2 block h-2 w-2 rounded-full ring-2 ring-white bg-red-500"></span>
            </button>
        </div>
    </div>

    <div id="sidebar-overlay"
        class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <div id="app-wrapper" class="flex min-h-screen">

        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-72 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col shadow-xl md:shadow-none">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="h-20 flex items-center px-8 border-b border-slate-100 hidden md:flex">
                    <img src="/image/icon_silme.png" alt="SILME Icon" class="w-8 h-8 mr-3 rounded-lg shadow-lg" />
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight font-display">SILMIN MOBILE</h1>
                </div>

                <!-- Company Select -->
                <div class="p-6 pb-2">
                    <label for="company-select"
                        class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Workspace</label>
                    <select id="company-select" class="form-select-theme shadow-sm">
                        <option selected value="company_1_id">ซิลมีน โมบาย จำกัด</option>
                        <option value="company_2_id">เอสจี พลัส 2023 จำกัด</option>
                    </select>
                </div>

                <!-- Navigation -->
                <nav id="nav-menu" class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
                    <a href="#" onclick="updateNavActiveState('dashboard')" id="nav-dashboard"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="grid-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">แดชบอร์ด</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('mytasks')" id="nav-mytasks"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="document-text-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">งานของฉัน</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('deposit')" id="nav-Storefront_deposit"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="wallet-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">เงินค่ามัดจำหน้าร้าน</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('purchasing')" id="nav-purchasing"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="cart-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">ติดตามการสั่งซื้อ</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('import')" id="nav-import"
                        class="hidden flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="cloud-upload-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">แจ้งนำเข้า</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('stock-import')" id="nav-stock-import"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group hidden">
                        <ion-icon name="cube-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">จัดการรายการนำเข้า</span>
                    </a>
                    <a href="#" onclick="updateNavActiveState('admin')" id="nav-admin"
                        class="flex items-center px-4 py-3 text-slate-600 hover:bg-slate-50 hover:text-slate-900 rounded-xl transition-all group">
                        <ion-icon name="people-outline"
                            class="w-5 h-5 mr-3 text-slate-400 group-hover:text-yellow-500 transition-colors"></ion-icon>
                        <span class="font-medium">จัดการผู้ใช้</span>
                    </a>
                </nav>

                <!-- User Profile -->
                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <div id="user-profile-widget" class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm">
                                <ion-icon name="person" class="text-xl"></ion-icon>
                            </div>
                            <div class="ml-3">
                                <p id="user-name" class="text-sm font-semibold text-slate-800">กำลังโหลด...</p>
                                <p id="user-role" class="text-xs text-slate-500 font-medium">...</p>
                            </div>
                        </div>
                        <div class="relative hidden md:block">
                            <button id="notification-bell"
                                class="relative p-2 text-slate-400 hover:text-yellow-600 hover:bg-yellow-50 rounded-full transition-all">
                                <ion-icon name="notifications-outline" class="w-5 h-5"></ion-icon>
                                <span id="notification-dot"
                                    class="hidden absolute top-2 right-2 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                            </button>
                        </div>
                    </div>
                    <button id="logout-button"
                        class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-xl transition-colors">
                        <ion-icon name="log-out-outline" class="w-5 h-5 mr-2"></ion-icon> ออกจากระบบ
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto h-screen">
            <div class="max-w-7xl mx-auto">

                <!-- Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div>
                        <h2 id="main-header" class="text-3xl font-bold text-slate-800 font-display">แดชบอร์ด</h2>
                        <p class="text-slate-500 mt-1">System</p>
                    </div>
                    <div id="main-header-buttons" class="flex gap-3">
                        <button id="showAllTasksBtn"
                            class="bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 font-semibold py-2.5 px-5 rounded-xl shadow-sm flex items-center transition-all transform hover:-translate-y-0.5">
                            <ion-icon name="list-outline" class="w-5 h-5 mr-2"></ion-icon> แสดงงานทั้งหมด
                        </button>
                        <button id="newTaskButton"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-yellow-500/30 flex items-center transition-all transform hover:-translate-y-0.5">
                            <ion-icon name="add-circle-outline" class="w-5 h-5 mr-2"></ion-icon> สั่งงานใหม่
                        </button>
                        <button id="newUserButton"
                            class="bg-slate-800 hover:bg-slate-900 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-slate-800/30 flex items-center transition-all transform hover:-translate-y-0.5 hidden">
                            <ion-icon name="person-add-outline" class="w-5 h-5 mr-2"></ion-icon> เพิ่มผู้ใช้ใหม่
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Content injected by JS -->
                </div>

                <!-- My Tasks Filters -->
                <div id="mytasks-filters" class="hidden mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-700">สถานะงาน</h3>
                        <button onclick="filterMyTasks('all')"
                            class="text-sm text-slate-500 hover:text-yellow-600 font-medium flex items-center transition-colors">
                            <ion-icon name="refresh-outline" class="mr-1"></ion-icon> แสดงทั้งหมด
                        </button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="filterMyTasks('todo')" id="btn-filter-todo"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-slate-100 rounded-lg text-slate-600 group-hover:bg-slate-200 transition-colors">
                                    <ion-icon name="clipboard-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-todo"
                                    class="bg-slate-100 text-slate-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">รอทำ</span>
                        </button>

                        <button onclick="filterMyTasks('in-progress')" id="btn-filter-inprogress"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-yellow-100 rounded-lg text-yellow-600 group-hover:bg-yellow-200 transition-colors">
                                    <ion-icon name="construct-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-inprogress"
                                    class="bg-yellow-100 text-yellow-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">กำลังทำ</span>
                        </button>

                        <button onclick="filterMyTasks('for-review')" id="btn-filter-review"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-orange-100 rounded-lg text-orange-600 group-hover:bg-orange-200 transition-colors">
                                    <ion-icon name="search-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-review"
                                    class="bg-orange-100 text-orange-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">รอตรวจสอบ</span>
                        </button>

                        <button onclick="filterMyTasks('completed')" id="btn-filter-completed"
                            class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div
                                    class="p-2 bg-green-100 rounded-lg text-green-600 group-hover:bg-green-200 transition-colors">
                                    <ion-icon name="checkmark-circle-outline"></ion-icon>
                                </div>
                                <span id="mytask-count-completed"
                                    class="bg-green-100 text-green-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                            </div>
                            <span class="text-sm font-semibold text-slate-600">เสร็จสิ้น</span>
                        </button>
                    </div>
                </div>

                <!-- Task View -->
                <div id="task-view-content"
                    class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div id="loading-tasks" class="text-center p-12 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-4">
                        </div>
                        <p class="text-slate-500 font-medium">กำลังดึงข้อมูลงาน...</p>
                    </div>
                    <div id="task-error-message"
                        class="hidden p-4 m-6 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100 flex items-center"
                        role="alert">
                        <ion-icon name="alert-circle" class="text-xl mr-2"></ion-icon>
                        <div><span class="font-bold">เกิดข้อผิดพลาด:</span> <span id="task-error-text"></span></div>
                    </div>

                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="text-lg font-bold text-slate-800">รายการงาน</h3>
                        <span id="task-count"
                            class="text-xs font-semibold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">0
                            งาน</span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ชื่องาน</th>
                                    <th id="header-assignee"
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ผู้รับผิดชอบ</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        สถานะ</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        วันครบกำหนด</th>
                                    <th
                                        class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body" class="divide-y divide-slate-100">
                                <tr id="no-task-row" class="text-center">
                                    <td colspan="5"
                                        class="px-6 py-12 text-slate-400 flex flex-col items-center justify-center">
                                        <ion-icon name="folder-open-outline"
                                            class="text-4xl mb-2 text-slate-300"></ion-icon>
                                        ไม่มีงานที่ต้องแสดงในขณะนี้
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Deposit View -->
                <div id="deposit-view"
                    class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mt-6 p-6">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h3 class="text-xl font-bold text-slate-800 flex items-center">
                            <div class="p-2 bg-yellow-100 text-yellow-600 rounded-lg mr-3"><ion-icon
                                    name="wallet"></ion-icon></div>
                            <span id="deposit-header-title">เงินค่ามัดจำหน้าร้าน</span>
                        </h3>

                        <div class="flex items-center gap-3">
                            <div id="filter-branch-container">
                                <select id="deposit-filter-branch" class="form-select-theme py-2 pl-3 pr-8 text-sm">
                                    <option value="all" selected>ดูทุกสาขา</option>
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="หาดใหญ่">หาดใหญ่</option>
                                    <option value="หาดใหญ่2">หาดใหญ่2</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                    <option value="โคลีเซียม">โคลีเซียม</option>
                                    <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                    <option value="ปากแมว">ปากแมว</option>
                                    <option value="ภูเก็ต">ภูเก็ต</option>
                                    <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                    <option value="กระบี่">กระบี่</option>
                                    <option value="กะทู้">กะทู้</option>
                                    <option value="ตรัง">ตรัง</option>
                                    <option value="คุรุ">คุรุ</option>
                                    <option value="ชุมพร">ชุมพร</option>
                                    <option value="สตูล">สตูล</option>
                                    <option value="พัทลุง">พัทลุง</option>
                                    <option value="สงขลา">สงขลา</option>
                                </select>
                            </div>

                            <button onclick="openDepositModal()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl shadow-lg shadow-green-600/20 flex items-center font-medium transition-all">
                                <ion-icon name="add-circle" class="mr-2"></ion-icon> เพิ่มรายการ
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-xl border border-slate-200">
                        <table class="w-full deposit-table border-collapse text-sm">
                            <thead>
                                <tr>
                                    <th rowspan="2">วันที่มัดจำ</th>
                                    <th rowspan="2">ลูกค้า</th>
                                    <th rowspan="2">เบอร์โทร</th>
                                    <th rowspan="2" class="bg-red-50 text-red-700 border-red-100">ยอดมัดจำ</th>
                                    <th rowspan="2">นัดรับ</th>
                                    <th colspan="8" class="bg-slate-100 text-slate-600 border-b border-slate-200">
                                        ข้อมูลรับเครื่อง</th>
                                </tr>
                                <tr>
                                    <th>บิล</th>
                                    <th>IMEI</th>
                                    <th>สินค้า</th>
                                    <th>สถานะจัดซื้อ</th>
                                    <th>ราคาเต็ม</th>
                                    <th class="bg-blue-50 text-blue-700">ค้างชำระ</th>
                                    <th>สถานะ</th>
                                    <th>ผู้ทำรายการ</th>
                                </tr>
                            </thead>
                            <tbody id="deposit-table-body" class="text-slate-600 bg-white">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="purchasing-view" class="hidden space-y-6 mt-6">
                    <!-- Header Section -->
                    <div
                        class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div
                                class="p-3 bg-gradient-to-br from-yellow-400 to-orange-600 text-white rounded-xl shadow-lg shadow-blue-500/30">
                                <ion-icon name="cart" class="text-2xl"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">ติดตามการสั่งซื้อ</h3>
                                <p class="text-sm text-slate-500">จัดการและติดตามสถานะสินค้าสำหรับหน้าร้าน</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 w-full md:w-auto">
                            <!-- Search Input (New) -->
                            <div class="relative w-full md:w-64">
                                <input type="text" id="purchasing-search-input" onkeyup="handlePurchasingSearch()"
                                    class="form-input-theme pl-10 text-sm shadow-sm border-slate-200 focus:border-blue-400 focus:ring-blue-400/50 placeholder-slate-400"
                                    placeholder="ค้นหาลูกค้า, เบอร์โทร, สินค้า...">
                            </div>

                            <div class="relative group w-full md:w-48">
                                <select id="purchasing-filter-branch" onchange="fetchPurchasingOrders()"
                                    class="form-select-theme pl-10 text-sm shadow-sm border-slate-200 hover:border-blue-400 transition-colors cursor-pointer appearance-none">
                                    <option value="all" selected>ทุกสาขา</option>
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="หาดใหญ่">หาดใหญ่</option>
                                    <option value="หาดใหญ่2">หาดใหญ่2</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                    <option value="โคลีเซียม">โคลีเซียม</option>
                                    <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                    <option value="ปากแมว">ปากแมว</option>
                                    <option value="ภูเก็ต">ภูเก็ต</option>
                                    <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                    <option value="กระบี่">กระบี่</option>
                                    <option value="กะทู้">กะทู้</option>
                                    <option value="ตรัง">ตรัง</option>
                                    <option value="คุรุ">คุรุ</option>
                                    <option value="ชุมพร">ชุมพร</option>
                                    <option value="สตูล">สตูล</option>
                                    <option value="พัทลุง">พัทลุง</option>
                                    <option value="สงขลา">สงขลา</option>
                                </select>
                            </div>
                            <button onclick="fetchPurchasingOrders()"
                                class="p-2.5 bg-white border border-slate-200 rounded-xl text-slate-500 hover:text-blue-600 hover:border-blue-300 hover:bg-blue-50 transition-all shadow-sm active:scale-95">
                                <ion-icon name="refresh" class="text-xl"></ion-icon>
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Summary (Optional Enhancement) -->
                    <!-- Statistics Summary (Clickable Filters) -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div onclick="filterPurchasingByStatus('pending')" id="card-filter-pending"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-yellow-600 transition-colors">
                                    รอดำเนินการ</p>
                                <p id="count-pending" class="text-xl font-bold text-yellow-600">0</p>
                            </div>
                            <div
                                class="p-2 bg-yellow-50 text-yellow-600 rounded-lg group-hover:bg-yellow-100 transition-colors">
                                <ion-icon name="time"></ion-icon>
                            </div>
                        </div>
                        <div onclick="filterPurchasingByStatus('ordered')" id="card-filter-ordered"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-blue-600 transition-colors">
                                    สั่งของแล้ว</p>
                                <p id="count-ordered" class="text-xl font-bold text-blue-600">0</p>
                            </div>
                            <div
                                class="p-2 bg-blue-50 text-blue-600 rounded-lg group-hover:bg-blue-100 transition-colors">
                                <ion-icon name="cart"></ion-icon>
                            </div>
                        </div>
                        <div onclick="filterPurchasingByStatus('arrived')" id="card-filter-arrived"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-green-600 transition-colors">
                                    ของมาถึงแล้ว</p>
                                <p id="count-arrived" class="text-xl font-bold text-green-600">0</p>
                            </div>
                            <div
                                class="p-2 bg-green-50 text-green-600 rounded-lg group-hover:bg-green-100 transition-colors">
                                <ion-icon name="cube"></ion-icon>
                            </div>
                        </div>
                        <div onclick="filterPurchasingByStatus('canceled')" id="card-filter-canceled"
                            class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer hover:shadow-md transition-all active:scale-95 group">
                            <div>
                                <p
                                    class="text-xs font-semibold text-slate-400 uppercase group-hover:text-red-600 transition-colors">
                                    ยกเลิก/คืนเงิน</p>
                                <p id="count-canceled" class="text-xl font-bold text-red-600">0</p>
                            </div>
                            <div class="p-2 bg-red-50 text-red-600 rounded-lg group-hover:bg-red-100 transition-colors">
                                <ion-icon name="alert-circle"></ion-icon>
                            </div>
                        </div>
                    </div>

                    <!-- Clear Filter Button (Hidden by default) -->
                    <div id="active-filter-indicator"
                        class="hidden flex items-center justify-between bg-blue-50 text-blue-700 px-4 py-2 rounded-xl border border-blue-100">
                        <span class="text-sm font-semibold flex items-center"><ion-icon name="funnel"
                                class="mr-2"></ion-icon> กำลังแสดง: <span id="filter-name-display"
                                class="ml-1">...</span></span>
                        <button onclick="clearPurchasingFilter()"
                            class="text-xs bg-white border border-blue-200 px-2 py-1 rounded-lg hover:bg-blue-100 transition-colors">ล้างตัวกรอง</button>
                    </div>

                    <!-- Cards Container -->
                    <div id="purchasing-list-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Cards will be injected here via JS -->
                    </div>

                    <!-- Empty State (Hidden by default) -->
                    <div id="purchasing-empty-state"
                        class="hidden flex-col items-center justify-center py-16 bg-white rounded-3xl border-2 border-dashed border-slate-200">
                        <div class="p-4 bg-slate-50 rounded-full mb-4">
                            <ion-icon name="basket-outline" class="text-4xl text-slate-300"></ion-icon>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-600">ไม่มีรายการสั่งซื้อ</h4>
                        <p class="text-slate-400 text-sm mt-1">รายการมัดจำจากหน้าร้านจะปรากฏที่นี่</p>
                    </div>
                </div>

                <!-- Import Notification View -->
                <div id="import-view" class="hidden space-y-6 mt-6">
                    <!-- Header -->
                    <div
                        class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div
                                class="p-3 bg-gradient-to-br from-blue-400 to-indigo-600 text-white rounded-xl shadow-lg shadow-indigo-500/30">
                                <ion-icon name="cloud-upload" class="text-2xl"></ion-icon>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">แจ้งนำเข้าสินค้า</h3>
                                <p class="text-sm text-slate-500">แจ้งรายการสินค้าเข้าใหม่ไปยังฝ่ายสต็อก</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-2 overflow-x-auto">
                        <div class="flex space-x-2 md:space-x-4 min-w-max">
                            <button onclick="switchImportTab('phone')" id="tab-btn-phone"
                                class="flex items-center px-4 py-3 rounded-xl text-sm font-semibold transition-all bg-indigo-50 text-indigo-600 ring-2 ring-indigo-100">
                                <ion-icon name="phone-portrait-outline" class="mr-2 text-lg"></ion-icon>
                                นำเข้าโทรศัพท์ (Excel)
                            </button>
                            <button onclick="switchImportTab('accessory')" id="tab-btn-accessory"
                                class="flex items-center px-4 py-3 rounded-xl text-sm font-semibold text-slate-500 hover:bg-slate-50 transition-all">
                                <ion-icon name="headset-outline" class="mr-2 text-lg"></ion-icon>
                                นำเข้า Accessories (รูปภาพ)
                            </button>
                        </div>
                    </div>

                    <!-- Phone Import Section -->
                    <div id="tab-import-phone" class="space-y-6 animate-fade-in">
                        <!-- Upload Card -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                            <h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                                <ion-icon name="document-attach-outline" class="mr-2 text-indigo-500"></ion-icon>
                                อัปโหลดไฟล์รายการ (Excel)
                            </h4>
                            <form id="phone-import-form" class="space-y-4">
                                <div
                                    class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center hover:bg-slate-50 transition-all cursor-pointer relative group">
                                    <input type="file" id="phone-import-file" accept=".xlsx, .xls"
                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer text-sm">
                                    <div class="flex flex-col items-center pointer-events-none">
                                        <div
                                            class="p-4 bg-indigo-50 text-indigo-500 rounded-full mb-3 group-hover:scale-110 transition-transform">
                                            <ion-icon name="cloud-upload" class="text-3xl"></ion-icon>
                                        </div>
                                        <p class="font-medium text-slate-700">คลิกเพื่อเลือกไฟล์ หรือลากไฟล์มาวางที่นี่
                                        </p>
                                        <p class="text-xs text-slate-400 mt-1">รองรับไฟล์ .xlsx, .xls</p>
                                        <p id="file-name-display" class="mt-4 text-sm font-semibold text-indigo-600">
                                        </p>
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit"
                                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl font-semibold shadow-lg shadow-indigo-600/30 transition-all flex items-center">
                                        <ion-icon name="paper-plane" class="mr-2"></ion-icon>
                                        ส่งแจ้งนำเข้า
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- History List -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h4 class="text-lg font-bold text-slate-800">ประวัติการแจ้งนำเข้า (โทรศัพท์)</h4>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500">
                                                วันที่แจ้ง</th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500">ไฟล์แนบ
                                            </th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500">สาขา
                                            </th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500">สถานะ
                                            </th>
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500">ผู้แจ้ง
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="phone-import-list" class="divide-y divide-slate-100">
                                        <!-- Items will be injected here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Accessory Import Section -->
                    <div id="tab-import-accessory" class="hidden space-y-6 animate-fade-in">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Form -->
                            <div class="lg:col-span-1">
                                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                                    <h4 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                                        <ion-icon name="create-outline" class="mr-2 text-pink-500"></ion-icon>
                                        ข้อมูลสินค้า (Accessory)
                                    </h4>
                                    <form id="accessory-import-form" class="space-y-4">
                                        <div>
                                            <label
                                                class="block text-sm font-semibold text-slate-700 mb-1">รูปภาพสินค้า</label>
                                            <div class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center hover:bg-slate-50 transition-all cursor-pointer relative bg-slate-50/50"
                                                style="min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                                <input type="file" id="acc-import-image" accept="image/*"
                                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                                    onchange="previewImage(this)">
                                                <div id="image-preview-placeholder" class="flex flex-col items-center">
                                                    <ion-icon name="image-outline"
                                                        class="text-4xl text-slate-300 mb-2"></ion-icon>
                                                    <span class="text-sm text-slate-500">เลือกรูปภาพ</span>
                                                </div>
                                                <img id="image-preview" src=""
                                                    class="hidden max-h-48 rounded-lg object-contain relative z-0">
                                            </div>
                                        </div>
                                        <div>
                                            <label
                                                class="block text-sm font-semibold text-slate-700 mb-1">ชื่อสินค้า</label>
                                            <input type="text" id="acc-name" class="form-input-theme" required
                                                placeholder="เช่น หูฟัง, เคส...">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-sm font-semibold text-slate-700 mb-1">จำนวนนำเข้า</label>
                                            <input type="number" id="acc-qty" class="form-input-theme" required min="1"
                                                value="1">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-sm font-semibold text-slate-700 mb-1">วันที่นำเข้า</label>
                                            <input type="date" id="acc-date" class="form-input-theme" required>
                                        </div>
                                        <button type="submit"
                                            class="w-full bg-pink-500 hover:bg-pink-600 text-white px-6 py-2.5 rounded-xl font-semibold shadow-lg shadow-pink-500/30 transition-all">
                                            บันทึกรายการ
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- List -->
                            <div class="lg:col-span-2">
                                <div
                                    class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden h-full">
                                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                                        <h4 class="text-lg font-bold text-slate-800">รายการ Accessories ล่าสุด</h4>
                                    </div>
                                    <div class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4" id="accessory-import-list">
                                        <!-- Accessor Cards Injected Here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin View -->
                <div id="admin-view-content"
                    class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div id="loading-users" class="text-center p-12 hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-4">
                        </div>
                        <p class="text-slate-500">กำลังดึงข้อมูลผู้ใช้...</p>
                    </div>
                    <div
                        class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center bg-slate-50/50 gap-4">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-bold text-slate-800">รายชื่อผู้ใช้ในระบบ</h3>
                            <span id="user-count"
                                class="text-xs font-semibold text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">0
                                คน</span>
                        </div>
                        <div class="relative w-full sm:w-64">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <ion-icon name="search-outline" class="text-slate-400"></ion-icon>
                            </div>
                            <input type="text" id="user-search-input"
                                class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-xl leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 sm:text-sm transition-shadow"
                                placeholder="ค้นหาชื่อ หรือ Username...">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-lg">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ชื่อ-สกุล</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        Username</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        ตำแหน่ง</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        แผนก / สาขา</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        หัวหน้า</th>
                                    <th
                                        class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                        จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="divide-y divide-slate-100">
                                <tr id="no-user-row" class="text-center">
                                    <td colspan="6" class="px-6 py-12 text-slate-400">ไม่มีผู้ใช้ในระบบ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- =============================================== -->
                <!-- STOCK IMPORT MANAGEMENT VIEW (ใหม่) -->
                <!-- =============================================== -->
                <div id="stock-import-view" class="hidden animate-fade-in">
                    <!-- Modern Tabs -->
                    <div
                        class="mb-6 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200 inline-flex flex-wrap gap-1">
                        <button onclick="filterStockType('phone')" id="tab-stock-phone"
                            class="px-6 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:text-slate-800 hover:bg-slate-50 transition-all flex items-center gap-2">
                            <ion-icon name="phone-portrait-outline" class="text-lg"></ion-icon> โทรศัพท์
                        </button>
                        <button onclick="filterStockType('accessory')" id="tab-stock-accessory"
                            class="px-6 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:text-slate-800 hover:bg-slate-50 transition-all flex items-center gap-2">
                            <ion-icon name="headset-outline" class="text-lg"></ion-icon> Accessories
                        </button>
                    </div>

                    <!-- Enhanced Filter Toolbar -->
                    <div
                        class="mb-6 bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col xl:flex-row items-start xl:items-center justify-between gap-6">
                        <!-- Left: Branch Filter -->
                        <div class="flex items-center gap-4 w-full xl:w-auto">
                            <div
                                class="flex-shrink-0 w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center">
                                <ion-icon name="storefront" class="text-xl"></ion-icon>
                            </div>
                            <div class="w-full xl:w-72">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5">สาขา
                                    (Branch)</label>
                                <select id="stock-import-branch-filter"
                                    class="form-select-theme py-2.5 pl-3 pr-10 text-sm shadow-none bg-slate-50 border-slate-200 focus:bg-white">
                                    <option value="all" selected>🏢 ทุกสาขา (All Branches)</option>
                                    <option value="ยะลา">ยะลา</option>
                                    <option value="นราธิวาส">นราธิวาส</option>
                                    <option value="หาดใหญ่">หาดใหญ่</option>
                                    <option value="หาดใหญ่2">หาดใหญ่2</option>
                                    <option value="ปัตตานี">ปัตตานี</option>
                                    <option value="โคลีเซียม">โคลีเซียม</option>
                                    <option value="สุราษฎร์ธานี">สุราษฎร์ธานี</option>
                                    <option value="ปากแมว">ปากแมว</option>
                                    <option value="ภูเก็ต">ภูเก็ต</option>
                                    <option value="นครศรีธรรมราช">นครศรีธรรมราช</option>
                                    <option value="กระบี่">กระบี่</option>
                                    <option value="กะทู้">กะทู้</option>
                                    <option value="ตรัง">ตรัง</option>
                                    <option value="คุรุ">คุรุ</option>
                                    <option value="ชุมพร">ชุมพร</option>
                                    <option value="สตูล">สตูล</option>
                                    <option value="พัทลุง">พัทลุง</option>
                                    <option value="สงขลา">สงขลา</option>
                                </select>
                            </div>
                        </div>

                        <!-- Right: Status Filters Pipeline -->
                        <div class="w-full xl:w-auto overflow-x-auto pb-1">
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 px-1">สถานะ
                                (Status)</label>
                            <div class="flex bg-slate-100/80 p-1.5 rounded-xl gap-1 min-w-max"
                                id="stock-import-filters">
                                <button onclick="filterStockImports('pending')" id="filter-stock-pending"
                                    class="px-5 py-2 rounded-lg text-sm font-bold text-white bg-indigo-600 shadow-md ring-1 ring-slate-200 transition-all flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-yellow-400 border border-white/30"></div>
                                    รอนำเข้า
                                </button>
                                <button onclick="filterStockImports('importing')" id="filter-stock-importing"
                                    class="px-5 py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-white/50 transition-all flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-blue-500"></div> กำลังนำเข้า
                                </button>
                                <button onclick="filterStockImports('received')" id="filter-stock-received"
                                    class="px-5 py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-white/50 transition-all flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-green-500"></div> นำเข้าแล้ว
                                </button>
                                <button onclick="filterStockImports('all')" id="filter-stock-all"
                                    class="px-5 py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-white/50 transition-all flex items-center gap-2">
                                    <ion-icon name="apps-outline"></ion-icon> ทั้งหมด
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Table Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-100">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                            วันที่แจ้ง</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                            สาขา / ผู้แจ้ง</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                            รายการสินค้า</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                            ไฟล์แนบ</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                            สถานะ</th>
                                        <th
                                            class="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                            จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-import-table-body" class="divide-y divide-slate-100">
                                    <!-- Rows will be populated by JS -->
                                    <tr>
                                        <td colspan="6" class="px-6 py-12 text-center text-slate-400">
                                            <ion-icon name="cube-outline" class="w-8 h-8 mb-2 opacity-50"></ion-icon>
                                            <p>กำลังโหลดข้อมูล...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- New Task Modal -->
    <div id="newTaskModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">สั่งงานใหม่</h3>
                <button onclick="closeModal('newTaskModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8">
                <form id="new-task-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="taskTitle"
                                class="block text-sm font-semibold text-slate-700 mb-2">ชื่องาน</label>
                            <input type="text" id="taskTitle" name="title" required class="form-input-theme"
                                placeholder="เช่น สรุปยอดขายประจำสัปดาห์">
                        </div>
                        <div>
                            <label for="taskAssignTo"
                                class="block text-sm font-semibold text-slate-700 mb-2">มอบหมายให้</label>
                            <select id="taskAssignTo" name="assignedTo" required class="form-select-theme">
                                <option value="" disabled selected>--- กำลังโหลดรายชื่อพนักงาน ---</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="taskDesc"
                            class="block text-sm font-semibold text-slate-700 mb-2">รายละเอียดงาน</label>
                        <textarea id="taskDesc" name="description" rows="4" class="form-input-theme"
                            placeholder="รายละเอียด..."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="taskDueDate"
                                class="block text-sm font-semibold text-slate-700 mb-2">กำหนดส่ง</label>
                            <input type="date" id="taskDueDate" name="dueDate" class="form-input-theme">
                        </div>
                        <div>
                            <label for="taskPriority"
                                class="block text-sm font-semibold text-slate-700 mb-2">ความสำคัญ</label>
                            <select id="taskPriority" name="priority" class="form-select-theme">
                                <option value="low">ต่ำ</option>
                                <option value="medium" selected>ปานกลาง</option>
                                <option value="high">สูง</option>
                            </select>
                        </div>
                    </div>
                    <div id="new-task-error"
                        class="hidden p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('newTaskModal')">ยกเลิก</button>
                        <button type="submit" id="submit-task-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all flex items-center">
                            <span id="submit-task-text">สร้างงาน</span>
                            <div id="submit-task-spinner"
                                class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent">
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="depositModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div
                class="bg-gradient-to-r from-yellow-500 to-orange-600 p-6 flex justify-between items-center text-white">
                <h3 class="text-xl font-bold flex items-center"><ion-icon name="wallet" class="mr-2"></ion-icon>
                    บันทึกรายการมัดจำ</h3>
                <button onclick="closeModal('depositModal')" class="hover:text-yellow-100 transition-colors"><ion-icon
                        name="close" class="text-2xl"></ion-icon></button>
            </div>
            <div class="p-8 max-h-[80vh] overflow-y-auto">
                <form id="deposit-form" class="space-y-6">
                    <input type="hidden" id="dep-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6 border-b border-slate-100">
                        <div class="col-span-2 font-bold text-slate-800 flex items-center text-lg">
                            <div
                                class="w-8 h-8 rounded-lg bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3">
                                <ion-icon name="document-text"></ion-icon>
                            </div>
                            ข้อมูลการมัดจำ
                        </div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">วันที่มัดจำ</label><input
                                type="date" id="dep-date" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">วันที่นัดรับ</label><input
                                type="date" id="dep-pickup" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ชื่อลูกค้า</label><input
                                type="text" id="dep-name" class="form-input-theme" required></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">เบอร์โทร</label><input
                                type="text" id="dep-phone" class="form-input-theme" required></div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ยอดมัดจำ
                                (บาท)</label>
                            <input type="number" id="dep-amount"
                                class="form-input-theme bg-red-50 text-red-600 font-bold border-red-100 focus:ring-red-500 focus:border-red-500 text-lg"
                                required>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                        <div
                            class="col-span-2 font-bold text-slate-800 flex items-center text-lg bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <ion-icon name="gift" class="mr-3 text-yellow-500 text-xl"></ion-icon> ส่วนรับเครื่อง
                            (กรอกเมื่อมารับของ)
                        </div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">สินค้า
                                (รุ่น/สี/ความจุ)</label><select id="dep-product" class="form-select-theme"
                                placeholder="เลือกหรือพิมพ์เพิ่ม..."></select>
                        </div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ราคาเครื่องเต็ม
                                (บาท)</label><input type="number" id="dep-price" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">เลขที่บิล</label><input
                                type="text" id="dep-bill" class="form-input-theme"></div>
                        <div><label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">IMEI</label><input
                                type="text" id="dep-imei" class="form-input-theme"></div>

                        <div class="col-span-2 flex items-center mt-2 p-4 bg-green-50 rounded-xl border border-green-200 cursor-pointer hover:bg-green-100 transition-colors"
                            onclick="document.getElementById('dep-success').click()">
                            <input type="checkbox" id="dep-success"
                                class="w-5 h-5 text-green-600 rounded focus:ring-green-500 mr-3">
                            <label for="dep-success"
                                class="font-bold text-green-800 cursor-pointer select-none">ทำรายการสำเร็จ
                                (รับเครื่องแล้ว)</label>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-6 border-t border-slate-100">
                        <button type="button" onclick="closeModal('depositModal')"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors">ยกเลิก</button>
                        <button type="submit"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">บันทึกข้อมูล</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <form id="update-task-form">
                <input type="hidden" id="detail-task-id" name="taskId">
                <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800" id="detail-task-title">กำลังโหลด...</h3>
                    <button type="button" class="text-slate-400 hover:text-slate-600 transition-colors"
                        onclick="closeModal('taskDetailModal')">
                        <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                    </button>
                </div>

                <div class="p-8 space-y-6">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-sm font-semibold text-slate-500 mb-1">รายละเอียด</p>
                        <p id="detail-task-desc" class="text-slate-700 whitespace-pre-wrap leading-relaxed">...</p>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mr-3">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">ผู้สั่งงาน</p>
                                <p id="detail-task-creator" class="text-sm font-semibold text-slate-800">...</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div
                                class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3">
                                <ion-icon name="calendar"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">กำหนดส่ง</p>
                                <p id="detail-task-dueDate" class="text-sm font-semibold text-slate-800">...</p>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6">
                        <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center"><ion-icon
                                name="time-outline" class="mr-2"></ion-icon> ประวัติการอัปเดต</h4>
                        <div id="detail-task-comments-list"
                            class="space-y-3 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                            <p class="text-sm text-slate-400 italic">ไม่มีประวัติการอัปเดต</p>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-6 bg-yellow-50/50 -mx-8 px-8 -mb-8 pb-8">
                        <div class="mb-4">
                            <label for="detail-task-status"
                                class="block text-sm font-bold text-slate-700 mb-2">อัปเดตสถานะงาน</label>
                            <select id="detail-task-status" name="status" class="form-select-theme">
                                <option value="todo">มอบหมายแล้ว (To Do)</option>
                                <option value="in-progress">กำลังดำเนินการ (In Progress)</option>
                                <option value="for-review">ส่งตรวจสอบ (For Review)</option>
                                <option value="completed">สำเร็จแล้ว (Completed)</option>
                            </select>
                        </div>
                        <div>
                            <label for="detail-task-comment"
                                class="block text-sm font-bold text-slate-700 mb-2">เพิ่มคำอธิบาย</label>
                            <textarea id="detail-task-comment" name="commentText" rows="3" class="form-input-theme"
                                placeholder="เช่น อัปเดตความคืบหน้า หรือแนบ Link ผลงาน..."></textarea>
                        </div>
                    </div>
                </div>

                <div id="update-task-error"
                    class="hidden mx-8 mb-6 p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>

                <div class="px-8 py-4 border-t border-slate-100 bg-white flex justify-between items-center">
                    <button type="button" id="delete-task-btn"
                        class="text-red-600 hover:text-red-700 font-medium text-sm flex items-center px-3 py-2 rounded-lg hover:bg-red-50 transition-colors"
                        style="display: none;">
                        <ion-icon name="trash-outline" class="text-lg mr-2"></ion-icon> ลบงานนี้
                    </button>
                    <div class="flex gap-3">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('taskDetailModal')">ปิด</button>
                        <button type="submit" id="save-task-details-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">บันทึกการเปลี่ยนแปลง</button>
                    </div>
                </div>
            </form>
        </div>
    </div>



    <!-- Confirm Modal for Status Change -->
    <div id="statusUpdateModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6 text-center transform transition-all">
            <div
                class="w-16 h-16 bg-blue-100/50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <ion-icon name="sync-outline" class="text-3xl"></ion-icon>
            </div>
            <h3 class="text-lg font-bold text-slate-800">อัปเดตสถานะ</h3>
            <p class="text-sm text-slate-500 mt-2 mb-6">เปลี่ยนสถานะเป็น <span id="target-status-name"
                    class="font-bold text-indigo-600">...</span> ใช่หรือไม่?</p>
            <div class="flex gap-3">
                <button onclick="closeModal('statusUpdateModal')"
                    class="flex-1 px-4 py-2.5 bg-slate-100 text-slate-700 rounded-xl hover:bg-slate-200 font-medium transition-colors">ยกเลิก</button>
                <button id="confirm-status-update-btn"
                    class="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-medium shadow-lg shadow-indigo-200 transition-colors">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- =============================================== -->
    <!-- View: Admin (User Management) -->
    <!-- =============================================== -->
    <div id="admin-view-content" class="hidden animate-fade-in">
        <div class="modal-content relative w-full max-w-md bg-white rounded-2xl shadow-2xl p-6 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <ion-icon name="warning" class="text-3xl"></ion-icon>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">ยืนยันการลบ</h3>
            <p class="text-slate-500 mb-6" id="confirm-message">คุณแน่ใจหรือไม่ว่าต้องการลบงานนี้?
                การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <p id="confirm-error-message" class="text-xs text-red-600 mb-4"></p>

            <div class="flex justify-center gap-3">
                <button type="button"
                    class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                    onclick="closeModal('confirmModal')">ยกเลิก</button>
                <button type="button" id="confirm-delete-button" data-task-id=""
                    class="px-6 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg shadow-red-600/30 transition-all">ยืนยันลบ</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800" id="user-modal-title">เพิ่มผู้ใช้ใหม่</h3>
                <button onclick="closeModal('userModal')" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="p-8">
                <form id="user-form" class="space-y-6">
                    <input type="hidden" id="user-id" name="userId">
                    <input type="hidden" id="form-mode" name="mode" value="create">

                    <div>
                        <label for="user-company-input" class="block text-sm font-semibold text-slate-700 mb-2">บริษัท
                            (Company)</label>
                        <select id="user-company-input" name="companyId" required class="form-select-theme">
                            <option value="company_1_id">ซิลมีน โมบาย จำกัด</option>
                            <option value="company_2_id">เอสจี พลัส 2023 จำกัด</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="user-name-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">ชื่อ-สกุล</label>
                            <input type="text" id="user-name-input" name="name" required class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-role-input" class="block text-sm font-semibold text-slate-700 mb-2">ตำแหน่ง
                                (Role)</label>
                            <select id="user-role-input" name="role" required class="form-select-theme">
                                <option value="staff">พนักงาน (Staff)</option>
                                <option value="manager">ผู้จัดการ (Manager)</option>
                                <option value="hr">ฝ่ายบุคคล (HR)</option>
                                <option value="executive">ผู้บริหาร (Executive)</option>
                            </select>
                        </div>
                    </div>

                    <div id="auth-section"
                        class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                        <div>
                            <label for="user-username-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">Username (รหัสพนักงาน)</label>
                            <input type="text" id="user-username-input" name="username" required
                                class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-password-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">Password</label>
                            <input type="password" id="user-password-input" name="password" class="form-input-theme"
                                placeholder="เว้นว่างไว้หากไม่ต้องการเปลี่ยน">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="user-department-input"
                                class="block text-sm font-semibold text-slate-700 mb-2">แผนก</label>
                            <input type="text" id="user-department-input" name="department" required
                                class="form-input-theme">
                        </div>
                        <div>
                            <label for="user-branch-input" class="block text-sm font-semibold text-slate-700 mb-2">สาขา
                                (ถ้ามี)</label>
                            <input type="text" id="user-branch-input" name="branch" class="form-input-theme">
                        </div>
                    </div>

                    <div>
                        <label for="user-reportsTo-input"
                            class="block text-sm font-semibold text-slate-700 mb-2">หัวหน้างาน (Reports To)</label>
                        <select id="user-reportsTo-input" name="reportsTo" class="form-select-theme">
                            <option value="">--- ไม่มีหัวหน้า ---</option>
                        </select>
                    </div>

                    <div id="user-form-error"
                        class="hidden p-4 text-sm text-red-700 bg-red-50 rounded-xl border border-red-100"></div>

                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button"
                            class="px-6 py-2.5 rounded-xl text-slate-600 font-medium hover:bg-slate-100 transition-colors"
                            onclick="closeModal('userModal')">ยกเลิก</button>
                        <button type="submit" id="submit-user-btn"
                            class="px-6 py-2.5 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold shadow-lg shadow-yellow-500/30 transition-all">บันทึก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-content relative w-full max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-slate-800">การแจ้งเตือน</h3>
                    <button onclick="deleteAllNotifications()"
                        class="text-xs text-red-500 hover:text-red-700 font-medium bg-red-50 px-2 py-1 rounded-lg transition-colors">
                        ลบทั้งหมด
                    </button>
                </div>
                <button onclick="closeModal('notificationModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <ion-icon name="close" class="text-2xl"></ion-icon>
                </button>
            </div>

            <div id="notification-list" class="max-h-[60vh] overflow-y-auto custom-scrollbar">
                <p class="text-center text-slate-400 p-8">ไม่มีการแจ้งเตือนใหม่</p>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50/50 flex justify-end">
                <button type="button"
                    class="px-6 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium transition-colors"
                    onclick="closeModal('notificationModal')">ปิด</button>
            </div>
        </div>
    </div>
    <div id="purchasingModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div
            class="modal-content relative w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div
                class="bg-gradient-to-r from-blue-600 to-indigo-600 p-5 flex justify-between items-center text-white shadow-md">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                        <ion-icon name="cart" class="text-xl"></ion-icon>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold">อัปเดตสถานะ</h3>
                        <p class="text-blue-100 text-xs font-light">สำหรับฝ่ายจัดซื้อ</p>
                    </div>
                </div>
                <button onclick="closeModal('purchasingModal')"
                    class="hover:bg-white/10 p-2 rounded-full transition-colors"><ion-icon name="close"
                        class="text-2xl"></ion-icon></button>
            </div>
            <div class="p-6">
                <form id="purchasing-form" class="space-y-4">
                    <input type="hidden" id="pur-id">

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-6 shadow-inner">
                        <div class="flex items-start gap-3">
                            <div class="mt-1 p-1.5 bg-yellow-100 text-yellow-600 rounded-md">
                                <ion-icon name="cube"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-semibold uppercase tracking-wider">สินค้า</p>
                                <p id="pur-product-display"
                                    class="font-bold text-slate-800 text-lg leading-tight mt-0.5">...</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-200 flex items-start gap-3">
                            <div class="mt-1 p-1.5 bg-green-100 text-green-600 rounded-md">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 font-semibold uppercase tracking-wider">ลูกค้า</p>
                                <p id="pur-customer-display" class="font-medium text-slate-700 mt-0.5">...</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">สถานะสินค้า</label>
                        <select id="pur-status" class="form-select-theme">
                            <option value="pending">⏳ รอดำเนินการ (Pending)</option>
                            <option value="ordered">🚚 สั่งของแล้ว (Ordered)</option>
                            <option value="arrived">✅ ของมาถึงแล้ว (Arrived)</option>
                            <option value="canceled">❌ ยกเลิก (Canceled)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">หมายเหตุ (เช่น เลขพัสดุ)</label>
                        <textarea id="pur-note" rows="3" class="form-input-theme"
                            placeholder="ระบุรายละเอียดเพิ่มเติม..."></textarea>
                    </div>

                    <div class="pt-4 flex justify-end gap-3">
                        <button type="button" onclick="closeModal('purchasingModal')"
                            class="px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100">ยกเลิก</button>
                        <button type="submit"
                            class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-600/30">บันทึกสถานะ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        const SERVER_URL = '/api';
        let currentUser = null;
        let currentView = 'dashboard';
        let notificationPollInterval = null;
        let allDashboardTasks = [];
        let allMyTasks = [];

        // --- Helper Functions ---
        const getRoleName = (role) => {
            switch (role) {
                case 'executive': return 'ผู้บริหาร';
                case 'manager': return 'ผู้จัดการ';
                case 'hr': return 'ฝ่ายบุคคล (HR)';
                case 'staff': return 'พนักงาน';
                default: return role;
            }
        };
        const getStatusTag = (status) => {
            const map = {
                'todo': { text: 'รอทำ', bg: 'bg-slate-100', color: 'text-slate-600' },
                'in-progress': { text: 'กำลังทำ', bg: 'bg-yellow-100', color: 'text-yellow-700' },
                'for-review': { text: 'ส่งตรวจสอบ', bg: 'bg-orange-100', color: 'text-orange-700' },
                'completed': { text: 'เสร็จสิ้น', bg: 'bg-green-100', color: 'text-green-700' },
                'overdue': { text: 'เลยกำหนด', bg: 'bg-red-100', color: 'text-red-700' },
                // Import Statuses
                'pending': { text: 'รอนำเข้า', bg: 'bg-yellow-50', color: 'text-yellow-700' },
                'importing': { text: 'กำลังนำเข้า', bg: 'bg-blue-50', color: 'text-blue-700' },
                'received': { text: 'นำเข้าแล้ว', bg: 'bg-green-50', color: 'text-green-700' },
                'rejected': { text: 'ยกเลิก', bg: 'bg-red-50', color: 'text-red-700' }
            };
            const s = map[status] || map['todo'];
            return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${s.bg} ${s.color}">${s.text}</span>`;
        };
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };
        const safeHide = (el) => { if (el) el.classList.add('hidden'); };
        const safeShow = (el) => { if (el) el.classList.remove('hidden'); };

        const initializeAuth = () => {
            const token = localStorage.getItem('token');
            const userString = localStorage.getItem('user');

            if (!token || !userString) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userString);

            // แสดงชื่อและตำแหน่ง
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = getRoleName(currentUser.role);

            // เตรียมข้อมูลแผนก (ตัดช่องว่างซ้ายขวาออกเพื่อความชัวร์)
            const userDept = (currentUser.department || '').trim();

            // Populate Branches
            populateBranchSelects();

            // =======================================================
            // 1. ควบคุมเมนู "เงินค่ามัดจำหน้าร้าน" (Sales / Storefront)
            // =======================================================
            const depositNav = document.getElementById('nav-Storefront_deposit');
            if (depositNav) {
                const isSalesTeam = userDept.includes('ขาย') || userDept.includes('Sales');

                // แสดงเมนูนี้ถ้าเป็น: ทีมขาย, Admin, Executive, Manager, หรือ HR
                if (isSalesTeam || ['admin', 'executive', 'manager', 'hr'].includes(currentUser.role)) {
                    depositNav.style.display = 'flex';
                } else {
                    depositNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2. [ใหม่] ควบคุมเมนู "ติดตามการสั่งซื้อ" (Purchasing)
            // =======================================================
            const purchasingNav = document.getElementById('nav-purchasing');
            if (purchasingNav) {
                const isPurchasing = userDept.includes('จัดซื้อ') || userDept.includes('Purchase');

                // แสดงเมนูนี้ถ้าเป็น: ทีมจัดซื้อ, Admin, Executive, หรือ Manager
                // (HR อาจจะไม่จำเป็นต้องดู แต่ถ้าอยากให้ดูได้ก็เติม 'hr' เข้าไปใน array ได้ครับ)
                if (isPurchasing || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    purchasingNav.style.display = 'flex';
                } else {
                    purchasingNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2.1 [ใหม่] ควบคุมเมนู "แจ้งนำเข้า" (Import Notification)
            // =======================================================
            const importNav = document.getElementById('nav-import');
            if (importNav) {
                const isSales = userDept.includes('ขาย') || userDept.includes('Sales');
                // แสดงเมนูนี้ถ้าเป็น: ทีมขาย (Sales), Admin, Executive, Manager
                if (isSales || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    importNav.classList.remove('hidden');
                    importNav.style.display = 'flex';
                } else {
                    importNav.classList.add('hidden');
                    importNav.style.display = 'none';
                }
            }

            // =======================================================
            // 2.2 [ใหม่] ควบคุมเมนู "จัดการรายการนำเข้า" (Stock Import)
            // =======================================================
            const stockImportNav = document.getElementById('nav-stock-import');
            if (stockImportNav) {
                const isStockTeam = userDept.includes('Store') || userDept.includes('Stock') || userDept.includes('สต๊อก');
                if (isStockTeam || ['admin', 'executive', 'manager'].includes(currentUser.role)) {
                    stockImportNav.classList.remove('hidden');
                    stockImportNav.style.display = 'flex';
                } else {
                    stockImportNav.classList.add('hidden');
                    stockImportNav.style.display = 'none';
                }
            }

            // =======================================================
            // 3. กำหนดหน้าจอเริ่มต้นตามตำแหน่ง (Role Logic)
            // =======================================================
            if (currentUser.role === 'staff') {
                // --- พนักงานทั่วไป (Staff) ---
                safeHide(document.getElementById('nav-dashboard'));
                safeHide(document.getElementById('nav-admin'));

                if (document.getElementById('company-select')) {
                    document.getElementById('company-select').parentElement.style.display = 'none';
                }

                // เปลี่ยนข้อความ Header
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = 'ผู้มอบหมายงาน';

                // เข้าสู่หน้า "งานของฉัน" เป็นหน้าแรก
                updateNavActiveState('mytasks');
                fetchMyTasks();

            } else if (currentUser.role === 'executive') {
                // --- ผู้บริหาร (Executive) ---
                safeHide(document.getElementById('nav-mytasks'));

                // เข้าสู่หน้า Dashboard เป็นหน้าแรก
                updateNavActiveState('dashboard');
                fetchDashboardTasks();
                fetchTaskStats();
                fetchAllUsers();

            } else if (currentUser.role === 'manager' || currentUser.role === 'hr') {
                // --- ผู้จัดการ (Manager) และ HR ---
                // (แสดง Dashboard แต่ยังเข้าเมนู My Tasks ได้ถ้าไม่ได้ซ่อน)

                updateNavActiveState('dashboard');
                fetchDashboardTasks();
                fetchTaskStats();
                fetchAllUsers();
            }

            // =======================================================
            // 4. ตั้งค่าระบบอื่นๆ (Logout / Notifications)
            // =======================================================
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                clearInterval(notificationPollInterval);
                window.location.href = 'login.html';
            });

            fetchNotifications();
            notificationPollInterval = setInterval(fetchNotifications, 60000);
        };

        // ------------------------------------------
        // --- (A) TASK FUNCTIONS ---
        // ------------------------------------------
        const fetchTaskStats = async () => {
            const token = localStorage.getItem('token');
            const selectedCompanyId = document.getElementById('company-select').value;
            const statsDiv = document.getElementById('stats-cards');
            statsDiv.innerHTML = `<div class="text-sm text-gray-500">กำลังโหลดสถิติ...</div>`;
            try {
                const response = await fetch(`${SERVER_URL}/tasks/stats?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { statsDiv.innerHTML = `<div class="text-sm text-red-500">โหลดสถิติไม่สำเร็จ</div>`; return; }
                const stats = await response.json();

                statsDiv.innerHTML = `
                    <div onclick="filterTasksByStatus('todo')" data-status="todo" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-gray-100 text-gray-600"><ion-icon name="clipboard-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">สั่งแล้ว</p><p class="text-2xl font-bold text-gray-900">${stats.todo || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('in-progress')" data-status="in-progress" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-yellow-100 text-yellow-600"><ion-icon name="ellipsis-horizontal-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">กำลังดำเนินการ</p><p class="text-2xl font-bold text-gray-900">${stats.inProgress || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('for-review')" data-status="for-review" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-amber-100 text-amber-600"><ion-icon name="search-circle-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">ส่งตรวจสอบ</p><p class="text-2xl font-bold text-gray-900">${stats.forReview || 0}</p></div></div>
                    </div>
                    <div onclick="filterTasksByStatus('completed')" data-status="completed" class="p-5 bg-white rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                        <div class="flex items-center"><div class="p-3 rounded-full bg-green-100 text-green-600"><ion-icon name="checkmark-done-outline" class="w-6 h-6"></ion-icon></div><div class="ml-4"><p class="text-sm font-medium text-gray-500">งานที่เสร็จสิ้น</p><p class="text-2xl font-bold text-gray-900">${stats.completed || 0}</p></div></div>
                    </div>
                `;
            } catch (error) {
                console.error('Fetch Stats Error:', error);
                statsDiv.innerHTML = `<div class="text-sm text-red-500">เกิดข้อผิดพลาดในการโหลดสถิติ</div>`;
            }
        };

        const fetchAllUsers = async () => {
            const token = localStorage.getItem('token');
            const selectElement = document.getElementById('taskAssignTo');
            const selectedCompanyId = document.getElementById('company-select').value;
            selectElement.innerHTML = '<option value="" disabled selected>--- กำลังโหลด... ---</option>';
            selectElement.disabled = true;
            try {
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                if (!response.ok) { selectElement.innerHTML = '<option value="" disabled selected>--- โหลดรายชื่อไม่สำเร็จ ---</option>'; return; }
                const users = await response.json();
                selectElement.innerHTML = '';
                selectElement.disabled = false;
                selectElement.prepend(new Option('--- เลือกผู้รับผิดชอบ ---', '', true, true));
                if (selectElement.tomselect) {
                    selectElement.tomselect.destroy();
                }
                users.forEach(user => {
                    if (user && user._id) {
                        const option = document.createElement('option');
                        option.value = user._id;
                        option.textContent = `${user.name} (${user.branch || user.department})`;
                        selectElement.appendChild(option);
                    }
                });
            } catch (error) {
                selectElement.innerHTML = '<option value="" disabled selected>--- โหลดรายชื่อไม่สำเร็จ (Server Down?) ---</option>';
            }
        };

        const fetchDashboardTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = '';
            const selectedCompanyId = document.getElementById('company-select').value;
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=dashboard&companyId=${selectedCompanyId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || 'ไม่สามารถดึงข้อมูลงานได้';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();

                allDashboardTasks = tasks;      // เก็บงานทั้งหมดลง Cache
                renderTaskTable(tasks);         // แสดงผลทั้งหมด (ปกติ)
                filterTasksByStatus('todo');

            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };

        const fetchMyTasks = async () => {
            safeShow(document.getElementById('loading-tasks'));
            safeHide(document.getElementById('task-error-message'));
            const token = localStorage.getItem('token');
            const taskTableBody = document.getElementById('task-table-body');
            taskTableBody.innerHTML = '';
            try {
                const response = await fetch(`${SERVER_URL}/tasks?view=mytasks`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                safeHide(document.getElementById('loading-tasks'));
                if (!response.ok) {
                    const errorData = await response.json();
                    document.getElementById('task-error-text').textContent = errorData.message || 'ไม่สามารถดึงข้อมูลงานได้';
                    safeShow(document.getElementById('task-error-message'));
                    return;
                }
                const tasks = await response.json();
                allMyTasks = tasks;     // 1. เก็บข้อมูลทั้งหมดไว้ในตัวแปรกลาง
                updateMyTaskCounts();   // 2. อัปเดตตัวเลขบนปุ่ม
                filterMyTasks('todo'); // 3. Default แสดง Todo
            } catch (error) {
                safeHide(document.getElementById('loading-tasks'));
                document.getElementById('task-error-text').textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ Server';
                safeShow(document.getElementById('task-error-message'));
            }
        };

        const renderTaskTable = (tasks) => {
            const taskTableBody = document.getElementById('task-table-body');

            // อัปเดตจำนวนงาน (ถ้ามี element นี้)
            const countElement = document.getElementById('task-count');
            if (countElement) countElement.textContent = `${tasks.length} งาน`;

            // 1. กรณีไม่มีงาน
            if (tasks.length === 0) {
                taskTableBody.innerHTML = `<tr id="no-task-row" class="text-center"><td colspan="5" class="px-6 py-4 text-gray-500">ไม่มีงานที่ต้องแสดงในขณะนี้</td></tr>`;
                return;
            }

            taskTableBody.innerHTML = '';

            // 2. วนลูปแสดงงาน
            tasks.forEach((task, index) => {
                // ตรวจสอบงานเกินกำหนด
                const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'completed';
                const statusDisplay = isOverdue ? getStatusTag('overdue') : getStatusTag(task.status);

                // --- LOGIC การเลือกแสดงชื่อ (ผู้รับผิดชอบ VS ผู้สั่งงาน) ---
                let personName = 'Unknown User';
                let personSubText = '-';
                let personImageChar = '?';
                let showBranchBadge = false; // ตัวแปรเช็คว่าจะโชว์ Badge สาขาไหม

                // ตรวจสอบว่าเป็นหน้า "งานของฉัน" หรือไม่ (ต้องมีตัวแปร currentView ในระบบ)
                const isMyTasksView = (typeof currentView !== 'undefined' && currentView === 'mytasks');

                if (isMyTasksView) {
                    // >> กรณีหน้างานของฉัน: แสดง "ผู้สั่งงาน" (Created By)
                    if (task.createdBy) {
                        personName = task.createdBy.name || 'ไม่ระบุชื่อ';
                        personSubText = 'ผู้สั่งงาน'; // ข้อความระบุสถานะ
                        personImageChar = personName.charAt(0);
                    } else {
                        personName = 'ไม่ระบุ';
                        personSubText = 'ผู้สั่งงาน';
                    }
                    // ปกติผู้สั่งงานไม่ต้องโชว์ Badge สาขาก็ได้ (หรือถ้าต้องการก็เปิดได้)
                    showBranchBadge = false;

                } else {
                    // >> กรณีหน้าอื่น (Dashboard): แสดง "ผู้รับผิดชอบ" (Assigned To)
                    if (task.assignedTo) {
                        personName = task.assignedTo.name || 'Unknown User';
                        // ดึงสังกัด (ถ้ามีสาขาให้แสดงสาขา ถ้าไม่มีให้แสดงแผนก)
                        personSubText = task.assignedTo.branch || task.assignedTo.department || 'N/A';
                        personImageChar = personName.charAt(0);
                    }
                    // แสดง Badge สาขาเฉพาะเมื่อดูในมุมมองผู้รับผิดชอบ และงานนั้นมีระบุสาขา
                    showBranchBadge = true;
                }

                // --- LOGIC การแสดงชื่อและ Badge ---
                let nameDisplayHtml = personName;

                // ถ้า Logic อนุญาตให้โชว์ Badge และ Task มีข้อมูล Branch
                if (showBranchBadge && task.branch) {
                    nameDisplayHtml += ` <span class="ml-2 px-2 py-0.5 text-xs rounded bg-indigo-100 text-indigo-800 border border-indigo-200">สาขา${task.branch}</span>`;
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition-colors duration-150';
                // คลิกที่แถวเพื่อดูรายละเอียด (ถ้าเผลอคลิกปุ่มจะไม่ซ้อนทับกัน เพราะปุ่มมี event แยก)
                row.onclick = (e) => {
                    // ป้องกันการเปิด Modal ซ้อนถ้าคลิกโดนปุ่ม "เพิ่มเติม" โดยตรง (Optional)
                    if (!e.target.closest('button')) openDetailModal(task._id);
                };

                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="ml-0">
                                <div class="text-sm font-medium text-gray-900">
                                    <span class="font-bold text-yellow-600 mr-2">${index + 1}.</span>${task.title}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <img class="h-8 w-8 rounded-full object-cover shadow-sm" 
                                 src="https://placehold.co/100x100/e0e7ff/4f46e5?text=${encodeURIComponent(personImageChar)}" 
                                 alt="">
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900 flex items-center">
                                    ${nameDisplayHtml}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusDisplay}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${isOverdue ? 'text-red-500 font-bold' : 'text-gray-500'}">
                        ${formatDate(task.dueDate)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-amber-600 hover:text-amber-800 bg-amber-50 hover:bg-amber-100 px-3 py-1 rounded-md transition-colors" onclick="openDetailModal('${task._id}')">
                            เพิ่มเติม
                        </button>
                    </td>
                `;
                taskTableBody.appendChild(row);
            });
        };

        const filterTasksByStatus = (status) => {
            // 1. ไฮไลท์การ์ดที่เลือก
            const statCards = document.querySelectorAll('#stats-cards [data-status]');
            statCards.forEach(card => {
                if (card.getAttribute('data-status') === status) {
                    card.classList.add('ring-2', 'ring-amber-500', 'shadow-lg');
                } else {
                    card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
                }
            });

            // 2. กรองงานจาก Cache
            const filteredTasks = allDashboardTasks.filter(task => task.status === status);

            // 3. วาดตารางใหม่
            renderTaskTable(filteredTasks);
        };

        const clearTaskFilterHighlights = () => {
            const statCards = document.querySelectorAll('#stats-cards [data-status]');
            statCards.forEach(card => {
                card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
            });
        };

        const handleNewTaskSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const submitButton = document.getElementById('submit-task-btn');
            const errorBox = document.getElementById('new-task-error');
            if (!data.assignedTo || data.assignedTo === "") {
                errorBox.textContent = 'กรุณาเลือกผู้รับผิดชอบงาน'; safeShow(errorBox); return;
            }
            const postData = { ...data, companyId: document.getElementById('company-select').value, dueDate: data.dueDate ? new Date(data.dueDate).toISOString() : null };
            submitButton.disabled = true; submitButton.querySelector('#submit-task-text').textContent = 'กำลังสร้าง...'; safeShow(submitButton.querySelector('#submit-task-spinner'));
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(postData)
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('newTaskModal'); form.reset(); fetchDashboardTasks(); fetchTaskStats();
                fetchNotifications();
            } catch (error) {
                errorBox.textContent = `สร้างงานไม่สำเร็จ: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.querySelector('#submit-task-text').textContent = 'สร้างงาน'; safeHide(submitButton.querySelector('#submit-task-spinner'));
            }
        };

        const openDetailModal = async (taskId) => {
            openModal('taskDetailModal');
            const token = localStorage.getItem('token');
            const errorBox = document.getElementById('update-task-error');
            const deleteTaskBtn = document.getElementById('delete-task-btn');
            safeHide(errorBox);
            document.getElementById('detail-task-title').textContent = "กำลังโหลด...";
            document.getElementById('detail-task-desc').textContent = "...";
            document.getElementById('detail-task-creator').textContent = "...";
            document.getElementById('detail-task-dueDate').textContent = "...";
            document.getElementById('detail-task-comment').value = '';
            document.getElementById('save-task-details-btn').disabled = true;

            const handleDeleteTask = async () => {
                const taskTitle = document.getElementById('detail-task-title').textContent;
                const confirmMsg = document.getElementById('confirm-message');
                const confirmBtn = document.getElementById('confirm-delete-button');
                confirmMsg.textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบงาน: "${taskTitle}"? การกระทำนี้ไม่สามารถย้อนกลับได้`;
                confirmBtn.setAttribute('data-task-id', taskId);
                document.getElementById('confirm-error-message').textContent = '';
                openModal('confirmModal');
            };

            deleteTaskBtn.replaceWith(deleteTaskBtn.cloneNode(true));
            document.getElementById('delete-task-btn').addEventListener('click', handleDeleteTask);

            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                const task = await response.json();
                document.getElementById('detail-task-id').value = task._id;
                document.getElementById('detail-task-title').textContent = task.title;
                document.getElementById('detail-task-desc').textContent = task.description || '(ไม่มีรายละเอียด)';
                document.getElementById('detail-task-status').value = task.status;
                document.getElementById('detail-task-creator').textContent = task.createdBy ? task.createdBy.name : 'N/A';
                document.getElementById('detail-task-dueDate').textContent = formatDate(task.dueDate);
                const commentsList = document.getElementById('detail-task-comments-list');
                commentsList.innerHTML = '';
                if (task.comments && task.comments.length > 0) {
                    task.comments.slice().reverse().forEach(comment => {
                        const commentEl = document.createElement('div');
                        commentEl.className = 'text-sm pb-2 mb-2 border-b border-gray-200';
                        commentEl.innerHTML = `<p class="text-gray-800">${comment.text}</p><p class="text-xs text-gray-500">โดย: ${comment.name} - ${new Date(comment.timestamp).toLocaleString('th-TH')}</p>`;
                        commentsList.appendChild(commentEl);
                    });
                } else {
                    commentsList.innerHTML = '<p class="text-sm text-gray-500">ไม่มีประวัติการอัปเดต</p>';
                }
                const userRole = currentUser.role;
                if (userRole === 'executive' || userRole === 'manager' || userRole === 'hr') {
                    document.getElementById('delete-task-btn').style.display = 'inline-flex';
                } else {
                    document.getElementById('delete-task-btn').style.display = 'none';
                }
            } catch (error) {
                console.error('Open Detail Modal Error:', error);
                errorBox.textContent = 'ไม่สามารถดึงข้อมูลงานได้ (Error: ' + error.message + ')';
                safeShow(errorBox);
            } finally {
                document.getElementById('save-task-details-btn').disabled = false;
            }
        };

        const handleUpdateTaskSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const status = document.getElementById('detail-task-status').value;
            const taskId = document.getElementById('detail-task-id').value;
            const commentText = document.getElementById('detail-task-comment').value;
            const errorBox = document.getElementById('update-task-error');
            const submitButton = document.getElementById('save-task-details-btn');
            submitButton.disabled = true; submitButton.textContent = 'กำลังบันทึก...';
            safeHide(errorBox);
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'PUT', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status, commentText: commentText })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
                fetchNotifications();
            } catch (error) {
                errorBox.textContent = `อัปเดตไม่สำเร็จ: ${error.message}`; safeShow(errorBox);
            } finally {
                submitButton.disabled = false; submitButton.textContent = 'บันทึกการเปลี่ยนแปลง';
            }
        };

        const executeDelete = async () => {
            const token = localStorage.getItem('token');
            const deleteButton = document.getElementById('confirm-delete-button');
            const errorMsg = document.getElementById('confirm-error-message');
            const taskId = deleteButton.getAttribute('data-task-id');
            if (!taskId) { errorMsg.textContent = 'เกิดข้อผิดพลาด: ไม่พบ ID งาน'; return; }
            deleteButton.disabled = true; deleteButton.textContent = 'กำลังลบ...'; errorMsg.textContent = '';
            try {
                const response = await fetch(`${SERVER_URL}/tasks/${taskId}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
                closeModal('confirmModal'); closeModal('taskDetailModal');
                if (currentView === 'dashboard') { fetchDashboardTasks(); fetchTaskStats(); }
                else { fetchMyTasks(); }
            } catch (error) {
                errorMsg.textContent = `ลบไม่สำเร็จ: ${error.message}`;
            } finally {
                deleteButton.disabled = false; deleteButton.textContent = 'ตกลง';
            }
        };

        // ------------------------------------------
        // --- (B) USER FUNCTIONS ---
        // ------------------------------------------
        const fetchAllUsersForTable = async () => {
            safeShow(document.getElementById('loading-users'));
            const token = localStorage.getItem('token');
            const userTableBody = document.getElementById('user-table-body');
            userTableBody.innerHTML = '';
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                safeHide(document.getElementById('loading-users'));
                if (!response.ok) { throw new Error('ไม่สามารถดึงข้อมูลผู้ใช้'); }
                const users = await response.json();
                document.getElementById('user-count').textContent = `${users.length} คน`;
                if (users.length === 0) {
                    userTableBody.innerHTML = `<tr id="no-user-row" class="text-center"><td colspan="6" class="px-6 py-4 text-slate-500">ไม่มีผู้ใช้ในระบบ</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50';
                    row.setAttribute('data-name', (user.name || '').toLowerCase());
                    row.setAttribute('data-username', (user.username || '').toLowerCase());
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${user.name}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.username}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${getRoleName(user.role)}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.branch || user.department}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.reportsTo ? user.reportsTo.name : '-'}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-amber-600 hover:text-amber-800" onclick="openEditUserModal('${user._id}')">แก้ไข</button>
                            <button class="text-red-600 hover:text-red-900 ml-4" onclick="executeDeleteUser('${user._id}', '${user.name}')">ลบ</button>
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });
            } catch (error) {
                safeHide(document.getElementById('loading-users'));
                userTableBody.innerHTML = `<tr class="text-center"><td colspan="6" class="px-6 py-4 text-red-500">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
            }
        };

        // ------------------------------------------
        // --- (C) NOTIFICATION FUNCTIONS ---
        // ------------------------------------------
        const filterUsersByName = (query) => {
            const rows = document.querySelectorAll('#user-table-body tr:not(#no-user-row)');
            const lowerQuery = query.toLowerCase();

            rows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const username = row.getAttribute('data-username') || '';

                if (name.includes(lowerQuery) || username.includes(lowerQuery)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        // Add listener for search input
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('user-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterUsersByName(e.target.value);
                });
            }
        });

        const fetchNotifications = async () => {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                // 1. ดึงข้อมูลจาก Server
                const response = await fetch(`${SERVER_URL}/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();

                // จัดการโครงสร้างข้อมูล (รองรับทั้งแบบส่งมาเป็น Array โดยตรง หรือส่งมาเป็น Object)
                const notifications = Array.isArray(data) ? data : (data.notifications || []);

                // คำนวณจำนวนที่ยังไม่อ่าน
                const unreadCount = typeof data.unreadCount === 'number'
                    ? data.unreadCount
                    : notifications.filter(n => !n.isRead).length;

                // --- ส่วนที่ 1: จัดการจุดแดง (Red Dot) ---

                // ฟังก์ชันช่วยเปิด/ปิดจุด (ใช้ได้ทั้ง Desktop และ Mobile)
                const toggleDot = (elementId, show) => {
                    const el = document.getElementById(elementId);
                    if (el) {
                        if (show) el.classList.remove('hidden');
                        else el.classList.add('hidden');
                    }
                };

                // อัปเดตจุดแดงทั้ง 2 จุดพร้อมกัน
                const hasUnread = unreadCount > 0;
                toggleDot('notification-dot', hasUnread);          // สำหรับ Desktop
                toggleDot('notification-dot-mobile', hasUnread);   // สำหรับ Mobile (ที่คุณเพิ่งเพิ่ม)

                // --- ส่วนที่ 2: แสดงรายการแจ้งเตือนใน Dropdown ---
                const listContainer = document.getElementById('notification-list');
                if (listContainer) {
                    listContainer.innerHTML = ''; // ล้างรายการเก่า

                    if (notifications.length === 0) {
                        // กรณีไม่มีการแจ้งเตือน
                        listContainer.innerHTML = `
                            <div class="px-4 py-6 text-sm text-gray-500 text-center flex flex-col items-center">
                                <ion-icon name="notifications-off-outline" class="text-2xl mb-2 text-gray-300"></ion-icon>
                                ไม่มีการแจ้งเตือนใหม่
                            </div>`;
                    } else {
                        // วนลูปสร้างรายการ
                        notifications.forEach(notif => {
                            const item = document.createElement('div');
                            // ถ้ายังไม่อ่าน ให้พื้นหลังเป็นสีฟ้าอ่อน (bg-blue-50)
                            item.className = `px-4 py-3 border-b hover:bg-gray-50 transition-colors cursor-pointer ${!notif.isRead ? 'bg-blue-50' : ''}`;

                            // ใส่เนื้อหา HTML
                            item.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">${notif.title || 'การแจ้งเตือน'}</p>
                                        <p class="text-xs text-gray-500 mt-1">${notif.message || '-'}</p>
                                        <p class="text-[10px] text-gray-400 mt-2">
                                            ${new Date(notif.createdAt).toLocaleString('th-TH')}
                                        </p>
                                    </div>
                                    ${!notif.isRead ? '<span class="h-2 w-2 bg-blue-600 rounded-full mt-1 flex-shrink-0"></span>' : ''}
                                </div>
                            `;

                            // เพิ่ม Event คลิก (เช่น กดแล้วไปหน้างาน หรือทำเครื่องหมายว่าอ่านแล้ว)
                            item.onclick = () => {
                                // ตรงนี้ใส่ Logic เพิ่มเติมได้ เช่น markAsRead(notif._id)
                                console.log('Clicked notification:', notif._id);
                            };

                            listContainer.appendChild(item);
                        });
                    }
                }

            } catch (error) {
                console.warn('Could not fetch notifications:', error.message);
            }
        };

        const updateNotificationUI = (notifications, unreadCount) => {
            const dot = document.getElementById('notification-dot');
            const list = document.getElementById('notification-list');

            if (unreadCount > 0) {
                safeShow(dot);
            } else {
                safeHide(dot);
            }

            if (notifications && notifications.length > 0) {
                list.innerHTML = '';
                notifications.forEach(noti => {
                    const taskTitle = noti.task ? noti.task.title : 'งานนี้ถูกลบแล้ว';
                    const taskAction = noti.task ? `onclick="openDetailModal('${noti.task._id}'); closeModal('notificationModal');"` : '';

                    const item = document.createElement('div');
                    item.className = `flex justify-between items-start p-3 border-b hover:bg-gray-50 cursor-pointer ${noti.isRead ? 'bg-white' : 'bg-blue-50'}`;

                    item.innerHTML = `
                        <div ${taskAction} class="flex-1">
                            <p class="text-sm text-gray-800 font-medium">${noti.message}</p>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } else {
                list.innerHTML = '<p class="text-center text-gray-500 p-4">ไม่มีการแจ้งเตือนใหม่</p>';
            }
        };

        const markNotificationsAsRead = async () => {
            const token = localStorage.getItem('token');
            const dot = document.getElementById('notification-dot');
            safeHide(dot);

            try {
                await fetch(`${SERVER_URL}/notifications/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.warn('Could not mark notifications as read:', error.message);
            }
        };

        // ------------------------------------------
        const deleteNotification = async (id) => {
            const token = localStorage.getItem('token');
            if (!confirm('คุณต้องการลบการแจ้งเตือนนี้หรือไม่?')) return;

            try {
                const response = await fetch(`${SERVER_URL}/notifications/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    fetchNotifications();
                } else {
                    alert('ลบการแจ้งเตือนไม่สำเร็จ');
                }
            } catch (error) {
                console.error('Delete Notification Error:', error);
                alert('เกิดข้อผิดพลาดในการลบการแจ้งเตือน');
            }
        };

        const deleteAllNotifications = async () => {
            const token = localStorage.getItem('token');
            if (!confirm('คุณต้องการลบการแจ้งเตือนทั้งหมดหรือไม่?')) return;

            try {
                const response = await fetch(`${SERVER_URL}/notifications`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    fetchNotifications();
                } else {
                    alert('ลบการแจ้งเตือนทั้งหมดไม่สำเร็จ');
                }
            } catch (error) {
                console.error('Delete All Notifications Error:', error);
                alert('เกิดข้อผิดพลาดในการลบการแจ้งเตือนทั้งหมด');
            }
        };

        // --- (D) DEPOSIT FUNCTIONS ---
        // ------------------------------------------
        // ในไฟล์ index.html
        function getOrderStatusBadge(status) {
            status = status || 'pending';
            switch (status) {
                case 'ordered':
                    return `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold border border-blue-200 whitespace-nowrap">สั่งของแล้ว</span>`;
                case 'arrived':
                    return `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold border border-green-200 whitespace-nowrap">ของมาถึงแล้ว</span>`;
                case 'canceled':
                    return `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold border border-red-200 whitespace-nowrap">ยกเลิก</span>`;
                default:
                    return `<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-[10px] font-bold border border-yellow-200 whitespace-nowrap">รอดำเนินการ</span>`;
            }
        }

        async function fetchDeposits() {
            try {
                const token = localStorage.getItem('token');
                const selectedCompanyId = document.getElementById('company-select').value;

                // --- ส่วนที่ 1: อัปเดตหัวข้อตาราง (Header Title) ---
                // ส่วนนี้จะเปลี่ยนข้อความ "รายการเงินค่ามัดจำหน้าร้าน" เป็น "รายการเงินค่ามัดจำ - สาขา..."
                const titleElem = document.getElementById('deposit-header-title');
                const filterBranchElem = document.getElementById('deposit-filter-branch');

                if (titleElem) {
                    if (typeof currentUser !== 'undefined' && currentUser && currentUser.role === 'staff') {
                        // กรณี Staff: ให้แสดงสาขาของ Staff คนนั้นเสมอ
                        const branchName = currentUser.branch || 'ทั้งหมด'; // ถ้าเป็นค่าว่าง/null/undefined ให้ใช้คำว่า 'ทั้งหมด' แทน
                        titleElem.textContent = `รายการเงินค่ามัดจำ - สาขา ${branchName}`;
                    } else {
                        // กรณี Admin/Manager: ให้แสดงตามที่เลือกใน Dropdown
                        // ถ้าเลือก "ทั้งหมด" หรือยังไม่เลือก ให้แสดงคำว่า "ทั้งหมด"
                        // ถ้าเลือกสาขาเจาะจง ให้ดึงข้อความ (Text) ของ option นั้นมาแสดง
                        let branchName = 'ทั้งหมด';
                        if (filterBranchElem && filterBranchElem.value !== 'all' && filterBranchElem.selectedIndex > -1) {
                            branchName = filterBranchElem.options[filterBranchElem.selectedIndex].text;
                        }
                        titleElem.textContent = `รายการเงินค่ามัดจำ - ${branchName}`;
                    }
                }

                // --- ส่วนที่ 2: เตรียม URL และ Parameter ---
                let url = `${SERVER_URL}/deposits?companyId=${selectedCompanyId}`;

                // ดึงค่าจาก Dropdown ตัวกรองสาขา เพื่อส่งไปที่ API
                if (filterBranchElem) {
                    const branchVal = filterBranchElem.value;
                    if (branchVal && branchVal !== 'all') {
                        url += `&branch=${encodeURIComponent(branchVal)}`;
                    }
                }

                // --- ส่วนที่ 3: ส่งคำสั่งไปที่ Server ---
                // console.log('Fetching URL:', url); 
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });

                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }

                const deposits = await res.json();

                // --- ส่วนที่ 4: วาดตาราง ---
                const tbody = document.getElementById('deposit-table-body');
                tbody.innerHTML = '';

                if (deposits.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-slate-500">ไม่พบข้อมูลในสาขานี้</td></tr>`;
                    return;
                }

                deposits.forEach(d => {
                    const price = d.price || 0;
                    const deposit = d.depositAmount || 0;
                    const balance = price > 0 ? (price - deposit) : 0;

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-yellow-50 transition-colors cursor-pointer border-b";
                    tr.onclick = () => openDepositModal(d);

                    tr.innerHTML = `
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.depositDate)}</td>
                        <td class="font-medium border p-2 text-gray-800">${d.customerName}</td>
                        <td class="text-center border p-2 text-gray-600">${d.phoneNumber}</td>
                        <td class="text-right border p-2 font-bold text-red-600 bg-red-50">${deposit.toLocaleString()}</td>
                        <td class="text-center border p-2 text-gray-600">${formatDateShort(d.pickupDueDate)}</td>
                
                        <td class="text-center border p-2 text-xs">${d.billNo || '-'}</td>
                        <td class="text-center border p-2 text-xs font-mono text-gray-500">${d.imei || '-'}</td>
                        <td class="text-xs border p-2">${d.product || '-'}</td>
                        <td class="text-center border p-2 text-xs">
                           ${getOrderStatusBadge(d.orderStatus)}
                        </td>
                        <td class="text-right border p-2 bg-red-50 text-xs">${price ? price.toLocaleString() : '-'}</td>
                        <td class="text-right border p-2 font-bold bg-blue-50 text-blue-800">${price ? balance.toLocaleString() : '-'}</td>
                        <td class="text-center border p-2 bg-green-50">
                            ${d.isSuccess ? '<ion-icon name="checkmark-circle" class="text-green-600 text-xl"></ion-icon>' : '<span class="text-gray-300">-</span>'}
                        </td>
                        <td class="text-center border p-2 text-xs text-gray-500">${d.signName || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (e) {
                console.error("Error fetching deposits:", e);
                // อาจจะแสดง Error บนหน้าจอด้วยก็ได้ถ้าต้องการ
                const tbody = document.getElementById('deposit-table-body');
                if (tbody) tbody.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`;
            }
        }

        let productTomSelect = null;

        async function fetchProducts() {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${SERVER_URL}/deposits/products`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) return [];
                return await res.json();
            } catch (e) {
                console.error("Error fetching products:", e);
                return [];
            }
        }

        // Global variables for purchasing view
        let allPurchasingOrders = [];
        let currentStatusFilter = 'all';
        let currentSearchText = '';

        // 1. ฟังก์ชันดึงข้อมูล (Fetch & Store)
        // 1. ฟังก์ชันดึงข้อมูล (Fetch & Store)
        async function fetchPurchasingOrders(initialStatus = null) {
            const token = localStorage.getItem('token');
            const container = document.getElementById('purchasing-list-container');
            const emptyState = document.getElementById('purchasing-empty-state');
            const branchFilter = document.getElementById('purchasing-filter-branch').value;
            const companyId = document.getElementById('company-select').value;

            // Loading State
            container.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-16">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mb-4"></div>
                    <p class="text-slate-400 animate-pulse">กำลังโหลดข้อมูลการสั่งซื้อ...</p>
                </div>
            `;
            emptyState.classList.add('hidden');

            try {
                let url = `${SERVER_URL}/deposits?companyId=${companyId}&viewMode=purchasing`;
                if (branchFilter && branchFilter !== 'all') {
                    url += `&branch=${encodeURIComponent(branchFilter)}`;
                }

                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to fetch');

                const deposits = await res.json();
                allPurchasingOrders = deposits; // Store data

                // Set Filter Logic
                if (initialStatus) {
                    currentStatusFilter = initialStatus;
                    // Trigger UI update for the filter buttons
                    // Note: filterPurchasingByStatus sets currentStatusFilter and calls renderPurchasingOrders
                    filterPurchasingByStatus(initialStatus);
                } else {
                    // Reset filters if no initialStatus provided
                    currentStatusFilter = 'all';
                    currentSearchText = '';
                    document.getElementById('purchasing-search-input').value = '';
                    clearPurchasingFilterUI();
                    renderPurchasingOrders();
                }

                updatePurchasingStats(deposits);

            } catch (e) {
                console.error(e);
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 bg-red-50 rounded-2xl border border-red-100">
                        <ion-icon name="alert-circle" class="text-4xl text-red-400 mb-2"></ion-icon>
                        <p class="text-red-700 font-semibold">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                        <button onclick="fetchPurchasingOrders()" class="mt-4 text-sm bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg hover:bg-red-50">ลองใหม่</button>
                    </div>
                `;
            }
        }

        function renderPurchasingOrders() {
            const container = document.getElementById('purchasing-list-container');
            const emptyState = document.getElementById('purchasing-empty-state');
            const searchText = currentSearchText.toLowerCase();

            container.innerHTML = '';

            // Filter Data
            const filtered = allPurchasingOrders.filter(d => {
                // Status Filter
                if (currentStatusFilter !== 'all' && (d.orderStatus || 'pending') !== currentStatusFilter) return false;

                // Search Filter
                if (searchText) {
                    const searchMatch = (d.customerName || '').toLowerCase().includes(searchText) ||
                        (d.phoneNumber || '').toLowerCase().includes(searchText) ||
                        (d.product || '').toLowerCase().includes(searchText) ||
                        (d.branch || '').toLowerCase().includes(searchText);
                    if (!searchMatch) return false;
                }
                return true;
            });

            filtered.forEach(d => {
                // Status Logic
                let statusConfig = { text: 'รอดำเนินการ', color: 'bg-yellow-100 text-yellow-700 border-yellow-200', icon: 'time' };
                const status = d.orderStatus || 'pending';

                if (status === 'ordered') statusConfig = { text: 'สั่งของแล้ว', color: 'bg-blue-100 text-blue-700 border-blue-200', icon: 'cart' };
                else if (status === 'arrived') statusConfig = { text: 'ของมาถึงแล้ว', color: 'bg-green-100 text-green-700 border-green-200', icon: 'checkmark-circle' };
                else if (status === 'canceled') statusConfig = { text: 'ยกเลิก', color: 'bg-red-100 text-red-700 border-red-200', icon: 'close-circle' };

                const dataString = JSON.stringify(d).replace(/'/g, "&#39;");

                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl p-5 shadow-sm border border-slate-100 hover:shadow-md transition-shadow group relative overflow-hidden";

                const statusColorMap = {
                    'pending': 'bg-yellow-400',
                    'ordered': 'bg-blue-500',
                    'arrived': 'bg-green-500',
                    'canceled': 'bg-red-500'
                };
                const sidebarColor = statusColorMap[status] || 'bg-slate-300';

                card.innerHTML = `
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 ${sidebarColor}"></div>
                    <div class="flex justify-between items-start mb-4 pl-3">
                        <div>
                            <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded-md font-medium mb-2 inline-block">
                                <ion-icon name="storefront-outline" class="align-middle mr-1"></ion-icon>${d.branch || '-'}
                            </span>
                            <h4 class="font-bold text-slate-800 text-lg leading-tight line-clamp-2" title="${d.product || 'ไม่ระบุสินค้า'}">${d.product || 'ไม่ระบุสินค้า'}</h4>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="${statusConfig.color} px-2.5 py-1 rounded-full text-xs font-bold border flex items-center gap-1 shadow-sm">
                                <ion-icon name="${statusConfig.icon}"></ion-icon> ${statusConfig.text}
                            </span>
                        </div>
                    </div>
                    
                    <div class="space-y-3 pl-3">
                        <div class="flex items-center gap-3 text-sm text-slate-600">
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400">
                                <ion-icon name="person"></ion-icon>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-slate-700">${d.customerName}</p>
                                <p class="text-xs text-slate-400">${d.phoneNumber}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 text-xs bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <div>
                                <p class="text-slate-400 font-medium">วันกำหนดรับ</p>
                                <p class="font-semibold text-slate-700 mt-0.5 flex items-center gap-1">
                                    <ion-icon name="calendar-outline"></ion-icon> ${formatDateShort(d.pickupDueDate)}
                                </p>
                            </div>
                            <div>
                                <p class="text-slate-400 font-medium">ยอดมัดจำ</p>
                                <p class="font-mono font-semibold text-red-500 mt-0.5">฿${(d.depositAmount || 0).toLocaleString()}</p>
                            </div>
                        </div>

                            ${d.orderNote ? `
                            <div class="text-xs text-slate-500 bg-yellow-50/50 p-2 rounded-lg border border-yellow-100/50 flex gap-2">
                                <ion-icon name="document-text-outline" class="text-yellow-500 mt-0.5"></ion-icon>
                                <span class="line-clamp-2 italic">"${d.orderNote}"</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-100 flex justify-end pl-3">
                        <button onclick='openPurchasingModal(${dataString})' 
                            class="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-xl font-medium transition-all shadow-lg shadow-slate-800/20 active:scale-95">
                            <ion-icon name="create-outline"></ion-icon> อัปเดตสถานะ
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Helpers
        function updatePurchasingStats(deposits) {
            const pending = deposits.filter(d => !d.orderStatus || d.orderStatus === 'pending').length;
            const ordered = deposits.filter(d => d.orderStatus === 'ordered').length;
            const arrived = deposits.filter(d => d.orderStatus === 'arrived').length;
            const canceled = deposits.filter(d => d.orderStatus === 'canceled').length;

            document.getElementById('count-pending').textContent = pending;
            document.getElementById('count-ordered').textContent = ordered;
            document.getElementById('count-arrived').textContent = arrived;
            document.getElementById('count-canceled').textContent = canceled;
        }

        function handlePurchasingSearch() {
            currentSearchText = document.getElementById('purchasing-search-input').value.trim();
            renderPurchasingOrders();
        }

        function filterPurchasingByStatus(status) {
            currentStatusFilter = status;

            // Highlight Logic
            ['pending', 'ordered', 'arrived', 'canceled'].forEach(s => {
                const card = document.getElementById(`card-filter-${s}`);
                if (s === status) {
                    card.classList.add('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-slate-50');
                } else {
                    card.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-slate-50');
                }
            });

            // Show indicator
            const indicator = document.getElementById('active-filter-indicator');
            const nameDisplay = document.getElementById('filter-name-display');
            indicator.classList.remove('hidden');

            let statusName = '';
            if (status === 'pending') statusName = 'รอดำเนินการ';
            else if (status === 'ordered') statusName = 'สั่งของแล้ว';
            else if (status === 'arrived') statusName = 'ของมาถึงแล้ว';
            else if (status === 'canceled') statusName = 'ยกเลิก';
            nameDisplay.textContent = statusName;

            renderPurchasingOrders();
        }

        function clearPurchasingFilter() {
            currentStatusFilter = 'all';
            clearPurchasingFilterUI();
            renderPurchasingOrders();
        }

        function clearPurchasingFilterUI() {
            ['pending', 'ordered', 'arrived', 'canceled'].forEach(s => {
                document.getElementById(`card-filter-${s}`).classList.remove('ring-2', 'ring-offset-2', 'ring-blue-400', 'bg-slate-50');
            });
            document.getElementById('active-filter-indicator').classList.add('hidden');
        }


        // 2. ฟังก์ชันเปิด Modal อัปเดตสถานะ
        function openPurchasingModal(data) {
            document.getElementById('pur-id').value = data._id;
            document.getElementById('pur-product-display').textContent = data.product || 'ไม่ระบุสินค้า';
            document.getElementById('pur-customer-display').textContent = `${data.customerName} (โทร: ${data.phoneNumber})`;
            document.getElementById('pur-status').value = data.orderStatus || 'pending';
            document.getElementById('pur-note').value = data.orderNote || '';

            openModal('purchasingModal');
        }

        async function openDepositModal(data = null) {
            openModal('depositModal');

            // Initialize Tom Select if not already done
            if (!productTomSelect) {
                productTomSelect = new TomSelect('#dep-product', {
                    create: true,
                    sortField: { field: "text", direction: "asc" },
                    placeholder: "เลือกหรือพิมพ์เพิ่ม...",
                    valueField: 'text',
                    labelField: 'text',
                    searchField: 'text',
                    options: [],
                    maxOptions: null
                });
            }

            // Load products
            productTomSelect.clear();
            productTomSelect.clearOptions();

            const defaultProducts = [
                // iPhone 13
                "13 128 ดำ New",
                "13 128 ขาว New",

                // iPhone 15
                "15 128 ดำ New",
                "15 128 บลู New",
                "15 128 ชมพู New",
                "15 256 บลู New",

                // iPhone 16
                "16 128 ดำ New",
                "16 128 บลู New",
                "16 128 ชมพู New",
                "16 128 เขียว New",
                "16 128 ขาว New",
                "16 256 บลู New",

                // iPhone 16 Plus
                "16 Plus 128 ดำ New",
                "16 Plus 128 ชมพู New",
                "16 Plus 128 ขาว New",

                // iPhone 16 Pro
                "16 Pro 128 ดำ New",
                "16 Pro 128 Black Titanium",
                "16 Pro 128 Graphite",

                // iPhone 16 Pro Max
                "16 Pro Max 256 Black Titanium",
                "16 Pro Max 256 Desert",
                "16 Pro Max 256 Desert Titanium",
                "16 Pro Max 256 Graphite",
                "16 Pro Max 256 Silver",
                "16 Pro Max 256 White Titanium",

                // iPhone 17
                "17 256 ดำ New",
                "17 256 บลู New",
                "17 256 Lavender",
                "17 256 Purple",
                "17 256 ขาว New",

                // iPhone 17 Pro
                "17 Pro 256 Orange",
                "17 Pro 256 บลู New",

                // iPhone 17 Pro Max
                "17 Pro Max 256 Blue",
                "17 Pro Max 256 Orange",
                "17 Pro Max 256 White",

                // iPad Gen 11
                "iPad Gen11 128 ขาว New",
                "iPad Gen11 128 บลู New",
                "iPad Gen11 128 ชมพู New",

                // iPad Air 7
                "iPad Air7 128 ขาว New",
                "iPad Air7 128 ม่วง New",
                "iPad Air7 128 เทา New",
                "iPad Air7 128 บลู New"
            ];

            const serverProducts = await fetchProducts();
            // Merge and dedup
            const allProducts = Array.from(new Set([...defaultProducts, ...serverProducts])).sort();

            allProducts.forEach(p => productTomSelect.addOption({ text: p }));
            document.getElementById('deposit-form').reset();
            document.getElementById('dep-id').value = '';

            if (data) {
                document.getElementById('dep-id').value = data._id;
                document.getElementById('dep-date').value = data.depositDate ? data.depositDate.split('T')[0] : '';
                document.getElementById('dep-pickup').value = data.pickupDueDate ? data.pickupDueDate.split('T')[0] : '';
                document.getElementById('dep-name').value = data.customerName;
                document.getElementById('dep-phone').value = data.phoneNumber;
                document.getElementById('dep-amount').value = data.depositAmount;

                // Set product value
                if (data.product) {
                    productTomSelect.addOption({ text: data.product }); // Ensure option exists
                    productTomSelect.setValue(data.product);
                }
                document.getElementById('dep-price').value = data.price || '';
                document.getElementById('dep-bill').value = data.billNo || '';
                document.getElementById('dep-imei').value = data.imei || '';
                document.getElementById('dep-success').checked = data.isSuccess;
            } else {
                document.getElementById('dep-date').value = new Date().toISOString().split('T')[0];
            }
        }

        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const payload = {
                id: document.getElementById('dep-id').value,
                depositDate: document.getElementById('dep-date').value,
                pickupDueDate: document.getElementById('dep-pickup').value,
                customerName: document.getElementById('dep-name').value,
                phoneNumber: document.getElementById('dep-phone').value,
                depositAmount: document.getElementById('dep-amount').value,

                product: document.getElementById('dep-product').value,
                price: document.getElementById('dep-price').value,
                billNo: document.getElementById('dep-bill').value,
                imei: document.getElementById('dep-imei').value,
                isSuccess: document.getElementById('dep-success').checked
            };

            try {
                const res = await fetch(`${SERVER_URL}/deposits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    closeModal('depositModal');
                    fetchDeposits();
                } else {
                    alert('บันทึกไม่สำเร็จ โปรดลองใหม่');
                }
            } catch (err) { alert('Error: ' + err.message); }
        });

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric', year: '2-digit' });
        }


        // ------------------------------------------
        // --- (F) IMPORT NOTIFICATION FUNCTIONS ---
        // ------------------------------------------
        let startImportTab = 'phone';

        function switchImportTab(tab) {
            startImportTab = tab;
            const btnPhone = document.getElementById('tab-btn-phone');
            const btnAcc = document.getElementById('tab-btn-accessory');
            const viewPhone = document.getElementById('tab-import-phone');
            const viewAcc = document.getElementById('tab-import-accessory');

            if (tab === 'phone') {
                // Active Phone
                btnPhone.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold transition-all bg-indigo-50 text-indigo-600 ring-2 ring-indigo-100";
                btnAcc.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold text-slate-500 hover:bg-slate-50 transition-all";
                safeShow(viewPhone);
                safeHide(viewAcc);
            } else {
                // Active Accessory
                btnAcc.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold transition-all bg-pink-50 text-pink-600 ring-2 ring-pink-100";
                btnPhone.className = "flex items-center px-4 py-3 rounded-xl text-sm font-semibold text-slate-500 hover:bg-slate-50 transition-all";
                safeShow(viewAcc);
                safeHide(viewPhone);
            }
            fetchImportRequests();
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const placeholder = document.getElementById('image-preview-placeholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function fetchImportRequests() {
            const token = localStorage.getItem('token');
            const companyId = document.getElementById('company-select').value;
            try {
                const res = await fetch(`${SERVER_URL}/imports?companyId=${companyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) return;
                const data = await res.json();

                // Render Phone List
                const phoneList = document.getElementById('phone-import-list');
                const phoneData = data.filter(d => d.type === 'phone');
                phoneList.innerHTML = '';
                if (phoneData.length === 0) {
                    phoneList.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-slate-400">ไม่มีประวัติการแจ้งนำเข้า</td></tr>`;
                } else {
                    phoneData.forEach(item => {
                        // ดึงลิงก์ไฟล์จาก Array ตัวแรก ถ้าไม่มีให้ใส่เครื่องหมาย #
                        const fileLink = (item.files && item.files.length > 0) ? item.files[0] : '#';
                        
                        // ตรวจสอบว่ามีลิงก์ไหม เพื่อกำหนดสีและให้กดได้หรือไม่ (UX เพิ่มเติม)
                        const linkClass = (fileLink !== '#') ? 'text-indigo-600 hover:underline' : 'text-gray-400 cursor-not-allowed';
                        const targetAttr = (fileLink !== '#') ? 'target="_blank"' : '';
                    
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-slate-50";
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${formatDateShort(item.createdAt)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <a href="${fileLink}" ${targetAttr} class="${linkClass} flex items-center">
                                    <ion-icon name="document-text" class="mr-1"></ion-icon> Download
                                </a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.branch}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${getStatusTag(item.status)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item.createdBy ? item.createdBy.name : '-'}</td>
                        `;
                        phoneList.appendChild(tr);
                    });
                }

                // Render Accessory List
                const accList = document.getElementById('accessory-import-list');
                const accData = data.filter(d => d.type === 'accessory');
                accList.innerHTML = '';
                if (accData.length === 0) {
                    accList.innerHTML = `<div class="col-span-full text-center py-8 text-slate-400">ไม่มีรายการแจ้งนำเข้า</div>`;
                } else {
                    accData.forEach(item => {
                        const card = document.createElement('div');
                        card.className = "bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex gap-4";

                        // Use files[0] for image, and details.* for other info
                        const imageUrl = item.files && item.files.length > 0 ? item.files[0] : 'https://placehold.co/100';
                        // Handle productName vs name mismatch (schema has productName)
                        const accName = item.details ? (item.details.productName || item.details.name || 'Unknown') : 'Unknown';
                        const accQty = item.details ? item.details.quantity : '-';
                        const accDate = item.details ? formatDateShort(item.details.importDate) : '-';

                        card.innerHTML = `
                             <img src="${imageUrl}" class="w-20 h-20 object-cover rounded-lg bg-slate-100 border border-slate-200">
                             <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h5 class="font-bold text-slate-800 text-sm line-clamp-1">${accName}</h5>
                                    ${getStatusTag(item.status)}
                                </div>
                                <p class="text-xs text-slate-500 mt-1">จำนวน: <span class="font-semibold text-slate-700">${accQty}</span> ชิ้น</p>
                                <p class="text-xs text-slate-500">วันที่ต้องการ: ${accDate}</p>
                                <div class="mt-2 flex items-center text-xs text-slate-400">
                                    <ion-icon name="person" class="mr-1"></ion-icon> ${item.createdBy ? item.createdBy.name : '-'} (${item.branch})
                                </div>
                             </div>
                        `;
                        accList.appendChild(card);
                    });
                }

            } catch (err) { console.error(err); }
        }

        // ------------------------------------------
        // --- (E) GENERAL HELPERS & INIT ---
        // ------------------------------------------

        const loadManagersForDropdown = async () => {
            const token = localStorage.getItem('token');
            const select = document.getElementById('user-reportsTo-input');
            select.innerHTML = '<option value="">--- กำลังโหลด... ---</option>';
            try {
                const selectedCompanyId = document.getElementById('user-company-input').value;
                const response = await fetch(`${SERVER_URL}/users?companyId=${selectedCompanyId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('โหลดรายชื่อหัวหน้าไม่สำเร็จ');
                const users = await response.json();
                select.innerHTML = '<option value="">--- ไม่มีหัวหน้า ---</option>';
                const managers = users.filter(u => u.role === 'manager' || u.role === 'hr' || u.role === 'executive');
                managers.forEach(user => {
                    select.appendChild(new Option(`${user.name} (${getRoleName(user.role)})`, user._id));
                });
            } catch (error) {
                select.innerHTML = `<option value="">--- ${error.message} ---</option>`;
            }
        };

        const populateBranchSelects = () => {
            const branches = ['ยะลา', 'นราธิวาส', 'ปัตตานี', 'หาดใหญ่', 'หาดใหญ่2', 'โคลีเซียม', 'สุราษฎร์ธานี', 'ปากแมว', 'ภูเก็ต', 'นครศรีธรรมราช', 'กระบี่', 'กะทู้', 'ตรัง', 'คุรุ', 'ชุมพร', 'สตูล', 'พัทลุง', 'สงขลา'];
            const selects = ['deposit-filter-branch', 'purchasing-filter-branch'];

            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    // Keep the first option (all)
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption);

                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        select.appendChild(option);
                    });
                }
            });
        };

        const openNewUserModal = () => {
            document.getElementById('user-form').reset();
            document.getElementById('user-modal-title').textContent = 'เพิ่มผู้ใช้ใหม่';
            document.getElementById('form-mode').value = 'create';
            document.getElementById('user-id').value = '';
            safeHide(document.getElementById('user-form-error'));
            document.getElementById('user-username-input').disabled = false;
            document.getElementById('user-username-input').required = true;
            document.getElementById('user-password-input').placeholder = "ต้องกรอก";
            document.getElementById('user-password-input').required = true;
            safeShow(document.getElementById('auth-section'));

            const currentCompany = document.getElementById('company-select').value;
            const userCompanySelect = document.getElementById('user-company-input');
            userCompanySelect.value = currentCompany;
            userCompanySelect.disabled = false;

            safeHide(document.getElementById('user-reportsTo-input').parentElement);

            openModal('userModal');
        };

        const openEditUserModal = async (id) => {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('ไม่สามารถดึงข้อมูลผู้ใช้ได้');
                const users = await response.json();
                const user = users.find(u => u._id === id);

                if (user) {
                    document.getElementById('user-form').reset();
                    document.getElementById('user-modal-title').textContent = 'แก้ไขผู้ใช้';
                    document.getElementById('form-mode').value = 'edit';
                    document.getElementById('user-id').value = user._id;
                    safeHide(document.getElementById('user-form-error'));

                    document.getElementById('user-username-input').disabled = true;
                    document.getElementById('user-username-input').required = false;
                    document.getElementById('user-password-input').placeholder = "เว้นว่างไว้หากไม่ต้องการเปลี่ยน";
                    document.getElementById('user-password-input').required = false;
                    safeShow(document.getElementById('auth-section'));

                    document.getElementById('user-name-input').value = user.name;
                    document.getElementById('user-role-input').value = user.role;
                    document.getElementById('user-username-input').value = user.username;
                    document.getElementById('user-department-input').value = user.department;
                    document.getElementById('user-branch-input').value = user.branch || '';

                    const userCompanySelect = document.getElementById('user-company-input');
                    userCompanySelect.value = user.companyId;
                    userCompanySelect.disabled = true;

                    const reportsToDiv = document.getElementById('user-reportsTo-input').parentElement;
                    safeShow(reportsToDiv);

                    await loadManagersForDropdown();

                    document.getElementById('user-reportsTo-input').value = user.reportsTo ? user.reportsTo._id : '';
                } else {
                    throw new Error('ไม่พบข้อมูลผู้ใช้');
                }
                openModal('userModal');
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการดึงข้อมูล: ' + error.message);
            }
        };

        const handleUserFormSubmit = async (event) => {
            event.preventDefault();
            const token = localStorage.getItem('token');
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const mode = data.mode;
            const userId = data.userId;
            const submitButton = document.getElementById('submit-user-btn');
            const errorBox = document.getElementById('user-form-error');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';
            safeHide(errorBox);
            let url = '';
            let method = '';
            let body = {};

            if (mode === 'create') {
                url = `${SERVER_URL}/auth/register`;
                method = 'POST';
                body = {
                    name: data.name,
                    username: data.username,
                    password: data.password,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                    companyId: data.companyId
                };
            } else {
                url = `${SERVER_URL}/users/admin/${userId}`;
                method = 'PUT';
                body = {
                    name: data.name,
                    role: data.role,
                    department: data.department,
                    branch: data.branch || null,
                    reportsTo: data.reportsTo || null,
                };
                if (data.password && data.password.trim() !== '') {
                    body.password = data.password;
                }
            }
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                closeModal('userModal');
                fetchAllUsersForTable();
                fetchAllUsers();
            } catch (error) {
                errorBox.textContent = `บันทึกไม่สำเร็จ: ${error.message}`;
                safeShow(errorBox);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึก';
            }
        };

        const executeDeleteUser = async (id, name) => {
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้: "${name}"?`)) {
                return;
            }
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${SERVER_URL}/users/admin/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message);
                }
                fetchAllUsersForTable();
                fetchAllUsers();
            } catch (error) {
                alert(`ลบไม่สำเร็จ: ${error.message}`);
            }
        };

        // --- NAVIGATION LOGIC (รวมระบบแล้ว) ---
        const updateNavActiveState = (activeView) => {
            const statsCards = document.getElementById('stats-cards');
            const myTasksFilters = document.getElementById('mytasks-filters');
            const taskView = document.getElementById('task-view-content');
            const adminView = document.getElementById('admin-view-content');
            const depositView = document.getElementById('deposit-view'); // เพิ่ม Deposit View

            const mainHeader = document.getElementById('main-header');
            const newTaskBtn = document.getElementById('newTaskButton');
            const newUserBtn = document.getElementById('newUserButton');
            const showAllTasksBtn = document.getElementById('showAllTasksBtn');

            const navDashboard = document.getElementById('nav-dashboard');
            const navMyTasks = document.getElementById('nav-mytasks');
            const navAdmin = document.getElementById('nav-admin');
            const navDeposit = document.getElementById('nav-Storefront_deposit'); // เพิ่ม Deposit Nav

            const companySelectDiv = document.getElementById('company-select').parentElement;
            const navPurchasing = document.getElementById('nav-purchasing');
            const purchasingView = document.getElementById('purchasing-view');
            const navImport = document.getElementById('nav-import');      // [New]
            const importView = document.getElementById('import-view');    // [New]
            const navStockImport = document.getElementById('nav-stock-import'); // [Stock Import]
            const stockImportView = document.getElementById('stock-import-view'); // [Stock Import]

            // Reset Nav Styles
            [navDashboard, navMyTasks, navAdmin, navDeposit, navPurchasing, navImport, navStockImport].forEach(el => {
                if (el) {
                    el.classList.remove('bg-amber-500', 'text-white');
                    el.classList.add('text-slate-600', 'hover:bg-slate-50');
                }
            });

            // Hide All Views
            safeHide(statsCards);
            safeHide(taskView);
            safeHide(adminView);
            safeHide(depositView); // Hide Deposit View
            safeHide(purchasingView);
            safeHide(importView);     // [New]
            safeHide(stockImportView); // [Stock Import]

            // Hide Buttons & Filters
            safeHide(newTaskBtn); safeHide(newUserBtn);
            safeHide(showAllTasksBtn);
            safeHide(myTasksFilters);

            currentView = activeView;

            if (activeView === 'dashboard') {
                safeShow(statsCards); safeShow(taskView);
                if (currentUser.role !== 'staff') safeShow(newTaskBtn);
                safeShow(showAllTasksBtn);
                mainHeader.textContent = "แดชบอร์ด";
                navDashboard.classList.add('bg-amber-500', 'text-white');
                navDashboard.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'block';
            }
            else if (activeView === 'mytasks') {
                safeShow(taskView);
                safeShow(myTasksFilters);
                mainHeader.textContent = "งานของฉัน";
                navMyTasks.classList.add('bg-amber-500', 'text-white');
                navMyTasks.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'admin') {
                safeShow(adminView); safeShow(newUserBtn);
                mainHeader.textContent = "จัดการผู้ใช้";
                navAdmin.classList.add('bg-amber-500', 'text-white');
                navAdmin.classList.remove('text-gray-600', 'hover:bg-gray-100');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'deposit') { // (*** ใหม่ ***)
                safeShow(depositView);
                mainHeader.textContent = "เงินค่ามัดจำหน้าร้าน";
                navDeposit.classList.add('bg-amber-500', 'text-white');
                navDeposit.classList.remove('text-gray-600', 'hover:bg-gray-100');
                // ปกติหน้าร้านก็ควรเลือกบริษัทได้
                if (companySelectDiv) companySelectDiv.style.display = 'none';
            }
            else if (activeView === 'purchasing') { // [เพิ่ม]
                safeShow(purchasingView);
                mainHeader.textContent = "ติดตามการสั่งซื้อ";
                navPurchasing.classList.add('bg-amber-500', 'text-white');
                navPurchasing.classList.remove('text-slate-600', 'hover:bg-slate-50');
                if (companySelectDiv) companySelectDiv.style.display = 'none';

                // Default to Pending
                if (typeof fetchPurchasingOrders === 'function') {
                    fetchPurchasingOrders('pending');
                }
            }
            else if (activeView === 'import') { // [New]
                safeShow(importView);
                mainHeader.textContent = "แจ้งนำเข้าสินค้า";
                navImport.classList.add('bg-amber-500', 'text-white');
                navImport.classList.remove('text-slate-600', 'hover:bg-slate-50');
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                fetchImportRequests();
            }
            else if (activeView === 'stock-import') { // [New Stock]
                const stockImportView = document.getElementById('stock-import-view');
                const navStockImport = document.getElementById('nav-stock-import');
                safeShow(stockImportView);
                mainHeader.textContent = "จัดการรายการนำเข้า";
                if (navStockImport) {
                    navStockImport.classList.add('bg-amber-500', 'text-white');
                    navStockImport.classList.remove('text-slate-600', 'hover:bg-slate-50');
                }
                if (companySelectDiv) companySelectDiv.style.display = 'none';
                // Reset to Pending filter on entry
                if (typeof filterStockImports === 'function') {
                    filterStockImports('pending');
                } else {
                    fetchStockImports();
                }
            }

            if (currentUser && currentUser.role === 'staff') {
                if (document.getElementById('company-select')) document.getElementById('company-select').disabled = true;
            }
        };

        const updateMyTaskCounts = () => {
            if (!allMyTasks) return;
            document.getElementById('mytask-count-todo').textContent = allMyTasks.filter(t => t.status === 'todo').length;
            document.getElementById('mytask-count-inprogress').textContent = allMyTasks.filter(t => t.status === 'in-progress').length;
            document.getElementById('mytask-count-review').textContent = allMyTasks.filter(t => t.status === 'for-review').length;
            document.getElementById('mytask-count-completed').textContent = allMyTasks.filter(t => t.status === 'completed').length;
        };

        const filterMyTasks = (status) => {
            ['todo', 'inprogress', 'review', 'completed'].forEach(id => {
                document.getElementById(`btn-filter-${id}`).classList.remove('ring-2', 'ring-offset-1', 'ring-gray-400');
            });

            let filtered = [];
            if (status === 'all') {
                filtered = allMyTasks;
            } else {
                filtered = allMyTasks.filter(t => t.status === status);
                let btnId = '';
                if (status === 'todo') btnId = 'todo';
                else if (status === 'in-progress') btnId = 'inprogress';
                else if (status === 'for-review') btnId = 'review';
                else if (status === 'completed') btnId = 'completed';

                if (btnId) {
                    document.getElementById(`btn-filter-${btnId}`).classList.add('ring-2', 'ring-offset-1', 'ring-gray-400');
                }
            }
            renderTaskTable(filtered);
        };

        // --- INIT & LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth();


            // ============================================
            // STOCK IMPORT LOGIC
            // ============================================
            let currentStockFilter = 'pending';
            let currentStockImportType = 'phone'; // Default to Phone
            let currentStockBranch = 'all'; // [New] Branch Filter
            let targetImportId = null;
            let targetImportStatus = null;

            function filterStockType(type) {
                currentStockImportType = type;

                // Update Tab Styling
                const phoneTab = document.getElementById('tab-stock-phone');
                const accTab = document.getElementById('tab-stock-accessory');

                // Reset Base Styles
                [phoneTab, accTab].forEach(tab => {
                    tab.className = "px-6 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 border border-transparent";
                });

                if (type === 'phone') {
                    // Phone Active: Blue Theme
                    phoneTab.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'shadow-blue-200');
                    phoneTab.classList.remove('text-slate-500', 'hover:bg-slate-50');

                    // Acc Inactive
                    accTab.classList.add('text-slate-500', 'hover:bg-slate-100', 'bg-transparent');
                } else {
                    // Acc Active: Purple Theme
                    accTab.classList.add('bg-purple-600', 'text-white', 'shadow-md', 'shadow-purple-200');
                    accTab.classList.remove('text-slate-500', 'hover:bg-slate-50');

                    // Phone Inactive
                    phoneTab.classList.add('text-slate-500', 'hover:bg-slate-100', 'bg-transparent');
                }

                fetchStockImports();
            }

            function filterStockImports(status) {
                currentStockFilter = status;
                // Update UI buttons
                ['pending', 'importing', 'received', 'all'].forEach(s => {
                    const btn = document.getElementById(`filter-stock-${s}`);
                    if (btn) {
                        if (s === status) {
                            btn.classList.remove('bg-white', 'text-slate-600');
                            btn.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                        } else {
                            btn.classList.add('bg-white', 'text-slate-600');
                            btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
                        }
                    }
                });
                fetchStockImports();
            }

            async function fetchStockImports() {
                try {
                    // Include type and status in query
                    let url = `${SERVER_URL}/imports?t=${Date.now()}&type=${currentStockImportType}`;
                    if (currentStockFilter !== 'all') {
                        url += `&status=${currentStockFilter}`;
                    }
                    // [New] Branch Filter
                    if (currentStockBranch !== 'all') {
                        url += `&branch=${encodeURIComponent(currentStockBranch)}`;
                    }

                    const res = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (!res.ok) throw new Error('Failed to fetch');
                    const data = await res.json();
                    renderStockImportTable(data);
                    document.getElementById('stock-import-count').textContent = `${data.length} รายการ`;
                } catch (err) {
                    console.error(err);
                }
            }

            function renderStockImportTable(data) {
                console.log('Rendering Stock Import Table:', data);
                const tbody = document.getElementById('stock-import-table-body');
                tbody.innerHTML = '';

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium">ไม่พบข้อมูลการแจ้งนำเข้า</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    // Determine details
                    let productName = '-';
                    let quantity = '-';
                    let imageUrl = null;

                    // Logic for Name & Quantity
                    const isPhone = (item.type || '').toLowerCase() === 'phone';

                    if (isPhone && item.files && item.files.length > 0) {
                        productName = 'Import via Excel';
                        quantity = 'Many';
                    } else if (item.details) {
                        productName = item.details.productName || item.details.name || '-';
                        quantity = item.details.quantity || '-';
                    }

                    // Logic for Image URL & File Links
                    const getFullUrl = (path) => {
                        if (!path) return '';
                        if (path.startsWith('http')) return path;
                        if (path.startsWith('/')) return `${SERVER_URL}${path}`;
                        return `${SERVER_URL}/uploads/${path}`;
                    };

                    if (item.files && item.files.length > 0) {
                        const file = item.files[0];
                        if (file.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                            imageUrl = getFullUrl(file);
                        }
                    }

                    // Build Product Cell
                    let productCellContent = `
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 flex-shrink-0 bg-slate-100 rounded-lg flex items-center justify-center text-slate-400">
                                <ion-icon name="cube-outline" class="text-xl"></ion-icon>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-800">${productName}</div>
                                <div class="text-xs text-slate-500">จำนวน: ${quantity}</div>
                            </div>
                        </div>
                    `;

                    if (imageUrl) {
                        productCellContent = `
                            <div class="flex items-center gap-3">
                                <div class="h-10 w-10 flex-shrink-0 grouping">
                                    <img class="h-10 w-10 rounded-lg object-cover border border-slate-200" src="${imageUrl}" alt="Product" onerror="this.src='https://placehold.co/100?text=No+Img'">
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-slate-800 line-clamp-1">${productName}</div>
                                    <div class="text-xs text-slate-500">จำนวน: ${quantity}</div>
                                </div>
                            </div>
                        `;
                    }

                    // Build File Links
                    let fileHtml = '<span class="text-slate-400 text-xs">-</span>';
                    if (item.files && item.files.length > 0) {
                        fileHtml = item.files.map((f, i) => {
                            const url = getFullUrl(f);
                            return `
                            <a href="${url}" target="_blank" class="inline-flex items-center px-2.5 py-1 bg-slate-50 text-indigo-600 rounded-lg hover:bg-slate-100 border border-slate-200 text-xs font-medium mr-1.5 mb-1 transition-colors">
                                <ion-icon name="document-text-outline" class="mr-1.5"></ion-icon> ไฟล์ ${i + 1}
                            </a>
                        `}).join('');
                    }

                    // Status Options with Custom Styling
                    const statusOptions = [
                        { val: 'pending', label: 'รอนำเข้า' },
                        { val: 'importing', label: 'กำลังนำเข้า' },
                        { val: 'received', label: 'นำเข้าแล้ว' },
                        { val: 'rejected', label: 'ยกเลิก' }
                    ];

                    let statusSelectHtml = `
                        <div class="relative">
                            <select onchange="openStatusModal('${item._id}', this.value)" 
                                class="appearance-none w-full bg-white border border-slate-200 text-slate-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 pr-8 font-medium shadow-sm transition-all hover:border-indigo-300">
                                ${statusOptions.map(opt => `<option value="${opt.val}" ${item.status === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('')}
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                <ion-icon name="chevron-down-outline" class="text-sm"></ion-icon>
                            </div>
                        </div>
                    `;

                    // Helper for Status Badge
                    const getStatusBadge = (status) => {
                        const styles = {
                            'pending': 'bg-yellow-50 text-yellow-700 border-yellow-200 ring-yellow-500/30',
                            'importing': 'bg-blue-50 text-blue-700 border-blue-200 ring-blue-500/30',
                            'received': 'bg-green-50 text-green-700 border-green-200 ring-green-500/30',
                            'rejected': 'bg-red-50 text-red-700 border-red-200 ring-red-500/30'
                        };
                        const labels = {
                            'pending': 'รอนำเข้า',
                            'importing': 'กำลังนำเข้า',
                            'received': 'นำเข้าแล้ว',
                            'rejected': 'ยกเลิก'
                        };
                        const css = styles[status] || 'bg-slate-50 text-slate-600 border-slate-200';
                        const label = labels[status] || status;

                        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold border ring-1 ring-inset ${css}">
                                    <span class="w-1.5 h-1.5 rounded-full bg-current mr-1.5 opacity-60"></span>
                                    ${label}
                                </span>`;
                    };

                    // Render Row
                    const tr = document.createElement('tr');
                    tr.className = 'group hover:bg-slate-50/80 transition-all border-b border-transparent hover:border-slate-100 last:border-0';
                    const dateStr = formatDate(item.createdAt);

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                             <div class="font-medium text-slate-700">${dateStr.split(' ')[0]}</div>
                             <div class="text-xs text-slate-400">${dateStr.split(' ')[1] || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-8 w-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold mr-3 border border-indigo-200">
                                    ${(item.branch || 'HO').substring(0, 2)}
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-slate-800">${item.branch}</div>
                                    <div class="text-xs text-slate-500 flex items-center gap-1">
                                        <ion-icon name="person-outline" class="text-[10px]"></ion-icon>
                                        ${item.createdBy ? item.createdBy.name : 'Unknown'}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            ${productCellContent}
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-500">
                            <div class="flex flex-wrap max-w-xs">
                                 ${fileHtml}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                             ${getStatusBadge(item.status)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium w-40">
                            ${statusSelectHtml}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function openStatusModal(id, status) {
                targetImportId = id;
                targetImportStatus = status;

                const map = {
                    'pending': 'รอนำเข้า',
                    'importing': 'กำลังนำเข้า',
                    'received': 'นำเข้าแล้ว',
                    'rejected': 'ยกเลิก (Reject)'
                };
                document.getElementById('target-status-name').textContent = map[status] || status;

                openModal('statusUpdateModal');
            }

            document.getElementById('confirm-status-update-btn').addEventListener('click', async () => {
                if (!targetImportId || !targetImportStatus) return;

                try {
                    const res = await fetch(`${SERVER_URL}/imports/${targetImportId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ status: targetImportStatus })
                    });

                    if (res.ok) {
                        closeModal('statusUpdateModal');
                        fetchStockImports();
                    } else {
                        alert('Failed to update status');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error updating status');
                }
            });

            // Forms
            document.getElementById('new-task-form').addEventListener('submit', handleNewTaskSubmit);
            document.getElementById('update-task-form').addEventListener('submit', handleUpdateTaskSubmit);
            document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);

            // Import Forms
            const phoneImportForm = document.getElementById('phone-import-form');
            if (phoneImportForm) {
                phoneImportForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fileInput = document.getElementById('phone-import-file');
                    if (fileInput.files.length === 0) return alert('กรุณาเลือกไฟล์');

                    const formData = new FormData();
                    formData.append('type', 'phone');
                    formData.append('files', fileInput.files[0]);
                    formData.append('companyId', document.getElementById('company-select').value);

                    try {
                        const res = await fetch(`${SERVER_URL}/imports`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                            body: formData
                        });
                        if (res.ok) {
                            alert('แจ้งนำเข้าสำเร็จ');
                            phoneImportForm.reset();
                            document.getElementById('file-name-display').textContent = '';
                            fetchImportRequests();
                        } else {
                            const err = await res.json();
                            alert('Error: ' + err.message);
                        }
                    } catch (err) { alert('Error: ' + err.message); }
                });

                document.getElementById('phone-import-file').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        document.getElementById('file-name-display').textContent = e.target.files[0].name;
                    } else {
                        document.getElementById('file-name-display').textContent = '';
                    }
                });
            }

            const accImportForm = document.getElementById('accessory-import-form');
            if (accImportForm) {
                accImportForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const imageInput = document.getElementById('acc-import-image');
                    const name = document.getElementById('acc-name').value;
                    const qty = document.getElementById('acc-qty').value;
                    const date = document.getElementById('acc-date').value;

                    if (!name || !qty || !date) return alert('กรุณากรอกข้อมูลให้ครบ');

                    const formData = new FormData();
                    formData.append('type', 'accessory');
                    formData.append('companyId', document.getElementById('company-select').value);
                    formData.append('name', name);
                    formData.append('quantity', qty);
                    formData.append('importDate', date);
                    if (imageInput.files.length > 0) {
                        formData.append('files', imageInput.files[0]);
                    }

                    try {
                        const res = await fetch(`${SERVER_URL}/imports`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                            body: formData
                        });
                        if (res.ok) {
                            alert('บันทึกแจ้งนำเข้าสำเร็จ');
                            accImportForm.reset();
                            document.getElementById('image-preview').classList.add('hidden');
                            document.getElementById('image-preview-placeholder').classList.remove('hidden');
                            fetchImportRequests();
                        } else {
                            const err = await res.json();
                            alert('Error: ' + err.message);
                        }
                    } catch (err) { alert('Error: ' + err.message); }
                });
            }

            // Buttons
            document.getElementById('confirm-delete-button').addEventListener('click', executeDelete);
            document.getElementById('newTaskButton').addEventListener('click', () => {
                fetchAllUsers();
                openModal('newTaskModal');
            });
            // (*** เพิ่ม Listener ปุ่มแสดงงานทั้งหมด ***)
            document.getElementById('showAllTasksBtn').addEventListener('click', () => {
                // 1. ลบ Highlight จากการ์ดสถิติ
                document.querySelectorAll('#stats-cards [data-status]').forEach(card => {
                    card.classList.remove('ring-2', 'ring-amber-500', 'shadow-lg');
                });
                // 2. แสดงงานทั้งหมดจาก Cache
                if (typeof allDashboardTasks !== 'undefined') {
                    renderTaskTable(allDashboardTasks);
                }
            });
            document.getElementById('newUserButton').addEventListener('click', openNewUserModal);
            document.getElementById('notification-bell').addEventListener('click', () => {
                openModal('notificationModal');
                markNotificationsAsRead();
            });
            const mobileBell = document.getElementById('notification-bell-btn-mobile');
            if (mobileBell) {
                mobileBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const mobileDot = document.getElementById('notification-dot-mobile');
                    if (mobileDot) mobileDot.classList.add('hidden');
                    openModal('notificationModal');
                });
            }
            document.getElementById('nav-dashboard').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = 'ผู้รับผิดชอบ';
                e.preventDefault(); updateNavActiveState('dashboard');
                fetchDashboardTasks(); fetchTaskStats();
            });
            document.getElementById('nav-mytasks').addEventListener('click', (e) => {
                const header = document.getElementById('header-assignee');
                if (header) header.textContent = 'ผู้มอบหมายงาน';
                e.preventDefault(); updateNavActiveState('mytasks');
                fetchMyTasks();
            });
            document.getElementById('nav-admin').addEventListener('click', (e) => {
                e.preventDefault(); updateNavActiveState('admin');
                fetchAllUsersForTable();
            });

            // (*** เพิ่ม Listener สำหรับเมนู Deposit ***)
            document.getElementById('nav-Storefront_deposit').addEventListener('click', (e) => {
                e.preventDefault();
                updateNavActiveState('deposit'); // เรียกใช้ฟังก์ชันกลาง
                fetchDeposits(); // โหลดข้อมูล
            });

            // Company Change Listener
            document.getElementById('company-select').addEventListener('change', () => {
                if (currentView === 'dashboard') {
                    fetchNotifications(); fetchDashboardTasks(); fetchTaskStats(); fetchAllUsers();
                } else if (currentView === 'admin') {
                    fetchAllUsersForTable();
                } else if (currentView === 'deposit') { // (*** เพิ่ม ***)
                    fetchDeposits(); // รีเฟรชตารางมัดจำเมื่อเปลี่ยนบริษัท
                }
            });

            document.getElementById('user-company-input').addEventListener('change', () => {
                loadManagersForDropdown();
            });

            const branchFilterSelect = document.getElementById('deposit-filter-branch');
            if (branchFilterSelect) {
                branchFilterSelect.addEventListener('change', () => {
                    fetchDeposits(); // เรียกฟังก์ชันโหลดข้อมูลใหม่
                });

                // (เสริม) ถ้าเป็น Staff ทั่วไป ซ่อนตัวกรองนี้ไปเลย (เพราะดูได้แค่สาขาตัวเองอยู่แล้ว)
                if (currentUser && currentUser.role === 'staff') {
                    const container = document.getElementById('filter-branch-container');
                    if (container) container.style.display = 'none';
                }
            }
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const overlay = document.getElementById('sidebar-overlay');

            if (menuToggle && sidebar && overlay) {
                const toggleMenu = () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('hidden');
                };
                menuToggle.addEventListener('click', toggleMenu);
                overlay.addEventListener('click', toggleMenu);

                // ปิดเมนูอัตโนมัติเมื่อกดลิงก์
                document.querySelectorAll('#nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        // เช็คว่าอยู่ในโหมดมือถือ (จอเล็กกว่า 768px)
                        if (window.innerWidth < 768) {
                            toggleMenu();
                        }
                    });
                });
            }

            const purForm = document.getElementById('purchasing-form');
            if (purForm) {
                purForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const token = localStorage.getItem('token');
                    const id = document.getElementById('pur-id').value;
                    const companyId = document.getElementById('company-select').value;

                    try {
                        // 1. ดึงข้อมูลเก่ามาก่อนเพื่อความปลอดภัย (ป้องกันข้อมูลลูกค้าหาย)
                        const resGet = await fetch(`${SERVER_URL}/deposits?companyId=${companyId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const allDeposits = await resGet.json();
                        const oldData = allDeposits.find(d => d._id === id);

                        if (!oldData) {
                            alert('ไม่พบข้อมูลเดิม');
                            return;
                        }

                        // 2. รวมข้อมูลเก่ากับสถานะใหม่
                        const payload = {
                            ...oldData, // แผ่ข้อมูลเดิม
                            id: oldData._id, // *** สำคัญ: ต้องระบุ id เพื่อให้ Backend รู้ว่าเป็นการแก้ไข ***
                            orderStatus: document.getElementById('pur-status').value,
                            orderNote: document.getElementById('pur-note').value
                        };

                        // 3. ส่งกลับไปบันทึก
                        const res = await fetch(`${SERVER_URL}/deposits`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            closeModal('purchasingModal');
                            fetchPurchasingOrders(); // รีเฟรชตาราง
                        } else {
                            alert('บันทึกไม่สำเร็จ');
                        }
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                });
            }
            // Expose Stock Functions to Window
            window.filterStockImports = filterStockImports;
            window.fetchStockImports = fetchStockImports;
            window.openStatusModal = openStatusModal;
            window.filterStockType = filterStockType;

            // [New] Branch Filter Listener
            const stockBranchSelect = document.getElementById('stock-import-branch-filter');
            if (stockBranchSelect) {
                stockBranchSelect.addEventListener('change', (e) => {
                    currentStockBranch = e.target.value;
                    fetchStockImports();
                });
            }

        });

        // Modal Control
        function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
    </script>
</body>

</html>